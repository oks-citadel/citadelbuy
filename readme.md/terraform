# Terraform Infrastructure as Code
## Cross-Border Commerce Platform

Complete infrastructure automation using Terraform for AWS deployment across dev, test, and production environments.

---

## ğŸ“‹ Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Project Structure](#project-structure)
- [Environments](#environments)
- [Modules](#modules)
- [Deployment Guide](#deployment-guide)
- [State Management](#state-management)
- [Security](#security)
- [Cost Optimization](#cost-optimization)
- [Troubleshooting](#troubleshooting)

---

## Overview

This Terraform configuration deploys a complete, production-ready e-commerce platform on AWS with:

- **Multi-environment support**: Dev, Test, Production
- **High availability**: Multi-AZ deployment, auto-scaling
- **Security**: VPC isolation, security groups, encrypted storage
- **Monitoring**: CloudWatch, Container Insights
- **Auto-scaling**: ECS services with target tracking
- **Load balancing**: Application Load Balancer with SSL
- **Database**: RDS PostgreSQL with automated backups
- **Caching**: ElastiCache Redis cluster
- **Storage**: S3 with CloudFront CDN
- **Secrets**: AWS Systems Manager Parameter Store

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AWS Cloud                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    VPC (10.x.0.0/16)                    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  Public Subnets          Private Subnets               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚ Application  â”‚        â”‚ ECS Services â”‚             â”‚   â”‚
â”‚  â”‚  â”‚ Load Balancerâ”‚â”€â”€â”€â”€â”€â”€â”€>â”‚ - Backend    â”‚             â”‚   â”‚
â”‚  â”‚  â”‚ (ALB)        â”‚        â”‚ - Frontend   â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚        â”‚                         â”‚                     â”‚   â”‚
â”‚  â”‚        â”‚                         â–¼                     â”‚   â”‚
â”‚  â”‚        â”‚                  Database Subnets             â”‚   â”‚
â”‚  â”‚        â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚        â”‚                  â”‚ RDS          â”‚             â”‚   â”‚
â”‚  â”‚        â”‚                  â”‚ PostgreSQL   â”‚             â”‚   â”‚
â”‚  â”‚        â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚        â”‚                         â”‚                     â”‚   â”‚
â”‚  â”‚        â”‚                         â–¼                     â”‚   â”‚
â”‚  â”‚        â”‚                  Cache Subnets                â”‚   â”‚
â”‚  â”‚        â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚        â”‚                  â”‚ ElastiCache  â”‚             â”‚   â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Redis        â”‚             â”‚   â”‚
â”‚  â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  External Services:                                             â”‚
â”‚  - S3 (Asset Storage)                                          â”‚
â”‚  - CloudFront (CDN)                                            â”‚
â”‚  - Route53 (DNS)                                               â”‚
â”‚  - ACM (SSL Certificates)                                      â”‚
â”‚  - CloudWatch (Monitoring)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Prerequisites

### Required Tools

1. **Terraform** >= 1.6.0
   ```bash
   # macOS
   brew install terraform
   
   # Linux
   wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
   unzip terraform_1.6.0_linux_amd64.zip
   sudo mv terraform /usr/local/bin/
   ```

2. **AWS CLI** >= 2.0
   ```bash
   # macOS
   brew install awscli
   
   # Linux
   curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
   unzip awscliv2.zip
   sudo ./aws/install
   ```

3. **Docker** (for local testing)
   ```bash
   # macOS
   brew install --cask docker
   
   # Linux
   curl -fsSL https://get.docker.com -o get-docker.sh
   sudo sh get-docker.sh
   ```

### AWS Setup

1. **AWS Account** with appropriate permissions
2. **AWS Access Keys** configured
3. **S3 Bucket** for Terraform state (create manually first)
4. **DynamoDB Table** for state locking (create manually first)

```bash
# Configure AWS credentials
aws configure

# Create S3 bucket for state
aws s3 mb s3://commerce-platform-terraform-state --region us-east-1

# Create DynamoDB table for state locking
aws dynamodb create-table \
    --table-name terraform-state-lock \
    --attribute-definitions AttributeName=LockID,AttributeType=S \
    --key-schema AttributeName=LockID,KeyType=HASH \
    --billing-mode PAY_PER_REQUEST \
    --region us-east-1
```

---

## Quick Start

### 1. Clone Repository

```bash
git clone https://github.com/yourorg/commerce-platform.git
cd commerce-platform/terraform
```

### 2. Initialize Terraform

```bash
# Initialize for development environment
cd environments/dev
terraform init
```

### 3. Review Plan

```bash
# See what will be created
terraform plan
```

### 4. Deploy Infrastructure

```bash
# Deploy to development
terraform apply

# Type 'yes' when prompted
```

### 5. Get Outputs

```bash
# View deployment information
terraform output
```

---

## Project Structure

```
terraform/
â”œâ”€â”€ main.tf                       # Main configuration
â”œâ”€â”€ variables.tf                  # Variable definitions
â”œâ”€â”€ outputs.tf                    # Output definitions
â”œâ”€â”€ backend.tf                    # Backend configuration
â”‚
â”œâ”€â”€ environments/                 # Environment-specific configs
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ terraform.tfvars     # Dev variables
â”‚   â”‚   â””â”€â”€ backend.tfvars       # Dev backend config
â”‚   â”œâ”€â”€ test/
â”‚   â”‚   â”œâ”€â”€ terraform.tfvars     # Test variables
â”‚   â”‚   â””â”€â”€ backend.tfvars       # Test backend config
â”‚   â””â”€â”€ prod/
â”‚       â”œâ”€â”€ terraform.tfvars     # Prod variables
â”‚       â””â”€â”€ backend.tfvars       # Prod backend config
â”‚
â”œâ”€â”€ modules/                      # Reusable modules
â”‚   â”œâ”€â”€ vpc/                     # VPC and networking
â”‚   â”œâ”€â”€ security/                # Security groups
â”‚   â”œâ”€â”€ database/                # RDS PostgreSQL
â”‚   â”œâ”€â”€ redis/                   # ElastiCache Redis
â”‚   â”œâ”€â”€ storage/                 # S3 and CloudFront
â”‚   â”œâ”€â”€ ecs/                     # ECS cluster
â”‚   â”œâ”€â”€ ecs-service/             # ECS service module
â”‚   â”œâ”€â”€ alb/                     # Application Load Balancer
â”‚   â””â”€â”€ monitoring/              # CloudWatch and alarms
â”‚
â””â”€â”€ scripts/                      # Helper scripts
    â”œâ”€â”€ init.sh                  # Initialize environment
    â”œâ”€â”€ deploy.sh                # Deploy infrastructure
    â”œâ”€â”€ destroy.sh               # Destroy infrastructure
    â””â”€â”€ update-services.sh       # Update ECS services
```

---

## Environments

### Development

**Purpose**: Local development and feature testing

**Characteristics**:
- Single AZ deployment
- Smaller instance sizes (t3.micro, t3.small)
- No deletion protection
- 7-day log retention
- Auto-scaling: 1-3 tasks
- Costs: ~$50-100/month

**Deploy**:
```bash
cd environments/dev
terraform init
terraform apply -var-file=terraform.tfvars
```

### Test/Staging

**Purpose**: QA testing and pre-production validation

**Characteristics**:
- Single or Multi-AZ
- Medium instance sizes (t3.small, t3.medium)
- Moderate deletion protection
- 14-day log retention
- Auto-scaling: 2-5 tasks
- Costs: ~$150-250/month

**Deploy**:
```bash
cd environments/test
terraform init
terraform apply -var-file=terraform.tfvars
```

### Production

**Purpose**: Live customer-facing environment

**Characteristics**:
- Multi-AZ for high availability
- Production-grade instances (r6g.xlarge, r6g.large)
- Full deletion protection
- 90-day log retention
- Auto-scaling: 3-20 tasks
- Enhanced monitoring
- Costs: ~$500-2000/month

**Deploy**:
```bash
cd environments/prod
terraform init
terraform apply -var-file=terraform.tfvars
```

---

## Modules

### VPC Module (`modules/vpc`)

Creates a complete VPC with:
- Public, private, database, and cache subnets across multiple AZs
- Internet Gateway
- NAT Gateways (one per AZ for HA)
- Route tables
- VPC Flow Logs

**Usage**:
```hcl
module "vpc" {
  source = "./modules/vpc"
  
  project_name       = "commerce-platform"
  environment        = "prod"
  vpc_cidr           = "10.0.0.0/16"
  availability_zones = ["us-east-1a", "us-east-1b", "us-east-1c"]
  enable_nat_gateway = true
}
```

### Database Module (`modules/database`)

Creates RDS PostgreSQL instance with:
- Automated backups
- Multi-AZ deployment option
- Enhanced monitoring
- Performance Insights
- Encrypted storage
- Parameter groups

### ECS Service Module (`modules/ecs-service`)

Creates ECS service with:
- Task definition
- Service with load balancer integration
- Auto-scaling policies
- CloudWatch alarms
- IAM roles

---

## Deployment Guide

### Initial Deployment

1. **Prepare Environment**
   ```bash
   # Set AWS credentials
   export AWS_ACCESS_KEY_ID="your-key"
   export AWS_SECRET_ACCESS_KEY="your-secret"
   export AWS_REGION="us-east-1"
   
   # Set sensitive variables
   export TF_VAR_stripe_secret_key="sk_live_..."
   ```

2. **Initialize Backend**
   ```bash
   cd environments/prod
   terraform init -backend-config=backend.tfvars
   ```

3. **Validate Configuration**
   ```bash
   terraform validate
   terraform fmt -check
   ```

4. **Plan Changes**
   ```bash
   terraform plan -var-file=terraform.tfvars -out=tfplan
   ```

5. **Apply Changes**
   ```bash
   terraform apply tfplan
   ```

6. **Verify Deployment**
   ```bash
   # Get outputs
   terraform output
   
   # Check ECS services
   aws ecs list-services --cluster commerce-platform-prod
   
   # Test endpoints
   curl https://api.yourplatform.com/health
   ```

### Updating Infrastructure

```bash
# Pull latest changes
git pull origin main

# Review changes
terraform plan -var-file=terraform.tfvars

# Apply updates
terraform apply -var-file=terraform.tfvars
```

### Updating Container Images

```bash
# Update image variables in terraform.tfvars
backend_image  = "your-registry/commerce-backend:v1.0.1"
frontend_image = "your-registry/commerce-frontend:v1.0.1"

# Apply changes (this will update ECS task definitions)
terraform apply -var-file=terraform.tfvars
```

### Rolling Back

```bash
# List state versions
terraform state list

# Pull specific state version
terraform state pull > backup.tfstate

# Revert to previous configuration
git checkout <previous-commit>
terraform apply -var-file=terraform.tfvars
```

---

## State Management

### Remote State Configuration

State is stored in S3 with DynamoDB locking:

```hcl
terraform {
  backend "s3" {
    bucket         = "commerce-platform-terraform-state"
    key            = "prod/terraform.tfstate"
    region         = "us-east-1"
    encrypt        = true
    dynamodb_table = "terraform-state-lock"
  }
}
```

### State Commands

```bash
# View current state
terraform show

# List resources
terraform state list

# Show specific resource
terraform state show module.vpc.aws_vpc.main

# Move resource in state
terraform state mv module.old module.new

# Remove resource from state (keeps actual resource)
terraform state rm module.example
```

### State Backup

```bash
# Pull current state
terraform state pull > terraform.tfstate.backup

# Push state (careful!)
terraform state push terraform.tfstate.backup
```

---

## Security

### Best Practices

1. **Never commit secrets**:
   ```bash
   # Use environment variables
   export TF_VAR_stripe_secret_key="sk_live_..."
   
   # Or use AWS Secrets Manager
   ```

2. **Enable encryption**:
   - S3 state bucket encrypted
   - RDS storage encrypted
   - EBS volumes encrypted
   - Secrets in SSM Parameter Store

3. **Use least privilege IAM**:
   - Separate roles for services
   - No hardcoded credentials
   - Rotate access keys regularly

4. **Network isolation**:
   - Private subnets for applications
   - Database in dedicated subnets
   - Security groups with minimal access

5. **Enable logging**:
   - VPC Flow Logs
   - CloudWatch Logs
   - CloudTrail for API calls

### Security Checklist

- [ ] All sensitive variables marked as `sensitive = true`
- [ ] State file encrypted in S3
- [ ] No hardcoded credentials in code
- [ ] IAM roles follow least privilege
- [ ] Security groups have minimal required access
- [ ] All data encrypted at rest and in transit
- [ ] CloudTrail enabled for audit logging
- [ ] MFA required for production changes
- [ ] Regular security scans performed

---

## Cost Optimization

### Development Environment Costs

```
RDS (db.t3.micro):           ~$15/month
ElastiCache (cache.t3.micro): ~$12/month
ECS Fargate (2 tasks):        ~$30/month
ALB:                          ~$20/month
NAT Gateway:                  ~$35/month
Data Transfer:                ~$10/month
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:                        ~$122/month
```

### Production Environment Costs

```
RDS (db.r6g.xlarge, Multi-AZ): ~$600/month
ElastiCache (2x cache.r6g.large): ~$300/month
ECS Fargate (6 tasks avg):     ~$180/month
ALB:                           ~$20/month
NAT Gateway (3):               ~$105/month
CloudFront:                    ~$50/month
Data Transfer:                 ~$100/month
S3 Storage:                    ~$25/month
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:                         ~$1,380/month
```

### Cost Optimization Tips

1. **Right-size instances**: Start small, scale as needed
2. **Use auto-scaling**: Only pay for what you use
3. **Reserved Instances**: Save up to 75% for predictable workloads
4. **S3 lifecycle policies**: Move old data to cheaper storage
5. **CloudFront caching**: Reduce origin requests
6. **Delete unused resources**: Run `terraform destroy` for test environments
7. **Use Spot instances**: For non-critical workloads (80-90% savings)

### Cost Monitoring

```bash
# View estimated costs
aws ce get-cost-and-usage \
    --time-period Start=2025-01-01,End=2025-01-31 \
    --granularity MONTHLY \
    --metrics BlendedCost
```

---

## Troubleshooting

### Common Issues

**1. "Backend initialization required"**
```bash
terraform init -reconfigure
```

**2. "Error locking state"**
```bash
# Force unlock (use carefully)
terraform force-unlock <lock-id>
```

**3. "Resource already exists"**
```bash
# Import existing resource
terraform import module.vpc.aws_vpc.main vpc-xxxxx
```

**4. "Insufficient permissions"**
```bash
# Check IAM permissions
aws sts get-caller-identity
```

**5. "Quota exceeded"**
```bash
# Request quota increase
aws service-quotas request-service-quota-increase \
    --service-code ecs \
    --quota-code L-xxxxxxxx \
    --desired-value 100
```

### Debug Mode

```bash
# Enable detailed logging
export TF_LOG=DEBUG
export TF_LOG_PATH=./terraform.log

terraform apply
```

### Validation

```bash
# Validate syntax
terraform validate

# Format code
terraform fmt -recursive

# Security scan
tfsec .

# Cost estimate
terraform cost estimate
```

---

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Terraform Deploy

on:
  push:
    branches: [main]

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
      
      - name: Terraform Init
        run: terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      
      - name: Terraform Plan
        run: terraform plan
      
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve
```

---

## Maintenance

### Regular Tasks

**Daily**:
- Monitor CloudWatch dashboards
- Review security alerts
- Check auto-scaling metrics

**Weekly**:
- Review costs and optimization opportunities
- Update container images
- Check for AWS service updates

**Monthly**:
- Update Terraform providers
- Review and rotate secrets
- Audit IAM permissions
- Test disaster recovery procedures

**Quarterly**:
- Major version upgrades (database, etc.)
- Security audit
- Capacity planning review

---

## Additional Resources

- [Terraform AWS Provider Docs](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [AWS Well-Architected Framework](https://aws.amazon.com/architecture/well-architected/)
- [ECS Best Practices](https://docs.aws.amazon.com/AmazonECS/latest/bestpracticesguide/intro.html)
- [RDS Best Practices](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_BestPractices.html)

---

## Support

- **Issues**: Open a GitHub issue
- **Slack**: #infrastructure channel
- **Email**: devops@yourcompany.com
- **On-call**: PagerDuty

---

**Built with â¤ï¸ using Terraform**
