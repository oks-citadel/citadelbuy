# Getting Started with Terraform
## Cross-Border Commerce Platform

This guide will walk you through deploying the commerce platform to AWS using Terraform.

---

## üìã Prerequisites

### 1. Install Required Tools

**Terraform**:
```bash
# macOS
brew install terraform

# Linux
wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
unzip terraform_1.6.0_linux_amd64.zip
sudo mv terraform /usr/local/bin/

# Windows
choco install terraform

# Verify installation
terraform version
```

**AWS CLI**:
```bash
# macOS
brew install awscli

# Linux
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# Windows
msiexec.exe /i https://awscli.amazonaws.com/AWSCLIV2.msi

# Verify installation
aws --version
```

**jq** (optional, for JSON parsing):
```bash
# macOS
brew install jq

# Linux
sudo apt-get install jq
```

### 2. AWS Account Setup

1. **Create AWS Account** (if you don't have one)
   - Go to https://aws.amazon.com
   - Click "Create an AWS Account"
   - Follow the registration process

2. **Create IAM User for Terraform**
   ```bash
   # Log in to AWS Console
   # Go to IAM > Users > Add User
   # Username: terraform-deployer
   # Access type: Programmatic access
   # Attach policies:
   #   - AdministratorAccess (for initial setup)
   #   - Or create custom policy with required permissions
   ```

3. **Configure AWS Credentials**
   ```bash
   aws configure
   # AWS Access Key ID: [your key]
   # AWS Secret Access Key: [your secret]
   # Default region: us-east-1
   # Default output format: json
   
   # Verify configuration
   aws sts get-caller-identity
   ```

### 3. Create S3 Backend for State

```bash
# Create S3 bucket for Terraform state
aws s3 mb s3://commerce-platform-terraform-state --region us-east-1

# Enable versioning
aws s3api put-bucket-versioning \
    --bucket commerce-platform-terraform-state \
    --versioning-configuration Status=Enabled

# Enable encryption
aws s3api put-bucket-encryption \
    --bucket commerce-platform-terraform-state \
    --server-side-encryption-configuration '{
        "Rules": [{
            "ApplyServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
            }
        }]
    }'

# Create DynamoDB table for state locking
aws dynamodb create-table \
    --table-name terraform-state-lock \
    --attribute-definitions AttributeName=LockID,AttributeType=S \
    --key-schema AttributeName=LockID,KeyType=HASH \
    --billing-mode PAY_PER_REQUEST \
    --region us-east-1
```

---

## üöÄ Deploy Development Environment

### Step 1: Clone Repository

```bash
git clone https://github.com/yourorg/commerce-platform.git
cd commerce-platform/terraform
```

### Step 2: Configure Development Environment

```bash
cd environments/dev

# Review default configuration
cat terraform.tfvars

# Create custom overrides (optional)
cp terraform.tfvars terraform.tfvars.local

# Edit terraform.tfvars.local with your values:
# - domain_name
# - owner_email
# - backend_image (your Docker registry)
# - frontend_image (your Docker registry)
```

### Step 3: Set Sensitive Variables

```bash
# Set secrets via environment variables (never commit these!)
export TF_VAR_stripe_secret_key="sk_test_your_key_here"

# Or create a secrets file (add to .gitignore)
cat > secrets.tfvars << EOF
stripe_secret_key = "sk_test_your_key_here"
EOF
```

### Step 4: Initialize Terraform

```bash
# Initialize Terraform
terraform init

# Expected output:
# Initializing modules...
# Initializing the backend...
# Initializing provider plugins...
# Terraform has been successfully initialized!
```

### Step 5: Plan Deployment

```bash
# Create execution plan
terraform plan -var-file=terraform.tfvars -out=tfplan

# Review the plan carefully
# Shows what will be created, modified, or destroyed

# Expected resources:
# - VPC and subnets
# - Security groups
# - RDS PostgreSQL instance
# - ElastiCache Redis cluster
# - ECS cluster and services
# - Application Load Balancer
# - S3 buckets
# - IAM roles and policies
# - CloudWatch log groups
```

### Step 6: Apply Configuration

```bash
# Apply the plan
terraform apply tfplan

# This will take 10-15 minutes
# Progress will be shown for each resource

# When complete, you'll see:
# Apply complete! Resources: XX added, 0 changed, 0 destroyed.
```

### Step 7: Get Deployment Information

```bash
# View all outputs
terraform output

# Get specific outputs
terraform output frontend_domain
terraform output api_domain

# Get database endpoint
terraform output database_endpoint

# Save outputs to file
terraform output -json > outputs.json
```

### Step 8: Verify Deployment

```bash
# Check ECS services
aws ecs list-services --cluster commerce-platform-dev

# Check task status
aws ecs list-tasks --cluster commerce-platform-dev

# Test API endpoint
FRONTEND_URL=$(terraform output -raw frontend_domain)
curl -I $FRONTEND_URL

API_URL=$(terraform output -raw api_domain)
curl $API_URL/health
```

---

## üîÑ Update Infrastructure

### Update Container Images

```bash
# Build and push new images to your registry
docker build -t your-registry/commerce-backend:v1.0.1 ./backend
docker push your-registry/commerce-backend:v1.0.1

# Update terraform.tfvars
backend_image = "your-registry/commerce-backend:v1.0.1"

# Apply changes
terraform apply -var-file=terraform.tfvars
```

### Modify Infrastructure

```bash
# Edit main.tf or module configurations
nano ../../main.tf

# Plan changes
terraform plan -var-file=terraform.tfvars

# Apply if changes look good
terraform apply -var-file=terraform.tfvars
```

### Scale Services

```bash
# Edit terraform.tfvars
backend_desired_count = 5
frontend_desired_count = 3

# Apply changes
terraform apply -var-file=terraform.tfvars
```

---

## üß™ Deploy Test Environment

```bash
# Navigate to test environment
cd ../test

# Initialize
terraform init

# Plan
terraform plan -var-file=terraform.tfvars

# Apply
terraform apply -var-file=terraform.tfvars
```

---

## üè≠ Deploy Production Environment

### Production Checklist

Before deploying to production, ensure:

- [ ] All sensitive variables are set via environment variables
- [ ] SSL certificate obtained and ARN added to terraform.tfvars
- [ ] Domain name configured in Route53
- [ ] Backup retention configured (30 days)
- [ ] Multi-AZ enabled for database
- [ ] Deletion protection enabled
- [ ] Monitoring and alerting configured
- [ ] Security groups reviewed
- [ ] Cost estimates reviewed
- [ ] Disaster recovery plan documented

### Production Deployment

```bash
# Navigate to production environment
cd environments/prod

# Set all secrets via environment variables
export TF_VAR_stripe_secret_key="sk_live_your_key_here"
# Add other secrets...

# Initialize
terraform init

# Plan (review very carefully!)
terraform plan -var-file=terraform.tfvars -out=tfplan

# Review plan output
# Ensure no unexpected changes

# Apply (requires confirmation)
terraform apply tfplan

# Monitor deployment
watch -n 5 'aws ecs list-tasks --cluster commerce-platform-prod'
```

---

## üìä Monitor Infrastructure

### CloudWatch Dashboards

```bash
# Get CloudWatch dashboard URL
aws cloudwatch list-dashboards

# View metrics
aws cloudwatch get-metric-statistics \
    --namespace AWS/ECS \
    --metric-name CPUUtilization \
    --dimensions Name=ClusterName,Value=commerce-platform-prod \
    --start-time 2025-01-01T00:00:00Z \
    --end-time 2025-01-01T23:59:59Z \
    --period 3600 \
    --statistics Average
```

### View Logs

```bash
# List log groups
aws logs describe-log-groups --log-group-name-prefix /ecs/commerce

# Tail logs
aws logs tail /ecs/commerce-platform-dev/backend --follow

# Search logs
aws logs filter-log-events \
    --log-group-name /ecs/commerce-platform-dev/backend \
    --filter-pattern "ERROR"
```

---

## üßπ Clean Up Resources

### Destroy Development Environment

```bash
cd environments/dev

# Preview what will be destroyed
terraform plan -destroy -var-file=terraform.tfvars

# Destroy (requires confirmation)
terraform destroy -var-file=terraform.tfvars

# Type 'yes' to confirm
```

### Destroy Specific Resources

```bash
# Remove specific resource
terraform destroy -target=module.frontend_service -var-file=terraform.tfvars

# Remove multiple resources
terraform destroy \
    -target=module.frontend_service \
    -target=module.backend_service \
    -var-file=terraform.tfvars
```

---

## üêõ Troubleshooting

### Common Issues

**Issue**: "Error: Backend initialization required"
```bash
# Solution: Reinitialize backend
terraform init -reconfigure
```

**Issue**: "Error locking state"
```bash
# Solution: Force unlock (use carefully!)
terraform force-unlock <lock-id>

# Or wait for lock to expire (usually 20 minutes)
```

**Issue**: "Error: InvalidParameterException"
```bash
# Solution: Check parameter format
terraform validate
terraform fmt

# Review specific parameter
grep -r "parameter_name" .
```

**Issue**: "Insufficient ECS capacity"
```bash
# Solution: Request quota increase
aws service-quotas request-service-quota-increase \
    --service-code ecs \
    --quota-code L-xxxxxxxx \
    --desired-value 100
```

### Debug Mode

```bash
# Enable detailed logging
export TF_LOG=DEBUG
export TF_LOG_PATH=./terraform.log

# Run terraform command
terraform apply -var-file=terraform.tfvars

# Review log
cat terraform.log
```

### State Issues

```bash
# View current state
terraform state list

# Show specific resource
terraform state show module.database.aws_db_instance.main

# Pull state file (for backup)
terraform state pull > terraform.tfstate.backup

# Import existing resource
terraform import module.vpc.aws_vpc.main vpc-xxxxx
```

---

## üìñ Next Steps

After successful deployment:

1. **Configure DNS**
   - Point your domain to the ALB
   - Verify SSL certificate

2. **Set Up Monitoring**
   - Create CloudWatch dashboards
   - Configure alerts
   - Set up PagerDuty integration

3. **Implement CI/CD**
   - Connect GitHub Actions
   - Automate deployments
   - Set up automated testing

4. **Security Hardening**
   - Review IAM permissions
   - Enable GuardDuty
   - Configure AWS WAF
   - Set up CloudTrail

5. **Cost Optimization**
   - Enable Cost Explorer
   - Set up billing alerts
   - Review Reserved Instance options

6. **Backup & DR**
   - Test backup restoration
   - Document DR procedures
   - Schedule regular DR drills

---

## üìö Additional Resources

- [Terraform AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [AWS ECS Documentation](https://docs.aws.amazon.com/ecs/)
- [Terraform Best Practices](https://www.terraform-best-practices.com/)
- [AWS Well-Architected](https://aws.amazon.com/architecture/well-architected/)

---

## üÜò Get Help

- Email: devops@yourcompany.com
- Slack: #infrastructure
- On-call: PagerDuty

---

**Happy Deploying! üöÄ**
