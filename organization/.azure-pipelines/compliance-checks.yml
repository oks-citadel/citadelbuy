# Compliance Checks Pipeline
# Validates GDPR, POPIA, PDPA, and other regulatory compliance

name: Compliance-Checks-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
      - release/*
  paths:
    include:
      - organization/apps/**
      - organization/infrastructure/**

schedules:
  - cron: "0 2 * * *"  # Daily at 2 AM
    displayName: Daily Compliance Scan
    branches:
      include:
        - main
    always: true

variables:
  - group: compliance-vars
  - name: vmImageName
    value: 'ubuntu-latest'

stages:
  # Stage 1: Data Privacy Compliance
  - stage: DataPrivacyCompliance
    displayName: 'Data Privacy Compliance Checks'
    jobs:
      - job: GDPRCompliance
        displayName: 'GDPR Compliance (EU)'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Check Data Retention Policies'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking GDPR data retention policies..."

                # Check database retention settings
                python3 <<EOF
                import json

                # Load data residency rules
                with open('organization/infrastructure/kubernetes/global/data-residency-policies.yaml', 'r') as f:
                    content = f.read()
                    if 'retentionMaxDays: 2555' not in content:
                        print("ERROR: GDPR retention period not set correctly")
                        exit(1)
                    print("GDPR retention policies validated")
                EOF

          - task: Bash@3
            displayName: 'Verify Right to be Forgotten Implementation'
            inputs:
              targetType: 'inline'
              script: |
                echo "Verifying GDPR Right to be Forgotten..."

                # Check if data deletion endpoints exist
                files_to_check=(
                  "organization/apps/api/src/modules/users/data-deletion.service.ts"
                  "organization/apps/api/src/modules/privacy/privacy.service.ts"
                )

                for file in "${files_to_check[@]}"; do
                  if [ ! -f "$file" ]; then
                    echo "ERROR: Required file for GDPR compliance not found: $file"
                    exit 1
                  fi
                done

                echo "GDPR Right to be Forgotten implementation verified"

          - task: Bash@3
            displayName: 'Check Data Export Capabilities'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking GDPR data portability..."

                if [ ! -f "organization/apps/api/src/modules/users/data-export.service.ts" ]; then
                  echo "ERROR: Data export service not found"
                  exit 1
                fi

                echo "GDPR data portability implementation verified"

      - job: POPIACompliance
        displayName: 'POPIA Compliance (South Africa)'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Verify South Africa Data Residency'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking POPIA data residency..."

                # Verify Africa region configuration
                if [ ! -f "organization/infrastructure/terraform/environments/africa/main.tf" ]; then
                  echo "ERROR: Africa region infrastructure not configured"
                  exit 1
                fi

                # Check data residency settings
                grep -q "southafricanorth" organization/infrastructure/terraform/environments/africa/main.tf
                if [ $? -ne 0 ]; then
                  echo "ERROR: South Africa region not configured"
                  exit 1
                fi

                echo "POPIA data residency verified"

          - task: Bash@3
            displayName: 'Check POPIA Consent Management'
            inputs:
              targetType: 'inline'
              script: |
                echo "Verifying POPIA consent mechanisms..."

                # Check for consent tracking
                grep -r "consent" organization/apps/api/src/modules/users/ > /dev/null
                if [ $? -ne 0 ]; then
                  echo "WARNING: Consent tracking may not be fully implemented"
                fi

                echo "POPIA consent management checked"

      - job: PDPACompliance
        displayName: 'PDPA Compliance (Singapore)'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Verify Singapore Data Residency'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking PDPA data residency..."

                # Verify Asia region configuration
                if [ ! -f "organization/infrastructure/terraform/environments/asia/main.tf" ]; then
                  echo "ERROR: Asia region infrastructure not configured"
                  exit 1
                fi

                # Check data residency settings
                grep -q "southeastasia" organization/infrastructure/terraform/environments/asia/main.tf
                if [ $? -ne 0 ]; then
                  echo "ERROR: Singapore region not configured"
                  exit 1
                fi

                echo "PDPA data residency verified"

  # Stage 2: Security Compliance
  - stage: SecurityCompliance
    displayName: 'Security Compliance Checks'
    jobs:
      - job: EncryptionCompliance
        displayName: 'Encryption Compliance'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Verify Data Encryption at Rest'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking encryption at rest..."

                # Check Terraform configurations for encryption
                files=$(find organization/infrastructure/terraform -name "*.tf")

                for file in $files; do
                  if grep -q "storage_account" "$file"; then
                    if ! grep -q "enable_blob_encryption.*true" "$file"; then
                      echo "WARNING: Encryption may not be enabled in $file"
                    fi
                  fi
                done

                echo "Encryption at rest verified"

          - task: Bash@3
            displayName: 'Verify TLS Configuration'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking TLS/SSL configuration..."

                # Check ingress configurations
                find organization/infrastructure/kubernetes -name "*.yaml" -exec grep -l "tls:" {} \; > /dev/null
                if [ $? -ne 0 ]; then
                  echo "WARNING: TLS configuration may be missing"
                fi

                echo "TLS configuration verified"

      - job: AccessControlCompliance
        displayName: 'Access Control Compliance'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Verify RBAC Implementation'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking RBAC policies..."

                # Check for RBAC configurations
                if [ ! -f "organization/infrastructure/kubernetes/base/rbac.yaml" ]; then
                  echo "ERROR: RBAC configuration not found"
                  exit 1
                fi

                echo "RBAC implementation verified"

          - task: Bash@3
            displayName: 'Check Secrets Management'
            inputs:
              targetType: 'inline'
              script: |
                echo "Verifying secrets management..."

                # Check for hardcoded secrets
                echo "Scanning for hardcoded secrets..."

                # Install gitleaks if not present
                if ! command -v gitleaks &> /dev/null; then
                  wget -O gitleaks.tar.gz https://github.com/zricethezav/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
                  tar -xzf gitleaks.tar.gz
                  chmod +x gitleaks
                  ./gitleaks detect --source=. --no-git --verbose
                else
                  gitleaks detect --source=. --no-git --verbose
                fi

  # Stage 3: Data Residency Validation
  - stage: DataResidencyValidation
    displayName: 'Data Residency Validation'
    jobs:
      - job: RegionalDataCheck
        displayName: 'Regional Data Boundaries'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: AzureCLI@2
            displayName: 'Verify Resource Locations'
            inputs:
              azureSubscription: 'citadelbuy-production'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Checking resource locations for compliance..."

                # Check EU resources are in EU
                eu_resources=$(az resource list --tag data-region=europe --query "[].location" -o tsv)
                for location in $eu_resources; do
                  if [[ ! "$location" =~ ^(westeurope|northeurope|francecentral|germanywestcentral)$ ]]; then
                    echo "ERROR: EU resource found in non-EU location: $location"
                    exit 1
                  fi
                done

                # Check Africa resources
                africa_resources=$(az resource list --tag data-region=africa --query "[].location" -o tsv)
                for location in $africa_resources; do
                  if [[ ! "$location" =~ ^(southafricanorth|southafricawest)$ ]]; then
                    echo "ERROR: Africa resource found in incorrect location: $location"
                    exit 1
                  fi
                done

                echo "Data residency validation passed"

  # Stage 4: Audit Logging Compliance
  - stage: AuditLoggingCompliance
    displayName: 'Audit Logging Compliance'
    jobs:
      - job: LoggingVerification
        displayName: 'Verify Audit Logging'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Check Audit Log Configuration'
            inputs:
              targetType: 'inline'
              script: |
                echo "Verifying audit logging configuration..."

                # Check for audit policies
                if [ ! -f "organization/infrastructure/kubernetes/global/data-residency-policies.yaml" ]; then
                  echo "ERROR: Audit policies not found"
                  exit 1
                fi

                # Verify audit policy content
                grep -q "audit.k8s.io/v1" organization/infrastructure/kubernetes/global/data-residency-policies.yaml
                if [ $? -ne 0 ]; then
                  echo "ERROR: Kubernetes audit policy not configured"
                  exit 1
                fi

                echo "Audit logging verified"

          - task: AzureCLI@2
            displayName: 'Verify Azure Diagnostic Settings'
            inputs:
              azureSubscription: 'citadelbuy-production'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Checking Azure diagnostic settings..."

                # Check diagnostic settings for key resources
                resource_groups=("citadelbuy-prod-us-east-rg" "citadelbuy-prod-eu-west-rg" "citadelbuy-prod-africa-primary-rg")

                for rg in "${resource_groups[@]}"; do
                  echo "Checking $rg..."
                  resources=$(az resource list -g $rg --query "[?type=='Microsoft.DBforPostgreSQL/flexibleServers' || type=='Microsoft.Storage/storageAccounts'].id" -o tsv)

                  for resource in $resources; do
                    diagnostics=$(az monitor diagnostic-settings list --resource $resource --query "value[].name" -o tsv)
                    if [ -z "$diagnostics" ]; then
                      echo "WARNING: No diagnostic settings for $resource"
                    fi
                  done
                done

  # Stage 5: Cross-Border Data Transfer Compliance
  - stage: CrossBorderCompliance
    displayName: 'Cross-Border Transfer Compliance'
    jobs:
      - job: DataTransferValidation
        displayName: 'Validate Data Transfer Mechanisms'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Check Standard Contractual Clauses'
            inputs:
              targetType: 'inline'
              script: |
                echo "Validating cross-border data transfer policies..."

                # Check for cross-border policy configuration
                grep -q "cross-border-policy" organization/infrastructure/kubernetes/global/data-residency-policies.yaml
                if [ $? -ne 0 ]; then
                  echo "ERROR: Cross-border data transfer policy not found"
                  exit 1
                fi

                # Verify encryption for cross-border transfers
                grep -q "encryptionRequired.*true" organization/infrastructure/kubernetes/global/data-residency-policies.yaml
                if [ $? -ne 0 ]; then
                  echo "ERROR: Encryption not required for cross-border transfers"
                  exit 1
                fi

                echo "Cross-border transfer compliance verified"

  # Stage 6: Compliance Reporting
  - stage: ComplianceReporting
    displayName: 'Generate Compliance Report'
    dependsOn:
      - DataPrivacyCompliance
      - SecurityCompliance
      - DataResidencyValidation
      - AuditLoggingCompliance
      - CrossBorderCompliance
    condition: always()
    jobs:
      - job: GenerateReport
        displayName: 'Generate Compliance Report'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Create Compliance Summary'
            inputs:
              targetType: 'inline'
              script: |
                cat > compliance-report.md <<EOF
                # CitadelBuy Compliance Report

                **Date:** $(date)
                **Build:** $(Build.BuildNumber)

                ## Summary

                This report summarizes compliance with various data protection regulations.

                ### Regulations Covered
                - GDPR (General Data Protection Regulation - EU)
                - POPIA (Protection of Personal Information Act - South Africa)
                - PDPA (Personal Data Protection Act - Singapore)
                - APPI (Act on Protection of Personal Information - Japan)
                - CCPA (California Consumer Privacy Act - US)

                ### Data Residency

                - **Europe:** West Europe, North Europe
                - **Africa:** South Africa North
                - **Asia:** Southeast Asia (Singapore), Japan East (Tokyo), Australia East (Sydney)
                - **Americas:** US East, US West

                ### Compliance Status

                All compliance checks have been executed. Review individual stage results for details.

                ### Data Protection Measures

                - Encryption at rest: Enabled
                - Encryption in transit: TLS 1.2+
                - Access controls: RBAC implemented
                - Audit logging: Enabled across all regions
                - Data retention: Configured per regulation
                - Right to be forgotten: Implemented
                - Data portability: Implemented

                ### Next Steps

                Regular compliance audits are scheduled daily at 2 AM UTC.
                EOF

                cat compliance-report.md

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Compliance Report'
            inputs:
              PathtoPublish: 'compliance-report.md'
              ArtifactName: 'compliance-report'
              publishLocation: 'Container'
