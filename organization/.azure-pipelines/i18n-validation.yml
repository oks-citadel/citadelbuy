# Internationalization (i18n) Validation Pipeline
# Validates translations and locale configurations for global deployment

name: i18n-Validation-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
      - release/*
  paths:
    include:
      - organization/apps/**/locales/**
      - organization/apps/**/i18n/**
      - organization/apps/**/translations/**

pr:
  branches:
    include:
      - main
  paths:
    include:
      - organization/apps/**/locales/**
      - organization/apps/**/i18n/**
      - organization/apps/**/translations/**

variables:
  - group: i18n-vars
  - name: vmImageName
    value: 'ubuntu-latest'
  - name: supportedLanguages
    value: 'en,es,fr,de,pt,ar,zh,ja,ko,hi,sw'  # English, Spanish, French, German, Portuguese, Arabic, Chinese, Japanese, Korean, Hindi, Swahili

stages:
  # Stage 1: Translation Completeness Check
  - stage: TranslationCompleteness
    displayName: 'Translation Completeness Check'
    jobs:
      - job: CheckTranslations
        displayName: 'Validate Translation Files'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - task: Bash@3
            displayName: 'Check Translation File Structure'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking translation file structure..."

                # Check if translation directories exist
                translation_dirs=(
                  "organization/apps/web/locales"
                  "organization/apps/api/locales"
                )

                for dir in "${translation_dirs[@]}"; do
                  if [ ! -d "$dir" ]; then
                    echo "Creating translation directory: $dir"
                    mkdir -p "$dir"
                  fi
                done

                echo "Translation directory structure validated"

          - task: Bash@3
            displayName: 'Validate Translation Completeness'
            inputs:
              targetType: 'inline'
              script: |
                #!/bin/bash
                set -e

                echo "Validating translation completeness..."

                # Function to count keys in JSON file
                count_keys() {
                  jq -r 'paths(scalars) | join(".")' "$1" | wc -l
                }

                # Languages to validate
                IFS=',' read -ra LANGUAGES <<< "$(supportedLanguages)"
                base_lang="en"

                # Find all translation directories
                translation_dirs=$(find organization/apps -type d -name "locales" -o -name "i18n")

                for trans_dir in $translation_dirs; do
                  echo "Checking translations in: $trans_dir"

                  # Check if base language exists
                  base_file="$trans_dir/$base_lang.json"
                  if [ ! -f "$base_file" ]; then
                    echo "WARNING: Base translation file not found: $base_file"
                    continue
                  fi

                  base_count=$(count_keys "$base_file")
                  echo "Base language ($base_lang) has $base_count keys"

                  # Check each language
                  for lang in "${LANGUAGES[@]}"; do
                    if [ "$lang" == "$base_lang" ]; then
                      continue
                    fi

                    lang_file="$trans_dir/$lang.json"
                    if [ ! -f "$lang_file" ]; then
                      echo "WARNING: Translation file missing for language: $lang in $trans_dir"
                      continue
                    fi

                    lang_count=$(count_keys "$lang_file")
                    coverage=$((lang_count * 100 / base_count))

                    echo "Language: $lang - Coverage: $coverage% ($lang_count/$base_count keys)"

                    if [ $coverage -lt 80 ]; then
                      echo "WARNING: Translation coverage below 80% for $lang"
                    fi
                  done
                done

          - task: Bash@3
            displayName: 'Check for Missing Translation Keys'
            inputs:
              targetType: 'inline'
              script: |
                #!/bin/bash

                echo "Checking for missing translation keys..."

                # Install i18n-unused (if using npm-based i18n)
                npm install -g i18next-scanner

                # Scan for used translation keys in code
                echo "Scanning code for translation key usage..."

                # Create scanner configuration
                cat > i18next-scanner.config.js <<EOF
                module.exports = {
                  input: [
                    'organization/apps/web/src/**/*.{ts,tsx,js,jsx}',
                    'organization/apps/api/src/**/*.{ts,js}',
                  ],
                  output: './scanned-translations',
                  options: {
                    debug: true,
                    removeUnusedKeys: false,
                    sort: true,
                    func: {
                      list: ['t', 'i18n.t', 'i18next.t'],
                      extensions: ['.ts', '.tsx', '.js', '.jsx']
                    },
                    lngs: ['en'],
                    defaultLng: 'en',
                    defaultNs: 'translation',
                    resource: {
                      loadPath: 'organization/apps/{{ns}}/locales/{{lng}}.json',
                      savePath: '{{lng}}.json'
                    }
                  }
                };
                EOF

                # Run scanner (if translation files exist)
                if [ -d "organization/apps/web/locales" ]; then
                  i18next-scanner --config i18next-scanner.config.js || echo "Scanner completed with warnings"
                fi

  # Stage 2: Translation Quality Checks
  - stage: TranslationQuality
    displayName: 'Translation Quality Checks'
    dependsOn: TranslationCompleteness
    jobs:
      - job: ValidateJSONFormat
        displayName: 'Validate JSON Format'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Validate JSON Syntax'
            inputs:
              targetType: 'inline'
              script: |
                echo "Validating JSON syntax in translation files..."

                # Find all JSON files in locale directories
                json_files=$(find organization/apps -path "*/locales/*.json" -o -path "*/i18n/*.json")

                error_count=0
                for file in $json_files; do
                  echo "Checking: $file"
                  if ! jq empty "$file" 2>/dev/null; then
                    echo "ERROR: Invalid JSON in $file"
                    error_count=$((error_count + 1))
                  fi
                done

                if [ $error_count -gt 0 ]; then
                  echo "Found $error_count files with JSON errors"
                  exit 1
                fi

                echo "All translation files have valid JSON syntax"

      - job: CheckDuplicateKeys
        displayName: 'Check for Duplicate Keys'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Detect Duplicate Translation Keys'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking for duplicate translation keys..."

                json_files=$(find organization/apps -path "*/locales/*.json" -o -path "*/i18n/*.json")

                for file in $json_files; do
                  echo "Checking: $file"

                  # Check for duplicate keys
                  duplicates=$(jq -r 'paths(scalars) as $p | "\($p | join("."))"' "$file" | sort | uniq -d)

                  if [ -n "$duplicates" ]; then
                    echo "WARNING: Duplicate keys found in $file:"
                    echo "$duplicates"
                  fi
                done

      - job: CheckPlaceholders
        displayName: 'Validate Placeholders'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Verify Placeholder Consistency'
            inputs:
              targetType: 'inline'
              script: |
                #!/bin/bash

                echo "Checking placeholder consistency across translations..."

                # Function to extract placeholders from a string
                extract_placeholders() {
                  grep -oP '\{\{[^}]+\}\}|\{[^}]+\}' <<< "$1" | sort
                }

                # Find translation directories
                translation_dirs=$(find organization/apps -type d -name "locales" -o -name "i18n")

                for trans_dir in $translation_dirs; do
                  base_file="$trans_dir/en.json"
                  if [ ! -f "$base_file" ]; then
                    continue
                  fi

                  # Get all keys and their values from base language
                  jq -r 'paths(scalars) as $p | "\($p | join("."))\t\(.[$p | .[-1]])"' "$base_file" | while IFS=$'\t' read -r key value; do
                    base_placeholders=$(extract_placeholders "$value")

                    # Check placeholders in all other languages
                    for lang_file in "$trans_dir"/*.json; do
                      if [ "$lang_file" == "$base_file" ]; then
                        continue
                      fi

                      lang=$(basename "$lang_file" .json)
                      lang_value=$(jq -r ".\"$key\" // empty" "$lang_file")

                      if [ -z "$lang_value" ]; then
                        continue
                      fi

                      lang_placeholders=$(extract_placeholders "$lang_value")

                      if [ "$base_placeholders" != "$lang_placeholders" ]; then
                        echo "WARNING: Placeholder mismatch in $lang for key: $key"
                        echo "  Base: $base_placeholders"
                        echo "  $lang: $lang_placeholders"
                      fi
                    done
                  done
                done

  # Stage 3: Locale Configuration Validation
  - stage: LocaleConfiguration
    displayName: 'Locale Configuration Validation'
    dependsOn: TranslationQuality
    jobs:
      - job: ValidateDateTimeFormats
        displayName: 'Validate Date/Time Formats'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Check Date/Time Localization'
            inputs:
              targetType: 'inline'
              script: |
                echo "Validating date/time format configurations..."

                # Check for locale-specific date/time format files
                format_files=$(find organization/apps -name "*format*.ts" -o -name "*format*.js")

                if [ -z "$format_files" ]; then
                  echo "WARNING: No date/time format configuration files found"
                else
                  echo "Found date/time format files:"
                  echo "$format_files"
                fi

      - job: ValidateCurrencyFormats
        displayName: 'Validate Currency Formats'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Check Currency Localization'
            inputs:
              targetType: 'inline'
              script: |
                echo "Validating currency format configurations..."

                # Check for currency configuration
                currency_files=$(find organization/apps -name "*currency*.ts" -o -name "*currency*.js")

                if [ -z "$currency_files" ]; then
                  echo "WARNING: No currency format configuration files found"
                else
                  echo "Found currency format files:"
                  echo "$currency_files"
                fi

      - job: ValidateNumberFormats
        displayName: 'Validate Number Formats'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Check Number Localization'
            inputs:
              targetType: 'inline'
              script: |
                echo "Validating number format configurations..."

                # Regional number formats vary (e.g., 1,000.00 vs 1.000,00)
                echo "Reminder: Verify number formatting for all supported locales"

  # Stage 4: RTL (Right-to-Left) Language Support
  - stage: RTLSupport
    displayName: 'RTL Language Support'
    dependsOn: LocaleConfiguration
    jobs:
      - job: CheckRTLImplementation
        displayName: 'Validate RTL Implementation'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Check RTL CSS Support'
            inputs:
              targetType: 'inline'
              script: |
                echo "Checking RTL language support (Arabic, Hebrew)..."

                # Check for RTL CSS or style configurations
                rtl_files=$(find organization/apps/web -name "*rtl*" -o -name "*arabic*")

                if [ -z "$rtl_files" ]; then
                  echo "WARNING: No RTL-specific styling found. Ensure RTL languages are supported."
                else
                  echo "Found RTL-related files:"
                  echo "$rtl_files"
                fi

                # Check for dir attribute usage
                grep -r 'dir="rtl"' organization/apps/web/src || echo "Note: Consider dynamic dir attribute for RTL support"

  # Stage 5: Translation Report
  - stage: TranslationReport
    displayName: 'Generate Translation Report'
    dependsOn:
      - TranslationCompleteness
      - TranslationQuality
      - LocaleConfiguration
      - RTLSupport
    condition: always()
    jobs:
      - job: GenerateReport
        displayName: 'Generate i18n Report'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Bash@3
            displayName: 'Create Translation Summary'
            inputs:
              targetType: 'inline'
              script: |
                cat > i18n-report.md <<EOF
                # CitadelBuy Internationalization Report

                **Date:** $(date)
                **Build:** $(Build.BuildNumber)

                ## Supported Languages

                - English (en) - Base language
                - Spanish (es)
                - French (fr)
                - German (de)
                - Portuguese (pt)
                - Arabic (ar) - RTL
                - Chinese (zh)
                - Japanese (ja)
                - Korean (ko)
                - Hindi (hi)
                - Swahili (sw)

                ## Regional Focus

                ### Americas
                - English (US, CA)
                - Spanish (MX, BR, AR)
                - Portuguese (BR)

                ### Europe
                - English (UK)
                - French (FR)
                - German (DE)
                - Spanish (ES)

                ### Africa
                - English (ZA, NG, KE)
                - French (West Africa)
                - Swahili (East Africa)
                - Arabic (North Africa)

                ### Asia-Pacific
                - English (SG, AU)
                - Chinese (CN, SG)
                - Japanese (JP)
                - Korean (KR)
                - Hindi (IN)

                ## Translation Coverage

                All translation files have been validated for:
                - JSON syntax correctness
                - Key completeness
                - Placeholder consistency
                - Duplicate key detection

                ## Recommendations

                1. Maintain at least 80% translation coverage for all supported languages
                2. Implement automated translation testing
                3. Regular reviews by native speakers
                4. Test RTL layouts for Arabic
                5. Validate currency and date formats per region

                EOF

                cat i18n-report.md

          - task: PublishBuildArtifacts@1
            displayName: 'Publish i18n Report'
            inputs:
              PathtoPublish: 'i18n-report.md'
              ArtifactName: 'i18n-report'
              publishLocation: 'Container'
