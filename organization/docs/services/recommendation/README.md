# Recommendation Service

## Overview

The Recommendation Service is CitadelBuy's AI-powered product recommendation engine that delivers personalized shopping experiences. It uses collaborative filtering, content-based filtering, and hybrid approaches to suggest relevant products, increase engagement, and boost conversions.

## Key Features

### Personalized Recommendations
- **User-based Recommendations**: Personalized suggestions based on browsing and purchase history
- **Product-based Recommendations**: Similar product suggestions for cross-selling
- **Hybrid Strategy**: Combines collaborative and content-based approaches
- **Real-time Personalization**: Dynamic recommendations based on current session

### Recommendation Strategies
- **Collaborative Filtering**: Recommendations based on similar user behavior
- **Content-based Filtering**: Suggestions based on product attributes and metadata
- **Hybrid Filtering**: Intelligent combination of multiple algorithms
- **Cold Start Handling**: Smart recommendations for new users and products

### Discovery Features
- **Trending Products**: Real-time trending items by category
- **Similar Products**: Find visually and functionally similar items
- **Personalized Feed**: Custom homepage feed for each user
- **Category Exploration**: Discover products in related categories

### Business Intelligence
- **A/B Testing**: Test different recommendation strategies
- **Performance Metrics**: Track CTR, conversion, and engagement
- **User Segmentation**: Targeted recommendations by user segment
- **Revenue Attribution**: Track revenue generated by recommendations

## Environment Variables

```bash
# Service Configuration
LOG_LEVEL=INFO
PORT=8001

# Database (PostgreSQL)
DATABASE_URL=postgresql://user:password@localhost:5432/citadelbuy

# Redis Cache
REDIS_URL=redis://localhost:6379/2
REDIS_PASSWORD=your_redis_password
CACHE_TTL=3600

# Machine Learning
MODEL_PATH=/app/models
MODEL_VERSION=v2.0.0
MIN_SIMILARITY_SCORE=0.5

# Algorithm Configuration
DEFAULT_STRATEGY=hybrid
COLLABORATIVE_WEIGHT=0.6
CONTENT_WEIGHT=0.4
TRENDING_WINDOW_HOURS=24

# Performance
MAX_RECOMMENDATIONS=50
DEFAULT_LIMIT=10
BATCH_SIZE=100

# Feature Flags
ENABLE_COLLABORATIVE_FILTERING=true
ENABLE_CONTENT_FILTERING=true
ENABLE_TRENDING_ANALYSIS=true
ENABLE_COLD_START_HANDLING=true

# Analytics
TRACK_IMPRESSIONS=true
TRACK_CLICKS=true
TRACK_CONVERSIONS=true
```

## API Endpoints

### Core Recommendations
- `POST /recommend` - Get personalized recommendations for a user
- `POST /similar-products` - Find similar products
- `POST /trending` - Get trending products
- `POST /personalized-feed` - Get personalized homepage feed

### Discovery
- `GET /new-arrivals` - Get new products
- `GET /bestsellers` - Get best-selling products
- `GET /category/{category}/recommendations` - Category-specific recommendations

### Analytics
- `POST /track/impression` - Track recommendation impression
- `POST /track/click` - Track recommendation click
- `POST /track/conversion` - Track recommendation conversion

### Health & Monitoring
- `GET /health` - Service health check
- `GET /metrics` - Prometheus metrics
- `GET /model/info` - Model information and version

## Dependencies

### Core Framework
- FastAPI 0.109.0 - Async web framework
- Uvicorn 0.27.0 - ASGI server
- Pydantic 2.5.3 - Data validation

### Database & Caching
- SQLAlchemy 2.0.25 - ORM
- AsyncPG 0.29.0 - PostgreSQL driver
- Redis 5.0.1 - Caching layer
- Hiredis 2.3.2 - High-performance Redis

### Machine Learning
- NumPy 1.26.3 - Numerical computing
- Pandas 2.1.4 - Data manipulation
- Scikit-learn 1.4.0 - ML algorithms
- SciPy 1.11.4 - Scientific computing

### Utilities
- Python-dotenv 1.0.0 - Environment management
- HTTPX 0.26.0 - HTTP client
- PyJWT 2.8.0 - JWT tokens

## Local Development Setup

### Prerequisites
- Python 3.11+
- PostgreSQL 14+
- Redis 7+

### Installation

```bash
# Navigate to service directory
cd organization/apps/services/recommendation

# Create virtual environment
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Set up environment variables
cp .env.example .env
# Edit .env with your configuration

# Initialize database
python scripts/init_db.py

# Build initial recommendation models
python scripts/build_models.py

# Start the service
uvicorn src.api:app --reload --port 8001
```

### Development Workflow

```bash
# Run with auto-reload
uvicorn src.api:app --reload --port 8001

# Run tests
pytest tests/ -v

# Run with coverage
pytest tests/ --cov=src --cov-report=html

# Lint code
flake8 src/
pylint src/

# Format code
black src/
isort src/
```

## Docker Usage

### Build Image

```bash
# Build the Docker image
docker build -t citadelbuy/recommendation:latest .

# Build with specific version
docker build -t citadelbuy/recommendation:v2.0.0 .
```

### Run Container

```bash
# Run standalone
docker run -d \
  --name recommendation \
  -p 8001:8001 \
  --env-file .env \
  -v $(pwd)/models:/app/models \
  citadelbuy/recommendation:latest

# Run with Docker Compose
docker-compose up recommendation

# View logs
docker logs -f recommendation

# Shell access
docker exec -it recommendation bash
```

### Docker Compose Example

```yaml
services:
  recommendation:
    build: ./organization/apps/services/recommendation
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/citadelbuy
      - REDIS_URL=redis://redis:6379/2
      - MODEL_PATH=/app/models
    depends_on:
      - db
      - redis
    volumes:
      - ./models:/app/models
      - ./data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

## Testing Instructions

### Unit Tests

```bash
# Run all unit tests
pytest tests/unit/ -v

# Test specific algorithm
pytest tests/unit/test_collaborative_filter.py -v

# Test with markers
pytest -m "not slow" -v
```

### Integration Tests

```bash
# Run integration tests
pytest tests/integration/ -v

# Test with live services
docker-compose up -d
pytest tests/integration/ --live
```

### Algorithm Tests

```bash
# Test recommendation quality
pytest tests/algorithms/test_quality.py

# Test performance
pytest tests/algorithms/test_performance.py

# Benchmark algorithms
python tests/benchmark/benchmark_algorithms.py
```

### A/B Testing

```bash
# Create A/B test
python scripts/create_ab_test.py --name "hybrid_vs_collaborative"

# Monitor A/B test
python scripts/monitor_ab_test.py --test-id test_123

# Analyze results
python scripts/analyze_ab_test.py --test-id test_123
```

## Recommendation Algorithms

### Collaborative Filtering

```python
# User-based collaborative filtering
from algorithms.collaborative import CollaborativeFilter

cf = CollaborativeFilter()
recommendations = cf.recommend(user_id="user_123", limit=10)
```

### Content-based Filtering

```python
# Content-based recommendations
from algorithms.content_based import ContentBasedFilter

cbf = ContentBasedFilter()
similar = cbf.find_similar(product_id="prod_456", limit=10)
```

### Hybrid Approach

```python
# Hybrid recommendations
from algorithms.hybrid import HybridRecommender

hybrid = HybridRecommender()
recommendations = hybrid.recommend(
    user_id="user_123",
    strategy="hybrid",
    limit=10
)
```

## Model Training

### Build Recommendation Models

```bash
# Build collaborative filtering model
python src/algorithms/train_collaborative.py

# Build content-based model
python src/algorithms/train_content_based.py

# Build hybrid model
python src/algorithms/train_hybrid.py
```

### Scheduled Training

```bash
# Daily model updates (add to cron)
0 2 * * * cd /app && python scripts/daily_model_update.py

# Weekly full rebuild
0 3 * * 0 cd /app && python scripts/weekly_model_rebuild.py
```

### Model Evaluation

```bash
# Evaluate model performance
python scripts/evaluate_model.py

# A/B test new model
python scripts/ab_test_model.py --old-version v2.0.0 --new-version v2.1.0

# Compare algorithms
python scripts/compare_algorithms.py
```

## Performance Optimization

### Caching Strategy

```python
# Cache recommendations for 1 hour
@cache(ttl=3600)
def get_recommendations(user_id: str):
    return recommender.recommend(user_id)
```

### Batch Processing

```bash
# Pre-compute recommendations for active users
python scripts/precompute_recommendations.py --batch-size 1000

# Cache trending products
python scripts/cache_trending.py
```

### Database Optimization

```sql
-- Create indexes for fast lookups
CREATE INDEX idx_user_interactions ON user_interactions(user_id, created_at);
CREATE INDEX idx_product_category ON products(category);
CREATE INDEX idx_similar_products ON product_similarities(product_id, similarity_score);
```

## API Usage Examples

### Get Personalized Recommendations

```bash
curl -X POST http://localhost:8001/recommend \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user_123",
    "limit": 10,
    "strategy": "hybrid"
  }'
```

### Find Similar Products

```bash
curl -X POST http://localhost:8001/similar-products?product_id=prod_456&limit=10
```

### Get Trending Products

```bash
curl -X POST http://localhost:8001/trending?category=electronics&limit=20
```

## Monitoring & Analytics

### Key Metrics

- **Click-Through Rate (CTR)**: Percentage of clicked recommendations
- **Conversion Rate**: Percentage of purchased recommended products
- **Average Order Value (AOV)**: Revenue per recommendation
- **Coverage**: Percentage of catalog being recommended
- **Diversity**: Variety in recommendations

### Prometheus Metrics

```
# Total recommendations served
recommendations_total{strategy="hybrid"} 150000

# Recommendation latency
recommendation_duration_seconds{quantile="0.95"} 0.15

# Model quality
recommendation_accuracy{model="v2.0.0"} 0.87
```

### Dashboards

Access monitoring dashboards:
- Grafana: http://localhost:3000/d/recommendations
- Analytics: http://localhost:8001/admin/analytics

## Architecture

```
recommendation/
├── src/
│   ├── algorithms/            # Recommendation algorithms
│   │   ├── collaborative.py
│   │   ├── content_based.py
│   │   ├── hybrid.py
│   │   └── trending.py
│   ├── strategies/            # Strategy implementations
│   ├── evaluation/            # Model evaluation
│   ├── api/                   # API routers
│   └── utils/                 # Utilities
├── data/                      # Training data
├── models/                    # Trained models
├── notebooks/                 # Analysis notebooks
├── tests/                     # Test suite
├── scripts/                   # Utility scripts
└── Dockerfile                 # Container definition
```

## Best Practices

### Recommendation Quality
1. Regularly retrain models with fresh data
2. A/B test algorithm changes
3. Monitor diversity and novelty metrics
4. Handle cold start scenarios gracefully

### Performance
1. Cache frequently accessed recommendations
2. Pre-compute recommendations for active users
3. Use batch processing for model updates
4. Implement pagination for large result sets

### Privacy
1. Anonymize user interaction data
2. Respect user privacy preferences
3. Allow users to clear recommendation history
4. GDPR compliance for data storage

## Troubleshooting

### Common Issues

**Poor Recommendation Quality**
- Retrain model with more recent data
- Adjust collaborative/content weights
- Check data quality and coverage
- Review user interaction data

**Slow Response Time**
- Enable Redis caching
- Pre-compute recommendations
- Optimize database queries
- Reduce model complexity

**Cold Start Problems**
- Implement popularity-based fallback
- Use content-based for new products
- Gather more user signals
- Hybrid approach with trending items

## API Documentation

Interactive API documentation:
- Swagger UI: http://localhost:8001/docs
- ReDoc: http://localhost:8001/redoc

## Contributing

See [Contributing Guide](../../../CONTRIBUTING.md) for development guidelines.

## License

Proprietary - CitadelBuy Platform

## Support

For issues and questions:
- Internal Slack: #recommendation-support
- Email: dev@citadelbuy.com
