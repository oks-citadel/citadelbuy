# Broxiva Internationalization (i18n) Guide

## Overview

Broxiva uses a comprehensive internationalization strategy built on Vercel Edge Middleware for optimal performance and SEO. This document covers the locale strategy, cookie/header reference, SEO implications, and how to add new locales.

## Architecture

```
+-------------------+     +------------------+     +------------------+
|  Edge Middleware  | --> |  Next.js App     | --> |  Client Context  |
+-------------------+     +------------------+     +------------------+
        |                         |                        |
        v                         v                        v
  - Tenant Resolution       - Server Components      - React Hooks
  - Geo Detection           - Dictionary Loading     - Locale Switcher
  - Language Detection      - Layout Setup           - Currency Switcher
  - Currency Inference      - SEO Headers            - Country Selector
```

## Supported Locales

| Locale  | Language            | Region           | Currency | Direction |
|---------|---------------------|------------------|----------|-----------|
| en-us   | English             | United States    | USD      | LTR       |
| en-gb   | English             | United Kingdom   | GBP      | LTR       |
| fr-fr   | French              | France           | EUR      | LTR       |
| fr-ca   | French              | Canada           | CAD      | LTR       |
| es-es   | Spanish             | Spain            | EUR      | LTR       |
| es-mx   | Spanish             | Mexico           | MXN      | LTR       |
| de-de   | German              | Germany          | EUR      | LTR       |
| pt-br   | Portuguese          | Brazil           | BRL      | LTR       |
| ar-ae   | Arabic              | UAE              | AED      | RTL       |
| zh-cn   | Chinese (Simplified)| China            | CNY      | LTR       |
| ja-jp   | Japanese            | Japan            | JPY      | LTR       |
| yo-ng   | Yoruba              | Nigeria          | NGN      | LTR       |
| ha-ng   | Hausa               | Nigeria          | NGN      | LTR       |

## URL Structure

All routes are prefixed with the locale code:

```
https://broxiva.com/en-us/products/shoes
https://broxiva.com/fr-fr/products/chaussures
https://broxiva.com/ar-ae/products/احذية
```

## Cookies

| Cookie Name  | Description                | Example Value | Max Age  |
|--------------|----------------------------|---------------|----------|
| bx_country   | User's country code        | US, NG, DE    | 1 year   |
| bx_lang      | User's preferred locale    | en-us, fr-ca  | 1 year   |
| bx_currency  | User's preferred currency  | USD, NGN, EUR | 1 year   |
| bx_tenant    | Current tenant ID          | broxiva       | 1 year   |

## Headers (Set by Middleware)

| Header Name      | Description                    | Example Value          |
|------------------|--------------------------------|------------------------|
| x-bx-tenant      | Resolved tenant ID             | broxiva                |
| x-bx-country     | Detected/selected country      | US                     |
| x-bx-language    | Current locale                 | en-us                  |
| x-bx-locale      | Current locale (alias)         | en-us                  |
| x-bx-currency    | Active currency                | USD                    |
| x-bx-direction   | Text direction (ltr/rtl)       | ltr                    |
| x-bx-trace-id    | Request trace ID               | bx-abc123-xyz789       |

## Detection Priority

### Language Detection
1. Cookie preference (`bx_lang`)
2. Accept-Language header
3. Country-based inference
4. Tenant default

### Currency Detection
1. Cookie preference (`bx_currency`)
2. Middleware header (`x-bx-currency`)
3. Country-based mapping
4. Tenant default

### Country Detection
1. Cookie preference (`bx_country`)
2. Vercel geo header (`x-vercel-ip-country`)
3. Cloudflare header (`cf-ipcountry`)
4. Default (US)

## SEO Implications

### Hreflang Tags

The layout automatically generates hreflang tags for all supported locales:

```html
<link rel="alternate" hreflang="en-US" href="https://broxiva.com/en-us/products" />
<link rel="alternate" hreflang="fr-FR" href="https://broxiva.com/fr-fr/products" />
<link rel="alternate" hreflang="x-default" href="https://broxiva.com/en-us/products" />
```

### Canonical URLs

Each locale has its own canonical URL:

```html
<link rel="canonical" href="https://broxiva.com/fr-fr/products/chaussures" />
```

### Meta Language

The HTML lang attribute is set dynamically:

```html
<html lang="en" dir="ltr">
<html lang="ar" dir="rtl">
```

### OpenGraph Locale

```html
<meta property="og:locale" content="en_US" />
<meta property="og:locale:alternate" content="fr_FR" />
```

## Adding a New Locale

### Step 1: Update Configuration

Edit `apps/web/src/lib/i18n-edge/config.ts`:

```typescript
export const SUPPORTED_LOCALES = [
  // ... existing locales
  'sw-ke', // Add new locale
] as const;

export const LOCALE_DEFINITIONS: Record<SupportedLocale, LocaleDefinition> = {
  // ... existing definitions
  'sw-ke': {
    code: 'sw-ke',
    language: 'sw',
    region: 'KE',
    name: 'Swahili (Kenya)',
    nativeName: 'Kiswahili (Kenya)',
    flag: 'ke',
    direction: 'ltr',
    dateFormat: 'DD/MM/YYYY',
    numberFormat: { decimal: '.', thousand: ',' },
    hreflang: 'sw-KE',
    enabled: true,
  },
};
```

### Step 2: Add Currency Mapping

Edit `apps/web/src/lib/i18n-edge/currency-map.ts` if needed:

```typescript
export const COUNTRY_CURRENCY_MAP: Record<string, string> = {
  // ... existing mappings
  KE: 'KES',
};
```

### Step 3: Create Dictionary

Create `apps/web/src/lib/i18n/locales/dictionaries/sw-ke.json`:

```json
{
  "meta": {
    "title": "Broxiva - Jukwaa la Biashara la AI",
    "description": "..."
  },
  "navigation": {
    "home": "Nyumbani",
    "shop": "Duka",
    ...
  }
}
```

### Step 4: Update Dictionary Loader

Edit `apps/web/src/lib/i18n-edge/dictionaries.ts`:

```typescript
const dictionaryLoaders: Record<SupportedLocale, () => Promise<Dictionary>> = {
  // ... existing loaders
  'sw-ke': () => import('../i18n/locales/dictionaries/sw-ke.json').then((m) => m.default),
};
```

### Step 5: Update Tenant Configuration (if needed)

If the locale should only be available for specific tenants, update `apps/web/src/lib/tenant/tenant-context.ts`:

```typescript
const TENANT_REGISTRY: Record<string, TenantConfig> = {
  'broxiva-ke': {
    id: 'broxiva-ke',
    name: 'Broxiva Kenya',
    domain: 'ke.broxiva.com',
    defaultLocale: 'sw-ke',
    supportedLocales: ['sw-ke', 'en-us'],
    defaultCurrency: 'KES',
  },
};
```

## Usage Examples

### Server Components

```typescript
import { getLocaleFromHeaders } from '@/lib/i18n-edge';
import { getDictionary } from '@/lib/i18n-edge';

export default async function Page() {
  const { locale } = await getLocaleFromHeaders();
  const dictionary = await getDictionary(locale);

  return <h1>{dictionary.navigation.home}</h1>;
}
```

### Client Components

```typescript
'use client';

import { useTenant } from '@/lib/tenant';
import { LocaleSwitcher, CurrencySwitcher } from '@/components/locale';

export function Header() {
  const { locale, currency, setLocale, setCurrency } = useTenant();

  return (
    <header>
      <LocaleSwitcher />
      <CurrencySwitcher />
    </header>
  );
}
```

### Currency Formatting

```typescript
import { formatPrice, formatPriceRange } from '@/lib/geo';

// Format single price
formatPrice(99.99, 'USD'); // "$99.99"
formatPrice(99.99, 'NGN'); // "₦99.99"
formatPrice(99.99, 'EUR', { locale: 'de-DE' }); // "99,99 €"

// Format price range
formatPriceRange(50, 100, 'GBP'); // "£50.00 - £100.00"

// Compact notation
formatPrice(1500, 'USD', { compact: true }); // "$1.5K"
```

## Testing

### Local Development

1. Override country detection by setting cookies:
   ```javascript
   document.cookie = 'bx_country=NG; path=/';
   document.cookie = 'bx_lang=yo-ng; path=/';
   ```

2. Use browser language settings to test Accept-Language detection

3. Use Vercel CLI for local geo testing:
   ```bash
   vercel dev --listen 3000
   ```

### Production Testing

1. Use VPN to test from different countries
2. Verify hreflang tags with Google Search Console
3. Test RTL layouts with Arabic locale
4. Verify currency formatting in checkout flow

## Performance Considerations

1. **Dictionary Loading**: Dictionaries are loaded dynamically and cached in memory
2. **Edge Middleware**: Runs at the edge for minimal latency
3. **Cookie-based Preferences**: Subsequent requests use cached preferences
4. **Static Generation**: Pages can be statically generated per locale

## Troubleshooting

### Locale Not Detected

1. Check middleware matcher configuration
2. Verify Accept-Language header is being sent
3. Check cookie values in browser DevTools

### Wrong Currency

1. Verify country-currency mapping
2. Check if user has set preference cookie
3. Verify geo headers are being set

### RTL Layout Issues

1. Ensure `dir="rtl"` is set on html element
2. Check Tailwind RTL utilities are applied
3. Verify fonts support Arabic/Hebrew characters

## File Structure

```
apps/web/
├── middleware.ts                    # Edge middleware
├── src/
│   ├── lib/
│   │   ├── i18n-edge/
│   │   │   ├── config.ts           # Locale definitions
│   │   │   ├── get-locale.ts       # Detection utilities
│   │   │   ├── dictionaries.ts     # Translation loading
│   │   │   ├── currency-map.ts     # Currency mappings
│   │   │   └── index.ts            # Exports
│   │   ├── tenant/
│   │   │   ├── tenant-context.ts   # Server context
│   │   │   ├── tenant-provider.tsx # Client provider
│   │   │   ├── use-tenant.ts       # React hooks
│   │   │   └── index.ts            # Exports
│   │   ├── geo/
│   │   │   ├── country-detection.ts
│   │   │   ├── currency-resolver.ts
│   │   │   ├── shipping-zones.ts
│   │   │   └── index.ts
│   │   └── i18n/
│   │       └── locales/
│   │           └── dictionaries/
│   │               ├── en-us.json
│   │               ├── fr-fr.json
│   │               └── ...
│   └── components/
│       └── locale/
│           ├── LocaleSwitcher.tsx
│           ├── CurrencySwitcher.tsx
│           ├── CountrySelector.tsx
│           └── index.ts
```
