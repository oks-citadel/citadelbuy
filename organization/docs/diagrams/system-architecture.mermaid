```mermaid
graph TB
    subgraph "Client Layer"
        WEB[Web Application<br/>Next.js + React]
        MOBILE[Mobile Apps<br/>React Native]
        ADMIN[Admin Dashboard<br/>Next.js + React]
    end

    subgraph "CDN & Edge"
        CDN[Azure CDN<br/>Global Distribution]
    end

    subgraph "Load Balancing"
        LB[Azure Load Balancer<br/>Traffic Distribution]
        WAF[Web Application Firewall<br/>Security Layer]
    end

    subgraph "Application Layer - AKS Cluster"
        direction TB
        subgraph "API Services"
            API[API Gateway<br/>NestJS]
            AUTH[Auth Service<br/>JWT + OAuth]
            PRODUCTS[Products Service]
            ORDERS[Orders Service]
            PAYMENTS[Payments Service]
            VENDORS[Vendors Service]
            ORGS[Organizations Service]
        end

        subgraph "AI Services - Python FastAPI"
            AI_REC[Recommendation<br/>Engine]
            AI_SEARCH[Smart Search<br/>Semantic + Visual]
            AI_FRAUD[Fraud Detection<br/>ML Model]
            AI_PRICE[Dynamic Pricing<br/>Algorithm]
            AI_PERSON[Personalization<br/>Engine]
            AI_CHAT[Chatbot<br/>Conversational AI]
        end

        subgraph "Background Workers"
            QUEUE[Bull Queue<br/>Redis-based]
            EMAIL_WORKER[Email Worker]
            NOTIF_WORKER[Notification Worker]
            ANALYTICS_WORKER[Analytics Worker]
        end
    end

    subgraph "Data Layer"
        direction TB
        subgraph "Primary Database"
            POSTGRES[(PostgreSQL 16<br/>Primary)]
            PRISMA[Prisma ORM]
        end

        subgraph "Read Replicas"
            PG_REPLICA1[(PostgreSQL<br/>Replica 1)]
            PG_REPLICA2[(PostgreSQL<br/>Replica 2)]
        end

        subgraph "Caching Layer"
            REDIS[(Redis 7<br/>Cache + Sessions)]
            REDIS_CLUSTER[(Redis Cluster<br/>Distributed Cache)]
        end

        subgraph "Search Engine"
            ELASTIC[(Elasticsearch 8<br/>Product Search)]
        end

        subgraph "Object Storage"
            BLOB[Azure Blob Storage<br/>Images & Files]
        end
    end

    subgraph "External Services"
        STRIPE[Stripe<br/>Payment Processing]
        PAYPAL[PayPal<br/>Alternative Payments]
        SENDGRID[SendGrid<br/>Email Service]
        TWILIO[Twilio<br/>SMS Service]
        MAPS[Azure Maps<br/>Location Services]
    end

    subgraph "Monitoring & Observability"
        PROMETHEUS[Prometheus<br/>Metrics]
        GRAFANA[Grafana<br/>Dashboards]
        SENTRY[Sentry<br/>Error Tracking]
        APPINSIGHTS[Azure App Insights<br/>APM]
    end

    %% Client connections
    WEB --> CDN
    MOBILE --> CDN
    ADMIN --> CDN

    %% CDN to Load Balancer
    CDN --> WAF
    WAF --> LB

    %% Load Balancer to Services
    LB --> API
    LB --> AUTH

    %% API connections
    API --> AUTH
    API --> PRODUCTS
    API --> ORDERS
    API --> PAYMENTS
    API --> VENDORS
    API --> ORGS

    %% AI Service connections
    API --> AI_REC
    API --> AI_SEARCH
    API --> AI_FRAUD
    API --> AI_PRICE
    API --> AI_PERSON
    API --> AI_CHAT

    %% Database connections
    API --> PRISMA
    PRISMA --> POSTGRES
    POSTGRES -.Replication.-> PG_REPLICA1
    POSTGRES -.Replication.-> PG_REPLICA2

    %% Cache connections
    API --> REDIS
    API --> REDIS_CLUSTER
    AUTH --> REDIS

    %% Search connections
    PRODUCTS --> ELASTIC
    AI_SEARCH --> ELASTIC

    %% Queue connections
    API --> QUEUE
    QUEUE --> EMAIL_WORKER
    QUEUE --> NOTIF_WORKER
    QUEUE --> ANALYTICS_WORKER

    %% External service connections
    PAYMENTS --> STRIPE
    PAYMENTS --> PAYPAL
    EMAIL_WORKER --> SENDGRID
    NOTIF_WORKER --> TWILIO
    API --> MAPS

    %% Storage connections
    PRODUCTS --> BLOB
    VENDORS --> BLOB

    %% Monitoring connections
    API -.Metrics.-> PROMETHEUS
    PROMETHEUS --> GRAFANA
    API -.Errors.-> SENTRY
    API -.Traces.-> APPINSIGHTS

    %% Styling
    classDef clientStyle fill:#4CAF50,stroke:#2E7D32,stroke-width:2px,color:#fff
    classDef serviceStyle fill:#2196F3,stroke:#1565C0,stroke-width:2px,color:#fff
    classDef aiStyle fill:#9C27B0,stroke:#6A1B9A,stroke-width:2px,color:#fff
    classDef dataStyle fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
    classDef externalStyle fill:#F44336,stroke:#C62828,stroke-width:2px,color:#fff
    classDef monitorStyle fill:#607D8B,stroke:#37474F,stroke-width:2px,color:#fff

    class WEB,MOBILE,ADMIN clientStyle
    class API,AUTH,PRODUCTS,ORDERS,PAYMENTS,VENDORS,ORGS,QUEUE,EMAIL_WORKER,NOTIF_WORKER serviceStyle
    class AI_REC,AI_SEARCH,AI_FRAUD,AI_PRICE,AI_PERSON,AI_CHAT aiStyle
    class POSTGRES,PG_REPLICA1,PG_REPLICA2,REDIS,REDIS_CLUSTER,ELASTIC,BLOB dataStyle
    class STRIPE,PAYPAL,SENDGRID,TWILIO,MAPS externalStyle
    class PROMETHEUS,GRAFANA,SENTRY,APPINSIGHTS monitorStyle
```

# CitadelBuy System Architecture

## Overview
This diagram illustrates the complete system architecture of the CitadelBuy Global B2B Enterprise Marketplace platform.

## Key Components

### Client Layer
- **Web Application**: Next.js 15 + React 19 for desktop users
- **Mobile Apps**: React Native + Expo for iOS/Android
- **Admin Dashboard**: Separate administrative interface

### Edge & Distribution
- **Azure CDN**: Global content delivery network for static assets and caching
- **WAF**: Web Application Firewall for security at the edge

### Load Balancing
- **Azure Load Balancer**: Distributes traffic across multiple AKS nodes
- **Health Checks**: Ensures traffic only goes to healthy instances

### Application Layer (AKS)
- **API Gateway**: NestJS-based REST API
- **Microservices**: Product, Order, Payment, Vendor, Organization services
- **AI Services**: Python FastAPI services for ML/AI capabilities
- **Background Workers**: Asynchronous job processing with Bull Queue

### Data Layer
- **PostgreSQL 16**: Primary database with read replicas
- **Prisma ORM**: Type-safe database access
- **Redis 7**: Caching and session management
- **Elasticsearch 8**: Full-text search engine
- **Azure Blob Storage**: Object storage for files and images

### External Integrations
- **Stripe & PayPal**: Payment processing
- **SendGrid**: Email delivery
- **Twilio**: SMS notifications
- **Azure Maps**: Location and mapping services

### Monitoring
- **Prometheus**: Metrics collection
- **Grafana**: Visualization and dashboards
- **Sentry**: Error tracking and reporting
- **Azure App Insights**: Application performance monitoring

## Data Flow

1. **User Request**: Client makes request through CDN
2. **Security**: WAF filters malicious traffic
3. **Load Balancing**: LB distributes to healthy pods
4. **Authentication**: JWT validation through Auth Service
5. **Business Logic**: API services process request
6. **AI Enhancement**: Optional AI service integration
7. **Data Access**: Database queries through Prisma
8. **Caching**: Redis for frequently accessed data
9. **Response**: Data returned to client through CDN

## Scalability

- **Horizontal Scaling**: AKS auto-scales based on CPU/Memory
- **Database Scaling**: Read replicas for read-heavy operations
- **Cache Scaling**: Redis cluster for distributed caching
- **CDN**: Global edge locations for low latency

## High Availability

- **Multi-AZ Deployment**: Services distributed across availability zones
- **Database Replication**: Continuous replication to replicas
- **Automatic Failover**: Health checks trigger failover
- **Backup Strategy**: Automated daily backups with point-in-time recovery
