```mermaid
sequenceDiagram
    actor User
    participant Web as Web App
    participant CDN as Azure CDN
    participant LB as Load Balancer
    participant API as API Gateway
    participant Auth as Auth Service
    participant Product as Product Service
    participant AI as AI Services
    participant Cache as Redis Cache
    participant DB as PostgreSQL
    participant Queue as Bull Queue
    participant Worker as Background Worker
    participant Email as SendGrid

    %% User browses products
    Note over User,Email: Product Browse & Search Flow

    User->>Web: Browse Products
    Web->>CDN: GET /products
    CDN-->>Web: Cached Response (if available)

    alt Cache Miss
        CDN->>LB: Forward Request
        LB->>API: Route to API Pod
        API->>Cache: Check Cache

        alt Cache Hit
            Cache-->>API: Return Cached Data
        else Cache Miss
            API->>Product: Get Products
            Product->>DB: Query Products Table
            DB-->>Product: Product Data
            Product-->>API: Formatted Response
            API->>Cache: Store in Cache (TTL: 5min)
        end

        API-->>LB: Response
        LB-->>CDN: Response
        CDN->>CDN: Cache Response
    end

    CDN-->>Web: Product List
    Web-->>User: Display Products

    %% AI-powered recommendations
    Note over User,Email: Personalized Recommendations

    User->>Web: View Product Detail
    Web->>API: GET /products/:id
    API->>Product: Get Product Details
    Product->>DB: Query Product + Relations
    DB-->>Product: Full Product Data

    par Get Recommendations
        API->>AI: Get Recommendations(userId, productId)
        AI->>DB: Fetch User History
        AI->>AI: Run ML Model
        AI-->>API: Recommended Products
    end

    Product-->>API: Product Details
    API-->>Web: Product + Recommendations
    Web-->>User: Display

    %% Add to cart
    Note over User,Email: Shopping Cart Flow

    User->>Web: Add to Cart
    Web->>API: POST /cart/items
    API->>Auth: Validate JWT Token
    Auth-->>API: User Identity
    API->>Cache: Get User Cart
    API->>DB: Add Cart Item
    DB-->>API: Updated Cart
    API->>Cache: Update Cart Cache
    API-->>Web: Cart Updated
    Web-->>User: Show Cart Badge

    %% Checkout process
    Note over User,Email: Checkout & Payment Flow

    User->>Web: Proceed to Checkout
    Web->>API: POST /checkout
    API->>Auth: Validate User
    Auth-->>API: User Verified

    par Parallel Validations
        API->>Product: Check Stock Availability
        Product->>DB: Lock Inventory
        DB-->>Product: Stock Reserved
        Product-->>API: Available

        and Tax Calculation
            API->>API: Calculate Tax
        end

        and AI Fraud Check
            API->>AI: Analyze Transaction
            AI->>AI: Run Fraud Detection Model
            AI-->>API: Risk Score (Low)
        end
    end

    API->>API: Create Payment Intent
    API-->>Web: Checkout Session Created
    Web-->>User: Payment Form

    User->>Web: Submit Payment
    Web->>API: POST /checkout/complete
    API->>Payment: Process Payment
    Payment->>Stripe: Create Charge
    Stripe-->>Payment: Payment Successful
    Payment->>DB: Create Order (status: paid)
    DB-->>Payment: Order Created

    %% Background processing
    API->>Queue: Enqueue Order Tasks

    par Async Tasks
        Queue->>Worker: Send Order Confirmation
        Worker->>Email: Send Email
        Email-->>Worker: Email Sent

        and Update Analytics
            Queue->>Worker: Update Analytics
            Worker->>DB: Insert Analytics Event
        end

        and Notify Vendor
            Queue->>Worker: Notify Vendor
            Worker->>Email: Send Vendor Notification
        end

        and Update Inventory
            Queue->>Worker: Decrement Stock
            Worker->>DB: Update Inventory
        end
    end

    Payment-->>API: Order Confirmed
    API->>Cache: Clear User Cart
    API-->>Web: Order Success
    Web-->>User: Order Confirmation Page

    %% Order tracking
    Note over User,Email: Order Tracking Flow

    User->>Web: Track Order
    Web->>API: GET /orders/:id
    API->>Auth: Validate User
    Auth-->>API: Authorized
    API->>DB: Get Order + Tracking
    DB-->>API: Order Details
    API-->>Web: Order Status
    Web-->>User: Tracking Information
```

# Broxiva Data Flow Diagram

## Overview
This sequence diagram illustrates the complete data flow for key user journeys in the Broxiva platform.

## Key Flows

### 1. Product Browse & Search Flow
**Actors**: User, Web App, CDN, API, Database
**Purpose**: Efficiently deliver product listings with caching

**Steps**:
1. User requests product list through web app
2. CDN checks for cached response
3. If cache miss, request flows to API
4. API checks Redis cache before database
5. Product service queries PostgreSQL
6. Response is cached at multiple levels
7. User receives product list

**Performance Optimizations**:
- Multi-level caching (CDN + Redis + Application)
- Cache TTL: 5 minutes for product lists
- Pagination to limit payload size

### 2. Personalized Recommendations
**Actors**: User, AI Service, Database
**Purpose**: Provide personalized product recommendations

**Steps**:
1. User views product detail page
2. Parallel request to AI recommendation engine
3. AI fetches user purchase history
4. ML model generates recommendations
5. Recommendations returned alongside product details

**AI Integration**:
- Collaborative filtering algorithm
- Real-time inference (< 200ms)
- Fallback to trending products if user history insufficient

### 3. Shopping Cart Flow
**Actors**: User, Auth Service, Cache, Database
**Purpose**: Manage shopping cart with session persistence

**Steps**:
1. User adds item to cart
2. JWT token validated by Auth service
3. Cart retrieved from Redis cache
4. Item added to cart in database
5. Cache updated with new cart state
6. User sees updated cart badge

**State Management**:
- Cart stored in Redis for fast access
- Persistent storage in PostgreSQL
- Cart sync between sessions

### 4. Checkout & Payment Flow
**Actors**: User, Multiple Services, External Payment Provider
**Purpose**: Process order with fraud detection and payment

**Parallel Validations** (executed concurrently):
- Stock availability check and reservation
- Tax calculation based on address
- AI fraud detection analysis

**Steps**:
1. User proceeds to checkout
2. Parallel validations executed
3. Payment intent created
4. User submits payment information
5. Payment processed through Stripe
6. Order created in database
7. Background tasks enqueued

### 5. Background Processing
**Actors**: Queue, Workers, External Services
**Purpose**: Asynchronous post-order tasks

**Async Tasks** (executed in parallel):
- Send order confirmation email
- Update analytics database
- Notify vendor of new order
- Decrement inventory stock
- Generate invoice
- Update recommendation model

**Queue System**:
- Bull Queue with Redis backend
- Retry mechanism for failed tasks
- Dead letter queue for investigation

### 6. Order Tracking
**Actors**: User, Database
**Purpose**: Provide real-time order status

**Steps**:
1. User requests order tracking
2. Auth service validates ownership
3. Order details fetched from database
4. Tracking information displayed

## Performance Characteristics

### Response Times (Target)
- Product List: < 200ms (P95)
- Product Detail: < 300ms (P95)
- Add to Cart: < 100ms (P95)
- Checkout: < 500ms (P95)
- AI Recommendations: < 200ms (P95)

### Caching Strategy
- **CDN**: Static assets, product images (24h TTL)
- **Redis**: Product lists, user sessions, cart data (5-30min TTL)
- **Application**: Query results, computed values (in-memory)

### Database Optimization
- Read replicas for product queries
- Connection pooling (PgBouncer)
- Prepared statements for frequent queries
- Database indexes on foreign keys and frequently queried fields

### Scalability Considerations
- Horizontal scaling of API pods
- Database read replicas for read-heavy operations
- Redis cluster for distributed caching
- Queue-based async processing for heavy tasks

## Error Handling

### Retry Strategy
- Failed payments: Retry with exponential backoff
- Email failures: Retry up to 3 times over 24 hours
- External API failures: Circuit breaker pattern

### Fallbacks
- Recommendations: Fall back to trending products
- Payment gateway: Support multiple providers
- Search: Elasticsearch unavailable â†’ database fallback

## Security Measures

### Authentication
- JWT tokens with short expiration (15min)
- Refresh tokens for session management
- Rate limiting on auth endpoints

### Data Protection
- Encryption in transit (TLS 1.3)
- Encryption at rest (AES-256)
- PCI DSS compliance for payment data
- No sensitive data in logs

### Fraud Detection
- Real-time AI-based risk scoring
- Velocity checks (orders per time window)
- Geo-location validation
- Device fingerprinting
