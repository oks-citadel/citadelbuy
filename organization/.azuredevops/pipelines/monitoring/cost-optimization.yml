trigger: none

schedules:
  - cron: '0 6 * * 0'
    displayName: 'Weekly - Sunday 6 AM UTC'
    branches:
      include:
        - main
    always: true

variables:
  - group: monitoring-variables
  - group: azure-cost-management
  - name: subscriptionId
    value: '$(azureSubscriptionId)'
  - name: analysisWindowDays
    value: 30
  - name: costThresholdUSD
    value: 5000
  - name: idleResourceThresholdDays
    value: 7
  - name: reportPath
    value: '$(Build.ArtifactStagingDirectory)/cost-report.json'

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: AnalyzeCosts
    displayName: 'Analyze Azure Costs'
    jobs:
      - job: FetchCostData
        displayName: 'Fetch Cost Management Data'
        steps:
          - checkout: none

          - task: AzureCLI@2
            displayName: 'Query Azure Cost Management'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Querying Azure Cost Management API..."
                echo "Subscription: $(subscriptionId)"
                echo "Analysis window: $(analysisWindowDays) days"

                # Calculate date range
                END_DATE=$(date -u +%Y-%m-%d)
                START_DATE=$(date -u -d "$(analysisWindowDays) days ago" +%Y-%m-%d)

                echo "Date range: $START_DATE to $END_DATE"

                # Query cost data using Azure Cost Management REST API
                SCOPE="/subscriptions/$(subscriptionId)"

                # Get overall cost summary
                echo "Fetching overall cost summary..."

                az rest \
                  --method post \
                  --url "https://management.azure.com${SCOPE}/providers/Microsoft.CostManagement/query?api-version=2023-03-01" \
                  --body "{
                    \"type\": \"ActualCost\",
                    \"timeframe\": \"Custom\",
                    \"timePeriod\": {
                      \"from\": \"${START_DATE}T00:00:00Z\",
                      \"to\": \"${END_DATE}T23:59:59Z\"
                    },
                    \"dataset\": {
                      \"granularity\": \"Daily\",
                      \"aggregation\": {
                        \"totalCost\": {
                          \"name\": \"Cost\",
                          \"function\": \"Sum\"
                        }
                      },
                      \"grouping\": [
                        {
                          \"type\": \"Dimension\",
                          \"name\": \"ResourceGroupName\"
                        }
                      ]
                    }
                  }" > $(Build.ArtifactStagingDirectory)/cost-summary.json

                echo "Cost summary retrieved"
                cat $(Build.ArtifactStagingDirectory)/cost-summary.json | jq '.'

                # Calculate total cost
                TOTAL_COST=$(cat $(Build.ArtifactStagingDirectory)/cost-summary.json | \
                  jq '[.properties.rows[] | .[0]] | add // 0')

                echo "Total cost for period: \$$TOTAL_COST USD"
                echo "##vso[task.setvariable variable=totalCost;isOutput=true]$TOTAL_COST"

                # Check against threshold
                THRESHOLD_EXCEEDED=$(echo "$TOTAL_COST > $(costThresholdUSD)" | bc -l)

                if [ "$THRESHOLD_EXCEEDED" -eq 1 ]; then
                  echo "##[warning]Cost threshold exceeded! Total: \$$TOTAL_COST (Threshold: \$$(costThresholdUSD))"
                  echo "##vso[task.setvariable variable=thresholdExceeded;isOutput=true]true"
                else
                  echo "Cost within threshold"
                  echo "##vso[task.setvariable variable=thresholdExceeded;isOutput=true]false"
                fi
            name: queryCosts

          - task: AzureCLI@2
            displayName: 'Analyze Costs by Resource Type'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Analyzing costs by resource type..."

                START_DATE=$(date -u -d "$(analysisWindowDays) days ago" +%Y-%m-%d)
                END_DATE=$(date -u +%Y-%m-%d)
                SCOPE="/subscriptions/$(subscriptionId)"

                # Query costs grouped by resource type
                az rest \
                  --method post \
                  --url "https://management.azure.com${SCOPE}/providers/Microsoft.CostManagement/query?api-version=2023-03-01" \
                  --body "{
                    \"type\": \"ActualCost\",
                    \"timeframe\": \"Custom\",
                    \"timePeriod\": {
                      \"from\": \"${START_DATE}T00:00:00Z\",
                      \"to\": \"${END_DATE}T23:59:59Z\"
                    },
                    \"dataset\": {
                      \"granularity\": \"None\",
                      \"aggregation\": {
                        \"totalCost\": {
                          \"name\": \"Cost\",
                          \"function\": \"Sum\"
                        }
                      },
                      \"grouping\": [
                        {
                          \"type\": \"Dimension\",
                          \"name\": \"ResourceType\"
                        },
                        {
                          \"type\": \"Dimension\",
                          \"name\": \"ResourceGroupName\"
                        }
                      ]
                    }
                  }" > $(Build.ArtifactStagingDirectory)/cost-by-resource-type.json

                echo "Cost by resource type:"
                cat $(Build.ArtifactStagingDirectory)/cost-by-resource-type.json | \
                  jq '.properties.rows | sort_by(.[0]) | reverse | .[:10]' | \
                  jq -r '.[] | "\(.[0] | tonumber | round)USD - \(.[1]) (\(.[2]))"'

          - task: AzureCLI@2
            displayName: 'Forecast Future Costs'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Forecasting costs for next 30 days..."

                SCOPE="/subscriptions/$(subscriptionId)"

                # Query forecast data
                az rest \
                  --method post \
                  --url "https://management.azure.com${SCOPE}/providers/Microsoft.CostManagement/forecast?api-version=2023-03-01" \
                  --body "{
                    \"type\": \"ActualCost\",
                    \"timeframe\": \"Custom\",
                    \"timePeriod\": {
                      \"from\": \"$(date -u +%Y-%m-%d)T00:00:00Z\",
                      \"to\": \"$(date -u -d '30 days' +%Y-%m-%d)T23:59:59Z\"
                    },
                    \"dataset\": {
                      \"granularity\": \"Daily\",
                      \"aggregation\": {
                        \"totalCost\": {
                          \"name\": \"Cost\",
                          \"function\": \"Sum\"
                        }
                      }
                    }
                  }" > $(Build.ArtifactStagingDirectory)/cost-forecast.json 2>/dev/null || echo "{}" > $(Build.ArtifactStagingDirectory)/cost-forecast.json

                if [ -s $(Build.ArtifactStagingDirectory)/cost-forecast.json ]; then
                  echo "Forecast data retrieved"

                  FORECAST_TOTAL=$(cat $(Build.ArtifactStagingDirectory)/cost-forecast.json | \
                    jq '[.properties.rows[]? | .[0]] | add // 0')

                  echo "Forecasted cost for next 30 days: \$$FORECAST_TOTAL USD"
                  echo "##vso[task.setvariable variable=forecastCost;isOutput=true]$FORECAST_TOTAL"
                else
                  echo "Forecast data not available"
                  echo "##vso[task.setvariable variable=forecastCost;isOutput=true]0"
                fi
            name: forecast

      - job: IdentifyIdleResources
        displayName: 'Identify Idle Resources'
        dependsOn: []
        steps:
          - checkout: none

          - task: AzureCLI@2
            displayName: 'Find Idle Virtual Machines'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Searching for idle virtual machines..."

                # Get all VMs
                VMS=$(az vm list --query "[].{name:name, resourceGroup:resourceGroup, powerState:powerState, location:location}" -o json)

                echo "Total VMs found: $(echo "$VMS" | jq 'length')"

                # Find stopped/deallocated VMs
                STOPPED_VMS=$(echo "$VMS" | jq '[.[] | select(.powerState | contains("stopped") or contains("deallocated"))]')

                STOPPED_COUNT=$(echo "$STOPPED_VMS" | jq 'length')
                echo "Stopped/deallocated VMs: $STOPPED_COUNT"

                if [ $STOPPED_COUNT -gt 0 ]; then
                  echo "Idle VMs that could be deleted:"
                  echo "$STOPPED_VMS" | jq -r '.[] | "  - \(.name) in \(.resourceGroup) (\(.powerState))"'
                fi

                echo "$STOPPED_VMS" > $(Build.ArtifactStagingDirectory)/idle-vms.json
                echo "##vso[task.setvariable variable=idleVmCount;isOutput=true]$STOPPED_COUNT"
            name: findVMs

          - task: AzureCLI@2
            displayName: 'Find Unused Disks'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Searching for unattached managed disks..."

                # Find disks not attached to any VM
                UNATTACHED_DISKS=$(az disk list \
                  --query "[?diskState=='Unattached'].{name:name, resourceGroup:resourceGroup, sizeGB:diskSizeGb, sku:sku.name, location:location}" \
                  -o json)

                DISK_COUNT=$(echo "$UNATTACHED_DISKS" | jq 'length')
                echo "Unattached disks: $DISK_COUNT"

                if [ $DISK_COUNT -gt 0 ]; then
                  echo "Unused disks that could be deleted:"
                  echo "$UNATTACHED_DISKS" | jq -r '.[] | "  - \(.name) (\(.sizeGB)GB, \(.sku)) in \(.resourceGroup)"'

                  # Calculate total size
                  TOTAL_SIZE=$(echo "$UNATTACHED_DISKS" | jq '[.[].sizeGB] | add // 0')
                  echo "Total unused disk space: ${TOTAL_SIZE}GB"
                fi

                echo "$UNATTACHED_DISKS" > $(Build.ArtifactStagingDirectory)/unused-disks.json
                echo "##vso[task.setvariable variable=unusedDiskCount;isOutput=true]$DISK_COUNT"
            name: findDisks

          - task: AzureCLI@2
            displayName: 'Find Unused Public IPs'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Searching for unassociated public IP addresses..."

                # Find public IPs not associated with any resource
                UNUSED_IPS=$(az network public-ip list \
                  --query "[?ipConfiguration==null].{name:name, resourceGroup:resourceGroup, sku:sku.name, location:location}" \
                  -o json)

                IP_COUNT=$(echo "$UNUSED_IPS" | jq 'length')
                echo "Unassociated public IPs: $IP_COUNT"

                if [ $IP_COUNT -gt 0 ]; then
                  echo "Unused public IPs that could be deleted:"
                  echo "$UNUSED_IPS" | jq -r '.[] | "  - \(.name) (\(.sku)) in \(.resourceGroup)"'
                fi

                echo "$UNUSED_IPS" > $(Build.ArtifactStagingDirectory)/unused-ips.json
                echo "##vso[task.setvariable variable=unusedIpCount;isOutput=true]$IP_COUNT"
            name: findIPs

          - task: AzureCLI@2
            displayName: 'Find Old Snapshots'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Searching for old snapshots..."

                CUTOFF_DATE=$(date -u -d "90 days ago" +%Y-%m-%d)

                # Find snapshots older than 90 days
                OLD_SNAPSHOTS=$(az snapshot list \
                  --query "[?timeCreated<'${CUTOFF_DATE}'].{name:name, resourceGroup:resourceGroup, sizeGB:diskSizeGb, created:timeCreated}" \
                  -o json)

                SNAPSHOT_COUNT=$(echo "$OLD_SNAPSHOTS" | jq 'length')
                echo "Snapshots older than 90 days: $SNAPSHOT_COUNT"

                if [ $SNAPSHOT_COUNT -gt 0 ]; then
                  echo "Old snapshots that could be deleted:"
                  echo "$OLD_SNAPSHOTS" | jq -r '.[] | "  - \(.name) (\(.sizeGB)GB, created: \(.created)) in \(.resourceGroup)"'

                  TOTAL_SIZE=$(echo "$OLD_SNAPSHOTS" | jq '[.[].sizeGB] | add // 0')
                  echo "Total snapshot space: ${TOTAL_SIZE}GB"
                fi

                echo "$OLD_SNAPSHOTS" > $(Build.ArtifactStagingDirectory)/old-snapshots.json
                echo "##vso[task.setvariable variable=oldSnapshotCount;isOutput=true]$SNAPSHOT_COUNT"
            name: findSnapshots

          - task: AzureCLI@2
            displayName: 'Find Idle App Services'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Searching for stopped App Services..."

                # Find stopped app services
                STOPPED_APPS=$(az webapp list \
                  --query "[?state=='Stopped'].{name:name, resourceGroup:resourceGroup, sku:appServicePlanId, location:location}" \
                  -o json)

                APP_COUNT=$(echo "$STOPPED_APPS" | jq 'length')
                echo "Stopped App Services: $APP_COUNT"

                if [ $APP_COUNT -gt 0 ]; then
                  echo "Stopped App Services:"
                  echo "$STOPPED_APPS" | jq -r '.[] | "  - \(.name) in \(.resourceGroup)"'
                fi

                echo "$STOPPED_APPS" > $(Build.ArtifactStagingDirectory)/stopped-apps.json
                echo "##vso[task.setvariable variable=stoppedAppCount;isOutput=true]$APP_COUNT"
            name: findApps

      - job: AnalyzeAgentUsage
        displayName: 'Analyze Pipeline Agent Usage'
        dependsOn: []
        steps:
          - checkout: none

          - task: AzureCLI@2
            displayName: 'Analyze Self-Hosted Agent Usage'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Analyzing pipeline agent usage..."

                # Get all agent pools
                POOLS=$(az pipelines pool list \
                  --organization "$(System.CollectionUri)" \
                  --query "[].{id:id,name:name,size:size,isHosted:isHosted}" \
                  -o json)

                echo "Agent pools:"
                echo "$POOLS" | jq '.'

                # Analyze self-hosted pools
                SELF_HOSTED=$(echo "$POOLS" | jq '[.[] | select(.isHosted==false)]')

                echo "Self-hosted pools:"
                echo "$SELF_HOSTED" | jq '.'

                SELF_HOSTED_COUNT=$(echo "$SELF_HOSTED" | jq 'length')
                echo "##vso[task.setvariable variable=selfHostedPoolCount;isOutput=true]$SELF_HOSTED_COUNT"
            name: analyzeAgents

          - task: Bash@3
            displayName: 'Query Pipeline Run History'
            inputs:
              targetType: 'inline'
              script: |
                echo "Querying pipeline runs for the last $(analysisWindowDays) days..."

                DAYS_AGO=$(date -u -d "$(analysisWindowDays) days ago" +%Y-%m-%d)

                # Get pipeline runs
                RUNS=$(az pipelines runs list \
                  --organization "$(System.CollectionUri)" \
                  --project "$(System.TeamProject)" \
                  --query "[?finishTime>='${DAYS_AGO}'].{id:id,status:status,result:result,pool:queue.pool.name}" \
                  -o json)

                TOTAL_RUNS=$(echo "$RUNS" | jq 'length')
                echo "Total pipeline runs: $TOTAL_RUNS"

                # Group by pool
                echo "$RUNS" | jq 'group_by(.pool) | map({pool: .[0].pool, count: length})' > \
                  $(Build.ArtifactStagingDirectory)/runs-by-pool.json

                echo "Runs by pool:"
                cat $(Build.ArtifactStagingDirectory)/runs-by-pool.json | jq '.'

                # Calculate usage recommendations
                echo "Agent usage analysis complete"

      - job: GenerateOptimizationReport
        displayName: 'Generate Cost Optimization Report'
        dependsOn:
          - FetchCostData
          - IdentifyIdleResources
          - AnalyzeAgentUsage
        condition: always()
        variables:
          totalCost: $[ dependencies.FetchCostData.outputs['queryCosts.totalCost'] ]
          forecastCost: $[ dependencies.FetchCostData.outputs['forecast.forecastCost'] ]
          thresholdExceeded: $[ dependencies.FetchCostData.outputs['queryCosts.thresholdExceeded'] ]
          idleVms: $[ dependencies.IdentifyIdleResources.outputs['findVMs.idleVmCount'] ]
          unusedDisks: $[ dependencies.IdentifyIdleResources.outputs['findDisks.unusedDiskCount'] ]
          unusedIps: $[ dependencies.IdentifyIdleResources.outputs['findIPs.unusedIpCount'] ]
          oldSnapshots: $[ dependencies.IdentifyIdleResources.outputs['findSnapshots.oldSnapshotCount'] ]
        steps:
          - checkout: none

          - task: DownloadPipelineArtifact@2
            displayName: 'Download Analysis Data'
            condition: succeededOrFailed()
            inputs:
              buildType: 'current'
              targetPath: '$(Build.ArtifactStagingDirectory)/data'
            continueOnError: true

          - task: PowerShell@2
            displayName: 'Generate Optimization Report'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "##[section]Cost Optimization Report"
                Write-Host "===================================="
                Write-Host ""
                Write-Host "Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"
                Write-Host "Analysis Period: $(analysisWindowDays) days"
                Write-Host ""

                # Cost Summary
                Write-Host "Cost Summary:"
                Write-Host "  Total cost ($(analysisWindowDays) days): `$$(totalCost) USD"
                Write-Host "  Cost threshold: `$$(costThresholdUSD) USD"
                Write-Host "  Threshold exceeded: $(thresholdExceeded)"
                Write-Host "  Forecasted (30 days): `$$(forecastCost) USD"
                Write-Host ""

                # Idle Resources
                Write-Host "Idle Resources:"
                Write-Host "  Idle VMs: $(idleVms)"
                Write-Host "  Unused disks: $(unusedDisks)"
                Write-Host "  Unused public IPs: $(unusedIps)"
                Write-Host "  Old snapshots (>90 days): $(oldSnapshots)"
                Write-Host ""

                # Calculate potential savings
                $potentialSavings = 0

                # Estimate savings (rough approximations)
                $vmSavings = [int]"$(idleVms)" * 100  # $100/month per idle VM
                $diskSavings = [int]"$(unusedDisks)" * 10  # $10/month per disk
                $ipSavings = [int]"$(unusedIps)" * 5  # $5/month per IP
                $snapshotSavings = [int]"$(oldSnapshots)" * 2  # $2/month per snapshot

                $potentialSavings = $vmSavings + $diskSavings + $ipSavings + $snapshotSavings

                Write-Host "Potential Monthly Savings:"
                Write-Host "  From idle VMs: `$$vmSavings"
                Write-Host "  From unused disks: `$$diskSavings"
                Write-Host "  From unused IPs: `$$ipSavings"
                Write-Host "  From old snapshots: `$$snapshotSavings"
                Write-Host "  Total potential savings: `$$potentialSavings/month"
                Write-Host ""

                # Generate recommendations
                $recommendations = @()

                if ([int]"$(idleVms)" -gt 0) {
                  $recommendations += "Delete or resize $(idleVms) idle virtual machines"
                }
                if ([int]"$(unusedDisks)" -gt 0) {
                  $recommendations += "Delete $(unusedDisks) unattached managed disks"
                }
                if ([int]"$(unusedIps)" -gt 0) {
                  $recommendations += "Release $(unusedIps) unassociated public IP addresses"
                }
                if ([int]"$(oldSnapshots)" -gt 0) {
                  $recommendations += "Delete $(oldSnapshots) snapshots older than 90 days"
                }

                Write-Host "Recommendations:"
                foreach ($rec in $recommendations) {
                  Write-Host "  - $rec"
                }

                # Create structured report
                $report = @{
                  timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
                  analysisWindow = "$(analysisWindowDays) days"
                  costs = @{
                    total = "$(totalCost)"
                    threshold = "$(costThresholdUSD)"
                    thresholdExceeded = "$(thresholdExceeded)"
                    forecast = "$(forecastCost)"
                  }
                  idleResources = @{
                    vms = "$(idleVms)"
                    disks = "$(unusedDisks)"
                    publicIps = "$(unusedIps)"
                    snapshots = "$(oldSnapshots)"
                  }
                  savings = @{
                    vms = $vmSavings
                    disks = $diskSavings
                    ips = $ipSavings
                    snapshots = $snapshotSavings
                    total = $potentialSavings
                  }
                  recommendations = $recommendations
                }

                $report | ConvertTo-Json -Depth 10 | Out-File "$(reportPath)"

                Write-Host ""
                Write-Host "Full report saved to: $(reportPath)"

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Cost Report'
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)'
              artifact: 'cost-optimization-report'
              publishLocation: 'pipeline'

          - template: ../templates/jobs/notify.yml
            parameters:
              channel: 'teams'
              webhookUrl: '$(teamsWebhookUrl)'
              message: |
                Weekly Cost Optimization Report

                Total Cost: $$(totalCost)
                Potential Savings: $$(potentialSavings)/month

                Idle VMs: $(idleVms)
                Unused Disks: $(unusedDisks)
                Unused IPs: $(unusedIps)
                Old Snapshots: $(oldSnapshots)
              severity: 'info'

          - task: PowerShell@2
            displayName: 'Create Work Item for Cost Review'
            condition: or(eq(variables['thresholdExceeded'], 'true'), gt(variables['potentialSavings'], 500))
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Creating work item for cost review..."

                $title = "Cost Optimization Review - Potential savings: `$$($potentialSavings)/month"
                $description = @"
                Weekly cost optimization analysis has identified potential savings.

                **Cost Summary:**
                - Total cost ($(analysisWindowDays) days): `$$(totalCost)
                - Threshold: `$$(costThresholdUSD) (Exceeded: $(thresholdExceeded))
                - Forecast (30 days): `$$(forecastCost)

                **Idle Resources:**
                - Idle VMs: $(idleVms)
                - Unused disks: $(unusedDisks)
                - Unused public IPs: $(unusedIps)
                - Old snapshots: $(oldSnapshots)

                **Potential Monthly Savings: `$$($potentialSavings)**

                **Action Items:**
                1. Review and delete idle VMs
                2. Clean up unattached disks
                3. Release unused public IPs
                4. Remove old snapshots

                **Report:**
                $(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)
                "@

                az boards work-item create `
                  --title "$title" `
                  --type "Task" `
                  --area "$(System.TeamProject)\Operations" `
                  --assigned-to "$(Build.RequestedForEmail)" `
                  --description "$description" `
                  --organization "$(System.CollectionUri)" `
                  --project "$(System.TeamProject)" `
                  --fields "Microsoft.VSTS.Common.Priority=2"

                Write-Host "Work item created for cost review"
