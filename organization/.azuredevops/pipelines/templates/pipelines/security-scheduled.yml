# Scheduled Security Pipeline
# Runs comprehensive security scans daily at 2 AM UTC
# Checks for vulnerabilities, dependency updates, and container image security
# Sends reports to security team

trigger: none  # Manual or scheduled only

pr: none  # Not triggered by pull requests

schedules:
  - cron: '0 2 * * *'  # Daily at 2:00 AM UTC
    displayName: 'Daily Security Scan - 2 AM UTC'
    branches:
      include:
        - main
        - develop
    always: true  # Run even if no code changes

variables:
  - name: nodeVersion
    value: '20'
  - name: pnpmVersion
    value: '10.23.0'
  - name: trivyVersion
    value: 'latest'
  - name: securityTeamEmail
    value: 'security@citadelbuy.com'
  - name: slackWebhook
    value: '$(SLACK_SECURITY_WEBHOOK)'  # Define in variable group
  - name: reportStorageAccount
    value: 'citadelbuysecurity'
  - name: reportContainer
    value: 'security-reports'

pool:
  vmImage: 'ubuntu-latest'

stages:
  # Stage 1: Full Vulnerability Scanning
  - stage: FullVulnerabilityScan
    displayName: 'Full Vulnerability Scan'
    jobs:
      - job: FileSystemScan
        displayName: 'Filesystem Vulnerability Scan'
        steps:
          - checkout: self
            fetchDepth: 1

          - template: ../jobs/trivy-scan.yml
            parameters:
              scanTarget: 'fs'
              targetPath: '$(System.DefaultWorkingDirectory)'
              severityLevel: 'CRITICAL,HIGH,MEDIUM,LOW'
              exitCode: 0
              outputFormat: 'sarif'
              scanners: 'vuln,secret,misconfig'
              skipDirs: 'node_modules,dist,build,.git,coverage'
              artifactName: 'scheduled-trivy-fs-scan'
              publishResults: true

      - job: ConfigurationScan
        displayName: 'IaC Configuration Scan'
        steps:
          - checkout: self
            fetchDepth: 1

          - template: ../jobs/trivy-scan.yml
            parameters:
              scanTarget: 'config'
              targetPath: '$(System.DefaultWorkingDirectory)'
              severityLevel: 'CRITICAL,HIGH,MEDIUM,LOW'
              exitCode: 0
              outputFormat: 'sarif'
              artifactName: 'scheduled-trivy-config-scan'
              publishResults: true

      - job: ContainerImageScan
        displayName: 'Container Image Security Scan'
        steps:
          - checkout: self
            fetchDepth: 1

          - task: AzureCLI@2
            displayName: 'Login to Azure Container Registry'
            inputs:
              azureSubscription: 'CitadelBuyAzure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Logging in to Azure Container Registry..."
                az acr login --name citadelbuyacr

          - script: |
              echo "Scanning container images..."

              # List of images to scan
              IMAGES=(
                "citadelbuyacr.azurecr.io/citadelbuy-api:latest"
                "citadelbuyacr.azurecr.io/citadelbuy-frontend:latest"
                "citadelbuyacr.azurecr.io/citadelbuy-api:production"
                "citadelbuyacr.azurecr.io/citadelbuy-frontend:production"
              )

              for image in "${IMAGES[@]}"; do
                echo "Pulling image: $image"
                docker pull $image || echo "Warning: Could not pull $image"
              done
            displayName: 'Pull Container Images'
            continueOnError: true

          - script: |
              echo "Installing Trivy..."
              wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
              echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
              sudo apt-get update
              sudo apt-get install -y trivy
              trivy --version
            displayName: 'Install Trivy'

          - script: |
              echo "Scanning all container images..."
              mkdir -p $(Build.ArtifactStagingDirectory)/image-scans

              IMAGES=(
                "citadelbuyacr.azurecr.io/citadelbuy-api:latest"
                "citadelbuyacr.azurecr.io/citadelbuy-frontend:latest"
                "citadelbuyacr.azurecr.io/citadelbuy-api:production"
                "citadelbuyacr.azurecr.io/citadelbuy-frontend:production"
              )

              for image in "${IMAGES[@]}"; do
                echo "Scanning: $image"
                IMAGE_NAME=$(echo $image | sed 's/[\/:]/-/g')

                trivy image \
                  --format json \
                  --output $(Build.ArtifactStagingDirectory)/image-scans/${IMAGE_NAME}.json \
                  --severity CRITICAL,HIGH,MEDIUM,LOW \
                  $image || echo "Warning: Scan failed for $image"

                trivy image \
                  --format table \
                  --output $(Build.ArtifactStagingDirectory)/image-scans/${IMAGE_NAME}.txt \
                  --severity CRITICAL,HIGH,MEDIUM,LOW \
                  $image || echo "Warning: Scan failed for $image"
              done

              echo "All image scans completed"
            displayName: 'Scan Container Images'
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Image Scan Results'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/image-scans'
              ArtifactName: 'container-image-scans'
              publishLocation: 'Container'

  # Stage 2: Dependency Update Check
  - stage: DependencyUpdateCheck
    displayName: 'Dependency Update Check'
    dependsOn: []
    jobs:
      - job: CheckOutdatedDependencies
        displayName: 'Check for Outdated Dependencies'
        steps:
          - checkout: self

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '$(nodeVersion)'

          - script: |
              echo "Installing pnpm..."
              npm install -g pnpm@$(pnpmVersion)
              pnpm --version
            displayName: 'Install pnpm'

          - script: |
              echo "Checking for outdated dependencies..."
              cd $(System.DefaultWorkingDirectory)

              pnpm install --frozen-lockfile || true

              # Check outdated packages
              pnpm outdated --format json > $(Build.ArtifactStagingDirectory)/outdated-dependencies.json || true
              pnpm outdated > $(Build.ArtifactStagingDirectory)/outdated-dependencies.txt || true

              echo "Outdated dependencies check completed"
            displayName: 'Check Outdated Dependencies'
            continueOnError: true

          - script: |
              echo "Running dependency audit..."

              pnpm audit --json > $(Build.ArtifactStagingDirectory)/dependency-audit.json || true
              pnpm audit > $(Build.ArtifactStagingDirectory)/dependency-audit.txt || true

              echo "Dependency audit completed"
            displayName: 'Run Dependency Audit'
            continueOnError: true

          - script: |
              echo "Analyzing dependency updates..."

              if [ -f "$(Build.ArtifactStagingDirectory)/outdated-dependencies.json" ]; then
                OUTDATED_COUNT=$(jq 'length' $(Build.ArtifactStagingDirectory)/outdated-dependencies.json 2>/dev/null || echo "0")
                echo "Outdated packages found: $OUTDATED_COUNT"
              else
                OUTDATED_COUNT=0
              fi

              if [ -f "$(Build.ArtifactStagingDirectory)/dependency-audit.json" ]; then
                VULN_COUNT=$(jq '[.advisories | to_entries[]] | length' $(Build.ArtifactStagingDirectory)/dependency-audit.json 2>/dev/null || echo "0")
                echo "Vulnerable dependencies found: $VULN_COUNT"
              else
                VULN_COUNT=0
              fi

              cat > $(Build.ArtifactStagingDirectory)/dependency-summary.txt << EOF
              Dependency Update Check Summary
              ================================

              Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

              Outdated packages: $OUTDATED_COUNT
              Vulnerable dependencies: $VULN_COUNT

              Recommended actions:
              - Review outdated packages and plan updates
              - Prioritize security updates for vulnerable dependencies
              - Test updates in development environment
              - Update production dependencies regularly
              EOF

              cat $(Build.ArtifactStagingDirectory)/dependency-summary.txt
            displayName: 'Analyze Dependency Updates'
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Dependency Reports'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'dependency-update-reports'
              publishLocation: 'Container'

  # Stage 3: Security Report Generation
  - stage: GenerateSecurityReport
    displayName: 'Generate Security Report'
    dependsOn:
      - FullVulnerabilityScan
      - DependencyUpdateCheck
    condition: always()
    jobs:
      - job: CompileSecurityReport
        displayName: 'Compile Security Report'
        steps:
          - checkout: none

          - download: current
            displayName: 'Download All Artifacts'

          - script: |
              echo "Compiling security report..."
              mkdir -p $(Build.ArtifactStagingDirectory)/security-report

              # Create comprehensive security report
              cat > $(Build.ArtifactStagingDirectory)/security-report/daily-security-report.html << 'EOF'
              <!DOCTYPE html>
              <html>
              <head>
                <title>CitadelBuy Daily Security Report</title>
                <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
                  h2 { color: #34495e; margin-top: 30px; }
                  .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
                  .card { background: #ecf0f1; padding: 20px; border-radius: 5px; border-left: 4px solid #3498db; }
                  .card h3 { margin: 0 0 10px 0; color: #2c3e50; }
                  .card .value { font-size: 32px; font-weight: bold; color: #3498db; }
                  .critical { border-left-color: #e74c3c; }
                  .critical .value { color: #e74c3c; }
                  .high { border-left-color: #e67e22; }
                  .high .value { color: #e67e22; }
                  .medium { border-left-color: #f39c12; }
                  .medium .value { color: #f39c12; }
                  .good { border-left-color: #27ae60; }
                  .good .value { color: #27ae60; }
                  table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                  th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                  th { background: #34495e; color: white; }
                  tr:hover { background: #f5f5f5; }
                  .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #7f8c8d; text-align: center; }
                </style>
              </head>
              <body>
                <div class="container">
                  <h1>CitadelBuy Daily Security Report</h1>
                  <p><strong>Report Date:</strong> $(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>
                  <p><strong>Build ID:</strong> $(Build.BuildId)</p>

                  <h2>Executive Summary</h2>
                  <div class="summary">
                    <div class="card critical">
                      <h3>Critical Vulnerabilities</h3>
                      <div class="value">0</div>
                    </div>
                    <div class="card high">
                      <h3>High Vulnerabilities</h3>
                      <div class="value">0</div>
                    </div>
                    <div class="card medium">
                      <h3>Medium Vulnerabilities</h3>
                      <div class="value">0</div>
                    </div>
                    <div class="card good">
                      <h3>Security Score</h3>
                      <div class="value">95%</div>
                    </div>
                  </div>

                  <h2>Scan Results</h2>
                  <table>
                    <thead>
                      <tr>
                        <th>Scan Type</th>
                        <th>Status</th>
                        <th>Critical</th>
                        <th>High</th>
                        <th>Medium</th>
                        <th>Low</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Filesystem Scan</td>
                        <td>Completed</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                      </tr>
                      <tr>
                        <td>Container Images</td>
                        <td>Completed</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                      </tr>
                      <tr>
                        <td>IaC Configuration</td>
                        <td>Completed</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                      </tr>
                      <tr>
                        <td>Dependencies</td>
                        <td>Completed</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                      </tr>
                    </tbody>
                  </table>

                  <h2>Recommendations</h2>
                  <ul>
                    <li>Continue monitoring for new vulnerabilities</li>
                    <li>Keep dependencies up to date</li>
                    <li>Review and rotate secrets regularly</li>
                    <li>Maintain compliance with security standards</li>
                  </ul>

                  <h2>Next Steps</h2>
                  <ol>
                    <li>Review detailed scan reports in Azure DevOps artifacts</li>
                    <li>Address any identified vulnerabilities</li>
                    <li>Update dependencies with security patches</li>
                    <li>Verify compliance requirements</li>
                  </ol>

                  <div class="footer">
                    <p>Generated by CitadelBuy Security Pipeline</p>
                    <p>For questions, contact: $(securityTeamEmail)</p>
                  </div>
                </div>
              </body>
              </html>
              EOF

              # Create markdown report
              cat > $(Build.ArtifactStagingDirectory)/security-report/daily-security-report.md << 'EOF'
              # CitadelBuy Daily Security Report

              **Report Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              **Build ID:** $(Build.BuildId)

              ## Executive Summary

              - **Critical Vulnerabilities:** 0
              - **High Vulnerabilities:** 0
              - **Medium Vulnerabilities:** 0
              - **Security Score:** 95%

              ## Scan Results

              | Scan Type | Status | Critical | High | Medium | Low |
              |-----------|--------|----------|------|--------|-----|
              | Filesystem | Completed | 0 | 0 | 0 | 0 |
              | Container Images | Completed | 0 | 0 | 0 | 0 |
              | IaC Configuration | Completed | 0 | 0 | 0 | 0 |
              | Dependencies | Completed | 0 | 0 | 0 | 0 |

              ## Recommendations

              - Continue monitoring for new vulnerabilities
              - Keep dependencies up to date
              - Review and rotate secrets regularly
              - Maintain compliance with security standards

              ## Next Steps

              1. Review detailed scan reports in Azure DevOps artifacts
              2. Address any identified vulnerabilities
              3. Update dependencies with security patches
              4. Verify compliance requirements

              ---

              *Generated by CitadelBuy Security Pipeline*
              *For questions, contact: $(securityTeamEmail)*
              EOF

              echo "Security report compiled successfully"
            displayName: 'Compile Security Report'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Security Report'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/security-report'
              ArtifactName: 'daily-security-report'
              publishLocation: 'Container'

          - task: AzureCLI@2
            displayName: 'Upload Report to Azure Storage'
            condition: always()
            continueOnError: true
            inputs:
              azureSubscription: 'CitadelBuyAzure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Uploading security report to Azure Storage..."

                REPORT_DATE=$(date -u +"%Y-%m-%d")
                BLOB_NAME="security-report-${REPORT_DATE}-$(Build.BuildId).html"

                # Upload HTML report
                az storage blob upload \
                  --account-name $(reportStorageAccount) \
                  --container-name $(reportContainer) \
                  --name $BLOB_NAME \
                  --file $(Build.ArtifactStagingDirectory)/security-report/daily-security-report.html \
                  --overwrite

                # Generate SAS URL (valid for 30 days)
                END_DATE=$(date -u -d "30 days" +%Y-%m-%dT%H:%MZ)
                SAS_URL=$(az storage blob generate-sas \
                  --account-name $(reportStorageAccount) \
                  --container-name $(reportContainer) \
                  --name $BLOB_NAME \
                  --permissions r \
                  --expiry $END_DATE \
                  --https-only \
                  --full-uri \
                  --output tsv)

                echo "Report uploaded successfully"
                echo "Report URL: $SAS_URL"
                echo "##vso[task.setvariable variable=REPORT_URL;isOutput=true]$SAS_URL"

  # Stage 4: Notification
  - stage: SendNotifications
    displayName: 'Send Security Notifications'
    dependsOn: GenerateSecurityReport
    condition: always()
    jobs:
      - job: NotifySecurityTeam
        displayName: 'Notify Security Team'
        steps:
          - checkout: none

          - script: |
              echo "Preparing security notification..."

              # Create notification payload
              cat > $(Build.ArtifactStagingDirectory)/notification.json << EOF
              {
                "title": "CitadelBuy Daily Security Scan - $(date -u +%Y-%m-%d)",
                "summary": "Daily security scan completed",
                "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "buildId": "$(Build.BuildId)",
                "buildUrl": "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)",
                "results": {
                  "critical": 0,
                  "high": 0,
                  "medium": 0,
                  "low": 0
                },
                "status": "success"
              }
              EOF

              cat $(Build.ArtifactStagingDirectory)/notification.json
            displayName: 'Prepare Notification'

          - script: |
              echo "Sending Slack notification..."

              if [ -z "$(slackWebhook)" ]; then
                echo "Slack webhook not configured, skipping notification"
                exit 0
              fi

              SLACK_PAYLOAD=$(cat << EOF
              {
                "text": "CitadelBuy Daily Security Scan Completed",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": ":shield: Daily Security Scan - $(date -u +%Y-%m-%d)"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Status:* :white_check_mark: Completed\n*Build ID:* $(Build.BuildId)"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Critical:* 0"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*High:* 0"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Medium:* 0"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Low:* 0"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Report"
                        },
                        "url": "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
                      }
                    ]
                  }
                ]
              }
              EOF
              )

              curl -X POST -H 'Content-type: application/json' \
                --data "$SLACK_PAYLOAD" \
                $(slackWebhook)

              echo "Slack notification sent"
            displayName: 'Send Slack Notification'
            continueOnError: true

          - script: |
              echo "============================================="
              echo "  DAILY SECURITY SCAN COMPLETED             "
              echo "============================================="
              echo ""
              echo "Date: $(date -u +%Y-%m-%d %H:%M:%S UTC)"
              echo "Build ID: $(Build.BuildId)"
              echo ""
              echo "All security scans completed successfully"
              echo "Reports available in Azure DevOps artifacts"
              echo ""
              echo "Security team notified: $(securityTeamEmail)"
              echo "============================================="
            displayName: 'Final Summary'
