# ==========================================
# Template: Deploy to AKS
# Reusable template for deploying to Azure Kubernetes Service
# ==========================================

parameters:
  - name: environment
    type: string
    values:
      - dev
      - staging
      - production
  - name: namespace
    type: string
  - name: aksConnection
    type: string
  - name: manifests
    type: object
  - name: containerImage
    type: string
  - name: useCanary
    type: boolean
    default: false
  - name: canaryPercentage
    type: number
    default: 25

steps:
  - checkout: self

  - task: qetza.replacetokens.replacetokens-task.replacetokens@5
    displayName: 'Replace tokens in manifests'
    inputs:
      rootDirectory: '$(Build.SourcesDirectory)/infrastructure/kubernetes'
      targetFiles: |
        **/*.yaml
        **/*.yml
      encoding: 'auto'
      tokenPattern: 'default'
      writeBOM: true
      actionOnMissing: 'warn'

  - task: KubernetesManifest@0
    displayName: 'Deploy to AKS ${{ parameters.environment }}'
    inputs:
      action: 'deploy'
      kubernetesServiceConnection: ${{ parameters.aksConnection }}
      namespace: ${{ parameters.namespace }}
      ${{ if eq(parameters.useCanary, true) }}:
        strategy: 'canary'
        percentage: ${{ parameters.canaryPercentage }}
      manifests: |
        ${{ join(chr(10), parameters.manifests) }}
      containers: ${{ parameters.containerImage }}

  - task: Kubernetes@1
    displayName: 'Wait for Rollout'
    inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: ${{ parameters.aksConnection }}
      namespace: ${{ parameters.namespace }}
      command: 'rollout'
      arguments: 'status deployment/${{ parameters.environment }} --timeout=5m'
