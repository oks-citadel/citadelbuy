# Security Scanning Stage
# Comprehensive security analysis including vulnerabilities, secrets, SAST, and license compliance
# Outputs SARIF format for Azure DevOps integration

parameters:
  - name: scanPath
    type: string
    default: '$(System.DefaultWorkingDirectory)'
  - name: failOnCritical
    type: boolean
    default: true
  - name: failOnHigh
    type: boolean
    default: false
  - name: publishResults
    type: boolean
    default: true
  - name: skipSecretsScan
    type: boolean
    default: false
  - name: skipSastScan
    type: boolean
    default: false

stages:
  - stage: SecurityScan
    displayName: 'Security & Vulnerability Scanning'
    dependsOn: []

    jobs:
      # Job 1: Trivy Filesystem Vulnerability Scan
      - job: TrivyScan
        displayName: 'Trivy Filesystem Security Scan'
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - checkout: self
            fetchDepth: 1

          - script: |
              echo "Installing Trivy vulnerability scanner..."
              wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
              echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
              sudo apt-get update
              sudo apt-get install -y trivy
              trivy --version
            displayName: 'Install Trivy'

          - script: |
              echo "Running Trivy filesystem vulnerability scan..."
              echo "Scan path: ${{ parameters.scanPath }}"

              # Run scan with SARIF output
              trivy fs \
                --format sarif \
                --output $(Build.ArtifactStagingDirectory)/trivy-results.sarif \
                --severity CRITICAL,HIGH,MEDIUM,LOW \
                --scanners vuln,secret,misconfig \
                --skip-dirs node_modules \
                ${{ parameters.scanPath }}

              # Also generate JSON for detailed analysis
              trivy fs \
                --format json \
                --output $(Build.ArtifactStagingDirectory)/trivy-results.json \
                --severity CRITICAL,HIGH,MEDIUM,LOW \
                --scanners vuln,secret,misconfig \
                --skip-dirs node_modules \
                ${{ parameters.scanPath }}

              # Generate human-readable table
              trivy fs \
                --format table \
                --output $(Build.ArtifactStagingDirectory)/trivy-results.txt \
                --severity CRITICAL,HIGH,MEDIUM,LOW \
                --scanners vuln,secret,misconfig \
                --skip-dirs node_modules \
                ${{ parameters.scanPath }}

              echo "Trivy scan completed"
            displayName: 'Run Trivy Filesystem Scan'
            continueOnError: true

          - script: |
              echo "Analyzing Trivy scan results..."

              CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' $(Build.ArtifactStagingDirectory)/trivy-results.json)
              HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' $(Build.ArtifactStagingDirectory)/trivy-results.json)
              MEDIUM_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' $(Build.ArtifactStagingDirectory)/trivy-results.json)
              LOW_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' $(Build.ArtifactStagingDirectory)/trivy-results.json)

              echo "===== Trivy Scan Summary ====="
              echo "Critical vulnerabilities: $CRITICAL_COUNT"
              echo "High vulnerabilities: $HIGH_COUNT"
              echo "Medium vulnerabilities: $MEDIUM_COUNT"
              echo "Low vulnerabilities: $LOW_COUNT"
              echo "=============================="

              # Set pipeline variables
              echo "##vso[task.setvariable variable=TRIVY_CRITICAL_COUNT;isOutput=true]$CRITICAL_COUNT"
              echo "##vso[task.setvariable variable=TRIVY_HIGH_COUNT;isOutput=true]$HIGH_COUNT"
              echo "##vso[task.setvariable variable=TRIVY_MEDIUM_COUNT;isOutput=true]$MEDIUM_COUNT"

              # Fail pipeline based on parameters
              if [ "${{ parameters.failOnCritical }}" = "True" ] && [ "$CRITICAL_COUNT" -gt 0 ]; then
                echo "##vso[task.logissue type=error]Found $CRITICAL_COUNT critical vulnerabilities"
                exit 1
              fi

              if [ "${{ parameters.failOnHigh }}" = "True" ] && [ "$HIGH_COUNT" -gt 0 ]; then
                echo "##vso[task.logissue type=error]Found $HIGH_COUNT high vulnerabilities"
                exit 1
              fi

              echo "Trivy scan validation passed"
            displayName: 'Analyze Trivy Results'
            name: TrivyAnalysis

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Trivy Results'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'trivy-scan-results'
              publishLocation: 'Container'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Trivy SARIF'
            condition: always()
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/trivy-results.sarif'
              artifact: 'CodeAnalysisLogs'
              publishLocation: 'pipeline'

      # Job 2: Dependency Security Audit
      - job: DependencyScan
        displayName: 'NPM/PNPM Dependency Audit'
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - checkout: self

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - script: |
              echo "Installing pnpm..."
              npm install -g pnpm@10.23.0
              pnpm --version
            displayName: 'Install pnpm'

          - script: |
              echo "Running pnpm audit..."
              cd ${{ parameters.scanPath }}

              # Run audit and generate JSON report
              pnpm audit --json > $(Build.ArtifactStagingDirectory)/pnpm-audit.json || true

              # Generate human-readable report
              pnpm audit > $(Build.ArtifactStagingDirectory)/pnpm-audit.txt || true

              echo "Dependency audit completed"
            displayName: 'Run pnpm Audit'
            continueOnError: true

          - script: |
              echo "Analyzing dependency vulnerabilities..."

              if [ ! -f "$(Build.ArtifactStagingDirectory)/pnpm-audit.json" ]; then
                echo "No audit results found"
                exit 0
              fi

              # Parse audit results
              CRITICAL=$(jq '[.advisories | to_entries[] | select(.value.severity == "critical")] | length' $(Build.ArtifactStagingDirectory)/pnpm-audit.json 2>/dev/null || echo "0")
              HIGH=$(jq '[.advisories | to_entries[] | select(.value.severity == "high")] | length' $(Build.ArtifactStagingDirectory)/pnpm-audit.json 2>/dev/null || echo "0")
              MODERATE=$(jq '[.advisories | to_entries[] | select(.value.severity == "moderate")] | length' $(Build.ArtifactStagingDirectory)/pnpm-audit.json 2>/dev/null || echo "0")
              LOW=$(jq '[.advisories | to_entries[] | select(.value.severity == "low")] | length' $(Build.ArtifactStagingDirectory)/pnpm-audit.json 2>/dev/null || echo "0")

              echo "===== Dependency Audit Summary ====="
              echo "Critical: $CRITICAL"
              echo "High: $HIGH"
              echo "Moderate: $MODERATE"
              echo "Low: $LOW"
              echo "===================================="

              # Set output variables
              echo "##vso[task.setvariable variable=DEP_CRITICAL;isOutput=true]$CRITICAL"
              echo "##vso[task.setvariable variable=DEP_HIGH;isOutput=true]$HIGH"

              # Fail on critical vulnerabilities
              if [ "${{ parameters.failOnCritical }}" = "True" ] && [ "$CRITICAL" -gt 0 ]; then
                echo "##vso[task.logissue type=error]Found $CRITICAL critical dependency vulnerabilities"
                exit 1
              fi

              echo "Dependency audit validation passed"
            displayName: 'Analyze Dependency Results'
            name: DependencyAnalysis

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Dependency Audit Results'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'dependency-audit-results'
              publishLocation: 'Container'

      # Job 3: Secrets Detection
      - job: SecretsScan
        displayName: 'Secrets & Credentials Detection'
        condition: and(succeeded(), eq('${{ parameters.skipSecretsScan }}', false))
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - checkout: self
            fetchDepth: 0
            persistCredentials: true

          - script: |
              echo "Installing Gitleaks..."
              wget -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
              tar -xzf gitleaks.tar.gz
              sudo mv gitleaks /usr/local/bin/
              sudo chmod +x /usr/local/bin/gitleaks
              gitleaks version
            displayName: 'Install Gitleaks'

          - script: |
              echo "Scanning for exposed secrets..."
              cd ${{ parameters.scanPath }}

              # Run Gitleaks on filesystem
              gitleaks detect \
                --source . \
                --report-format sarif \
                --report-path $(Build.ArtifactStagingDirectory)/gitleaks-results.sarif \
                --verbose \
                --no-git || true

              # Also generate JSON report
              gitleaks detect \
                --source . \
                --report-format json \
                --report-path $(Build.ArtifactStagingDirectory)/gitleaks-results.json \
                --verbose \
                --no-git || true

              echo "Secrets scan completed"
            displayName: 'Run Gitleaks Scan'
            continueOnError: true

          - script: |
              echo "Analyzing secrets scan results..."

              if [ ! -f "$(Build.ArtifactStagingDirectory)/gitleaks-results.json" ]; then
                echo "No secrets scan results found"
                echo "##vso[task.setvariable variable=SECRETS_FOUND;isOutput=true]0"
                exit 0
              fi

              SECRETS_COUNT=$(jq 'length' $(Build.ArtifactStagingDirectory)/gitleaks-results.json 2>/dev/null || echo "0")

              echo "===== Secrets Scan Summary ====="
              echo "Potential secrets found: $SECRETS_COUNT"
              echo "================================"

              if [ "$SECRETS_COUNT" -gt 0 ]; then
                echo "##vso[task.logissue type=warning]Found $SECRETS_COUNT potential exposed secrets"
                jq -r '.[] | "Secret: \(.Description) in \(.File):\(.StartLine)"' $(Build.ArtifactStagingDirectory)/gitleaks-results.json
              fi

              echo "##vso[task.setvariable variable=SECRETS_FOUND;isOutput=true]$SECRETS_COUNT"

              # Fail if secrets are found
              if [ "$SECRETS_COUNT" -gt 0 ]; then
                echo "##vso[task.logissue type=error]Exposed secrets detected! Review and remediate immediately."
                exit 1
              fi

              echo "No secrets detected"
            displayName: 'Analyze Secrets Results'
            name: SecretsAnalysis

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Secrets Scan Results'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'secrets-scan-results'
              publishLocation: 'Container'

      # Job 4: SAST - Static Application Security Testing
      - job: SastScan
        displayName: 'Static Application Security Testing'
        condition: and(succeeded(), eq('${{ parameters.skipSastScan }}', false))
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - checkout: self

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - script: |
              echo "Installing ESLint security plugins..."
              npm install -g eslint@8.57.0
              npm install -g eslint-plugin-security@1.7.1
              npm install -g @microsoft/eslint-plugin-sdl@0.2.2
              echo "ESLint version:"
              eslint --version
            displayName: 'Install ESLint Security Tools'

          - script: |
              echo "Running SAST analysis..."
              cd ${{ parameters.scanPath }}

              # Create ESLint security config
              cat > .eslintrc-security.json << 'EOF'
              {
                "plugins": ["security", "@microsoft/sdl"],
                "extends": [
                  "plugin:security/recommended",
                  "plugin:@microsoft/sdl/required"
                ],
                "parserOptions": {
                  "ecmaVersion": 2022,
                  "sourceType": "module"
                },
                "rules": {
                  "security/detect-object-injection": "warn",
                  "security/detect-non-literal-regexp": "warn",
                  "security/detect-unsafe-regex": "error",
                  "security/detect-buffer-noassert": "error",
                  "security/detect-child-process": "warn",
                  "security/detect-disable-mustache-escape": "error",
                  "security/detect-eval-with-expression": "error",
                  "security/detect-no-csrf-before-method-override": "error",
                  "security/detect-non-literal-fs-filename": "warn",
                  "security/detect-non-literal-require": "warn",
                  "security/detect-possible-timing-attacks": "warn",
                  "security/detect-pseudoRandomBytes": "error",
                  "@microsoft/sdl/no-cookies": "warn",
                  "@microsoft/sdl/no-document-write": "error",
                  "@microsoft/sdl/no-inner-html": "error",
                  "@microsoft/sdl/no-insecure-url": "error"
                }
              }
              EOF

              # Run ESLint with security rules
              eslint . \
                --config .eslintrc-security.json \
                --ext .js,.ts,.jsx,.tsx \
                --format json \
                --output-file $(Build.ArtifactStagingDirectory)/sast-results.json \
                --ignore-pattern "node_modules/*" \
                --ignore-pattern "dist/*" \
                --ignore-pattern "build/*" || true

              # Also generate SARIF format
              eslint . \
                --config .eslintrc-security.json \
                --ext .js,.ts,.jsx,.tsx \
                --format @microsoft/eslint-formatter-sarif \
                --output-file $(Build.ArtifactStagingDirectory)/sast-results.sarif \
                --ignore-pattern "node_modules/*" \
                --ignore-pattern "dist/*" \
                --ignore-pattern "build/*" || true

              echo "SAST analysis completed"
            displayName: 'Run SAST Analysis'
            continueOnError: true

          - script: |
              echo "Analyzing SAST results..."

              if [ ! -f "$(Build.ArtifactStagingDirectory)/sast-results.json" ]; then
                echo "No SAST results found"
                exit 0
              fi

              ERROR_COUNT=$(jq '[.[] | .messages[] | select(.severity == 2)] | length' $(Build.ArtifactStagingDirectory)/sast-results.json)
              WARNING_COUNT=$(jq '[.[] | .messages[] | select(.severity == 1)] | length' $(Build.ArtifactStagingDirectory)/sast-results.json)

              echo "===== SAST Analysis Summary ====="
              echo "Errors: $ERROR_COUNT"
              echo "Warnings: $WARNING_COUNT"
              echo "================================="

              echo "##vso[task.setvariable variable=SAST_ERRORS;isOutput=true]$ERROR_COUNT"
              echo "##vso[task.setvariable variable=SAST_WARNINGS;isOutput=true]$WARNING_COUNT"

              if [ "$ERROR_COUNT" -gt 0 ]; then
                echo "##vso[task.logissue type=warning]Found $ERROR_COUNT security issues in code"
              fi

              echo "SAST analysis completed"
            displayName: 'Analyze SAST Results'
            name: SastAnalysis

          - task: PublishBuildArtifacts@1
            displayName: 'Publish SAST Results'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'sast-results'
              publishLocation: 'Container'

      # Job 5: License Compliance Check
      - job: LicenseCompliance
        displayName: 'License Compliance Validation'
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - checkout: self

          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: '20.x'

          - script: |
              echo "Installing license checker..."
              npm install -g pnpm@10.23.0
              npm install -g license-checker@25.0.1
              npm install -g license-compliance-checker
            displayName: 'Install License Tools'

          - script: |
              echo "Installing dependencies..."
              cd ${{ parameters.scanPath }}

              if [ -f "pnpm-lock.yaml" ]; then
                pnpm install --frozen-lockfile
              elif [ -f "package-lock.json" ]; then
                npm ci
              else
                npm install
              fi
            displayName: 'Install Project Dependencies'
            continueOnError: true

          - script: |
              echo "Checking license compliance..."
              cd ${{ parameters.scanPath }}

              # Define approved licenses
              APPROVED_LICENSES="MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;CC0-1.0;Unlicense;Python-2.0"

              # Run license checker
              license-checker \
                --json \
                --out $(Build.ArtifactStagingDirectory)/licenses.json || true

              # Generate CSV format
              license-checker \
                --csv \
                --out $(Build.ArtifactStagingDirectory)/licenses.csv || true

              # Generate summary
              license-checker \
                --summary \
                > $(Build.ArtifactStagingDirectory)/licenses-summary.txt || true

              echo "License compliance check completed"
            displayName: 'Run License Compliance Check'
            continueOnError: true

          - script: |
              echo "Analyzing license compliance..."

              if [ ! -f "$(Build.ArtifactStagingDirectory)/licenses.json" ]; then
                echo "No license information found"
                exit 0
              fi

              # Define problematic licenses (GPL, AGPL, etc.)
              PROBLEMATIC_LICENSES=("GPL" "AGPL" "LGPL" "MPL" "CDDL" "EPL")

              # Check for problematic licenses
              PROBLEMATIC_COUNT=0
              for license in "${PROBLEMATIC_LICENSES[@]}"; do
                COUNT=$(jq -r "to_entries[] | select(.value.licenses | tostring | contains(\"$license\")) | .key" $(Build.ArtifactStagingDirectory)/licenses.json | wc -l)
                if [ "$COUNT" -gt 0 ]; then
                  echo "##vso[task.logissue type=warning]Found $COUNT packages with $license license"
                  PROBLEMATIC_COUNT=$((PROBLEMATIC_COUNT + COUNT))
                fi
              done

              TOTAL_PACKAGES=$(jq 'length' $(Build.ArtifactStagingDirectory)/licenses.json)
              UNKNOWN_LICENSE=$(jq -r 'to_entries[] | select(.value.licenses == "UNKNOWN") | .key' $(Build.ArtifactStagingDirectory)/licenses.json | wc -l)

              echo "===== License Compliance Summary ====="
              echo "Total packages: $TOTAL_PACKAGES"
              echo "Problematic licenses: $PROBLEMATIC_COUNT"
              echo "Unknown licenses: $UNKNOWN_LICENSE"
              echo "======================================"

              echo "##vso[task.setvariable variable=LICENSE_ISSUES;isOutput=true]$PROBLEMATIC_COUNT"

              if [ "$PROBLEMATIC_COUNT" -gt 0 ]; then
                echo "##vso[task.logissue type=warning]Review packages with restrictive licenses"
              fi

              echo "License compliance check completed"
            displayName: 'Analyze License Compliance'
            name: LicenseAnalysis

          - task: PublishBuildArtifacts@1
            displayName: 'Publish License Reports'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'license-compliance-results'
              publishLocation: 'Container'

      # Summary Job
      - job: SecuritySummary
        displayName: 'Security Scan Summary'
        dependsOn:
          - TrivyScan
          - DependencyScan
          - SecretsScan
          - SastScan
          - LicenseCompliance
        condition: always()
        pool:
          vmImage: 'ubuntu-latest'

        variables:
          trivyCritical: $[ dependencies.TrivyScan.outputs['TrivyAnalysis.TRIVY_CRITICAL_COUNT'] ]
          trivyHigh: $[ dependencies.TrivyScan.outputs['TrivyAnalysis.TRIVY_HIGH_COUNT'] ]
          depCritical: $[ dependencies.DependencyScan.outputs['DependencyAnalysis.DEP_CRITICAL'] ]
          secretsFound: $[ dependencies.SecretsScan.outputs['SecretsAnalysis.SECRETS_FOUND'] ]
          sastErrors: $[ dependencies.SastScan.outputs['SastAnalysis.SAST_ERRORS'] ]
          licenseIssues: $[ dependencies.LicenseCompliance.outputs['LicenseAnalysis.LICENSE_ISSUES'] ]

        steps:
          - script: |
              echo "========================================"
              echo "     SECURITY SCAN SUMMARY REPORT      "
              echo "========================================"
              echo ""
              echo "Trivy Vulnerabilities:"
              echo "  Critical: $(trivyCritical)"
              echo "  High: $(trivyHigh)"
              echo ""
              echo "Dependency Vulnerabilities:"
              echo "  Critical: $(depCritical)"
              echo ""
              echo "Secrets Detected: $(secretsFound)"
              echo "SAST Errors: $(sastErrors)"
              echo "License Issues: $(licenseIssues)"
              echo ""
              echo "========================================"

              # Generate overall security score
              TOTAL_ISSUES=$(($(trivyCritical) + $(depCritical) + $(secretsFound) + $(sastErrors)))

              echo "Total Critical Issues: $TOTAL_ISSUES"

              if [ "$TOTAL_ISSUES" -gt 0 ]; then
                echo "##vso[task.logissue type=warning]Security scan found $TOTAL_ISSUES critical issues requiring attention"
              else
                echo "##vso[task.logissue type=info]No critical security issues detected"
              fi
            displayName: 'Display Security Summary'
