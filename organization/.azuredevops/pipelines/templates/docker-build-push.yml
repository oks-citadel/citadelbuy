# ==========================================
# Template: Docker Build and Push
# Reusable template for building and pushing Docker images
# ==========================================

parameters:
  - name: dockerfilePath
    type: string
  - name: imageRepository
    type: string
  - name: containerRegistry
    type: string
    default: 'citadelbuyprod.azurecr.io'
  - name: acrConnection
    type: string
    default: 'citadelbuy-acr-connection'
  - name: buildArgs
    type: string
    default: ''
  - name: tags
    type: object
    default:
      - '$(Build.BuildNumber)'

steps:
  - task: Docker@2
    displayName: 'Login to ACR'
    inputs:
      command: login
      containerRegistry: ${{ parameters.acrConnection }}

  - task: Docker@2
    displayName: 'Build and Push ${{ parameters.imageRepository }}'
    inputs:
      command: buildAndPush
      repository: ${{ parameters.imageRepository }}
      dockerfile: ${{ parameters.dockerfilePath }}
      containerRegistry: ${{ parameters.acrConnection }}
      tags: |
        ${{ join(chr(10), parameters.tags) }}
      ${{ if ne(parameters.buildArgs, '') }}:
        arguments: ${{ parameters.buildArgs }}

  - script: |
      echo "Image built and pushed successfully:"
      echo "Repository: ${{ parameters.imageRepository }}"
      echo "Registry: ${{ parameters.containerRegistry }}"
      echo "Tags: ${{ join(', ', parameters.tags) }}"
    displayName: 'Build Summary'
