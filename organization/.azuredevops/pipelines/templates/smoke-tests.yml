# ==========================================
# Template: Smoke Tests
# Reusable template for running smoke tests
# ==========================================

parameters:
  - name: environment
    type: string
    values:
      - dev
      - staging
      - production
  - name: endpoints
    type: object
    default:
      - path: '/api/health'
        expectedStatus: 200
      - path: '/api'
        expectedStatus: 200

steps:
  - script: |
      echo "Running smoke tests for ${{ parameters.environment }} environment..."

      # Set base URL based on environment
      if [ "${{ parameters.environment }}" = "production" ]; then
        base_url="https://broxiva.com"
      elif [ "${{ parameters.environment }}" = "staging" ]; then
        base_url="https://staging.broxiva.com"
      else
        base_url="https://dev.broxiva.com"
      fi

      echo "Base URL: $base_url"

      # Test each endpoint
      failed=0
      ${{ each endpoint in parameters.endpoints }}:
        echo "Testing: ${{ endpoint.path }}"
        response=$(curl -s -o /dev/null -w "%{http_code}" ${base_url}${{ endpoint.path }})

        if [ $response -eq ${{ endpoint.expectedStatus }} ]; then
          echo "✓ ${{ endpoint.path }} returned expected status: $response"
        else
          echo "✗ ${{ endpoint.path }} failed. Expected: ${{ endpoint.expectedStatus }}, Got: $response"
          failed=1
        fi
      ${{ end }}

      if [ $failed -eq 1 ]; then
        echo "Some smoke tests failed"
        exit 1
      fi

      echo "✓ All smoke tests passed"
    displayName: 'Run Smoke Tests'
