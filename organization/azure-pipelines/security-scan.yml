# CitadelBuy - Security Scanning Pipeline
# Converted from GitHub Actions security-scan.yml
# Comprehensive security scanning for vulnerabilities, secrets, and SAST

trigger:
  branches:
    include:
      - main
      - master
      - develop

pr:
  branches:
    include:
      - main
      - master
      - develop

schedules:
  - cron: '0 2 * * *'
    displayName: 'Daily security scan at 2 AM UTC'
    branches:
      include:
        - main
    always: true

variables:
  - name: NODE_VERSION
    value: '20'
  - name: PNPM_VERSION
    value: '10'

stages:
  # ============================================
  # STAGE 1: Dependency Vulnerability Scanning
  # ============================================
  - stage: DependencyScanning
    displayName: 'Dependency Vulnerability Scan'
    jobs:
      - job: ScanDependencies
        displayName: 'Scan Dependencies'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          matrix:
            API:
              DIRECTORY: 'apps/api'
              PROJECT_NAME: 'api'
            Web:
              DIRECTORY: 'apps/web'
              PROJECT_NAME: 'web'
            Root:
              DIRECTORY: '.'
              PROJECT_NAME: 'root'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
            displayName: 'Setup pnpm'

          - script: |
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - bash: |
              cd $(DIRECTORY)
              echo "Running pnpm audit for $(DIRECTORY)"
              pnpm audit --audit-level=moderate --json > audit-report.json || true
              pnpm audit --audit-level=moderate || true
            displayName: 'Run pnpm audit'
            continueOnError: true

          - task: PublishPipelineArtifact@1
            displayName: 'Upload audit report'
            condition: always()
            inputs:
              targetPath: '$(DIRECTORY)/audit-report.json'
              artifact: 'pnpm-audit-$(PROJECT_NAME)'
              publishLocation: 'pipeline'

          - bash: |
              cd $(DIRECTORY)
              # Fail if critical or high vulnerabilities found
              pnpm audit --audit-level=high
            displayName: 'Check for critical vulnerabilities'

  # ============================================
  # STAGE 2: Secret Scanning
  # ============================================
  - stage: SecretScanning
    displayName: 'Secret Scanning'
    jobs:
      - job: ScanSecrets
        displayName: 'Scan for Secrets'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'
            fetchDepth: 0

          - task: Gitleaks@1
            displayName: 'Run Gitleaks'
            inputs:
              scanMode: 'repository'
              configType: 'default'
              reportFormat: 'sarif'
              reportFile: 'gitleaks-report.sarif'
            continueOnError: true

          - task: PublishPipelineArtifact@1
            displayName: 'Upload Gitleaks report'
            condition: always()
            inputs:
              targetPath: 'gitleaks-report.sarif'
              artifact: 'gitleaks-report'
              publishLocation: 'pipeline'

  # ============================================
  # STAGE 3: SAST - Static Application Security Testing
  # ============================================
  - stage: SASTAnalysis
    displayName: 'SAST Analysis'
    jobs:
      - job: CodeQLAnalysis
        displayName: 'CodeQL Analysis'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          matrix:
            JavaScript:
              LANGUAGE: 'javascript'
            TypeScript:
              LANGUAGE: 'typescript'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: AdvancedSecurity-Codeql-Init@1
            displayName: 'Initialize CodeQL'
            inputs:
              languages: '$(LANGUAGE)'
              querysuite: 'security-extended'

          - task: AdvancedSecurity-Codeql-Autobuild@1
            displayName: 'CodeQL Autobuild'

          - task: AdvancedSecurity-Codeql-Analyze@1
            displayName: 'Perform CodeQL Analysis'
            inputs:
              language: '$(LANGUAGE)'

  # ============================================
  # STAGE 4: Snyk Security Scanning
  # ============================================
  - stage: SnykSecurity
    displayName: 'Snyk Security Scan'
    condition: or(eq(variables['Build.Reason'], 'IndividualCI'), eq(variables['Build.Reason'], 'Schedule'))
    jobs:
      - job: SnykScan
        displayName: 'Run Snyk Security Scan'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
            displayName: 'Setup pnpm'

          - script: |
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - task: SnykSecurityScan@1
            displayName: 'Snyk Security Scan - API'
            inputs:
              serviceConnectionEndpoint: 'Snyk'
              testType: 'app'
              severityThreshold: 'high'
              monitorWhen: 'always'
              failOnIssues: false
              projectName: 'citadelbuy-api'
              additionalArguments: '--file=apps/api/package.json'
            continueOnError: true

          - task: SnykSecurityScan@1
            displayName: 'Snyk Security Scan - Web'
            inputs:
              serviceConnectionEndpoint: 'Snyk'
              testType: 'app'
              severityThreshold: 'high'
              monitorWhen: 'always'
              failOnIssues: false
              projectName: 'citadelbuy-web'
              additionalArguments: '--file=apps/web/package.json'
            continueOnError: true

  # ============================================
  # STAGE 5: Dependency Review (PR only)
  # ============================================
  - stage: DependencyReview
    displayName: 'Dependency Review'
    condition: eq(variables['Build.Reason'], 'PullRequest')
    jobs:
      - job: ReviewDependencies
        displayName: 'Review Dependencies'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: ComponentGovernanceComponentDetection@0
            displayName: 'Component Detection'
            inputs:
              scanType: 'Register'
              verbosity: 'Verbose'
              alertWarningLevel: 'Medium'

  # ============================================
  # STAGE 6: Docker Security Scanning
  # ============================================
  - stage: DockerSecurity
    displayName: 'Docker Image Security Scan'
    condition: or(eq(variables['Build.Reason'], 'IndividualCI'), eq(variables['Build.Reason'], 'Schedule'))
    jobs:
      - job: ScanDockerImages
        displayName: 'Scan Docker Images'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: Docker@2
            displayName: 'Build Docker image (API)'
            inputs:
              command: 'build'
              repository: 'citadelbuy-api'
              dockerfile: '$(System.DefaultWorkingDirectory)/infrastructure/docker/Dockerfile.organization'
              tags: 'test'
              buildContext: '$(System.DefaultWorkingDirectory)'

          - task: trivy@1
            displayName: 'Run Trivy vulnerability scanner (API)'
            inputs:
              version: 'latest'
              image: 'citadelbuy-api:test'
              severities: 'CRITICAL,HIGH'
              format: 'sarif'
              output: 'trivy-api-results.sarif'
              exitCode: '1'
              ignoreUnfixed: true
            continueOnError: true

          - task: PublishPipelineArtifact@1
            displayName: 'Upload Trivy results'
            condition: always()
            inputs:
              targetPath: 'trivy-api-results.sarif'
              artifact: 'trivy-docker-results'
              publishLocation: 'pipeline'

  # ============================================
  # STAGE 7: License Compliance Check
  # ============================================
  - stage: LicenseCompliance
    displayName: 'License Compliance Check'
    jobs:
      - job: CheckLicenses
        displayName: 'Check License Compliance'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: |
              npm install -g license-checker
            displayName: 'Install license checker'

          - bash: |
              cd apps/api
              npm ci
              license-checker --summary
              license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" --production
            displayName: 'Check licenses (API)'
            continueOnError: true

          - bash: |
              cd apps/web
              npm ci
              license-checker --summary
              license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" --production
            displayName: 'Check licenses (Web)'
            continueOnError: true

  # ============================================
  # STAGE 8: Security Summary
  # ============================================
  - stage: SecuritySummary
    displayName: 'Security Summary'
    dependsOn:
      - DependencyScanning
      - SecretScanning
      - SASTAnalysis
      - DockerSecurity
    condition: always()
    jobs:
      - job: GenerateSummary
        displayName: 'Generate Security Summary'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - bash: |
              echo "Security Scan Summary"
              echo "====================="
              echo "Dependency Scan: $DEPENDENCY_RESULT"
              echo "Secret Scan: $SECRET_RESULT"
              echo "SAST (CodeQL): $SAST_RESULT"
              echo "Docker Scan: $DOCKER_RESULT"
            displayName: 'Display security scan results'
            env:
              DEPENDENCY_RESULT: $[stageDependencies.DependencyScanning.ScanDependencies.result]
              SECRET_RESULT: $[stageDependencies.SecretScanning.ScanSecrets.result]
              SAST_RESULT: $[stageDependencies.SASTAnalysis.CodeQLAnalysis.result]
              DOCKER_RESULT: $[stageDependencies.DockerSecurity.ScanDockerImages.result]

          - task: PublishSecurityAnalysisLogs@3
            displayName: 'Publish Security Analysis Logs'
            condition: always()
            inputs:
              ArtifactName: 'SecurityLogs'
              ArtifactType: 'Container'
              AllTools: true
              ToolLogsNotFoundAction: 'Standard'
