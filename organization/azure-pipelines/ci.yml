# ==================================
# CitadelBuy - CI Pipeline for Azure DevOps
# Main continuous integration pipeline
# ==================================

name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '**.md'
      - 'docs/**'
      - '.github/**'

pr:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '**.md'
      - 'docs/**'

variables:
  - template: variables/common.yml
  - name: isMain
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  - name: isDevelop
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/develop')]

stages:
  # ==================================
  # STAGE 1: LINT & TYPE CHECK
  # ==================================
  - stage: Lint
    displayName: 'Code Quality Checks'
    jobs:
      - job: ESLint
        displayName: 'ESLint'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        steps:
          - checkout: self
            clean: true
            fetchDepth: 1

          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)

          - task: Cache@2
            displayName: 'Cache pnpm store'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: $(PNPM_CACHE_FOLDER)
              restoreKeys: |
                pnpm | "$(Agent.OS)"

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm config set store-dir $(PNPM_CACHE_FOLDER)
            displayName: 'Install pnpm'

          - script: pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm lint
            displayName: 'Run ESLint'

          - task: PublishTestResults@2
            displayName: 'Publish lint results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/lint-results.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'ESLint Results'

      - job: TypeCheck
        displayName: 'TypeScript Type Check'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        steps:
          - checkout: self
            clean: true
            fetchDepth: 1

          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)

          - task: Cache@2
            displayName: 'Cache pnpm store'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: $(PNPM_CACHE_FOLDER)
              restoreKeys: |
                pnpm | "$(Agent.OS)"

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm config set store-dir $(PNPM_CACHE_FOLDER)
            displayName: 'Install pnpm'

          - script: pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm type-check
            displayName: 'Run TypeScript type checking'

  # ==================================
  # STAGE 2: TESTS
  # ==================================
  - stage: Test
    displayName: 'Run Tests'
    dependsOn: Lint
    jobs:
      - job: APITests
        displayName: 'API Tests'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        services:
          postgres:
            image: postgres:16-alpine
            env:
              POSTGRES_USER: citadelbuy
              POSTGRES_PASSWORD: citadelbuy123
              POSTGRES_DB: citadelbuy_test
            ports:
              - 5432:5432
          redis:
            image: redis:7-alpine
            ports:
              - 6379:6379
        variables:
          DATABASE_URL: 'postgresql://citadelbuy:citadelbuy123@localhost:5432/citadelbuy_test'
          REDIS_URL: 'redis://localhost:6379'
          JWT_SECRET: 'test-secret-key'
          NODE_ENV: 'test'
        steps:
          - checkout: self
            clean: true

          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)

          - task: Cache@2
            displayName: 'Cache pnpm store'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: $(PNPM_CACHE_FOLDER)

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm config set store-dir $(PNPM_CACHE_FOLDER)
            displayName: 'Install pnpm'

          - script: pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm prisma:generate
            displayName: 'Generate Prisma Client'

          - script: pnpm db:migrate:deploy
            displayName: 'Run database migrations'

          - script: pnpm test:api --coverage --ci
            displayName: 'Run API tests'

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'API Tests'

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage'
            condition: always()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage/cobertura-coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/**/coverage'

      - job: WebTests
        displayName: 'Web Tests'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        steps:
          - checkout: self
            clean: true

          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)

          - task: Cache@2
            displayName: 'Cache pnpm store'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: $(PNPM_CACHE_FOLDER)

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm config set store-dir $(PNPM_CACHE_FOLDER)
            displayName: 'Install pnpm'

          - script: pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm test:web --coverage --ci
            displayName: 'Run web tests'

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'Web Tests'

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage'
            condition: always()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage/cobertura-coverage.xml'

      - job: PythonServicesTests
        displayName: 'Python Services Tests'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        strategy:
          matrix:
            SupplierIntegration:
              SERVICE_PATH: 'apps/services/supplier-integration'
              SERVICE_NAME: 'Supplier Integration'
            AIEngine:
              SERVICE_PATH: 'apps/services/ai-engine'
              SERVICE_NAME: 'AI Engine'
        steps:
          - checkout: self
            clean: true

          - task: UsePythonVersion@0
            displayName: 'Setup Python'
            inputs:
              versionSpec: '3.11'
              addToPath: true

          - task: Cache@2
            displayName: 'Cache pip packages'
            inputs:
              key: 'python | "$(Agent.OS)" | $(SERVICE_PATH)/requirements.txt'
              path: $(PIP_CACHE_DIR)

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
              pip install pytest pytest-cov flake8 black isort
            displayName: 'Install Python dependencies'
            workingDirectory: $(SERVICE_PATH)

          - script: |
              flake8 . --max-line-length=120 --exclude=__pycache__,venv
              black --check .
              isort --check-only .
            displayName: 'Run Python linting'
            workingDirectory: $(SERVICE_PATH)
            continueOnError: true

          - script: pytest --cov=src --cov-report=xml --cov-report=html -v
            displayName: 'Run $(SERVICE_NAME) tests'
            workingDirectory: $(SERVICE_PATH)
            env:
              TESTING: 'true'

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '$(SERVICE_PATH)/**/junit.xml'
              testRunTitle: '$(SERVICE_NAME) Tests'

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage'
            condition: always()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(SERVICE_PATH)/**/coverage.xml'

  # ==================================
  # STAGE 3: BUILD
  # ==================================
  - stage: Build
    displayName: 'Build Applications'
    dependsOn: Test
    jobs:
      - job: BuildApps
        displayName: 'Build All Apps'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        steps:
          - checkout: self
            clean: true

          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)

          - task: Cache@2
            displayName: 'Cache pnpm store'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: $(PNPM_CACHE_FOLDER)

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm config set store-dir $(PNPM_CACHE_FOLDER)
            displayName: 'Install pnpm'

          - script: pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: pnpm build
            displayName: 'Build all packages and apps'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish build artifacts'
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)'
              ArtifactName: 'build-artifacts'
              publishLocation: 'Container'
              StoreAsTar: true

  # ==================================
  # STAGE 4: SECURITY SCAN
  # ==================================
  - stage: SecurityScan
    displayName: 'Security Scanning'
    dependsOn: []
    jobs:
      - job: TrivyScan
        displayName: 'Trivy Security Scan'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        steps:
          - checkout: self
            clean: true

          - script: |
              wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
              echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
              sudo apt-get update
              sudo apt-get install trivy
            displayName: 'Install Trivy'

          - script: |
              trivy fs --exit-code 0 --severity CRITICAL,HIGH --format sarif --output trivy-results.sarif .
            displayName: 'Run Trivy filesystem scan'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Trivy results'
            condition: always()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/trivy-results.sarif'
              ArtifactName: 'security-scan-results'

      - job: DependencyScan
        displayName: 'Dependency Vulnerability Scan'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        steps:
          - checkout: self
            clean: true

          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: $(NODE_VERSION)

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm audit --audit-level=high
            displayName: 'Run npm audit'
            continueOnError: true

  # ==================================
  # STAGE 5: DOCKER BUILD (Main/Develop only)
  # ==================================
  - stage: DockerBuild
    displayName: 'Build Docker Images'
    dependsOn:
      - Build
      - SecurityScan
    condition: and(succeeded(), or(eq(variables.isMain, true), eq(variables.isDevelop, true)))
    jobs:
      - job: BuildAPIImage
        displayName: 'Build API Docker Image'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        steps:
          - template: templates/build-app.yml
            parameters:
              appName: 'api'
              dockerfilePath: 'apps/api/Dockerfile'
              dockerContext: 'apps/api'
              imageName: 'citadelbuy-api'

      - job: BuildWebImage
        displayName: 'Build Web Docker Image'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        steps:
          - template: templates/build-app.yml
            parameters:
              appName: 'web'
              dockerfilePath: 'apps/web/Dockerfile'
              dockerContext: 'apps/web'
              imageName: 'citadelbuy-web'
              buildArgs: |
                NEXT_PUBLIC_API_URL=$(NEXT_PUBLIC_API_URL)

      - job: BuildSupplierIntegrationImage
        displayName: 'Build Supplier Integration Image'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        steps:
          - template: templates/build-app.yml
            parameters:
              appName: 'supplier-integration'
              dockerfilePath: 'apps/services/supplier-integration/Dockerfile'
              dockerContext: 'apps/services/supplier-integration'
              imageName: 'citadelbuy-supplier-integration'

      - job: BuildAIEngineImage
        displayName: 'Build AI Engine Image'
        pool:
          vmImage: $(AGENT_VM_IMAGE)
        steps:
          - template: templates/build-app.yml
            parameters:
              appName: 'ai-engine'
              dockerfilePath: 'apps/services/ai-engine/Dockerfile'
              dockerContext: 'apps/services/ai-engine'
              imageName: 'citadelbuy-ai-engine'
