# CitadelBuy - Sentry Release Pipeline
# Converted from GitHub Actions sentry-release.yml
# Creates Sentry releases and uploads source maps for error tracking

trigger:
  branches:
    include:
      - main
      - develop
  tags:
    include:
      - 'v*'

pr: none

parameters:
  - name: environment
    displayName: 'Target environment'
    type: string
    default: 'staging'
    values:
      - development
      - staging
      - production

variables:
  - name: SENTRY_ORG
    value: 'citadelbuy'
  - name: NODE_VERSION
    value: '20'
  - name: PNPM_VERSION
    value: '8'

stages:
  # ============================================
  # STAGE 1: Create Backend Release
  # ============================================
  - stage: BackendRelease
    displayName: 'Create Backend Sentry Release'
    jobs:
      - job: BackendSentryRelease
        displayName: 'Backend Sentry Release'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'
            fetchDepth: 0

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - bash: |
              curl -sL https://sentry.io/get-cli/ | bash
            displayName: 'Install Sentry CLI'

          - bash: |
              if [[ "$(Build.SourceBranch)" == refs/tags/v* ]]; then
                VERSION="$(Build.SourceBranchName)"
              else
                SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
                VERSION="citadelbuy-backend@$SHA"
              fi
              echo "##vso[task.setvariable variable=VERSION]$VERSION"
              SHORT_SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
              echo "##vso[task.setvariable variable=SHORT_SHA]$SHORT_SHA"
            displayName: 'Determine release version'

          - bash: |
              if [[ "$(Build.SourceBranchName)" == "main" ]]; then
                echo "##vso[task.setvariable variable=ENVIRONMENT]production"
                echo "##vso[task.setvariable variable=PROJECT]citadelbuy-backend-prod"
              elif [[ "$(Build.SourceBranchName)" == "develop" ]]; then
                echo "##vso[task.setvariable variable=ENVIRONMENT]staging"
                echo "##vso[task.setvariable variable=PROJECT]citadelbuy-backend-staging"
              else
                echo "##vso[task.setvariable variable=ENVIRONMENT]development"
                echo "##vso[task.setvariable variable=PROJECT]citadelbuy-backend-dev"
              fi
            displayName: 'Determine environment'

          - bash: |
              # Create new release
              sentry-cli releases new "$(VERSION)" \
                --org $(SENTRY_ORG) \
                --project $(PROJECT)

              # Associate commits with release
              sentry-cli releases set-commits "$(VERSION)" \
                --auto \
                --org $(SENTRY_ORG) \
                --project $(PROJECT)

              # Finalize release
              sentry-cli releases finalize "$(VERSION)" \
                --org $(SENTRY_ORG) \
                --project $(PROJECT)
            displayName: 'Create Sentry release'
            env:
              SENTRY_AUTH_TOKEN: $(SENTRY_AUTH_TOKEN)

          - bash: |
              sentry-cli releases deploys "$(VERSION)" new \
                --env $(ENVIRONMENT) \
                --org $(SENTRY_ORG) \
                --project $(PROJECT)
            displayName: 'Create Sentry deployment'
            env:
              SENTRY_AUTH_TOKEN: $(SENTRY_AUTH_TOKEN)

  # ============================================
  # STAGE 2: Create Frontend Release & Upload Source Maps
  # ============================================
  - stage: FrontendRelease
    displayName: 'Create Frontend Sentry Release'
    jobs:
      - job: FrontendSentryRelease
        displayName: 'Frontend Sentry Release'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'
            fetchDepth: 0

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
            displayName: 'Setup pnpm'

          - bash: |
              curl -sL https://sentry.io/get-cli/ | bash
            displayName: 'Install Sentry CLI'

          - bash: |
              if [[ "$(Build.SourceBranch)" == refs/tags/v* ]]; then
                VERSION="$(Build.SourceBranchName)"
              else
                SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
                VERSION="citadelbuy-web@$SHA"
              fi
              echo "##vso[task.setvariable variable=VERSION]$VERSION"
              SHORT_SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
              echo "##vso[task.setvariable variable=SHORT_SHA]$SHORT_SHA"
            displayName: 'Determine release version'

          - bash: |
              if [[ "$(Build.SourceBranchName)" == "main" ]]; then
                echo "##vso[task.setvariable variable=ENVIRONMENT]production"
                echo "##vso[task.setvariable variable=PROJECT]citadelbuy-web-prod"
              elif [[ "$(Build.SourceBranchName)" == "develop" ]]; then
                echo "##vso[task.setvariable variable=ENVIRONMENT]staging"
                echo "##vso[task.setvariable variable=PROJECT]citadelbuy-web-staging"
              else
                echo "##vso[task.setvariable variable=ENVIRONMENT]development"
                echo "##vso[task.setvariable variable=PROJECT]citadelbuy-web-dev"
              fi
            displayName: 'Determine environment'

          - script: |
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - bash: |
              cd apps/web
              # Build with source maps
              pnpm build
            displayName: 'Build Next.js application'
            env:
              NODE_ENV: production
              NEXT_PUBLIC_SENTRY_DSN: $(NEXT_PUBLIC_SENTRY_DSN)
              SENTRY_AUTH_TOKEN: $(SENTRY_AUTH_TOKEN)
              SENTRY_ORG: $(SENTRY_ORG)
              SENTRY_PROJECT: $(PROJECT)
              NEXT_PUBLIC_API_URL: $(API_URL)

          - bash: |
              # Create new release
              sentry-cli releases new "$(VERSION)" \
                --org $(SENTRY_ORG) \
                --project $(PROJECT)

              # Associate commits with release
              sentry-cli releases set-commits "$(VERSION)" \
                --auto \
                --org $(SENTRY_ORG) \
                --project $(PROJECT)
            displayName: 'Create Sentry release'
            env:
              SENTRY_AUTH_TOKEN: $(SENTRY_AUTH_TOKEN)

          - bash: |
              cd apps/web
              # Upload source maps from .next directory
              sentry-cli releases files "$(VERSION)" upload-sourcemaps \
                --org $(SENTRY_ORG) \
                --project $(PROJECT) \
                ./.next/static \
                --url-prefix '~/_next/static' \
                --validate \
                --strip-prefix .next
            displayName: 'Upload source maps'
            env:
              SENTRY_AUTH_TOKEN: $(SENTRY_AUTH_TOKEN)

          - bash: |
              sentry-cli releases finalize "$(VERSION)" \
                --org $(SENTRY_ORG) \
                --project $(PROJECT)
            displayName: 'Finalize release'
            env:
              SENTRY_AUTH_TOKEN: $(SENTRY_AUTH_TOKEN)

          - bash: |
              sentry-cli releases deploys "$(VERSION)" new \
                --env $(ENVIRONMENT) \
                --org $(SENTRY_ORG) \
                --project $(PROJECT)
            displayName: 'Create Sentry deployment'
            env:
              SENTRY_AUTH_TOKEN: $(SENTRY_AUTH_TOKEN)

          - bash: |
              # Add deployment URL
              if [[ "$(ENVIRONMENT)" == "production" ]]; then
                URL="https://citadelbuy.com"
              elif [[ "$(ENVIRONMENT)" == "staging" ]]; then
                URL="https://staging.citadelbuy.com"
              else
                URL="https://dev.citadelbuy.com"
              fi

              # Add deployment metadata
              sentry-cli releases deploys "$(VERSION)" set-metadata \
                --url "$URL" \
                --org $(SENTRY_ORG) \
                --project $(PROJECT)
            displayName: 'Add release annotations'
            env:
              SENTRY_AUTH_TOKEN: $(SENTRY_AUTH_TOKEN)

  # ============================================
  # STAGE 3: Notify on Completion
  # ============================================
  - stage: NotifyRelease
    displayName: 'Notify Release Creation'
    dependsOn:
      - BackendRelease
      - FrontendRelease
    condition: always()
    jobs:
      - job: SendNotification
        displayName: 'Send Notification'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - bash: |
              BACKEND_RESULT="${{ stageDependencies.BackendRelease.BackendSentryRelease.result }}"
              FRONTEND_RESULT="${{ stageDependencies.FrontendRelease.FrontendSentryRelease.result }}"

              if [[ "$BACKEND_RESULT" == "Succeeded" && "$FRONTEND_RESULT" == "Succeeded" ]]; then
                echo "##vso[task.setvariable variable=STATUS]success"
                echo "##vso[task.setvariable variable=EMOJI]✅"
                echo "##vso[task.setvariable variable=COLOR]good"
              else
                echo "##vso[task.setvariable variable=STATUS]failure"
                echo "##vso[task.setvariable variable=EMOJI]❌"
                echo "##vso[task.setvariable variable=COLOR]danger"
              fi
            displayName: 'Determine status'

          - task: InvokeRESTAPI@1
            displayName: 'Send Slack notification'
            condition: ne(variables['SLACK_WEBHOOK_URL'], '')
            inputs:
              connectionType: 'connectedServiceName'
              serviceConnection: 'SlackWebhook'
              method: 'POST'
              body: |
                {
                  "text": "$(EMOJI) Sentry Release $(STATUS)",
                  "attachments": [{
                    "color": "$(COLOR)",
                    "fields": [
                      {
                        "title": "Commit",
                        "value": "$(Build.SourceVersion)",
                        "short": true
                      },
                      {
                        "title": "Branch",
                        "value": "$(Build.SourceBranchName)",
                        "short": true
                      },
                      {
                        "title": "Actor",
                        "value": "$(Build.RequestedFor)",
                        "short": true
                      },
                      {
                        "title": "Status",
                        "value": "$(STATUS)",
                        "short": true
                      }
                    ]
                  }]
                }
            continueOnError: true
