# CitadelBuy - Dropshipping Services CI/CD
# Converted from GitHub Actions dropshipping-services.yml
# Tests and deploys dropshipping-related services

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - 'apps/services/supplier-integration/**'
      - 'apps/services/ai-engine/**'
      - 'apps/api/src/modules/dropshipping/**'
      - 'infrastructure/docker/docker-compose.dropshipping.yml'

pr:
  branches:
    include:
      - main
  paths:
    include:
      - 'apps/services/supplier-integration/**'
      - 'apps/services/ai-engine/**'
      - 'apps/api/src/modules/dropshipping/**'

variables:
  - name: REGISTRY
    value: 'ghcr.io'
  - name: IMAGE_PREFIX
    value: 'citadelplatforms/citadelbuy'
  - name: PYTHON_VERSION
    value: '3.11'
  - name: NODE_VERSION
    value: '20'
  - name: PNPM_VERSION
    value: '8'

stages:
  # ============================================
  # STAGE 1: Supplier Integration Service Tests
  # ============================================
  - stage: SupplierIntegrationTest
    displayName: 'Test Supplier Integration'
    jobs:
      - job: TestSupplierIntegration
        displayName: 'Supplier Integration Tests'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: UsePythonVersion@0
            displayName: 'Set up Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'
              addToPath: true

          - bash: |
              cd apps/services/supplier-integration
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - bash: |
              cd apps/services/supplier-integration
              pip install flake8 black isort
              flake8 . --max-line-length=120 --exclude=__pycache__,venv
              black --check .
              isort --check-only .
            displayName: 'Run linting'
            continueOnError: true

          - bash: |
              cd apps/services/supplier-integration
              pytest --cov=src --cov-report=xml --cov-report=html -v
            displayName: 'Run tests'
            env:
              TESTING: 'true'

          - task: PublishCodeCoverageResults@1
            displayName: 'Upload coverage'
            condition: always()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/apps/services/supplier-integration/coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/apps/services/supplier-integration/htmlcov'

  # ============================================
  # STAGE 2: AI Engine Service Tests
  # ============================================
  - stage: AIEngineTest
    displayName: 'Test AI Engine'
    jobs:
      - job: TestAIEngine
        displayName: 'AI Engine Tests'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: UsePythonVersion@0
            displayName: 'Set up Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'
              addToPath: true

          - bash: |
              cd apps/services/ai-engine
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - bash: |
              cd apps/services/ai-engine
              pip install flake8 black isort
              flake8 . --max-line-length=120 --exclude=__pycache__,venv
            displayName: 'Run linting'
            continueOnError: true

          - bash: |
              cd apps/services/ai-engine
              pytest --cov=src --cov-report=xml -v
            displayName: 'Run tests'
            env:
              TESTING: 'true'

          - task: PublishCodeCoverageResults@1
            displayName: 'Upload coverage'
            condition: always()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/apps/services/ai-engine/coverage.xml'

  # ============================================
  # STAGE 3: Backend Dropshipping Module Tests
  # ============================================
  - stage: BackendDropshippingTest
    displayName: 'Test Backend Dropshipping'
    jobs:
      - job: TestBackendDropshipping
        displayName: 'Backend Dropshipping Tests'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
            displayName: 'Install pnpm'

          - bash: |
              cd apps/api
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - bash: |
              cd apps/api
              pnpm run typecheck
            displayName: 'Run TypeScript check'

          - bash: |
              cd apps/api
              pnpm run lint
            displayName: 'Run linting'

          - bash: |
              cd apps/api
              pnpm run test -- --coverage --passWithNoTests
            displayName: 'Run tests'
            env:
              DATABASE_URL: postgresql://test:test@localhost:5432/test

  # ============================================
  # STAGE 4: Build Docker Images
  # ============================================
  - stage: BuildImages
    displayName: 'Build Docker Images'
    dependsOn:
      - SupplierIntegrationTest
      - AIEngineTest
      - BackendDropshippingTest
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: BuildSupplierIntegration
        displayName: 'Build Supplier Integration Image'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: Docker@2
            displayName: 'Login to Container Registry'
            inputs:
              command: 'login'
              containerRegistry: 'GitHubContainerRegistry'

          - task: Docker@2
            displayName: 'Build and push'
            inputs:
              command: 'buildAndPush'
              repository: '$(IMAGE_PREFIX)-supplier-integration'
              dockerfile: '$(System.DefaultWorkingDirectory)/apps/services/supplier-integration/Dockerfile'
              buildContext: '$(System.DefaultWorkingDirectory)/apps/services/supplier-integration'
              tags: |
                $(Build.SourceVersion)

      - job: BuildAIEngine
        displayName: 'Build AI Engine Image'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: Docker@2
            displayName: 'Login to Container Registry'
            inputs:
              command: 'login'
              containerRegistry: 'GitHubContainerRegistry'

          - task: Docker@2
            displayName: 'Build and push'
            inputs:
              command: 'buildAndPush'
              repository: '$(IMAGE_PREFIX)-ai-engine'
              dockerfile: '$(System.DefaultWorkingDirectory)/apps/services/ai-engine/Dockerfile'
              buildContext: '$(System.DefaultWorkingDirectory)/apps/services/ai-engine'
              tags: |
                $(Build.SourceVersion)

  # ============================================
  # STAGE 5: Deploy to Staging
  # ============================================
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: BuildImages
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToStaging
        displayName: 'Deploy Dropshipping Services'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout code'

                - task: KubernetesManifest@0
                  displayName: 'Deploy to Kubernetes'
                  inputs:
                    action: 'deploy'
                    kubernetesServiceConnection: 'Kubernetes-Staging'
                    namespace: 'staging'
                    manifests: 'infrastructure/kubernetes/dropshipping/'

                - bash: |
                    kubectl rollout status deployment/supplier-integration -n staging --timeout=300s
                    kubectl rollout status deployment/ai-engine -n staging --timeout=300s
                  displayName: 'Wait for rollout'

                - bash: |
                    SUPPLIER_URL=$(kubectl get svc supplier-integration -n staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                    AI_URL=$(kubectl get svc ai-engine -n staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

                    curl -f "http://$SUPPLIER_URL:8001/health" || exit 1
                    curl -f "http://$AI_URL:8002/health" || exit 1

                    echo "Smoke tests passed!"
                  displayName: 'Run smoke tests'

  # ============================================
  # STAGE 6: Deploy to Production
  # ============================================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToProduction
        displayName: 'Deploy to Production'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout code'

                - task: KubernetesManifest@0
                  displayName: 'Deploy to Kubernetes'
                  inputs:
                    action: 'deploy'
                    kubernetesServiceConnection: 'Kubernetes-Production'
                    namespace: 'production'
                    manifests: 'infrastructure/kubernetes/dropshipping/'

                - bash: |
                    kubectl rollout status deployment/supplier-integration -n production --timeout=300s
                    kubectl rollout status deployment/ai-engine -n production --timeout=300s
                  displayName: 'Wait for rollout'

                - task: InvokeRESTAPI@1
                  displayName: 'Notify deployment'
                  inputs:
                    connectionType: 'connectedServiceName'
                    serviceConnection: 'SlackWebhook'
                    method: 'POST'
                    body: |
                      {
                        "text": "ðŸš€ Dropshipping services deployed to production!",
                        "blocks": [
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "*Dropshipping Services Deployed*\n- Supplier Integration: âœ…\n- AI Engine: âœ…"
                            }
                          }
                        ]
                      }
                  continueOnError: true
