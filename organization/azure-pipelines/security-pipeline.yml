# CitadelBuy - Comprehensive Security Pipeline
# Converted from GitHub Actions security.yml
# Enhanced security scanning with multiple tools and checks

trigger:
  branches:
    include:
      - main
      - master
      - develop

pr:
  branches:
    include:
      - main
      - master
      - develop

schedules:
  - cron: '0 2 * * *'
    displayName: 'Daily security scan at 2 AM UTC'
    branches:
      include:
        - main
    always: true

variables:
  - name: NODE_VERSION
    value: '18'

stages:
  # ============================================
  # STAGE 1: Dependency Vulnerability Scanning
  # ============================================
  - stage: DependencyScanning
    displayName: 'Dependency Vulnerability Scan'
    jobs:
      - job: NPMAudit
        displayName: 'NPM Audit'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          matrix:
            API:
              DIRECTORY: 'apps/api'
              PROJECT_NAME: 'api'
            Web:
              DIRECTORY: 'apps/web'
              PROJECT_NAME: 'web'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'
              checkLatest: true

          - bash: |
              cd organization/$(DIRECTORY)
              echo "Running npm audit for $(DIRECTORY)"
              npm audit --audit-level=moderate --json > audit-report.json || true
              npm audit --audit-level=moderate
            displayName: 'Run npm audit'
            continueOnError: true

          - task: PublishPipelineArtifact@1
            displayName: 'Upload npm audit report'
            condition: always()
            inputs:
              targetPath: 'organization/$(DIRECTORY)/audit-report.json'
              artifact: 'npm-audit-$(PROJECT_NAME)'
              publishLocation: 'pipeline'

          - bash: |
              cd organization/$(DIRECTORY)
              # Fail if critical or high vulnerabilities found
              npm audit --audit-level=high
            displayName: 'Check for critical vulnerabilities'

  # ============================================
  # STAGE 2: Secret Scanning
  # ============================================
  - stage: SecretScanning
    displayName: 'Secret Scanning'
    jobs:
      - job: GitLeaks
        displayName: 'GitLeaks Scan'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'
            fetchDepth: 0

          - task: Gitleaks@1
            displayName: 'Run Gitleaks'
            inputs:
              scanMode: 'repository'
              configType: 'default'
            continueOnError: true

      - job: HardcodedSecrets
        displayName: 'Scan for Hardcoded Secrets'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - bash: |
              echo "Scanning for common secret patterns..."

              # Check for API keys
              if grep -r "api[_-]key.*=.*['\"][a-zA-Z0-9]{20,}['\"]" organization/apps --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx"; then
                echo "##vso[task.logissue type=error]Found potential API keys in code"
                exit 1
              fi

              # Check for passwords
              if grep -r "password.*=.*['\"][^'\"]*['\"]" organization/apps --include="*.ts" --include="*.js" | grep -v "process.env" | grep -v "placeholder" | grep -v "example"; then
                echo "##vso[task.logissue type=warning]Found potential hardcoded passwords"
              fi

              # Check for private keys
              if grep -r "BEGIN.*PRIVATE KEY" organization/ --include="*.pem" --include="*.key"; then
                echo "##vso[task.logissue type=error]Found private key files"
                exit 1
              fi

              echo "Secret scanning completed"
            displayName: 'Scan for hardcoded secrets'

          - bash: |
              if git ls-files | grep -E "\.env$|\.env\.production$"; then
                echo "##vso[task.logissue type=error]Found .env files in git repository"
                exit 1
              fi
              echo ".env check passed"
            displayName: 'Check for .env files in git'

  # ============================================
  # STAGE 3: SAST CodeQL Analysis
  # ============================================
  - stage: SASTCodeQL
    displayName: 'CodeQL SAST Analysis'
    jobs:
      - job: CodeQL
        displayName: 'CodeQL Analysis'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          matrix:
            JavaScript:
              LANGUAGE: 'javascript'
            TypeScript:
              LANGUAGE: 'typescript'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: AdvancedSecurity-Codeql-Init@1
            displayName: 'Initialize CodeQL'
            inputs:
              languages: '$(LANGUAGE)'
              querysuite: 'security-extended,security-and-quality'

          - task: AdvancedSecurity-Codeql-Autobuild@1
            displayName: 'Autobuild'

          - task: AdvancedSecurity-Codeql-Analyze@1
            displayName: 'Perform CodeQL Analysis'
            inputs:
              language: '$(LANGUAGE)'

  # ============================================
  # STAGE 4: ESLint Security Rules
  # ============================================
  - stage: ESLintSecurity
    displayName: 'ESLint Security Rules'
    jobs:
      - job: ESLint
        displayName: 'Run ESLint Security'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - bash: |
              cd organization/apps/api
              npm ci
            displayName: 'Install dependencies (API)'

          - bash: |
              cd organization/apps/web
              npm ci
            displayName: 'Install dependencies (Web)'

          - bash: |
              npm install -g eslint-plugin-security eslint-plugin-no-secrets
            displayName: 'Install ESLint security plugins'

          - bash: |
              cd organization/apps/api
              npx eslint . --ext .ts,.tsx,.js,.jsx || true
            displayName: 'Run ESLint with security rules (API)'
            continueOnError: true

          - bash: |
              cd organization/apps/web
              npx eslint . --ext .ts,.tsx,.js,.jsx || true
            displayName: 'Run ESLint with security rules (Web)'
            continueOnError: true

  # ============================================
  # STAGE 5: Docker Security Scan
  # ============================================
  - stage: DockerSecurity
    displayName: 'Docker Image Security Scan'
    condition: or(eq(variables['Build.Reason'], 'IndividualCI'), eq(variables['Build.Reason'], 'Schedule'))
    jobs:
      - job: TrivyScan
        displayName: 'Trivy Docker Scan'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: Docker@2
            displayName: 'Build Docker image (API)'
            inputs:
              command: 'build'
              repository: 'citadelbuy-api'
              dockerfile: '$(System.DefaultWorkingDirectory)/organization/infrastructure/docker/Dockerfile.organization'
              tags: 'test'
              buildContext: '$(System.DefaultWorkingDirectory)/organization'

          - task: trivy@1
            displayName: 'Run Trivy vulnerability scanner (API)'
            inputs:
              version: 'latest'
              image: 'citadelbuy-api:test'
              severities: 'CRITICAL,HIGH'
              format: 'sarif'
              output: 'trivy-api-results.sarif'
            continueOnError: true

          - task: PublishPipelineArtifact@1
            displayName: 'Upload Trivy results to artifacts'
            condition: always()
            inputs:
              targetPath: 'trivy-api-results.sarif'
              artifact: 'trivy-api-results'
              publishLocation: 'pipeline'

          - task: trivy@1
            displayName: 'Run Trivy vulnerability scanner (detailed)'
            inputs:
              version: 'latest'
              image: 'citadelbuy-api:test'
              severities: 'CRITICAL'
              format: 'table'
              exitCode: '1'
              ignoreUnfixed: true
            continueOnError: false

  # ============================================
  # STAGE 6: Dependency Review (PR only)
  # ============================================
  - stage: DependencyReview
    displayName: 'Dependency Review'
    condition: eq(variables['Build.Reason'], 'PullRequest')
    jobs:
      - job: Review
        displayName: 'Review Dependencies'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: ComponentGovernanceComponentDetection@0
            displayName: 'Component Detection'
            inputs:
              scanType: 'Register'
              verbosity: 'Verbose'
              alertWarningLevel: 'Medium'
              failOnAlert: true
              failOnSeverity: 'Moderate'

  # ============================================
  # STAGE 7: Snyk Security Scan
  # ============================================
  - stage: SnykSecurity
    displayName: 'Snyk Security Scan'
    condition: or(eq(variables['Build.Reason'], 'IndividualCI'), eq(variables['Build.Reason'], 'Schedule'))
    jobs:
      - job: Snyk
        displayName: 'Snyk Scan'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - bash: |
              cd organization/apps/api
              npm ci
            displayName: 'Install dependencies (API)'

          - task: SnykSecurityScan@1
            displayName: 'Snyk Security Scan - API'
            inputs:
              serviceConnectionEndpoint: 'Snyk'
              testType: 'app'
              severityThreshold: 'high'
              monitorWhen: 'always'
              failOnIssues: false
              projectName: 'citadelbuy-api'
              organization: 'citadel'
            continueOnError: true

          - bash: |
              cd organization/apps/web
              npm ci
            displayName: 'Install dependencies (Web)'

          - task: SnykSecurityScan@1
            displayName: 'Snyk Security Scan - Web'
            inputs:
              serviceConnectionEndpoint: 'Snyk'
              testType: 'app'
              severityThreshold: 'high'
              monitorWhen: 'always'
              failOnIssues: false
              projectName: 'citadelbuy-web'
              organization: 'citadel'
            continueOnError: true

  # ============================================
  # STAGE 8: Security Headers Check
  # ============================================
  - stage: SecurityHeaders
    displayName: 'Security Headers Check'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: CheckHeaders
        displayName: 'Check Security Headers'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - bash: |
              if [ -n "$(STAGING_URL)" ]; then
                echo "Checking security headers for $(STAGING_URL)"

                curl -I "$(STAGING_URL)" | tee headers.txt

                # Check for security headers
                echo "Checking for required security headers..."

                if ! grep -qi "strict-transport-security" headers.txt; then
                  echo "##vso[task.logissue type=warning]Missing Strict-Transport-Security header"
                fi

                if ! grep -qi "x-frame-options" headers.txt; then
                  echo "##vso[task.logissue type=warning]Missing X-Frame-Options header"
                fi

                if ! grep -qi "x-content-type-options" headers.txt; then
                  echo "##vso[task.logissue type=warning]Missing X-Content-Type-Options header"
                fi

                if ! grep -qi "content-security-policy" headers.txt; then
                  echo "##vso[task.logissue type=warning]Missing Content-Security-Policy header"
                fi

                if ! grep -qi "x-xss-protection" headers.txt; then
                  echo "##vso[task.logissue type=warning]Missing X-XSS-Protection header"
                fi
              else
                echo "STAGING_URL not set, skipping header check"
              fi
            displayName: 'Check security headers'

  # ============================================
  # STAGE 9: License Compliance
  # ============================================
  - stage: LicenseCompliance
    displayName: 'License Compliance Check'
    jobs:
      - job: CheckLicenses
        displayName: 'Check Licenses'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - bash: |
              npm install -g license-checker
            displayName: 'Install license checker'

          - bash: |
              cd organization/apps/api
              npm ci
              license-checker --summary
              license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" --production
            displayName: 'Check licenses (API)'
            continueOnError: true

          - bash: |
              cd organization/apps/web
              npm ci
              license-checker --summary
              license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" --production
            displayName: 'Check licenses (Web)'
            continueOnError: true

  # ============================================
  # STAGE 10: Security Summary
  # ============================================
  - stage: SecuritySummary
    displayName: 'Security Summary'
    dependsOn:
      - DependencyScanning
      - SecretScanning
      - SASTCodeQL
      - DockerSecurity
    condition: always()
    jobs:
      - job: Summary
        displayName: 'Generate Security Summary'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - bash: |
              echo "Security Scan Summary"
              echo "====================="
              echo "Dependency Scan: $DEPENDENCY_RESULT"
              echo "Secret Scan: $SECRET_RESULT"
              echo "SAST (CodeQL): $SAST_RESULT"
              echo "Docker Scan: $DOCKER_RESULT"

              if [ "$DEPENDENCY_RESULT" != "Succeeded" ] || \
                 [ "$SECRET_RESULT" != "Succeeded" ] || \
                 [ "$SAST_RESULT" != "Succeeded" ] || \
                 [ "$DOCKER_RESULT" != "Succeeded" ]; then
                echo "##vso[task.logissue type=error]One or more security scans failed"
                exit 1
              fi
            displayName: 'Check security scan results'
            env:
              DEPENDENCY_RESULT: $[stageDependencies.DependencyScanning.NPMAudit.result]
              SECRET_RESULT: $[stageDependencies.SecretScanning.GitLeaks.result]
              SAST_RESULT: $[stageDependencies.SASTCodeQL.CodeQL.result]
              DOCKER_RESULT: $[stageDependencies.DockerSecurity.TrivyScan.result]
