{
  "workflow_config": {
    "name": "CitadelBuy Abandoned Cart Recovery",
    "version": "1.0.0",
    "schedule_interval_minutes": 30,
    "description": "Multi-stage abandoned cart recovery with AI recommendations"
  },

  "recovery_stages": {
    "stage_1": {
      "name": "Initial Reminder",
      "delay_hours": 1,
      "subject": "You left something behind, {{ customer_first_name }}!",
      "klaviyo_template_id": "abandoned_cart_stage_1",
      "offer_discount": false,
      "discount_code": null,
      "include_recommendations": false,
      "expected_conversion_rate": 0.25
    },
    "stage_2": {
      "name": "Urgency + Recommendations",
      "delay_hours": 24,
      "subject": "Still thinking? These items won't last long!",
      "klaviyo_template_id": "abandoned_cart_stage_2",
      "offer_discount": false,
      "discount_code": null,
      "include_recommendations": true,
      "recommendations_count": 4,
      "expected_conversion_rate": 0.12
    },
    "stage_3": {
      "name": "Discount Offer",
      "delay_hours": 72,
      "subject": "Special offer just for you: 10% off your cart!",
      "klaviyo_template_id": "abandoned_cart_stage_3",
      "offer_discount": true,
      "discount_code": "COMEBACK10",
      "discount_percentage": 10,
      "discount_expiry_hours": 24,
      "include_recommendations": false,
      "expected_conversion_rate": 0.18
    },
    "stage_4": {
      "name": "Final Attempt",
      "delay_hours": 168,
      "subject": "We miss you! Alternative products you might love",
      "klaviyo_template_id": "abandoned_cart_stage_4",
      "offer_discount": false,
      "discount_code": null,
      "include_recommendations": true,
      "recommendations_count": 4,
      "expected_conversion_rate": 0.08
    }
  },

  "exclusion_rules": {
    "check_recent_orders": {
      "enabled": true,
      "description": "Skip if customer placed an order after cart creation",
      "api_endpoint": "/orders",
      "query_params": {
        "customer_id": "{{ customer_id }}",
        "created_after": "{{ cart.created_at }}"
      }
    },
    "check_klaviyo_suppression": {
      "enabled": true,
      "description": "Skip if email is in Klaviyo suppression list",
      "list_id_env_var": "KLAVIYO_SUPPRESSION_LIST_ID"
    },
    "check_open_support_tickets": {
      "enabled": true,
      "description": "Skip if customer has open Zendesk tickets",
      "zendesk_query": "type:ticket requester:{{ customer_email }} status<solved"
    },
    "check_maximum_stages": {
      "enabled": true,
      "description": "Skip if cart has reached maximum recovery stages",
      "max_stages": 4
    },
    "check_cart_value": {
      "enabled": false,
      "description": "Only process carts above minimum value",
      "min_value": 25.00,
      "max_value": null
    },
    "check_business_hours": {
      "enabled": false,
      "description": "Only send emails during business hours",
      "timezone": "America/New_York",
      "start_hour": 9,
      "end_hour": 18,
      "exclude_weekends": true
    }
  },

  "personalization": {
    "use_customer_first_name": true,
    "fallback_name": "Valued Customer",
    "include_product_images": true,
    "image_cdn_base": "https://cdn.citadelbuy.com",
    "include_related_products": true,
    "related_products_provider": "algolia",
    "related_products_count": 4,
    "include_social_proof": false,
    "social_proof_threshold": 10
  },

  "api_endpoints": {
    "citadelbuy": {
      "base_url": "https://api.citadelbuy.com/v1",
      "endpoints": {
        "abandoned_carts": "/carts/abandoned",
        "update_cart": "/carts/{{ cart_id }}",
        "check_orders": "/orders",
        "customer_profile": "/customers/{{ customer_id }}"
      },
      "auth_header": "Authorization",
      "auth_value": "Bearer {{ CITADELBUY_API_KEY }}",
      "timeout_seconds": 30
    },
    "klaviyo": {
      "base_url": "https://a.klaviyo.com",
      "endpoints": {
        "track_event": "/api/v1/track",
        "suppression_list": "/api/v2/list/{{ list_id }}/members"
      },
      "auth_header": "Authorization",
      "auth_value": "Klaviyo-API-Key {{ KLAVIYO_PRIVATE_API_KEY }}",
      "timeout_seconds": 30
    },
    "algolia": {
      "app_id": "{{ ALGOLIA_APP_ID }}",
      "index_name": "citadelbuy_products",
      "search_api_key": "{{ ALGOLIA_API_KEY }}",
      "filters": {
        "same_category": true,
        "exclude_cart_items": true,
        "in_stock_only": true
      }
    },
    "zendesk": {
      "subdomain": "citadelbuy",
      "base_url": "https://citadelbuy.zendesk.com/api/v2",
      "auth_type": "basic",
      "timeout_seconds": 30
    },
    "mixpanel": {
      "base_url": "https://api.mixpanel.com",
      "project_token": "{{ MIXPANEL_PROJECT_TOKEN }}",
      "track_endpoint": "/track"
    }
  },

  "analytics": {
    "track_email_sent": true,
    "track_email_opened": true,
    "track_email_clicked": true,
    "track_cart_recovered": true,
    "track_exclusions": true,
    "mixpanel_events": {
      "email_sent": "Abandoned Cart Email Sent",
      "email_opened": "Abandoned Cart Email Opened",
      "email_clicked": "Abandoned Cart Email Clicked",
      "cart_recovered": "Abandoned Cart Recovered",
      "cart_excluded": "Cart Excluded from Recovery"
    },
    "custom_properties": {
      "include_cart_value": true,
      "include_item_count": true,
      "include_customer_segment": false,
      "include_device_type": false
    }
  },

  "error_handling": {
    "retry_on_api_failure": true,
    "max_retries": 3,
    "retry_delay_seconds": 60,
    "send_error_notifications": true,
    "error_notification_email": "devops@citadelbuy.com",
    "error_webhook_url": null,
    "continue_on_single_cart_failure": true,
    "log_level": "info"
  },

  "performance": {
    "batch_size": 100,
    "parallel_processing": false,
    "max_concurrent_carts": 10,
    "cache_related_products": false,
    "cache_ttl_seconds": 3600,
    "rate_limiting": {
      "enabled": false,
      "max_emails_per_minute": 60,
      "max_api_calls_per_second": 10
    }
  },

  "testing": {
    "test_mode": false,
    "test_email_override": null,
    "bypass_exclusion_rules": false,
    "bypass_timing_delays": false,
    "dry_run": false,
    "log_email_content": false
  },

  "compliance": {
    "gdpr_compliant": true,
    "include_unsubscribe_link": true,
    "include_physical_address": true,
    "physical_address": "CitadelBuy Inc., 123 Commerce St, New York, NY 10001",
    "data_retention_days": 90,
    "anonymize_after_days": 365,
    "respect_do_not_track": true
  },

  "advanced_features": {
    "ai_send_time_optimization": {
      "enabled": false,
      "description": "Use ML to determine optimal send time per customer",
      "ml_model_endpoint": null
    },
    "dynamic_product_recommendations": {
      "enabled": true,
      "description": "Use customer browsing history for recommendations",
      "fallback_to_category": true
    },
    "a_b_testing": {
      "enabled": false,
      "description": "Test different subject lines and discount amounts",
      "variants": []
    },
    "sms_notifications": {
      "enabled": false,
      "description": "Send SMS for high-value carts in stage 3",
      "provider": "twilio",
      "min_cart_value": 200
    },
    "push_notifications": {
      "enabled": false,
      "description": "Send mobile push notifications if customer has app",
      "provider": "onesignal"
    }
  },

  "monitoring": {
    "enable_health_checks": true,
    "health_check_url": "https://api.citadelbuy.com/health",
    "alert_on_zero_carts": true,
    "alert_on_high_exclusion_rate": true,
    "exclusion_rate_threshold": 0.5,
    "alert_on_low_conversion": true,
    "conversion_rate_threshold": 0.05,
    "dashboard_url": "https://mixpanel.com/report/citadelbuy/abandoned-cart",
    "slack_webhook": null,
    "pagerduty_integration": false
  },

  "environment_variables": {
    "required": [
      "CITADELBUY_API_KEY",
      "KLAVIYO_PUBLIC_API_KEY",
      "KLAVIYO_PRIVATE_API_KEY",
      "KLAVIYO_SUPPRESSION_LIST_ID",
      "ALGOLIA_APP_ID",
      "ALGOLIA_API_KEY",
      "MIXPANEL_PROJECT_TOKEN"
    ],
    "optional": [
      "ZENDESK_SUBDOMAIN",
      "ZENDESK_EMAIL",
      "ZENDESK_API_TOKEN",
      "ERROR_NOTIFICATION_EMAIL",
      "SLACK_WEBHOOK_URL"
    ]
  },

  "notes": {
    "version_history": "See README-abandoned-cart.md for version history",
    "last_updated": "2024-01-15",
    "maintained_by": "DevOps Team",
    "documentation": "https://docs.citadelbuy.com/automation/abandoned-cart"
  }
}
