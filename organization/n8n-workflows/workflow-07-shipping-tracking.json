{
  "name": "Broxiva Shipping & Tracking Updates",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "shipstation-tracking",
        "responseMode": "onReceived",
        "options": {}
      },
      "id": "webhook-shipstation",
      "name": "ShipStation Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "shipstation-tracking-webhook"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 2
            }
          ]
        }
      },
      "id": "schedule-polling",
      "name": "Schedule Polling (Every 2 Hours)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [240, 520]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://ssapi.shipstation.com/shipments",
        "authentication": "basicAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "modifyDateStart",
              "value": "={{ $now.minus({ hours: 2 }).toISO() }}"
            },
            {
              "name": "modifyDateEnd",
              "value": "={{ $now.toISO() }}"
            },
            {
              "name": "pageSize",
              "value": "500"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "fetch-shipstation-updates",
      "name": "Fetch ShipStation Updates",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [460, 520],
      "credentials": {
        "httpBasicAuth": {
          "id": "shipstation-api",
          "name": "ShipStation API Credentials"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "webhook-source",
              "name": "source",
              "value": "webhook",
              "type": "string"
            },
            {
              "id": "order-number",
              "name": "orderNumber",
              "value": "={{ $json.body.resource_url.split('/').pop() }}",
              "type": "string"
            },
            {
              "id": "tracking-number",
              "name": "trackingNumber",
              "value": "={{ $json.body.tracking_number }}",
              "type": "string"
            },
            {
              "id": "carrier",
              "name": "carrier",
              "value": "={{ $json.body.carrier }}",
              "type": "string"
            },
            {
              "id": "status",
              "name": "status",
              "value": "={{ $json.body.status }}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{ $json.body.occurred_at || $now.toISO() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "parse-webhook-data",
      "name": "Parse Webhook Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "polling-source",
              "name": "source",
              "value": "polling",
              "type": "string"
            },
            {
              "id": "order-number-poll",
              "name": "orderNumber",
              "value": "={{ $json.orderNumber }}",
              "type": "string"
            },
            {
              "id": "tracking-number-poll",
              "name": "trackingNumber",
              "value": "={{ $json.trackingNumber }}",
              "type": "string"
            },
            {
              "id": "carrier-poll",
              "name": "carrier",
              "value": "={{ $json.carrierCode }}",
              "type": "string"
            },
            {
              "id": "status-poll",
              "name": "status",
              "value": "={{ $json.shipmentStatus }}",
              "type": "string"
            },
            {
              "id": "shipped-date",
              "name": "shippedDate",
              "value": "={{ $json.shipDate }}",
              "type": "string"
            },
            {
              "id": "timestamp-poll",
              "name": "timestamp",
              "value": "={{ $json.modifyDate || $now.toISO() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "parse-polling-data",
      "name": "Parse Polling Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [680, 520]
    },
    {
      "parameters": {},
      "id": "merge-sources",
      "name": "Merge Sources",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [900, 410]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://ssapi.shipstation.com/shipments/{{ $json.trackingNumber }}/tracking",
        "authentication": "basicAuth",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "get-detailed-tracking",
      "name": "Get Detailed Tracking Info",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1120, 410],
      "credentials": {
        "httpBasicAuth": {
          "id": "shipstation-api",
          "name": "ShipStation API Credentials"
        }
      }
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.broxiva.com/v1/orders/{{ $json.orderNumber }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "broxivaApi",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "fetch-order-details",
      "name": "Fetch Order Details",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1340, 410],
      "credentials": {
        "broxivaApi": {
          "id": "broxiva-api",
          "name": "Broxiva API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "or",
          "conditions": [
            {
              "id": "fedex-carrier",
              "leftValue": "={{ $json.carrier.toLowerCase() }}",
              "rightValue": "fedex",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "ups-carrier",
              "leftValue": "={{ $json.carrier.toLowerCase() }}",
              "rightValue": "ups",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "usps-carrier",
              "leftValue": "={{ $json.carrier.toLowerCase() }}",
              "rightValue": "usps",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "dhl-carrier",
              "leftValue": "={{ $json.carrier.toLowerCase() }}",
              "rightValue": "dhl",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "validate-carrier",
      "name": "Validate Carrier (FedEx/UPS/USPS/DHL)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1560, 410]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "status-mapping",
              "name": "milestone",
              "value": "={{ \n  $json.status.toLowerCase().includes('shipped') ? 'shipped' :\n  $json.status.toLowerCase().includes('transit') ? 'in_transit' :\n  $json.status.toLowerCase().includes('out for delivery') ? 'out_for_delivery' :\n  $json.status.toLowerCase().includes('delivered') ? 'delivered' :\n  $json.status.toLowerCase().includes('exception') || $json.status.toLowerCase().includes('delay') ? 'exception' :\n  $json.status.toLowerCase().includes('attempt') && $json.status.toLowerCase().includes('fail') ? 'delivery_failed' :\n  'unknown'\n}}",
              "type": "string"
            },
            {
              "id": "tracking-url",
              "name": "trackingUrl",
              "value": "={{ \n  $json.carrier.toLowerCase().includes('fedex') ? 'https://www.fedex.com/fedextrack/?tracknumbers=' + $json.trackingNumber :\n  $json.carrier.toLowerCase().includes('ups') ? 'https://www.ups.com/track?tracknum=' + $json.trackingNumber :\n  $json.carrier.toLowerCase().includes('usps') ? 'https://tools.usps.com/go/TrackConfirmAction?tLabels=' + $json.trackingNumber :\n  $json.carrier.toLowerCase().includes('dhl') ? 'https://www.dhl.com/en/express/tracking.html?AWB=' + $json.trackingNumber :\n  'https://broxiva.com/track-order?tracking=' + $json.trackingNumber\n}}",
              "type": "string"
            },
            {
              "id": "estimated-delivery",
              "name": "estimatedDelivery",
              "value": "={{ $('Get Detailed Tracking Info').item.json.estimatedDeliveryDate || null }}",
              "type": "string"
            },
            {
              "id": "exception-type",
              "name": "exceptionType",
              "value": "={{ \n  $json.status.toLowerCase().includes('lost') ? 'lost' :\n  $json.status.toLowerCase().includes('delay') ? 'delayed' :\n  $json.status.toLowerCase().includes('attempt') && $json.status.toLowerCase().includes('fail') ? 'delivery_attempt_failed' :\n  null\n}}",
              "type": "string"
            },
            {
              "id": "delay-days",
              "name": "delayDays",
              "value": "={{ \n  $('Get Detailed Tracking Info').item.json.estimatedDeliveryDate && $('Get Detailed Tracking Info').item.json.originalEstimatedDeliveryDate ?\n  Math.floor((new Date($('Get Detailed Tracking Info').item.json.estimatedDeliveryDate) - new Date($('Get Detailed Tracking Info').item.json.originalEstimatedDeliveryDate)) / (1000 * 60 * 60 * 24)) :\n  0\n}}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "determine-milestone",
      "name": "Determine Milestone & Tracking URL",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "shipped-status",
              "leftValue": "={{ $json.milestone }}",
              "rightValue": "shipped",
              "operator": {
                "type": "string",
                "operation": "equals",
                "singleValue": true
              }
            }
          ]
        },
        "options": {}
      },
      "id": "switch-shipped",
      "name": "Shipped",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [2000, 100]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "in-transit-status",
              "leftValue": "={{ $json.milestone }}",
              "rightValue": "in_transit",
              "operator": {
                "type": "string",
                "operation": "equals",
                "singleValue": true
              }
            }
          ]
        },
        "options": {}
      },
      "id": "switch-in-transit",
      "name": "In Transit",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [2000, 240]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "out-for-delivery-status",
              "leftValue": "={{ $json.milestone }}",
              "rightValue": "out_for_delivery",
              "operator": {
                "type": "string",
                "operation": "equals",
                "singleValue": true
              }
            }
          ]
        },
        "options": {}
      },
      "id": "switch-out-for-delivery",
      "name": "Out For Delivery",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [2000, 380]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "delivered-status",
              "leftValue": "={{ $json.milestone }}",
              "rightValue": "delivered",
              "operator": {
                "type": "string",
                "operation": "equals",
                "singleValue": true
              }
            }
          ]
        },
        "options": {}
      },
      "id": "switch-delivered",
      "name": "Delivered",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [2000, 520]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "exception-status",
              "leftValue": "={{ $json.milestone }}",
              "rightValue": "exception",
              "operator": {
                "type": "string",
                "operation": "equals",
                "singleValue": true
              }
            }
          ]
        },
        "options": {}
      },
      "id": "switch-exception",
      "name": "Exception",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [2000, 660]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "delivery-failed-status",
              "leftValue": "={{ $json.milestone }}",
              "rightValue": "delivery_failed",
              "operator": {
                "type": "string",
                "operation": "equals",
                "singleValue": true
              }
            }
          ]
        },
        "options": {}
      },
      "id": "switch-delivery-failed",
      "name": "Delivery Failed",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [2000, 800]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "email-subject-shipped",
              "name": "emailSubject",
              "value": "=Your Order #{{ $json.orderNumber }} Has Shipped! ðŸ“¦",
              "type": "string"
            },
            {
              "id": "email-template-shipped",
              "name": "emailTemplate",
              "value": "shipped",
              "type": "string"
            },
            {
              "id": "email-data-shipped",
              "name": "emailData",
              "value": "={{ {\n  customerName: $('Fetch Order Details').item.json.customer.name,\n  orderNumber: $json.orderNumber,\n  trackingNumber: $json.trackingNumber,\n  trackingUrl: $json.trackingUrl,\n  carrier: $json.carrier,\n  estimatedDelivery: $json.estimatedDelivery,\n  items: $('Fetch Order Details').item.json.items,\n  supportUrl: 'https://broxiva.com/support'\n} }}",
              "type": "object"
            },
            {
              "id": "notification-type",
              "name": "notificationType",
              "value": "shipped",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-shipped-notification",
      "name": "Prepare Shipped Notification",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [2220, 100]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "email-subject-transit",
              "name": "emailSubject",
              "value": "=Order #{{ $json.orderNumber }} In Transit ðŸšš",
              "type": "string"
            },
            {
              "id": "email-template-transit",
              "name": "emailTemplate",
              "value": "in_transit",
              "type": "string"
            },
            {
              "id": "email-data-transit",
              "name": "emailData",
              "value": "={{ {\n  customerName: $('Fetch Order Details').item.json.customer.name,\n  orderNumber: $json.orderNumber,\n  trackingNumber: $json.trackingNumber,\n  trackingUrl: $json.trackingUrl,\n  carrier: $json.carrier,\n  estimatedDelivery: $json.estimatedDelivery,\n  estimatedDeliveryFormatted: new Date($json.estimatedDelivery).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }),\n  supportUrl: 'https://broxiva.com/support'\n} }}",
              "type": "object"
            },
            {
              "id": "notification-type-transit",
              "name": "notificationType",
              "value": "in_transit",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-transit-notification",
      "name": "Prepare In Transit Notification",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [2220, 240]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "email-subject-out-delivery",
              "name": "emailSubject",
              "value": "=Arriving Today! Order #{{ $json.orderNumber }} ðŸŽ‰",
              "type": "string"
            },
            {
              "id": "email-template-out-delivery",
              "name": "emailTemplate",
              "value": "out_for_delivery",
              "type": "string"
            },
            {
              "id": "email-data-out-delivery",
              "name": "emailData",
              "value": "={{ {\n  customerName: $('Fetch Order Details').item.json.customer.name,\n  orderNumber: $json.orderNumber,\n  trackingNumber: $json.trackingNumber,\n  trackingUrl: $json.trackingUrl,\n  carrier: $json.carrier,\n  deliveryAddress: $('Fetch Order Details').item.json.shippingAddress,\n  supportUrl: 'https://broxiva.com/support'\n} }}",
              "type": "object"
            },
            {
              "id": "notification-type-out-delivery",
              "name": "notificationType",
              "value": "out_for_delivery",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-out-delivery-notification",
      "name": "Prepare Out For Delivery Notification",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [2220, 380]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "email-subject-delivered",
              "name": "emailSubject",
              "value": "=Order #{{ $json.orderNumber }} Delivered! âœ…",
              "type": "string"
            },
            {
              "id": "email-template-delivered",
              "name": "emailTemplate",
              "value": "delivered",
              "type": "string"
            },
            {
              "id": "email-data-delivered",
              "name": "emailData",
              "value": "={{ {\n  customerName: $('Fetch Order Details').item.json.customer.name,\n  orderNumber: $json.orderNumber,\n  trackingNumber: $json.trackingNumber,\n  deliveredDate: new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }),\n  deliveryAddress: $('Fetch Order Details').item.json.shippingAddress,\n  reviewUrl: 'https://broxiva.com/review?order=' + $json.orderNumber,\n  reviewTeaser: 'Love your purchase? Share your experience and help others!',\n  supportUrl: 'https://broxiva.com/support'\n} }}",
              "type": "object"
            },
            {
              "id": "notification-type-delivered",
              "name": "notificationType",
              "value": "delivered",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-delivered-notification",
      "name": "Prepare Delivered Notification",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [2220, 520]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "delay-check",
              "leftValue": "={{ $json.delayDays }}",
              "rightValue": "2",
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "check-delay-severity",
      "name": "Check Delay >2 Days",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2220, 660]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.broxiva.com/v1/coupons/generate",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "broxivaApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"code\": \"DELAY{{ $json.orderNumber }}\",\n  \"discountType\": \"percentage\",\n  \"discountValue\": 10,\n  \"expiresIn\": 30,\n  \"customerId\": \"{{ $('Fetch Order Details').item.json.customer.id }}\",\n  \"reason\": \"shipping_delay_apology\",\n  \"maxUses\": 1\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "generate-delay-discount",
      "name": "Generate 10% Discount Code",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2440, 580],
      "credentials": {
        "broxivaApi": {
          "id": "broxiva-api",
          "name": "Broxiva API"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "email-subject-delay",
              "name": "emailSubject",
              "value": "=Important Update: Order #{{ $json.orderNumber }} Delayed",
              "type": "string"
            },
            {
              "id": "email-template-delay",
              "name": "emailTemplate",
              "value": "delayed_apology",
              "type": "string"
            },
            {
              "id": "email-data-delay",
              "name": "emailData",
              "value": "={{ {\n  customerName: $('Fetch Order Details').item.json.customer.name,\n  orderNumber: $json.orderNumber,\n  trackingNumber: $json.trackingNumber,\n  trackingUrl: $json.trackingUrl,\n  carrier: $json.carrier,\n  delayDays: $json.delayDays,\n  newEstimatedDelivery: new Date($json.estimatedDelivery).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }),\n  discountCode: $('Generate 10% Discount Code').item.json.code,\n  discountAmount: '10%',\n  supportUrl: 'https://broxiva.com/support',\n  contactEmail: 'support@broxiva.com'\n} }}",
              "type": "object"
            },
            {
              "id": "notification-type-delay",
              "name": "notificationType",
              "value": "delayed_apology",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-delay-notification",
      "name": "Prepare Delay Apology + Discount",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [2660, 580]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "email-subject-exception",
              "name": "emailSubject",
              "value": "=Update on Order #{{ $json.orderNumber }}",
              "type": "string"
            },
            {
              "id": "email-template-exception",
              "name": "emailTemplate",
              "value": "exception",
              "type": "string"
            },
            {
              "id": "email-data-exception",
              "name": "emailData",
              "value": "={{ {\n  customerName: $('Fetch Order Details').item.json.customer.name,\n  orderNumber: $json.orderNumber,\n  trackingNumber: $json.trackingNumber,\n  trackingUrl: $json.trackingUrl,\n  carrier: $json.carrier,\n  exceptionReason: $json.status,\n  supportUrl: 'https://broxiva.com/support',\n  contactEmail: 'support@broxiva.com',\n  contactPhone: '1-800-CITADEL'\n} }}",
              "type": "object"
            },
            {
              "id": "notification-type-exception",
              "name": "notificationType",
              "value": "exception",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-exception-notification",
      "name": "Prepare Exception Notification",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [2660, 740]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "email-subject-failed",
              "name": "emailSubject",
              "value": "=Delivery Attempt Failed - Order #{{ $json.orderNumber }}",
              "type": "string"
            },
            {
              "id": "email-template-failed",
              "name": "emailTemplate",
              "value": "delivery_failed",
              "type": "string"
            },
            {
              "id": "email-data-failed",
              "name": "emailData",
              "value": "={{ {\n  customerName: $('Fetch Order Details').item.json.customer.name,\n  orderNumber: $json.orderNumber,\n  trackingNumber: $json.trackingNumber,\n  trackingUrl: $json.trackingUrl,\n  carrier: $json.carrier,\n  attemptDate: new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }),\n  rescheduleUrl: $json.trackingUrl,\n  deliveryAddress: $('Fetch Order Details').item.json.shippingAddress,\n  supportUrl: 'https://broxiva.com/support',\n  contactEmail: 'support@broxiva.com'\n} }}",
              "type": "object"
            },
            {
              "id": "notification-type-failed",
              "name": "notificationType",
              "value": "delivery_failed",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-failed-notification",
      "name": "Prepare Delivery Failed Notification",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [2220, 800]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "lost-package-check",
              "leftValue": "={{ $json.exceptionType }}",
              "rightValue": "lost",
              "operator": {
                "type": "string",
                "operation": "equals",
                "singleValue": true
              }
            }
          ]
        },
        "options": {}
      },
      "id": "check-lost-package",
      "name": "Check if Lost Package",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2440, 740]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://broxiva.zendesk.com/api/v2/tickets",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "zendeskApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"ticket\": {\n    \"subject\": \"URGENT: Lost Package - Order #{{ $json.orderNumber }}\",\n    \"comment\": {\n      \"body\": \"Lost package reported for Order #{{ $json.orderNumber }}\\n\\nTracking: {{ $json.trackingNumber }}\\nCarrier: {{ $json.carrier }}\\nCustomer: {{ $('Fetch Order Details').item.json.customer.name }} ({{ $('Fetch Order Details').item.json.customer.email }})\\n\\nImmediate action required: Initiate replacement order and insurance claim.\"\n    },\n    \"priority\": \"urgent\",\n    \"type\": \"problem\",\n    \"tags\": [\"lost_package\", \"shipping\", \"replacement_needed\"],\n    \"custom_fields\": [\n      {\n        \"id\": 360000000000,\n        \"value\": \"{{ $json.orderNumber }}\"\n      }\n    ]\n  }\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "create-zendesk-ticket",
      "name": "Create Zendesk Escalation Ticket",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2660, 660],
      "credentials": {
        "zendeskApi": {
          "id": "zendesk-api",
          "name": "Zendesk API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.broxiva.com/v1/orders/replacement",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "broxivaApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"originalOrderId\": \"{{ $json.orderNumber }}\",\n  \"reason\": \"lost_package\",\n  \"trackingNumber\": \"{{ $json.trackingNumber }}\",\n  \"carrier\": \"{{ $json.carrier }}\",\n  \"priority\": \"high\",\n  \"expeditedShipping\": true,\n  \"zendeskTicketId\": \"{{ $('Create Zendesk Escalation Ticket').item.json.ticket.id }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "trigger-replacement",
      "name": "Trigger Replacement Order",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2880, 660],
      "credentials": {
        "broxivaApi": {
          "id": "broxiva-api",
          "name": "Broxiva API"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "email-subject-lost",
              "name": "emailSubject",
              "value": "=We're Sending You a Replacement - Order #{{ $json.orderNumber }}",
              "type": "string"
            },
            {
              "id": "email-template-lost",
              "name": "emailTemplate",
              "value": "lost_package",
              "type": "string"
            },
            {
              "id": "email-data-lost",
              "name": "emailData",
              "value": "={{ {\n  customerName: $('Fetch Order Details').item.json.customer.name,\n  orderNumber: $json.orderNumber,\n  trackingNumber: $json.trackingNumber,\n  carrier: $json.carrier,\n  replacementOrderNumber: $('Trigger Replacement Order').item.json.replacementOrderId,\n  zendeskTicketId: $('Create Zendesk Escalation Ticket').item.json.ticket.id,\n  estimatedReplacementDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }),\n  supportUrl: 'https://broxiva.com/support',\n  contactEmail: 'support@broxiva.com'\n} }}",
              "type": "object"
            },
            {
              "id": "notification-type-lost",
              "name": "notificationType",
              "value": "lost_package",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-lost-notification",
      "name": "Prepare Lost Package Notification",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [3100, 660]
    },
    {
      "parameters": {},
      "id": "merge-notifications",
      "name": "Merge All Notifications",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [2880, 380]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "email-opted-in",
              "leftValue": "={{ $('Fetch Order Details').item.json.customer.preferences.emailNotifications }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "check-email-preference",
      "name": "Check Email Preference",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3100, 200]
    },
    {
      "parameters": {
        "fromEmail": "shipping@broxiva.com",
        "toEmail": "={{ $('Fetch Order Details').item.json.customer.email }}",
        "subject": "={{ $json.emailSubject }}",
        "emailType": "html",
        "message": "=<!-- Email template will be rendered here -->\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: #0066cc; color: white; padding: 20px; text-align: center; }\n    .content { background: #f9f9f9; padding: 30px; }\n    .button { display: inline-block; padding: 12px 24px; background: #0066cc; color: white; text-decoration: none; border-radius: 4px; margin: 10px 0; }\n    .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }\n    .tracking-info { background: white; padding: 15px; border-left: 4px solid #0066cc; margin: 20px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>Broxiva Shipping Update</h1>\n    </div>\n    <div class=\"content\">\n      <h2>Hello {{ $json.emailData.customerName }}!</h2>\n      \n      {% if notificationType == 'shipped' %}\n        <p>Great news! Your order has been shipped and is on its way to you.</p>\n        <div class=\"tracking-info\">\n          <strong>Order Number:</strong> {{ $json.emailData.orderNumber }}<br>\n          <strong>Tracking Number:</strong> {{ $json.emailData.trackingNumber }}<br>\n          <strong>Carrier:</strong> {{ $json.emailData.carrier }}<br>\n          <strong>Estimated Delivery:</strong> {{ $json.emailData.estimatedDelivery }}\n        </div>\n        <a href=\"{{ $json.emailData.trackingUrl }}\" class=\"button\">Track Your Package</a>\n      {% endif %}\n      \n      {% if notificationType == 'in_transit' %}\n        <p>Your order is currently in transit and making its way to you!</p>\n        <div class=\"tracking-info\">\n          <strong>Order Number:</strong> {{ $json.emailData.orderNumber }}<br>\n          <strong>Estimated Delivery:</strong> {{ $json.emailData.estimatedDeliveryFormatted }}\n        </div>\n        <a href=\"{{ $json.emailData.trackingUrl }}\" class=\"button\">Track Your Package</a>\n      {% endif %}\n      \n      {% if notificationType == 'out_for_delivery' %}\n        <p><strong>Arriving today!</strong> Your package is out for delivery and should arrive shortly.</p>\n        <div class=\"tracking-info\">\n          <strong>Order Number:</strong> {{ $json.emailData.orderNumber }}<br>\n          <strong>Delivery Address:</strong> {{ $json.emailData.deliveryAddress.street }}, {{ $json.emailData.deliveryAddress.city }}\n        </div>\n      {% endif %}\n      \n      {% if notificationType == 'delivered' %}\n        <p>Your order has been delivered! We hope you love it.</p>\n        <div class=\"tracking-info\">\n          <strong>Order Number:</strong> {{ $json.emailData.orderNumber }}<br>\n          <strong>Delivered:</strong> {{ $json.emailData.deliveredDate }}\n        </div>\n        <p>{{ $json.emailData.reviewTeaser }}</p>\n        <a href=\"{{ $json.emailData.reviewUrl }}\" class=\"button\">Share Your Review</a>\n      {% endif %}\n      \n      {% if notificationType == 'delayed_apology' %}\n        <p>We sincerely apologize for the delay with your order. Your package has been delayed by {{ $json.emailData.delayDays }} days.</p>\n        <div class=\"tracking-info\">\n          <strong>New Estimated Delivery:</strong> {{ $json.emailData.newEstimatedDelivery }}\n        </div>\n        <p>As an apology, we'd like to offer you a <strong>{{ $json.emailData.discountAmount }} discount</strong> on your next order:</p>\n        <p style=\"font-size: 18px; font-weight: bold; color: #0066cc;\">Code: {{ $json.emailData.discountCode }}</p>\n      {% endif %}\n      \n      {% if notificationType == 'delivery_failed' %}\n        <p>We attempted to deliver your order on {{ $json.emailData.attemptDate }}, but were unable to complete the delivery.</p>\n        <div class=\"tracking-info\">\n          <strong>Order Number:</strong> {{ $json.emailData.orderNumber }}<br>\n          <strong>Delivery Address:</strong> {{ $json.emailData.deliveryAddress.street }}, {{ $json.emailData.deliveryAddress.city }}\n        </div>\n        <a href=\"{{ $json.emailData.rescheduleUrl }}\" class=\"button\">Reschedule Delivery</a>\n      {% endif %}\n      \n      {% if notificationType == 'lost_package' %}\n        <p>We're sorry to inform you that your package appears to be lost in transit. We're already taking action to make this right.</p>\n        <p><strong>We've automatically created a replacement order ({{ $json.emailData.replacementOrderNumber }}) with expedited shipping at no additional cost to you.</strong></p>\n        <div class=\"tracking-info\">\n          <strong>Original Order:</strong> {{ $json.emailData.orderNumber }}<br>\n          <strong>Replacement Order:</strong> {{ $json.emailData.replacementOrderNumber }}<br>\n          <strong>Estimated Delivery:</strong> {{ $json.emailData.estimatedReplacementDate }}<br>\n          <strong>Support Ticket:</strong> #{{ $json.emailData.zendeskTicketId }}\n        </div>\n      {% endif %}\n      \n      <p>If you have any questions, please don't hesitate to <a href=\"{{ $json.emailData.supportUrl }}\">contact our support team</a>.</p>\n    </div>\n    <div class=\"footer\">\n      <p>&copy; 2025 Broxiva. All rights reserved.</p>\n      <p>You're receiving this email because you placed an order with us.</p>\n    </div>\n  </div>\n</body>\n</html>",
        "options": {}
      },
      "id": "send-email-sendgrid",
      "name": "Send Email via SendGrid",
      "type": "n8n-nodes-base.sendGrid",
      "typeVersion": 1,
      "position": [3320, 100],
      "credentials": {
        "sendGridApi": {
          "id": "sendgrid-api",
          "name": "SendGrid API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "sms-opted-in",
              "leftValue": "={{ $('Fetch Order Details').item.json.customer.preferences.smsNotifications }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            },
            {
              "id": "has-phone",
              "leftValue": "={{ $('Fetch Order Details').item.json.customer.phone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "check-sms-preference",
      "name": "Check SMS Preference",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3100, 380]
    },
    {
      "parameters": {
        "fromPhoneNumber": "+1234567890",
        "toPhoneNumber": "={{ $('Fetch Order Details').item.json.customer.phone }}",
        "message": "={{ \n  $json.notificationType === 'shipped' ? 'Broxiva: Order #' + $json.orderNumber + ' shipped! Track: ' + $json.trackingUrl :\n  $json.notificationType === 'in_transit' ? 'Broxiva: Order #' + $json.orderNumber + ' in transit. ETA: ' + $json.emailData.estimatedDeliveryFormatted :\n  $json.notificationType === 'out_for_delivery' ? 'Broxiva: Your order #' + $json.orderNumber + ' is arriving today! ðŸŽ‰' :\n  $json.notificationType === 'delivered' ? 'Broxiva: Order #' + $json.orderNumber + ' delivered! Love it? Share a review: ' + $json.emailData.reviewUrl :\n  $json.notificationType === 'delayed_apology' ? 'Broxiva: Sorry for the delay on order #' + $json.orderNumber + '. Use code ' + $json.emailData.discountCode + ' for 10% off your next order.' :\n  $json.notificationType === 'delivery_failed' ? 'Broxiva: Delivery attempt failed for order #' + $json.orderNumber + '. Reschedule: ' + $json.emailData.rescheduleUrl :\n  $json.notificationType === 'lost_package' ? 'Broxiva: We\\'re sending a replacement for order #' + $json.orderNumber + '. New order #' + $json.emailData.replacementOrderNumber + ' with expedited shipping.' :\n  'Broxiva: Update on order #' + $json.orderNumber + '. Check email for details.'\n}}",
        "options": {}
      },
      "id": "send-sms-twilio",
      "name": "Send SMS via Twilio",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [3320, 300],
      "credentials": {
        "twilioApi": {
          "id": "twilio-api",
          "name": "Twilio API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": ""
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "whatsapp-opted-in",
              "leftValue": "={{ $('Fetch Order Details').item.json.customer.preferences.whatsappNotifications }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            },
            {
              "id": "has-whatsapp",
              "leftValue": "={{ $('Fetch Order Details').item.json.customer.whatsappNumber }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "check-whatsapp-preference",
      "name": "Check WhatsApp Preference",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3100, 560]
    },
    {
      "parameters": {
        "fromPhoneNumber": "whatsapp:+1234567890",
        "toPhoneNumber": "=whatsapp:{{ $('Fetch Order Details').item.json.customer.whatsappNumber }}",
        "message": "={{ \n  $json.notificationType === 'shipped' ? 'ðŸ“¦ Great news! Your Broxiva order #' + $json.orderNumber + ' has shipped!\\n\\nTrack your package: ' + $json.trackingUrl + '\\n\\nEstimated delivery: ' + $json.emailData.estimatedDelivery :\n  $json.notificationType === 'in_transit' ? 'ðŸšš Your order #' + $json.orderNumber + ' is on its way!\\n\\nExpected delivery: ' + $json.emailData.estimatedDeliveryFormatted + '\\n\\nTrack: ' + $json.trackingUrl :\n  $json.notificationType === 'out_for_delivery' ? 'ðŸŽ‰ Arriving today! Your order #' + $json.orderNumber + ' is out for delivery!\\n\\nGet ready to receive your package soon.' :\n  $json.notificationType === 'delivered' ? 'âœ… Delivered! Order #' + $json.orderNumber + ' has arrived.\\n\\nLove your purchase? Share your experience:\\n' + $json.emailData.reviewUrl :\n  $json.notificationType === 'delayed_apology' ? 'âš ï¸ We sincerely apologize - order #' + $json.orderNumber + ' has been delayed.\\n\\nNew ETA: ' + $json.emailData.newEstimatedDelivery + '\\n\\nAs an apology, here\\'s 10% off your next order:\\nCode: ' + $json.emailData.discountCode :\n  $json.notificationType === 'delivery_failed' ? 'âŒ Delivery attempt failed for order #' + $json.orderNumber + '.\\n\\nPlease reschedule:\\n' + $json.emailData.rescheduleUrl :\n  $json.notificationType === 'lost_package' ? 'ðŸ”„ We\\'re sorry - your package appears lost.\\n\\nDon\\'t worry! We\\'ve already created replacement order #' + $json.emailData.replacementOrderNumber + ' with expedited shipping.\\n\\nNew ETA: ' + $json.emailData.estimatedReplacementDate :\n  'Update on your Broxiva order #' + $json.orderNumber + '. Check your email for full details.'\n}}",
        "options": {}
      },
      "id": "send-whatsapp-twilio",
      "name": "Send WhatsApp via Twilio",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [3320, 500],
      "credentials": {
        "twilioApi": {
          "id": "twilio-api",
          "name": "Twilio API"
        }
      }
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://api.broxiva.com/v1/orders/{{ $json.orderNumber }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "broxivaApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"status\": \"{{ \n    $json.milestone === 'shipped' ? 'shipped' :\n    $json.milestone === 'in_transit' ? 'in_transit' :\n    $json.milestone === 'out_for_delivery' ? 'out_for_delivery' :\n    $json.milestone === 'delivered' ? 'delivered' :\n    $json.milestone === 'exception' ? 'exception' :\n    $json.milestone === 'delivery_failed' ? 'delivery_failed' :\n    'processing'\n  }}\",\n  \"trackingInfo\": {\n    \"trackingNumber\": \"{{ $json.trackingNumber }}\",\n    \"carrier\": \"{{ $json.carrier }}\",\n    \"trackingUrl\": \"{{ $json.trackingUrl }}\",\n    \"lastUpdate\": \"{{ $json.timestamp }}\",\n    \"estimatedDelivery\": \"{{ $json.estimatedDelivery }}\"\n  },\n  \"shipmentHistory\": [\n    {\n      \"status\": \"{{ $json.milestone }}\",\n      \"timestamp\": \"{{ $json.timestamp }}\",\n      \"location\": \"{{ $('Get Detailed Tracking Info').item.json.currentLocation || 'Unknown' }}\"\n    }\n  ]\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "update-order-status",
      "name": "Update Order Status in Broxiva",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [3540, 300],
      "credentials": {
        "broxivaApi": {
          "id": "broxiva-api",
          "name": "Broxiva API"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.mixpanel.com/track",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "mixpanelApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"event\": \"Shipping Milestone\",\n  \"properties\": {\n    \"distinct_id\": \"{{ $('Fetch Order Details').item.json.customer.id }}\",\n    \"order_id\": \"{{ $json.orderNumber }}\",\n    \"tracking_number\": \"{{ $json.trackingNumber }}\",\n    \"carrier\": \"{{ $json.carrier }}\",\n    \"milestone\": \"{{ $json.milestone }}\",\n    \"timestamp\": \"{{ $json.timestamp }}\",\n    \"estimated_delivery\": \"{{ $json.estimatedDelivery }}\",\n    \"delay_days\": {{ $json.delayDays || 0 }},\n    \"is_exception\": {{ $json.milestone === 'exception' || $json.milestone === 'delivery_failed' }},\n    \"is_delayed\": {{ $json.delayDays > 0 }},\n    \"notification_sent_email\": {{ $('Fetch Order Details').item.json.customer.preferences.emailNotifications }},\n    \"notification_sent_sms\": {{ $('Fetch Order Details').item.json.customer.preferences.smsNotifications }},\n    \"notification_sent_whatsapp\": {{ $('Fetch Order Details').item.json.customer.preferences.whatsappNotifications }}\n  }\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "track-carrier-performance",
      "name": "Track Carrier Performance in Mixpanel",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [3760, 300],
      "credentials": {
        "mixpanelApi": {
          "id": "mixpanel-api",
          "name": "Mixpanel API"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "workflow-result",
              "name": "workflowResult",
              "value": "=Shipping update processed successfully for Order #{{ $json.orderNumber }}",
              "type": "string"
            },
            {
              "id": "milestone-result",
              "name": "milestone",
              "value": "={{ $json.milestone }}",
              "type": "string"
            },
            {
              "id": "notifications-sent",
              "name": "notificationsSent",
              "value": "={{ {\n  email: $('Fetch Order Details').item.json.customer.preferences.emailNotifications,\n  sms: $('Fetch Order Details').item.json.customer.preferences.smsNotifications,\n  whatsapp: $('Fetch Order Details').item.json.customer.preferences.whatsappNotifications\n} }}",
              "type": "object"
            },
            {
              "id": "order-updated",
              "name": "orderUpdated",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "analytics-tracked",
              "name": "analyticsTracked",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "id": "final-output",
      "name": "Workflow Complete",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [3980, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "error-message",
              "name": "errorMessage",
              "value": "=Unsupported carrier: {{ $json.carrier }}. Only FedEx, UPS, USPS, and DHL are supported.",
              "type": "string"
            },
            {
              "id": "error-order",
              "name": "orderNumber",
              "value": "={{ $json.orderNumber }}",
              "type": "string"
            },
            {
              "id": "error-tracking",
              "name": "trackingNumber",
              "value": "={{ $json.trackingNumber }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "unsupported-carrier-error",
      "name": "Unsupported Carrier Error",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [1780, 520]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://broxiva.zendesk.com/api/v2/tickets",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "zendeskApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"ticket\": {\n    \"subject\": \"Unsupported Carrier Alert - Order #{{ $json.orderNumber }}\",\n    \"comment\": {\n      \"body\": \"An unsupported carrier was detected:\\n\\nOrder: {{ $json.orderNumber }}\\nTracking: {{ $json.trackingNumber }}\\nCarrier: {{ $json.carrier }}\\n\\nPlease review and configure carrier support.\"\n    },\n    \"priority\": \"normal\",\n    \"type\": \"task\",\n    \"tags\": [\"unsupported_carrier\", \"shipping\", \"configuration\"]\n  }\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "log-unsupported-carrier",
      "name": "Log Unsupported Carrier to Zendesk",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2000, 520],
      "credentials": {
        "zendeskApi": {
          "id": "zendesk-api",
          "name": "Zendesk API"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "ShipStation Webhook": {
      "main": [
        [
          {
            "node": "Parse Webhook Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Polling (Every 2 Hours)": {
      "main": [
        [
          {
            "node": "Fetch ShipStation Updates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch ShipStation Updates": {
      "main": [
        [
          {
            "node": "Parse Polling Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Webhook Data": {
      "main": [
        [
          {
            "node": "Merge Sources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Polling Data": {
      "main": [
        [
          {
            "node": "Merge Sources",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Sources": {
      "main": [
        [
          {
            "node": "Get Detailed Tracking Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Detailed Tracking Info": {
      "main": [
        [
          {
            "node": "Fetch Order Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Order Details": {
      "main": [
        [
          {
            "node": "Validate Carrier (FedEx/UPS/USPS/DHL)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Carrier (FedEx/UPS/USPS/DHL)": {
      "main": [
        [
          {
            "node": "Determine Milestone & Tracking URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Unsupported Carrier Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Determine Milestone & Tracking URL": {
      "main": [
        [
          {
            "node": "Shipped",
            "type": "main",
            "index": 0
          },
          {
            "node": "In Transit",
            "type": "main",
            "index": 0
          },
          {
            "node": "Out For Delivery",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delivered",
            "type": "main",
            "index": 0
          },
          {
            "node": "Exception",
            "type": "main",
            "index": 0
          },
          {
            "node": "Delivery Failed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Shipped": {
      "main": [
        [
          {
            "node": "Prepare Shipped Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "In Transit": {
      "main": [
        [
          {
            "node": "Prepare In Transit Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Out For Delivery": {
      "main": [
        [
          {
            "node": "Prepare Out For Delivery Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delivered": {
      "main": [
        [
          {
            "node": "Prepare Delivered Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Exception": {
      "main": [
        [
          {
            "node": "Check Delay Severity",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check if Lost Package",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delivery Failed": {
      "main": [
        [
          {
            "node": "Prepare Delivery Failed Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Delay Severity": {
      "main": [
        [
          {
            "node": "Generate 10% Discount Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Exception Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate 10% Discount Code": {
      "main": [
        [
          {
            "node": "Prepare Delay Apology + Discount",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Lost Package": {
      "main": [
        [
          {
            "node": "Create Zendesk Escalation Ticket",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Exception Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Zendesk Escalation Ticket": {
      "main": [
        [
          {
            "node": "Trigger Replacement Order",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Replacement Order": {
      "main": [
        [
          {
            "node": "Prepare Lost Package Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Shipped Notification": {
      "main": [
        [
          {
            "node": "Merge All Notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare In Transit Notification": {
      "main": [
        [
          {
            "node": "Merge All Notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Out For Delivery Notification": {
      "main": [
        [
          {
            "node": "Merge All Notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Delivered Notification": {
      "main": [
        [
          {
            "node": "Merge All Notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Delay Apology + Discount": {
      "main": [
        [
          {
            "node": "Merge All Notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Exception Notification": {
      "main": [
        [
          {
            "node": "Merge All Notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Delivery Failed Notification": {
      "main": [
        [
          {
            "node": "Merge All Notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Lost Package Notification": {
      "main": [
        [
          {
            "node": "Merge All Notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge All Notifications": {
      "main": [
        [
          {
            "node": "Check Email Preference",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check SMS Preference",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check WhatsApp Preference",
            "type": "main",
            "index": 0
          },
          {
            "node": "Update Order Status in Broxiva",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Email Preference": {
      "main": [
        [
          {
            "node": "Send Email via SendGrid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check SMS Preference": {
      "main": [
        [
          {
            "node": "Send SMS via Twilio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check WhatsApp Preference": {
      "main": [
        [
          {
            "node": "Send WhatsApp via Twilio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Order Status in Broxiva": {
      "main": [
        [
          {
            "node": "Track Carrier Performance in Mixpanel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Track Carrier Performance in Mixpanel": {
      "main": [
        [
          {
            "node": "Workflow Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unsupported Carrier Error": {
      "main": [
        [
          {
            "node": "Log Unsupported Carrier to Zendesk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "versionId": "1",
  "id": "workflow-07-shipping-tracking",
  "meta": {
    "instanceId": "broxiva-production"
  },
  "tags": [
    {
      "id": "shipping",
      "name": "Shipping"
    },
    {
      "id": "tracking",
      "name": "Tracking"
    },
    {
      "id": "notifications",
      "name": "Notifications"
    },
    {
      "id": "customer-experience",
      "name": "Customer Experience"
    }
  ]
}
