{
  "name": "Broxiva Customer Feedback & Review Collection",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "shipment-delivered",
        "options": {
          "allowedOrigins": "https://api.broxiva.com,https://ship.shipstation.com"
        }
      },
      "id": "webhook-shipment-delivered",
      "name": "Webhook: Shipment Delivered",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        300
      ],
      "webhookId": "shipment-delivered-feedback"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://api.broxiva.com/v1/orders/{{ $json.order_id }}",
        "options": {
          "allowUnauthorizedCerts": false
        }
      },
      "id": "get-order-details",
      "name": "Get Order Details",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        460,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "broxiva-api-key",
          "name": "Broxiva API Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://api.broxiva.com/v1/users/{{ $json.user_id }}",
        "options": {}
      },
      "id": "get-customer-details",
      "name": "Get Customer Details",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        680,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "broxiva-api-key",
          "name": "Broxiva API Key"
        }
      }
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "days"
      },
      "id": "wait-5-days",
      "name": "Wait 5 Days (Configurable)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        900,
        300
      ],
      "webhookId": "wait-feedback-delay"
    },
    {
      "parameters": {
        "jsCode": "const orderData = $input.first().json;\nconst customerData = $input.all()[1].json;\n\n// Build product list with images\nconst products = orderData.items.map(item => ({\n  id: item.product_id,\n  name: item.name,\n  image: item.image_url || `https://cdn.broxiva.com/products/${item.product_id}/thumb.jpg`,\n  price: item.price,\n  quantity: item.quantity,\n  sku: item.sku\n}));\n\n// Calculate if NPS survey should be sent\nconst orderTotal = orderData.total_amount;\nconst shouldSendNPS = orderTotal > 200;\n\n// Generate unique review token\nconst reviewToken = Buffer.from(`${orderData.id}:${Date.now()}`).toString('base64');\n\n// Build review URLs with pre-filled data\nconst reviewUrls = {\n  broxiva: `https://broxiva.com/review/${reviewToken}`,\n  google: `https://g.page/r/broxiva/review`,\n  trustpilot: `https://www.trustpilot.com/evaluate/broxiva.com?utm_medium=email&utm_source=order_${orderData.id}`\n};\n\n// Build star rating quick links (1-click rating)\nconst starRatingUrls = {\n  1: `https://broxiva.com/api/v1/reviews/quick-rate?token=${reviewToken}&rating=1`,\n  2: `https://broxiva.com/api/v1/reviews/quick-rate?token=${reviewToken}&rating=2`,\n  3: `https://broxiva.com/api/v1/reviews/quick-rate?token=${reviewToken}&rating=3`,\n  4: `https://broxiva.com/api/v1/reviews/quick-rate?token=${reviewToken}&rating=4`,\n  5: `https://broxiva.com/api/v1/reviews/quick-rate?token=${reviewToken}&rating=5`\n};\n\nreturn {\n  json: {\n    order_id: orderData.id,\n    order_number: orderData.order_number,\n    order_total: orderTotal,\n    customer_email: customerData.email,\n    customer_name: customerData.name || customerData.first_name + ' ' + customerData.last_name,\n    customer_id: customerData.id,\n    products: products,\n    review_token: reviewToken,\n    review_urls: reviewUrls,\n    star_rating_urls: starRatingUrls,\n    should_send_nps: shouldSendNPS,\n    delivery_date: orderData.delivered_at || new Date().toISOString(),\n    tracking_number: orderData.tracking_number,\n    carrier: orderData.carrier || 'USPS'\n  }\n};"
      },
      "id": "prepare-feedback-data",
      "name": "Prepare Feedback Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "apiKey",
        "fromEmail": "reviews@broxiva.com",
        "toEmail": "={{ $json.customer_email }}",
        "subject": "How was your Broxiva experience? Share your thoughts!",
        "emailType": "html",
        "message": "={{ $json.html_content }}",
        "options": {
          "templateId": "d-broxiva-review-request-v2",
          "dynamicTemplateData": {
            "customer_name": "={{ $json.customer_name }}",
            "order_number": "={{ $json.order_number }}",
            "products": "={{ $json.products }}",
            "review_url": "={{ $json.review_urls.broxiva }}",
            "google_review_url": "={{ $json.review_urls.google }}",
            "trustpilot_url": "={{ $json.review_urls.trustpilot }}",
            "star_1_url": "={{ $json.star_rating_urls[1] }}",
            "star_2_url": "={{ $json.star_rating_urls[2] }}",
            "star_3_url": "={{ $json.star_rating_urls[3] }}",
            "star_4_url": "={{ $json.star_rating_urls[4] }}",
            "star_5_url": "={{ $json.star_rating_urls[5] }}",
            "delivery_date": "={{ $json.delivery_date }}",
            "tracking_number": "={{ $json.tracking_number }}"
          },
          "customArgs": {
            "order_id": "={{ $json.order_id }}",
            "review_token": "={{ $json.review_token }}",
            "workflow": "feedback-collection"
          }
        }
      },
      "id": "send-review-request-email",
      "name": "Send Review Request (SendGrid)",
      "type": "n8n-nodes-base.sendGrid",
      "typeVersion": 1,
      "position": [
        1340,
        300
      ],
      "credentials": {
        "sendGridApi": {
          "id": "sendgrid-broxiva",
          "name": "SendGrid Broxiva"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "method": "POST",
        "url": "https://api.broxiva.com/v1/reviews/requests",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "order_id",
              "value": "={{ $json.order_id }}"
            },
            {
              "name": "customer_id",
              "value": "={{ $json.customer_id }}"
            },
            {
              "name": "review_token",
              "value": "={{ $json.review_token }}"
            },
            {
              "name": "email_sent_at",
              "value": "={{ new Date().toISOString() }}"
            },
            {
              "name": "status",
              "value": "sent"
            },
            {
              "name": "reminder_scheduled_at",
              "value": "={{ new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString() }}"
            }
          ]
        },
        "options": {}
      },
      "id": "log-review-request",
      "name": "Log Review Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1560,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "broxiva-api-key",
          "name": "Broxiva API Key"
        }
      }
    },
    {
      "parameters": {
        "amount": 3,
        "unit": "days"
      },
      "id": "wait-3-days-reminder",
      "name": "Wait 3 Days for Response",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        1780,
        300
      ],
      "webhookId": "wait-reminder-check"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "https://api.broxiva.com/v1/reviews/requests/{{ $json.review_token }}/status",
        "options": {}
      },
      "id": "check-review-status",
      "name": "Check Review Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2000,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "broxiva-api-key",
          "name": "Broxiva API Key"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.status }}",
              "operation": "equals",
              "value2": "pending"
            }
          ]
        }
      },
      "id": "if-no-response",
      "name": "IF: No Response Yet",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2220,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "apiKey",
        "method": "POST",
        "url": "https://a.klaviyo.com/api/v1/track",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "={{ $credentials.klaviyoApiKey }}"
            },
            {
              "name": "event",
              "value": "Review Reminder"
            },
            {
              "name": "customer_properties",
              "value": "={{ { \"$email\": $json.customer_email, \"$first_name\": $json.customer_name.split(' ')[0], \"order_id\": $json.order_id } }}"
            },
            {
              "name": "properties",
              "value": "={{ { \"review_url\": $json.review_urls.broxiva, \"order_number\": $json.order_number, \"products\": $json.products } }}"
            }
          ]
        },
        "options": {}
      },
      "id": "send-reminder-klaviyo",
      "name": "Send Gentle Reminder (Klaviyo)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2440,
        200
      ],
      "credentials": {
        "klaviyoApi": {
          "id": "klaviyo-broxiva",
          "name": "Klaviyo Broxiva"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "review-submitted",
        "options": {
          "allowedOrigins": "https://broxiva.com,https://api.broxiva.com"
        }
      },
      "id": "webhook-review-submitted",
      "name": "Webhook: Review Submitted",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        600
      ],
      "webhookId": "review-submitted-feedback"
    },
    {
      "parameters": {
        "jsCode": "const reviewData = $input.first().json;\n\n// Extract rating and review text\nconst rating = reviewData.rating || reviewData.stars || 0;\nconst reviewText = reviewData.review || reviewData.comment || '';\nconst reviewToken = reviewData.token || reviewData.review_token;\n\nreturn {\n  json: {\n    review_id: reviewData.review_id || reviewData.id,\n    order_id: reviewData.order_id,\n    customer_id: reviewData.customer_id,\n    customer_email: reviewData.customer_email,\n    customer_name: reviewData.customer_name,\n    rating: rating,\n    review_text: reviewText,\n    review_token: reviewToken,\n    submitted_at: new Date().toISOString(),\n    is_positive: rating >= 4,\n    is_negative: rating <= 2,\n    product_ids: reviewData.product_ids || []\n  }\n};"
      },
      "id": "parse-review-data",
      "name": "Parse Review Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        600
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.rating }}",
              "operation": "largerEqual",
              "value2": 4
            }
          ]
        }
      },
      "id": "if-positive-review",
      "name": "IF: Positive Review (â‰¥4)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        680,
        600
      ]
    },
    {
      "parameters": {
        "authentication": "apiKey",
        "fromEmail": "thank-you@broxiva.com",
        "toEmail": "={{ $json.customer_email }}",
        "subject": "Thank you for your amazing review!",
        "emailType": "html",
        "options": {
          "templateId": "d-broxiva-review-thank-you",
          "dynamicTemplateData": {
            "customer_name": "={{ $json.customer_name }}",
            "rating": "={{ $json.rating }}",
            "referral_url": "https://broxiva.com/refer?code={{ $json.customer_id }}",
            "discount_code": "THANKYOU15"
          }
        }
      },
      "id": "send-thank-you-email",
      "name": "Send Thank You Email",
      "type": "n8n-nodes-base.sendGrid",
      "typeVersion": 1,
      "position": [
        900,
        500
      ],
      "credentials": {
        "sendGridApi": {
          "id": "sendgrid-broxiva",
          "name": "SendGrid Broxiva"
        }
      }
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "method": "POST",
        "url": "https://api.broxiva.com/v1/referrals/invitations",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "customer_id",
              "value": "={{ $json.customer_id }}"
            },
            {
              "name": "customer_email",
              "value": "={{ $json.customer_email }}"
            },
            {
              "name": "trigger",
              "value": "positive_review"
            },
            {
              "name": "discount_code",
              "value": "THANKYOU15"
            },
            {
              "name": "created_at",
              "value": "={{ new Date().toISOString() }}"
            }
          ]
        },
        "options": {}
      },
      "id": "send-referral-invitation",
      "name": "Send Referral Program Invitation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1120,
        500
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "broxiva-api-key",
          "name": "Broxiva API Key"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.rating }}",
              "operation": "smallerEqual",
              "value2": 2
            }
          ]
        }
      },
      "id": "if-negative-review",
      "name": "IF: Negative Review (â‰¤2)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        680,
        800
      ]
    },
    {
      "parameters": {
        "fromEmail": "alerts@broxiva.com",
        "toEmail": "support@broxiva.com",
        "subject": "URGENT: Negative Review Alert - Order #{{ $json.order_id }}",
        "emailType": "html",
        "message": "=<h2>Negative Review Alert</h2>\n<p><strong>Order ID:</strong> {{ $json.order_id }}</p>\n<p><strong>Customer:</strong> {{ $json.customer_name }} ({{ $json.customer_email }})</p>\n<p><strong>Rating:</strong> {{ $json.rating }} / 5 stars</p>\n<p><strong>Review:</strong></p>\n<blockquote>{{ $json.review_text }}</blockquote>\n<p><strong>Submitted:</strong> {{ $json.submitted_at }}</p>\n<hr>\n<p>A Zendesk ticket has been automatically created.</p>\n<p><a href=\"https://broxiva.zendesk.com/agent/tickets/{{ $json.zendesk_ticket_id }}\">View Ticket</a></p>",
        "options": {}
      },
      "id": "alert-support-team",
      "name": "Alert Support Team",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [
        900,
        700
      ],
      "credentials": {
        "smtp": {
          "id": "smtp-broxiva",
          "name": "Broxiva SMTP"
        }
      }
    },
    {
      "parameters": {
        "authentication": "apiKey",
        "method": "POST",
        "url": "https://broxiva.zendesk.com/api/v2/tickets",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "ticket",
              "value": "={{ { \"subject\": \"Negative Review - Order #\" + $json.order_id, \"comment\": { \"body\": \"Customer \" + $json.customer_name + \" (\" + $json.customer_email + \") left a \" + $json.rating + \" star review.\\n\\nReview: \" + $json.review_text }, \"priority\": \"urgent\", \"tags\": [\"negative_review\", \"customer_feedback\", \"order_\" + $json.order_id], \"custom_fields\": [{ \"id\": 360000000001, \"value\": $json.order_id }] } }}"
            }
          ]
        },
        "options": {
          "bodyContentType": "json"
        }
      },
      "id": "create-zendesk-ticket",
      "name": "Create Zendesk Ticket",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        900,
        900
      ],
      "credentials": {
        "zendeskApi": {
          "id": "zendesk-broxiva",
          "name": "Zendesk Broxiva"
        }
      }
    },
    {
      "parameters": {
        "operation": "message",
        "resource": "chat",
        "authentication": "accessToken",
        "text": "ðŸš¨ *Negative Review Alert*\n\n*Order:* #{{ $json.order_id }}\n*Customer:* {{ $json.customer_name }}\n*Rating:* {{ $json.rating }}â­\n*Review:* {{ $json.review_text }}\n\nZendesk ticket created: https://broxiva.zendesk.com/agent/tickets/{{ $json.zendesk_ticket_id }}",
        "channel": "#customer-support",
        "options": {}
      },
      "id": "slack-alert-negative-review",
      "name": "Slack Alert: Negative Review",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [
        1120,
        900
      ],
      "credentials": {
        "slackApi": {
          "id": "slack-broxiva",
          "name": "Slack Broxiva"
        }
      }
    },
    {
      "parameters": {
        "resource": "text",
        "operation": "message",
        "model": "gpt-4",
        "text": "=Analyze the sentiment of this customer review and provide insights:\n\nRating: {{ $json.rating }}/5\nReview: {{ $json.review_text }}\n\nProvide:\n1. Sentiment score (0-100)\n2. Key themes/topics\n3. Emotional tone\n4. Action items for the business\n5. Category (product quality, shipping, customer service, etc.)\n\nReturn as JSON.",
        "options": {}
      },
      "id": "sentiment-analysis-openai",
      "name": "Sentiment Analysis (OpenAI)",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        900,
        600
      ],
      "credentials": {
        "openAiApi": {
          "id": "openai-broxiva",
          "name": "OpenAI Broxiva"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const reviewData = $input.first().json;\nconst sentimentData = $input.all()[1].json;\n\nlet sentiment = {};\ntry {\n  // Parse OpenAI response\n  const aiResponse = sentimentData.message?.content || sentimentData.text || '{}';\n  sentiment = JSON.parse(aiResponse);\n} catch (e) {\n  sentiment = {\n    sentiment_score: reviewData.rating * 20, // Fallback: convert 1-5 to 0-100\n    themes: [],\n    tone: 'neutral',\n    action_items: [],\n    category: 'general'\n  };\n}\n\nreturn {\n  json: {\n    ...reviewData,\n    sentiment_score: sentiment.sentiment_score || 0,\n    themes: sentiment.themes || [],\n    emotional_tone: sentiment.tone || 'neutral',\n    action_items: sentiment.action_items || [],\n    category: sentiment.category || 'general'\n  }\n};"
      },
      "id": "merge-sentiment-data",
      "name": "Merge Sentiment Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        700
      ]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "method": "POST",
        "url": "https://api.broxiva.com/v1/reviews",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "review_id",
              "value": "={{ $json.review_id }}"
            },
            {
              "name": "order_id",
              "value": "={{ $json.order_id }}"
            },
            {
              "name": "customer_id",
              "value": "={{ $json.customer_id }}"
            },
            {
              "name": "rating",
              "value": "={{ $json.rating }}"
            },
            {
              "name": "review_text",
              "value": "={{ $json.review_text }}"
            },
            {
              "name": "sentiment_score",
              "value": "={{ $json.sentiment_score }}"
            },
            {
              "name": "themes",
              "value": "={{ $json.themes }}"
            },
            {
              "name": "emotional_tone",
              "value": "={{ $json.emotional_tone }}"
            },
            {
              "name": "category",
              "value": "={{ $json.category }}"
            },
            {
              "name": "action_items",
              "value": "={{ $json.action_items }}"
            },
            {
              "name": "submitted_at",
              "value": "={{ $json.submitted_at }}"
            }
          ]
        },
        "options": {
          "bodyContentType": "json"
        }
      },
      "id": "save-review-with-sentiment",
      "name": "Save Review with Sentiment",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1340,
        700
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "broxiva-api-key",
          "name": "Broxiva API Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "apiKey",
        "method": "POST",
        "url": "https://api.mixpanel.com/track",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "event",
              "value": "Review Submitted"
            },
            {
              "name": "properties",
              "value": "={{ { \"distinct_id\": $json.customer_id, \"order_id\": $json.order_id, \"rating\": $json.rating, \"sentiment_score\": $json.sentiment_score, \"category\": $json.category, \"is_positive\": $json.is_positive, \"is_negative\": $json.is_negative, \"time\": Date.now() / 1000 } }}"
            }
          ]
        },
        "options": {
          "bodyContentType": "json"
        }
      },
      "id": "track-mixpanel",
      "name": "Track in Mixpanel",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1560,
        700
      ],
      "credentials": {
        "mixpanelApi": {
          "id": "mixpanel-broxiva",
          "name": "Mixpanel Broxiva"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.should_send_nps }}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-nps-eligible",
      "name": "IF: Order > $200 (NPS Eligible)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1340,
        400
      ]
    },
    {
      "parameters": {
        "authentication": "apiKey",
        "fromEmail": "feedback@broxiva.com",
        "toEmail": "={{ $json.customer_email }}",
        "subject": "How likely are you to recommend Broxiva?",
        "emailType": "html",
        "options": {
          "templateId": "d-broxiva-nps-survey",
          "dynamicTemplateData": {
            "customer_name": "={{ $json.customer_name }}",
            "order_number": "={{ $json.order_number }}",
            "order_total": "={{ $json.order_total }}",
            "nps_url": "https://broxiva.com/nps-survey/{{ $json.review_token }}"
          }
        }
      },
      "id": "send-nps-survey",
      "name": "Send NPS Survey",
      "type": "n8n-nodes-base.sendGrid",
      "typeVersion": 1,
      "position": [
        1560,
        400
      ],
      "credentials": {
        "sendGridApi": {
          "id": "sendgrid-broxiva",
          "name": "SendGrid Broxiva"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "nps-response",
        "options": {}
      },
      "id": "webhook-nps-response",
      "name": "Webhook: NPS Response",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        1000
      ],
      "webhookId": "nps-response-feedback"
    },
    {
      "parameters": {
        "jsCode": "const npsData = $input.first().json;\n\nconst npsScore = parseInt(npsData.score || npsData.rating || 0);\nlet npsCategory = 'passive';\n\nif (npsScore >= 9) {\n  npsCategory = 'promoter';\n} else if (npsScore <= 6) {\n  npsCategory = 'detractor';\n}\n\nreturn {\n  json: {\n    customer_id: npsData.customer_id,\n    customer_email: npsData.customer_email,\n    order_id: npsData.order_id,\n    nps_score: npsScore,\n    nps_category: npsCategory,\n    feedback: npsData.feedback || '',\n    submitted_at: new Date().toISOString()\n  }\n};"
      },
      "id": "process-nps-score",
      "name": "Process NPS Score",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        1000
      ]
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "method": "POST",
        "url": "https://api.broxiva.com/v1/nps/responses",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "customer_id",
              "value": "={{ $json.customer_id }}"
            },
            {
              "name": "order_id",
              "value": "={{ $json.order_id }}"
            },
            {
              "name": "score",
              "value": "={{ $json.nps_score }}"
            },
            {
              "name": "category",
              "value": "={{ $json.nps_category }}"
            },
            {
              "name": "feedback",
              "value": "={{ $json.feedback }}"
            },
            {
              "name": "submitted_at",
              "value": "={{ $json.submitted_at }}"
            }
          ]
        },
        "options": {
          "bodyContentType": "json"
        }
      },
      "id": "save-nps-response",
      "name": "Save NPS Response",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        680,
        1000
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "broxiva-api-key",
          "name": "Broxiva API Key"
        }
      }
    },
    {
      "parameters": {
        "authentication": "apiKey",
        "method": "POST",
        "url": "https://api.mixpanel.com/track",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "event",
              "value": "NPS Survey Completed"
            },
            {
              "name": "properties",
              "value": "={{ { \"distinct_id\": $json.customer_id, \"order_id\": $json.order_id, \"nps_score\": $json.nps_score, \"nps_category\": $json.nps_category, \"time\": Date.now() / 1000 } }}"
            }
          ]
        },
        "options": {
          "bodyContentType": "json"
        }
      },
      "id": "track-nps-mixpanel",
      "name": "Track NPS in Mixpanel",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        900,
        1000
      ],
      "credentials": {
        "mixpanelApi": {
          "id": "mixpanel-broxiva",
          "name": "Mixpanel Broxiva"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.broxiva.com/v1/analytics/aggregate-scores",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metric_type",
              "value": "daily_nps"
            },
            {
              "name": "date",
              "value": "={{ new Date().toISOString().split('T')[0] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "trigger-score-aggregation",
      "name": "Trigger Score Aggregation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1120,
        1000
      ]
    }
  ],
  "connections": {
    "Webhook: Shipment Delivered": {
      "main": [
        [
          {
            "node": "Get Order Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Order Details": {
      "main": [
        [
          {
            "node": "Get Customer Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Customer Details": {
      "main": [
        [
          {
            "node": "Wait 5 Days (Configurable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 5 Days (Configurable)": {
      "main": [
        [
          {
            "node": "Prepare Feedback Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Feedback Data": {
      "main": [
        [
          {
            "node": "Send Review Request (SendGrid)",
            "type": "main",
            "index": 0
          },
          {
            "node": "IF: Order > $200 (NPS Eligible)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Review Request (SendGrid)": {
      "main": [
        [
          {
            "node": "Log Review Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Review Request": {
      "main": [
        [
          {
            "node": "Wait 3 Days for Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 3 Days for Response": {
      "main": [
        [
          {
            "node": "Check Review Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Review Status": {
      "main": [
        [
          {
            "node": "IF: No Response Yet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: No Response Yet": {
      "main": [
        [
          {
            "node": "Send Gentle Reminder (Klaviyo)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: Review Submitted": {
      "main": [
        [
          {
            "node": "Parse Review Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Review Data": {
      "main": [
        [
          {
            "node": "IF: Positive Review (â‰¥4)",
            "type": "main",
            "index": 0
          },
          {
            "node": "IF: Negative Review (â‰¤2)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Sentiment Analysis (OpenAI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Positive Review (â‰¥4)": {
      "main": [
        [
          {
            "node": "Send Thank You Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Thank You Email": {
      "main": [
        [
          {
            "node": "Send Referral Program Invitation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Negative Review (â‰¤2)": {
      "main": [
        [
          {
            "node": "Alert Support Team",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create Zendesk Ticket",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Zendesk Ticket": {
      "main": [
        [
          {
            "node": "Slack Alert: Negative Review",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sentiment Analysis (OpenAI)": {
      "main": [
        [
          {
            "node": "Merge Sentiment Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Sentiment Data": {
      "main": [
        [
          {
            "node": "Save Review with Sentiment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Review with Sentiment": {
      "main": [
        [
          {
            "node": "Track in Mixpanel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Order > $200 (NPS Eligible)": {
      "main": [
        [
          {
            "node": "Send NPS Survey",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook: NPS Response": {
      "main": [
        [
          {
            "node": "Process NPS Score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process NPS Score": {
      "main": [
        [
          {
            "node": "Save NPS Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save NPS Response": {
      "main": [
        [
          {
            "node": "Track NPS in Mixpanel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Track NPS in Mixpanel": {
      "main": [
        [
          {
            "node": "Trigger Score Aggregation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "error-handler-workflow"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-12-03T00:00:00.000Z",
      "updatedAt": "2025-12-03T00:00:00.000Z",
      "id": "5",
      "name": "feedback"
    },
    {
      "createdAt": "2025-12-03T00:00:00.000Z",
      "updatedAt": "2025-12-03T00:00:00.000Z",
      "id": "6",
      "name": "reviews"
    },
    {
      "createdAt": "2025-12-03T00:00:00.000Z",
      "updatedAt": "2025-12-03T00:00:00.000Z",
      "id": "7",
      "name": "nps"
    }
  ],
  "pinData": {},
  "meta": {
    "version": "1.0.0",
    "description": "Broxiva Customer Feedback & Review Collection Workflow - Automated review requests, sentiment analysis, and NPS surveys",
    "created": "2025-12-03T00:00:00.000Z",
    "updated": "2025-12-03T00:00:00.000Z"
  }
}
