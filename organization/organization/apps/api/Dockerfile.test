# Test Dockerfile to debug ACR build issues
FROM node:20-slim AS builder

ENV LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    LANGUAGE=C.UTF-8 \
    DEBIAN_FRONTEND=noninteractive

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package files
COPY package*.json ./
COPY apps/api/package*.json ./apps/api/
COPY apps/api/prisma ./apps/api/prisma/

# Install dependencies from API directory
WORKDIR /app/apps/api
RUN HUSKY=0 npm install --legacy-peer-deps --ignore-scripts && npm rebuild

# Generate Prisma Client
RUN npx prisma generate || (echo "Prisma generate failed" && exit 1)

# Copy source code
COPY apps/api/src ./src
COPY apps/api/tsconfig*.json ./
COPY apps/api/nest-cli.json ./

# Build application with increased memory
ENV NODE_OPTIONS="--max_old_space_size=4096"
RUN npm run build || (echo "Build failed" && exit 1)

# Minimal production stage for testing
FROM node:20-slim AS production
WORKDIR /app
COPY --from=builder /app/apps/api/dist ./dist
CMD ["echo", "Build successful!"]
