version: '3.8'

# ==================================
# Broxiva E-Commerce Platform
# DEVELOPMENT Docker Compose Configuration
# Version: 1.1.0
# ==================================
# ⚠️  DEVELOPMENT ENVIRONMENT NOTICE  ⚠️
# ==================================
# This file is configured for LOCAL DEVELOPMENT ONLY.
# DO NOT use this configuration in production or staging environments!
#
# Key differences from production:
#   - Simplified security for ease of development
#   - Services exposed on all interfaces (0.0.0.0)
#   - Password authentication enforced but simplified
#   - No TLS/SSL requirements
#   - Development-friendly logging
#   - No resource limits
#   - Management tools included (pgAdmin)
#   - Hot reload and volume mounts for code
#
# For production deployment, use:
#   - infrastructure/docker/docker-compose.production-secure.yml
#
# SECURITY REQUIREMENTS:
# - Create a .env file with secure passwords
# - NEVER commit .env files to version control
# - Use different credentials from production
# - Do not expose ports to public internet
# - Use local firewall rules if needed
#
# Required environment variables:
#   POSTGRES_PASSWORD=<generate-secure-password>
#   PGADMIN_DEFAULT_PASSWORD=<generate-secure-password>
#   REDIS_PASSWORD=<generate-secure-password> (optional for dev)
#
# Optional (with defaults):
#   POSTGRES_USER=broxiva
#   POSTGRES_DB=broxiva_dev
#   PGADMIN_DEFAULT_EMAIL=admin@broxiva.com
#
# Generate passwords: openssl rand -base64 32
# See .env.docker.example for complete template
# See docs/DOCKER_SECURITY.md for security guidelines
# ==================================

services:
  # ==================================
  # PostgreSQL Database
  # ==================================
  postgres:
    image: postgres:16-alpine
    container_name: broxiva-postgres-dev
    restart: unless-stopped
    ports:
      - '5432:5432'
    environment:
      # Set POSTGRES_PASSWORD in .env file - do not use the default!
      POSTGRES_USER: ${POSTGRES_USER:-broxiva}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set in .env file}
      POSTGRES_DB: ${POSTGRES_DB:-broxiva_dev}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - broxiva-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U broxiva']
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "com.broxiva.env=development"
      - "com.broxiva.service=postgres"

  # ==================================
  # Redis Cache & Sessions
  # ==================================
  redis:
    image: redis:7-alpine
    container_name: broxiva-redis-dev
    restart: unless-stopped
    ports:
      - '6379:6379'
    volumes:
      - redis-data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - broxiva-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    # Development: Password optional but recommended
    # For production-like testing, set REDIS_PASSWORD in .env and use:
    # command: redis-server /usr/local/etc/redis/redis.conf --requirepass "${REDIS_PASSWORD}"
    command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes
    labels:
      - "com.broxiva.env=development"
      - "com.broxiva.service=redis"

  # ==================================
  # pgAdmin - Database Management Tool
  # ==================================
  # WARNING: pgAdmin should NOT be deployed in production
  # Only use for local development and testing
  pgadmin:
    image: dpage/pgadmin4:8.13
    container_name: broxiva-pgadmin-dev
    restart: unless-stopped
    ports:
      - '5050:80'
    environment:
      # Set PGADMIN_DEFAULT_PASSWORD in .env file - do not use the default!
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@broxiva.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:?PGADMIN_DEFAULT_PASSWORD must be set in .env file}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - broxiva-network
    depends_on:
      - postgres
    labels:
      - "com.broxiva.env=development"
      - "com.broxiva.service=pgadmin"
      - "com.broxiva.warning=DO_NOT_USE_IN_PRODUCTION"

# ==================================
# Volumes
# ==================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  pgadmin-data:
    driver: local

# ==================================
# Networks
# ==================================
networks:
  broxiva-network:
    driver: bridge
    name: broxiva-network-dev

# ==================================
# Development Security Checklist
# ==================================
# [ ] .env file created with secure passwords
# [ ] .env file added to .gitignore
# [ ] Different credentials from production
# [ ] Services not exposed to public internet
# [ ] Local firewall rules configured if needed
# [ ] Regular updates of Docker images
# [ ] Understanding of differences from production config
#
# Common Development Commands:
#   Start services:     docker-compose -f docker-compose-dev-secure.yml up -d
#   Stop services:      docker-compose -f docker-compose-dev-secure.yml down
#   View logs:          docker-compose -f docker-compose-dev-secure.yml logs -f
#   Restart service:    docker-compose -f docker-compose-dev-secure.yml restart <service>
#   Remove volumes:     docker-compose -f docker-compose-dev-secure.yml down -v
#
# For more information:
#   - See docs/DOCKER_SECURITY.md
#   - See .env.docker.example
#   - See docker-compose.production-secure.yml for production config
# ==================================
