%% Checkout Process Flow
%% E-commerce Platform - Checkout System
%% Shows standard checkout, express checkout, and guest checkout flows

sequenceDiagram
    autonumber

    participant Client as Client App
    participant API as API Server
    participant CheckoutSvc as CheckoutService
    participant CartSvc as CartService
    participant CouponSvc as CouponsService
    participant ShippingSvc as ShippingService
    participant PaymentSvc as PaymentsService
    participant OrderSvc as OrdersService
    participant Stripe as Stripe API
    participant DB as Database

    %% ==========================================
    %% STANDARD CHECKOUT INITIALIZATION
    %% ==========================================

    rect rgb(240, 248, 255)
        Note over Client, DB: Checkout Session Initialization

        Client->>API: POST /checkout/initialize
        Note right of Client: { cartId, shippingAddressId?, couponCode? }

        API->>CheckoutSvc: initializeCheckout()

        CheckoutSvc->>DB: Fetch User
        CheckoutSvc->>DB: Fetch Cart with Items
        Note right of CheckoutSvc: Include product details, prices, stock

        par Parallel Data Fetching
            CheckoutSvc->>CheckoutSvc: getSavedAddresses()
            CheckoutSvc->>CheckoutSvc: getSavedPaymentMethods()
        end

        CheckoutSvc->>CheckoutSvc: Calculate Subtotal
        Note right of CheckoutSvc: sum(item.price * item.quantity)

        alt Coupon Code Provided
            CheckoutSvc->>CartSvc: validateRecoveryDiscount()
            Note right of CheckoutSvc: Try cart abandonment discount first

            alt Recovery Discount Valid
                CheckoutSvc->>CheckoutSvc: Apply Recovery Discount
            else Regular Coupon
                CheckoutSvc->>CouponSvc: validateCoupon()
                Note right of CouponSvc: Check: isActive, dates,<br/>minOrderValue, usage limits
                CouponSvc-->>CheckoutSvc: { valid, discountAmount }
            end
        end

        alt Shipping Address Selected
            CheckoutSvc->>ShippingSvc: calculatePackageDimensions()
            CheckoutSvc->>ShippingSvc: compareRates()
            Note right of ShippingSvc: Calculate weight, dimensions,<br/>get carrier rates

            alt Free Shipping Eligible
                ShippingSvc-->>CheckoutSvc: shipping = 0
            else
                ShippingSvc-->>CheckoutSvc: cheapestRate
            end
        end

        CheckoutSvc->>CheckoutSvc: Calculate Tax (8%)
        CheckoutSvc->>CheckoutSvc: Calculate Total
        Note right of CheckoutSvc: total = subtotal - discount + shipping + tax

        CheckoutSvc-->>API: Checkout Session
        API-->>Client: { items, subtotal, discount,<br/>shipping, tax, total,<br/>addresses, paymentMethods }
    end

    %% ==========================================
    %% EXPRESS CHECKOUT (ONE-CLICK)
    %% ==========================================

    rect rgb(240, 255, 240)
        Note over Client, DB: Express Checkout Flow (One-Click Purchase)

        Client->>API: POST /checkout/express
        Note right of Client: { cartId OR productId, quantity,<br/>shippingAddressId?, paymentMethodId?,<br/>couponCode? }

        API->>CheckoutSvc: expressCheckout()

        CheckoutSvc->>DB: Fetch User

        alt Cart Checkout
            CheckoutSvc->>DB: Fetch Cart with Items
            CheckoutSvc->>CheckoutSvc: Validate Stock Availability
        else Single Product
            CheckoutSvc->>DB: Fetch Product
            CheckoutSvc->>CheckoutSvc: Check Stock >= Quantity
        end

        alt Address ID Provided
            CheckoutSvc->>DB: Fetch Saved Address
        else Use Default
            CheckoutSvc->>DB: Find Default Address
        end

        Note over CheckoutSvc: Address Required!

        CheckoutSvc->>CheckoutSvc: Apply Coupon (if provided)
        CheckoutSvc->>ShippingSvc: Calculate Shipping
        CheckoutSvc->>CheckoutSvc: Calculate Tax & Total

        alt Payment Method ID Provided
            CheckoutSvc->>CheckoutSvc: Use Provided Method
        else Use Default
            CheckoutSvc->>CheckoutSvc: Get Default Payment Method
        end

        Note over CheckoutSvc: Payment Method Required!

        CheckoutSvc->>OrderSvc: create()
        Note right of OrderSvc: Create Order with PENDING status
        DB-->>CheckoutSvc: Order Created

        CheckoutSvc->>CheckoutSvc: getOrCreateStripeCustomer()

        CheckoutSvc->>Stripe: paymentIntents.create()
        Note right of Stripe: customer, payment_method,<br/>confirm: true,<br/>allow_redirects: 'never'

        alt Payment Succeeded
            Stripe-->>CheckoutSvc: { status: 'succeeded' }

            CheckoutSvc->>OrderSvc: updateOrderStatus(PROCESSING)

            par Post-Payment Processing
                CheckoutSvc->>CartSvc: markCartRecovered()
                CheckoutSvc->>DB: Update Cart (convertedToOrder)
                CheckoutSvc->>DB: Delete Cart Items
                CheckoutSvc->>CouponSvc: applyCoupon()
            end

            CheckoutSvc-->>API: { success: true, orderId, total }
            API-->>Client: Express Checkout Complete

        else Payment Failed
            Stripe-->>CheckoutSvc: Error
            CheckoutSvc->>OrderSvc: updateOrderStatus(CANCELLED)
            CheckoutSvc-->>API: Payment Failed
            API-->>Client: Error: Payment failed
        end
    end

    %% ==========================================
    %% GUEST CHECKOUT
    %% ==========================================

    rect rgb(255, 248, 240)
        Note over Client, DB: Guest Checkout Flow (No Account Required)

        Client->>API: POST /checkout/guest
        Note right of Client: { items[], shippingAddress,<br/>guestEmail, couponCode? }

        API->>CheckoutSvc: guestCheckout()

        CheckoutSvc->>DB: Validate Products Exist
        CheckoutSvc->>CheckoutSvc: Validate Stock for All Items

        CheckoutSvc->>CheckoutSvc: Calculate Subtotal

        alt Coupon Code Provided
            CheckoutSvc->>DB: Find Coupon by Code
            CheckoutSvc->>CheckoutSvc: Validate Coupon
            Note right of CheckoutSvc: Check: isActive, dates,<br/>minOrderValue (skip user validation)
            CheckoutSvc->>CheckoutSvc: Calculate Discount
        end

        CheckoutSvc->>ShippingSvc: Calculate Shipping
        Note right of ShippingSvc: Based on address country<br/>and order subtotal

        CheckoutSvc->>CheckoutSvc: Calculate Tax (8%)
        CheckoutSvc->>CheckoutSvc: Calculate Total

        CheckoutSvc->>DB: Create Guest Order
        Note right of DB: userId: null, isGuestOrder: true,<br/>guestEmail, guestPhone

        CheckoutSvc->>PaymentSvc: createPaymentIntent()
        Note right of PaymentSvc: { total, 'usd',<br/>{ orderId, guestEmail } }

        PaymentSvc->>Stripe: paymentIntents.create()
        Stripe-->>PaymentSvc: { clientSecret, paymentIntentId }

        PaymentSvc-->>CheckoutSvc: Payment Intent
        CheckoutSvc-->>API: { orderId, clientSecret,<br/>paymentIntentId, totals }
        API-->>Client: Guest Checkout Ready

        Note over Client: Customer completes payment<br/>using Stripe Elements

        Client->>Stripe: confirmCardPayment()
        Stripe-->>Client: Payment Result
    end

    %% ==========================================
    %% ADDRESS MANAGEMENT
    %% ==========================================

    rect rgb(248, 240, 255)
        Note over Client, DB: Address Management

        Client->>API: GET /checkout/addresses
        API->>CheckoutSvc: getSavedAddresses()
        CheckoutSvc->>DB: Find Addresses (ordered by isDefault, createdAt)
        DB-->>CheckoutSvc: Address List
        CheckoutSvc-->>API: Formatted Addresses
        API-->>Client: [ { id, fullName, street, city, ... } ]

        Client->>API: POST /checkout/addresses
        Note right of Client: { fullName, street, city, state,<br/>postalCode, country, isDefault }
        API->>CheckoutSvc: saveAddress()

        alt Set as Default
            CheckoutSvc->>DB: Unset Other Defaults
        end

        CheckoutSvc->>DB: Create Address
        CheckoutSvc-->>API: Saved Address
        API-->>Client: Address Created
    end

    %% ==========================================
    %% PAYMENT METHOD MANAGEMENT
    %% ==========================================

    rect rgb(255, 245, 238)
        Note over Client, Stripe: Payment Method Management

        Client->>API: POST /checkout/payment-methods/setup
        API->>CheckoutSvc: setupPaymentMethod()

        CheckoutSvc->>CheckoutSvc: getOrCreateStripeCustomer()
        CheckoutSvc->>Stripe: setupIntents.create()
        Note right of Stripe: customer, payment_method_types: ['card']

        Stripe-->>CheckoutSvc: { clientSecret }
        CheckoutSvc-->>API: Setup Intent
        API-->>Client: { clientSecret }

        Client->>Client: Display Stripe Elements
        Client->>Stripe: confirmCardSetup()
        Note right of Client: User enters card details

        Stripe-->>Client: { setupIntent, paymentMethod }

        Client->>API: POST /checkout/payment-methods/attach
        Note right of Client: { paymentMethodId, setAsDefault }

        API->>CheckoutSvc: attachPaymentMethod()
        CheckoutSvc->>Stripe: paymentMethods.attach()

        alt Set as Default
            CheckoutSvc->>Stripe: customers.update()
            Note right of Stripe: invoice_settings.default_payment_method
        end

        CheckoutSvc-->>API: Payment Method Attached
        API-->>Client: Success
    end

    %% ==========================================
    %% ORDER COMPLETION & CONFIRMATION
    %% ==========================================

    rect rgb(240, 255, 248)
        Note over Client, DB: Order Completion

        Note over Stripe: Stripe Webhook Event
        Stripe->>API: POST /payments/webhook
        Note right of Stripe: payment_intent.succeeded

        API->>PaymentSvc: constructWebhookEvent()
        PaymentSvc->>PaymentSvc: Verify Webhook Signature

        API->>OrderSvc: Update Order from Metadata
        OrderSvc->>DB: Update Order Status (PROCESSING)
        OrderSvc->>DB: Update Stock Levels

        par Post-Order Processing
            OrderSvc->>DB: Send Confirmation Email
            OrderSvc->>DB: Update Inventory
            OrderSvc->>DB: Update Analytics
        end

        API-->>Stripe: 200 OK

        Note over Client: Polling or WebSocket
        Client->>API: GET /orders/{orderId}
        API->>DB: Fetch Order Details
        DB-->>API: Order with Items
        API-->>Client: Order Confirmation
    end
