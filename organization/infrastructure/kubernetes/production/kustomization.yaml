apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: citadelbuy-production

# Common labels applied to all resources
commonLabels:
  app: citadelbuy
  environment: production
  managed-by: kustomize
  version: v1

# Common annotations
commonAnnotations:
  contact: "devops@citadelbuy.com"
  documentation: "https://docs.citadelbuy.com/infrastructure"

# Resources to deploy
resources:
  - namespace.yaml
  - configmap.yaml
  - api-deployment.yaml
  - web-deployment.yaml
  - worker-deployment.yaml
  - ingress.yaml
  - hpa.yaml

# Reference base resources
bases:
  - ../base

# Image transformations
images:
  - name: ghcr.io/citadelplatforms/citadelbuy-api
    newName: ghcr.io/citadelplatforms/citadelbuy-api
    newTag: production-latest
  - name: ghcr.io/citadelplatforms/citadelbuy-web
    newName: ghcr.io/citadelplatforms/citadelbuy-web
    newTag: production-latest

# ConfigMap generator for deployment metadata
configMapGenerator:
  - name: deployment-info
    literals:
      - DEPLOYMENT_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
      - DEPLOYMENT_ENV=production
      - GIT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
      - GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
      - DEPLOYED_BY=$(git config user.name 2>/dev/null || echo "ci-cd")
      - K8S_CLUSTER=production
    options:
      disableNameSuffixHash: false

# Secret generator (use external secret management in production)
secretGenerator:
  - name: citadelbuy-secrets
    type: Opaque
    options:
      disableNameSuffixHash: true
    # NOTE: In production, use External Secrets Operator or similar
    # This is a placeholder - actual secrets should come from vault/AWS Secrets Manager

# Replicas for production environment
replicas:
  - name: citadelbuy-api
    count: 5
  - name: citadelbuy-web
    count: 5
  - name: email-worker
    count: 3
  - name: cart-abandonment-worker
    count: 2
  - name: order-processing-worker
    count: 5
  - name: search-indexing-worker
    count: 3
  - name: scheduled-jobs-worker
    count: 2

# Patches for production-specific configuration
patchesStrategicMerge:
  - |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: citadelbuy-api
    spec:
      template:
        metadata:
          annotations:
            prometheus.io/scrape: "true"
            prometheus.io/port: "9090"
        spec:
          containers:
          - name: api
            env:
            - name: ENVIRONMENT
              value: "production"
            - name: DEPLOYMENT_ID
              value: "$(date +%Y%m%d-%H%M%S)"
            resources:
              requests:
                memory: "1Gi"
                cpu: "500m"
              limits:
                memory: "2Gi"
                cpu: "2000m"
  - |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: citadelbuy-web
    spec:
      template:
        metadata:
          annotations:
            prometheus.io/scrape: "true"
            prometheus.io/port: "3000"
        spec:
          containers:
          - name: web
            env:
            - name: ENVIRONMENT
              value: "production"
            - name: DEPLOYMENT_ID
              value: "$(date +%Y%m%d-%H%M%S)"
            resources:
              requests:
                memory: "512Mi"
                cpu: "250m"
              limits:
                memory: "1536Mi"
                cpu: "1000m"

# JSON patches for fine-grained modifications
patchesJson6902:
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: citadelbuy-api
    patch: |-
      - op: add
        path: /spec/template/spec/securityContext/runAsNonRoot
        value: true
      - op: add
        path: /spec/template/spec/securityContext/seccompProfile
        value:
          type: RuntimeDefault
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: citadelbuy-web
    patch: |-
      - op: add
        path: /spec/template/spec/securityContext/runAsNonRoot
        value: true
      - op: add
        path: /spec/template/spec/securityContext/seccompProfile
        value:
          type: RuntimeDefault

# Configurations
configurations:
  - kustomizeconfig.yaml

# Vars for cross-resource references
vars:
  - name: API_SERVICE_NAME
    objref:
      kind: Service
      name: citadelbuy-api
      apiVersion: v1
    fieldref:
      fieldpath: metadata.name
  - name: WEB_SERVICE_NAME
    objref:
      kind: Service
      name: citadelbuy-web
      apiVersion: v1
    fieldref:
      fieldpath: metadata.name

# Generation behavior
generatorOptions:
  disableNameSuffixHash: false
  labels:
    environment: production
    managed-by: kustomize
  annotations:
    generated-by: kustomize

# Build metadata
buildMetadata: [managedByLabel, originAnnotations]
