# External Secrets Operator Configuration for Broxiva Production
# This configures automatic secret synchronization from Azure Key Vault to Kubernetes
#
# Prerequisites:
#   1. External Secrets Operator installed: helm install external-secrets external-secrets/external-secrets -n external-secrets-system
#   2. Azure Key Vault created with proper RBAC
#   3. Workload Identity configured for AKS
#
# Usage:
#   kubectl apply -f external-secrets-broxiva.yaml
#
# Last Updated: 2025-12-13

---
# Namespace for production
apiVersion: v1
kind: Namespace
metadata:
  name: broxiva-production
  labels:
    environment: production
    app: broxiva
    istio-injection: enabled

---
# Service Account with Workload Identity for External Secrets
apiVersion: v1
kind: ServiceAccount
metadata:
  name: broxiva-external-secrets-sa
  namespace: broxiva-production
  annotations:
    # Azure Workload Identity annotation
    azure.workload.identity/client-id: "REPLACE_WITH_MANAGED_IDENTITY_CLIENT_ID"
    azure.workload.identity/tenant-id: "REPLACE_WITH_AZURE_TENANT_ID"
  labels:
    azure.workload.identity/use: "true"

---
# SecretStore for Azure Key Vault (namespace-scoped)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-keyvault-broxiva
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
spec:
  provider:
    azurekv:
      # Azure Key Vault URL (broxiva-kv in broxiva-prod-rg)
      vaultUrl: "https://broxiva-kv.vault.azure.net"

      # Authentication using Workload Identity
      authType: WorkloadIdentity

      # Service Account reference
      serviceAccountRef:
        name: broxiva-external-secrets-sa

---
# ExternalSecret for Authentication & Session Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: broxiva-auth-secrets
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
    category: authentication
  annotations:
    rotation-schedule: "90-days"
    critical: "true"
spec:
  # Sync every 1 hour
  refreshInterval: 1h

  # Reference to SecretStore
  secretStoreRef:
    name: azure-keyvault-broxiva
    kind: SecretStore

  # Target Kubernetes Secret
  target:
    name: broxiva-auth-secrets
    creationPolicy: Owner
    deletionPolicy: Retain

  # Secret mappings
  data:
    - secretKey: JWT_SECRET
      remoteRef:
        key: jwt-access-secret

    - secretKey: JWT_REFRESH_SECRET
      remoteRef:
        key: jwt-refresh-secret

    - secretKey: SESSION_SECRET
      remoteRef:
        key: session-secret

    - secretKey: ENCRYPTION_KEY
      remoteRef:
        key: encryption-key

    - secretKey: KYC_ENCRYPTION_KEY
      remoteRef:
        key: kyc-encryption-key

---
# ExternalSecret for Database Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: broxiva-database-secrets
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
    category: database
  annotations:
    rotation-schedule: "90-days"
    critical: "true"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-broxiva
    kind: SecretStore
  target:
    name: broxiva-database-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: postgres-password

    - secretKey: DATABASE_URL
      remoteRef:
        key: postgres-url

---
# ExternalSecret for Cache/Redis Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: broxiva-cache-secrets
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
    category: cache
  annotations:
    rotation-schedule: "90-days"
    critical: "medium"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-broxiva
    kind: SecretStore
  target:
    name: broxiva-cache-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: redis-password

    - secretKey: REDIS_URL
      remoteRef:
        key: redis-url

---
# ExternalSecret for Payment Provider Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: broxiva-payment-secrets
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
    category: payment
  annotations:
    rotation-schedule: "as-needed"
    critical: "true"
    set-manually: "true"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-broxiva
    kind: SecretStore
  target:
    name: broxiva-payment-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: STRIPE_SECRET_KEY
      remoteRef:
        key: stripe-secret-key

    - secretKey: STRIPE_WEBHOOK_SECRET
      remoteRef:
        key: stripe-webhook-secret

    - secretKey: PAYPAL_CLIENT_ID
      remoteRef:
        key: paypal-client-id
        optional: true

    - secretKey: PAYPAL_CLIENT_SECRET
      remoteRef:
        key: paypal-client-secret
        optional: true

---
# ExternalSecret for Email Service Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: broxiva-email-secrets
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
    category: email
  annotations:
    rotation-schedule: "as-needed"
    critical: "high"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-broxiva
    kind: SecretStore
  target:
    name: broxiva-email-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: SENDGRID_API_KEY
      remoteRef:
        key: sendgrid-api-key

---
# ExternalSecret for AI Service Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: broxiva-ai-secrets
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
    category: ai
  annotations:
    rotation-schedule: "as-needed"
    critical: "low"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-broxiva
    kind: SecretStore
  target:
    name: broxiva-ai-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: openai-api-key

---
# ExternalSecret for Internal API Keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: broxiva-internal-secrets
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
    category: internal
  annotations:
    rotation-schedule: "90-days"
    critical: "true"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-broxiva
    kind: SecretStore
  target:
    name: broxiva-internal-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: INTERNAL_API_KEY
      remoteRef:
        key: internal-api-key

    - secretKey: WEBHOOK_SECRET
      remoteRef:
        key: webhook-secret
        optional: true

---
# ExternalSecret for OAuth Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: broxiva-oauth-secrets
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
    category: oauth
  annotations:
    rotation-schedule: "as-needed"
    critical: "medium"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-broxiva
    kind: SecretStore
  target:
    name: broxiva-oauth-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: GOOGLE_CLIENT_ID
      remoteRef:
        key: google-oauth-client-id
        optional: true

    - secretKey: GOOGLE_CLIENT_SECRET
      remoteRef:
        key: google-oauth-client-secret
        optional: true

    - secretKey: FACEBOOK_APP_ID
      remoteRef:
        key: facebook-app-id
        optional: true

    - secretKey: FACEBOOK_APP_SECRET
      remoteRef:
        key: facebook-app-secret
        optional: true

---
# ExternalSecret for Monitoring Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: broxiva-monitoring-secrets
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
    category: monitoring
  annotations:
    rotation-schedule: "as-needed"
    critical: "low"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-broxiva
    kind: SecretStore
  target:
    name: broxiva-monitoring-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: SENTRY_DSN
      remoteRef:
        key: sentry-dsn
        optional: true

    - secretKey: DATADOG_API_KEY
      remoteRef:
        key: datadog-api-key
        optional: true

---
# Combined ExternalSecret - All Secrets in One (Alternative Approach)
# Use this if you want a single secret containing all values
# Comment out the individual ExternalSecrets above if using this
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: broxiva-all-secrets
  namespace: broxiva-production
  labels:
    environment: production
    app: broxiva
    category: all
  annotations:
    description: "Combined secret containing all Broxiva production secrets"
    rotation-schedule: "varies-by-secret-type"
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-broxiva
    kind: SecretStore
  target:
    name: broxiva-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    # Authentication
    - secretKey: JWT_SECRET
      remoteRef:
        key: jwt-access-secret
    - secretKey: JWT_REFRESH_SECRET
      remoteRef:
        key: jwt-refresh-secret
    - secretKey: SESSION_SECRET
      remoteRef:
        key: session-secret
    - secretKey: ENCRYPTION_KEY
      remoteRef:
        key: encryption-key
    - secretKey: KYC_ENCRYPTION_KEY
      remoteRef:
        key: kyc-encryption-key

    # Database
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: postgres-password
    - secretKey: DATABASE_URL
      remoteRef:
        key: postgres-url

    # Cache
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: redis-password
    - secretKey: REDIS_URL
      remoteRef:
        key: redis-url

    # Payment
    - secretKey: STRIPE_SECRET_KEY
      remoteRef:
        key: stripe-secret-key
    - secretKey: STRIPE_WEBHOOK_SECRET
      remoteRef:
        key: stripe-webhook-secret

    # Email
    - secretKey: SENDGRID_API_KEY
      remoteRef:
        key: sendgrid-api-key

    # AI
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: openai-api-key

    # Internal
    - secretKey: INTERNAL_API_KEY
      remoteRef:
        key: internal-api-key

---
# ServiceMonitor for External Secrets Operator (if using Prometheus)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: broxiva-external-secrets
  namespace: broxiva-production
  labels:
    app: external-secrets
    environment: production
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: external-secrets
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics

---
# PrometheusRule for External Secrets Alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: broxiva-external-secrets-alerts
  namespace: broxiva-production
  labels:
    app: external-secrets
    environment: production
spec:
  groups:
    - name: external-secrets
      interval: 30s
      rules:
        - alert: BroxivaExternalSecretSyncFailed
          expr: |
            external_secrets_sync_calls_error{namespace="broxiva-production"} > 0
          for: 5m
          labels:
            severity: critical
            component: external-secrets
          annotations:
            summary: "Broxiva External Secret sync failed"
            description: "ExternalSecret {{ $labels.name }} in namespace {{ $labels.namespace }} failed to sync for more than 5 minutes"

        - alert: BroxivaExternalSecretStale
          expr: |
            (time() - external_secrets_sync_calls_total{namespace="broxiva-production"}) > 7200
          for: 5m
          labels:
            severity: warning
            component: external-secrets
          annotations:
            summary: "Broxiva External Secret not synced recently"
            description: "ExternalSecret {{ $labels.name }} hasn't synced in over 2 hours"

        - alert: BroxivaSecretMissing
          expr: |
            absent(kube_secret_info{namespace="broxiva-production",secret="broxiva-secrets"})
          for: 1m
          labels:
            severity: critical
            component: external-secrets
          annotations:
            summary: "Broxiva production secrets missing"
            description: "The broxiva-secrets secret is missing from broxiva-production namespace"

---
# RBAC for External Secrets Service Account
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: broxiva-external-secrets-role
  namespace: broxiva-production
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  - apiGroups: ["external-secrets.io"]
    resources: ["externalsecrets", "secretstores"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: broxiva-external-secrets-rolebinding
  namespace: broxiva-production
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: broxiva-external-secrets-role
subjects:
  - kind: ServiceAccount
    name: broxiva-external-secrets-sa
    namespace: broxiva-production
