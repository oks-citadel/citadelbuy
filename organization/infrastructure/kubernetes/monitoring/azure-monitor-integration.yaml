# Azure Monitor Integration for Broxiva AKS Cluster
# This file configures Azure Monitor Container Insights for the broxiva-prod-aks cluster
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: container-azm-ms-agentconfig
  namespace: kube-system
  labels:
    app: azure-monitor
    tier: monitoring
data:
  schema-version: v1
  config-version: ver1
  log-data-collection-settings: |-
    [log_collection_settings]
       [log_collection_settings.stdout]
          enabled = true
          exclude_namespaces = ["kube-system", "kube-public"]
       [log_collection_settings.stderr]
          enabled = true
          exclude_namespaces = ["kube-system", "kube-public"]
       [log_collection_settings.env_var]
          enabled = true
       [log_collection_settings.enrich_container_logs]
          enabled = true
       [log_collection_settings.collect_all_kube_events]
          enabled = true
  prometheus-data-collection-settings: |-
    [prometheus_data_collection_settings.cluster]
        interval = "1m"
        fieldpass = ["metric_name1", "metric_name2"]
        fielddrop = ["metric_name3", "metric_name4"]
        monitor_kubernetes_pods = true
        monitor_kubernetes_pods_namespaces = ["broxiva", "broxiva-production", "broxiva-monitoring"]
    [prometheus_data_collection_settings.node]
        interval = "1m"
        fieldpass = ["metric_name1", "metric_name2"]
        fielddrop = ["metric_name3", "metric_name4"]
  metric_collection_settings: |-
    [metric_collection_settings.collect_kube_system_pv_metrics]
      enabled = true
    [metric_collection_settings.collect_kube_system_pv_capacity]
      enabled = true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: azure-monitor-annotations
  namespace: broxiva-production
  labels:
    app: azure-monitor
    tier: monitoring
data:
  # Annotations to enable Azure Monitor for specific pods
  annotations: |
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"
---
# DaemonSet for Azure Monitor OMS Agent (deployed automatically by addon)
# This is a reference configuration - the actual DaemonSet is managed by Azure
apiVersion: v1
kind: ConfigMap
metadata:
  name: omsagent-rs-config
  namespace: kube-system
  labels:
    app: omsagent
    tier: monitoring
data:
  kube.conf: |
    # Fluentd config for OMS Agent
    <source>
      @type tail
      path /var/log/containers/*.log
      pos_file /var/opt/microsoft/omsagent/state/container.log.pos
      tag oms.container.*
      read_from_head true
      <parse>
        @type json
        time_format %Y-%m-%dT%H:%M:%S.%NZ
      </parse>
    </source>

    <filter oms.container.**>
      @type kubernetes_metadata
      kubernetes_url https://#{ENV['KUBERNETES_SERVICE_HOST']}:#{ENV['KUBERNETES_SERVICE_PORT']}
      verify_ssl true
      ca_file /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file /var/run/secrets/kubernetes.io/serviceaccount/token
    </filter>

    <match oms.container.**>
      @type out_oms
      log_level info
      num_threads 5
      buffer_chunk_limit 5m
      buffer_type file
      buffer_path /var/opt/microsoft/omsagent/state/out_oms*.buffer
      buffer_queue_limit 10
      flush_interval 20s
      retry_limit 10
      retry_wait 30s
    </match>
---
# Azure Monitor Workbook for Broxiva
# This is imported via Azure Portal or ARM template
apiVersion: v1
kind: ConfigMap
metadata:
  name: azure-workbook-config
  namespace: broxiva-monitoring
  labels:
    app: azure-monitor
    tier: monitoring
data:
  workbook.json: |
    {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 1,
          "content": {
            "json": "# Broxiva Production Monitoring Dashboard\n\n## AKS Cluster: broxiva-prod-aks"
          }
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "Perf | where ObjectName == 'K8SContainer' | where CounterName == 'cpuUsageNanoCores' | summarize avg(CounterValue) by bin(TimeGenerated, 5m), Computer",
            "size": 0,
            "title": "CPU Usage Over Time",
            "timeContext": {
              "durationMs": 3600000
            },
            "queryType": 0,
            "resourceType": "microsoft.containerservice/managedclusters",
            "visualization": "timechart"
          }
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "Perf | where ObjectName == 'K8SContainer' | where CounterName == 'memoryRssBytes' | summarize avg(CounterValue) by bin(TimeGenerated, 5m), Computer",
            "size": 0,
            "title": "Memory Usage Over Time",
            "timeContext": {
              "durationMs": 3600000
            },
            "queryType": 0,
            "resourceType": "microsoft.containerservice/managedclusters",
            "visualization": "timechart"
          }
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "KubePodInventory | where Namespace == 'broxiva-production' | summarize count() by PodStatus, bin(TimeGenerated, 5m)",
            "size": 0,
            "title": "Pod Status Distribution",
            "timeContext": {
              "durationMs": 3600000
            },
            "queryType": 0,
            "resourceType": "microsoft.containerservice/managedclusters",
            "visualization": "barchart"
          }
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "ContainerLog | where Namespace == 'broxiva-production' | where LogEntry contains 'error' or LogEntry contains 'ERROR' | summarize count() by bin(TimeGenerated, 5m)",
            "size": 0,
            "title": "Error Logs Over Time",
            "timeContext": {
              "durationMs": 3600000
            },
            "queryType": 0,
            "resourceType": "microsoft.containerservice/managedclusters",
            "visualization": "timechart"
          }
        }
      ]
    }
---
# Azure Log Analytics Query Pack
apiVersion: v1
kind: ConfigMap
metadata:
  name: log-analytics-queries
  namespace: broxiva-monitoring
  labels:
    app: azure-monitor
    tier: monitoring
data:
  queries.kql: |
    // Query 1: Pod Restart Analysis
    KubePodInventory
    | where Namespace == 'broxiva-production'
    | where PodRestartCount > 0
    | summarize TotalRestarts = sum(PodRestartCount) by PodName, ControllerName
    | order by TotalRestarts desc

    // Query 2: Container CPU Usage
    Perf
    | where ObjectName == "K8SContainer"
    | where CounterName == "cpuUsageNanoCores"
    | where InstanceName contains "broxiva"
    | summarize avg(CounterValue) by bin(TimeGenerated, 5m), InstanceName
    | render timechart

    // Query 3: Container Memory Usage
    Perf
    | where ObjectName == "K8SContainer"
    | where CounterName == "memoryRssBytes"
    | where InstanceName contains "broxiva"
    | summarize avg(CounterValue) / 1024 / 1024 by bin(TimeGenerated, 5m), InstanceName
    | render timechart

    // Query 4: Failed Pods
    KubePodInventory
    | where Namespace == 'broxiva-production'
    | where PodStatus in ("Failed", "Pending", "Unknown")
    | summarize count() by PodStatus, PodName, ControllerName
    | order by count_ desc

    // Query 5: Container Logs with Errors
    ContainerLog
    | where Namespace == 'broxiva-production'
    | where LogEntry contains "error" or LogEntry contains "ERROR" or LogEntry contains "exception"
    | project TimeGenerated, ContainerName, LogEntry
    | order by TimeGenerated desc
    | take 100

    // Query 6: Node Resource Utilization
    Perf
    | where ObjectName == "K8SNode"
    | where CounterName in ("cpuCapacityNanoCores", "memoryCapacityBytes")
    | summarize avg(CounterValue) by Computer, CounterName, bin(TimeGenerated, 5m)
    | render timechart

    // Query 7: Ingress Traffic Analysis
    KubeEvents
    | where ObjectKind == "Ingress"
    | where Namespace == 'broxiva-production'
    | summarize count() by Reason, Message
    | order by count_ desc

    // Query 8: Performance Bottlenecks
    Perf
    | where ObjectName == "K8SContainer"
    | where InstanceName contains "broxiva"
    | where CounterName in ("cpuUsageNanoCores", "memoryRssBytes")
    | summarize avg(CounterValue), max(CounterValue), min(CounterValue) by InstanceName, CounterName, bin(TimeGenerated, 1h)
    | order by TimeGenerated desc
---
# Azure Monitor Alert Action Group
# This should be created via Azure Portal or Terraform
apiVersion: v1
kind: ConfigMap
metadata:
  name: alert-action-groups
  namespace: broxiva-monitoring
  labels:
    app: azure-monitor
    tier: monitoring
data:
  action-groups.json: |
    {
      "actionGroups": [
        {
          "name": "broxiva-critical-alerts",
          "shortName": "BroxCrit",
          "enabled": true,
          "emailReceivers": [
            {
              "name": "DevOps Team",
              "emailAddress": "devops@broxiva.com"
            }
          ],
          "smsReceivers": [
            {
              "name": "On-Call",
              "countryCode": "1",
              "phoneNumber": "5551234567"
            }
          ],
          "webhookReceivers": [
            {
              "name": "Slack Integration",
              "serviceUri": "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
            }
          ],
          "azureAppPushReceivers": [],
          "azureFunctionReceivers": []
        },
        {
          "name": "broxiva-warning-alerts",
          "shortName": "BroxWarn",
          "enabled": true,
          "emailReceivers": [
            {
              "name": "Engineering Team",
              "emailAddress": "engineering@broxiva.com"
            }
          ],
          "webhookReceivers": [
            {
              "name": "Teams Integration",
              "serviceUri": "https://outlook.office.com/webhook/YOUR/WEBHOOK/URL"
            }
          ]
        }
      ]
    }
---
# NOTES:
#
# Azure Monitor Container Insights Setup:
# 1. Enable monitoring addon:
#    az aks enable-addons --name broxiva-prod-aks --resource-group broxiva-prod-rg --addons monitoring
#
# 2. Verify addon status:
#    az aks show --name broxiva-prod-aks --resource-group broxiva-prod-rg --query addonProfiles.omsagent
#
# 3. Get Log Analytics Workspace ID:
#    az aks show --name broxiva-prod-aks --resource-group broxiva-prod-rg --query addonProfiles.omsagent.config.logAnalyticsWorkspaceResourceID
#
# 4. Apply configurations:
#    kubectl apply -f azure-monitor-integration.yaml
#
# 5. View Container Insights in Azure Portal:
#    - Navigate to AKS cluster > Insights
#    - View Cluster, Nodes, Controllers, and Containers tabs
#    - Access Logs for custom queries
#
# 6. Import Workbook:
#    - Go to Azure Monitor > Workbooks
#    - Create new workbook
#    - Import JSON from workbook.json
#
# 7. Set up Action Groups and Alerts:
#    - Use Azure Portal or deploy via ARM template/Terraform
#    - Configure notification channels (email, SMS, webhooks)
#    - Link action groups to metric alerts
#
# Key Metrics to Monitor:
# - CPU and Memory utilization per pod/node
# - Pod restart counts
# - Container image pull errors
# - Network traffic and latency
# - Disk I/O and storage capacity
# - Application-specific metrics via Prometheus integration
