# CitadelBuy External Secrets Configuration
# Integrates with Azure Key Vault per-app-per-environment structure
# Requires: External Secrets Operator installed in cluster

---
# Shared SecretStore (for cross-app secrets)
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: citadelbuy-shared-vault
  labels:
    app.kubernetes.io/name: citadelbuy
    app.kubernetes.io/component: secrets
spec:
  provider:
    azurekv:
      authType: WorkloadIdentity
      vaultUrl: "https://citadelbuy-${ENVIRONMENT}-shared-kv.vault.azure.net/"
      serviceAccountRef:
        name: external-secrets-sa
        namespace: external-secrets

---
# API SecretStore
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: citadelbuy-api-vault
  namespace: citadelbuy-api
  labels:
    app.kubernetes.io/name: citadelbuy-api
    app.kubernetes.io/component: secrets
spec:
  provider:
    azurekv:
      authType: WorkloadIdentity
      vaultUrl: "https://citadelbuy-${ENVIRONMENT}-api-kv.vault.azure.net/"
      serviceAccountRef:
        name: api-service-account
        namespace: citadelbuy-api

---
# Web SecretStore
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: citadelbuy-web-vault
  namespace: citadelbuy-web
  labels:
    app.kubernetes.io/name: citadelbuy-web
    app.kubernetes.io/component: secrets
spec:
  provider:
    azurekv:
      authType: WorkloadIdentity
      vaultUrl: "https://citadelbuy-${ENVIRONMENT}-web-kv.vault.azure.net/"
      serviceAccountRef:
        name: web-service-account
        namespace: citadelbuy-web

---
# Mobile Backend SecretStore
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: citadelbuy-mobile-vault
  namespace: citadelbuy-mobile
  labels:
    app.kubernetes.io/name: citadelbuy-mobile
    app.kubernetes.io/component: secrets
spec:
  provider:
    azurekv:
      authType: WorkloadIdentity
      vaultUrl: "https://citadelbuy-${ENVIRONMENT}-mobile-kv.vault.azure.net/"
      serviceAccountRef:
        name: mobile-service-account
        namespace: citadelbuy-mobile

---
# ============================================================
# API External Secrets
# ============================================================

# Database secrets for API
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-database-secrets
  namespace: citadelbuy-api
  labels:
    app.kubernetes.io/name: citadelbuy-api
    app.kubernetes.io/component: database
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: citadelbuy-shared-vault
  target:
    name: database-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        DATABASE_URL: "{{ .postgres_url }}"
        POSTGRES_PASSWORD: "{{ .postgres_password }}"
  data:
    - secretKey: postgres_url
      remoteRef:
        key: postgres-url
    - secretKey: postgres_password
      remoteRef:
        key: postgres-password

---
# Redis secrets for API
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-redis-secrets
  namespace: citadelbuy-api
  labels:
    app.kubernetes.io/name: citadelbuy-api
    app.kubernetes.io/component: cache
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: citadelbuy-shared-vault
  target:
    name: redis-secrets
    creationPolicy: Owner
  data:
    - secretKey: REDIS_URL
      remoteRef:
        key: redis-url

---
# Auth secrets for API (JWT)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-auth-secrets
  namespace: citadelbuy-api
  labels:
    app.kubernetes.io/name: citadelbuy-api
    app.kubernetes.io/component: auth
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: citadelbuy-api-vault
  target:
    name: auth-secrets
    creationPolicy: Owner
  data:
    - secretKey: JWT_SECRET
      remoteRef:
        key: jwt-access-secret
    - secretKey: JWT_REFRESH_SECRET
      remoteRef:
        key: jwt-refresh-secret

---
# Payment secrets for API
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-payment-secrets
  namespace: citadelbuy-api
  labels:
    app.kubernetes.io/name: citadelbuy-api
    app.kubernetes.io/component: payment
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: citadelbuy-api-vault
  target:
    name: payment-secrets
    creationPolicy: Owner
  data:
    - secretKey: STRIPE_SECRET_KEY
      remoteRef:
        key: stripe-secret-key
    - secretKey: STRIPE_WEBHOOK_SECRET
      remoteRef:
        key: stripe-webhook-secret

---
# KYC encryption key for API (CRITICAL)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-kyc-secrets
  namespace: citadelbuy-api
  labels:
    app.kubernetes.io/name: citadelbuy-api
    app.kubernetes.io/component: kyc
    criticality: high
spec:
  refreshInterval: 24h  # Less frequent for critical secrets
  secretStoreRef:
    kind: SecretStore
    name: citadelbuy-api-vault
  target:
    name: kyc-secrets
    creationPolicy: Owner
  data:
    - secretKey: KYC_ENCRYPTION_KEY
      remoteRef:
        key: kyc-encryption-key

---
# Email secrets for API
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-email-secrets
  namespace: citadelbuy-api
  labels:
    app.kubernetes.io/name: citadelbuy-api
    app.kubernetes.io/component: email
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: citadelbuy-api-vault
  target:
    name: email-secrets
    creationPolicy: Owner
  data:
    - secretKey: SENDGRID_API_KEY
      remoteRef:
        key: sendgrid-api-key

---
# AI secrets for API
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: api-ai-secrets
  namespace: citadelbuy-api
  labels:
    app.kubernetes.io/name: citadelbuy-api
    app.kubernetes.io/component: ai
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: citadelbuy-api-vault
  target:
    name: ai-secrets
    creationPolicy: Owner
  data:
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: openai-api-key

---
# ============================================================
# WEB External Secrets
# ============================================================

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: web-api-secrets
  namespace: citadelbuy-web
  labels:
    app.kubernetes.io/name: citadelbuy-web
    app.kubernetes.io/component: api
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: citadelbuy-web-vault
  target:
    name: api-secrets
    creationPolicy: Owner
  data:
    - secretKey: INTERNAL_API_KEY
      remoteRef:
        key: internal-api-key

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: web-monitoring-secrets
  namespace: citadelbuy-web
  labels:
    app.kubernetes.io/name: citadelbuy-web
    app.kubernetes.io/component: monitoring
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: citadelbuy-web-vault
  target:
    name: monitoring-secrets
    creationPolicy: Owner
  data:
    - secretKey: SENTRY_DSN
      remoteRef:
        key: sentry-dsn

---
# ============================================================
# MOBILE External Secrets
# ============================================================

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mobile-iap-secrets
  namespace: citadelbuy-mobile
  labels:
    app.kubernetes.io/name: citadelbuy-mobile
    app.kubernetes.io/component: iap
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: citadelbuy-mobile-vault
  target:
    name: iap-secrets
    creationPolicy: Owner
  data:
    - secretKey: APPLE_SHARED_SECRET
      remoteRef:
        key: apple-shared-secret
    - secretKey: GOOGLE_PLAY_SERVICE_ACCOUNT
      remoteRef:
        key: google-play-service-account-key

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mobile-push-secrets
  namespace: citadelbuy-mobile
  labels:
    app.kubernetes.io/name: citadelbuy-mobile
    app.kubernetes.io/component: push
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: citadelbuy-mobile-vault
  target:
    name: push-secrets
    creationPolicy: Owner
  data:
    - secretKey: FIREBASE_SERVICE_ACCOUNT
      remoteRef:
        key: firebase-service-account

---
# ============================================================
# Service Accounts for Workload Identity
# ============================================================

apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-service-account
  namespace: citadelbuy-api
  annotations:
    azure.workload.identity/client-id: "${API_CLIENT_ID}"
  labels:
    azure.workload.identity/use: "true"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: web-service-account
  namespace: citadelbuy-web
  annotations:
    azure.workload.identity/client-id: "${WEB_CLIENT_ID}"
  labels:
    azure.workload.identity/use: "true"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mobile-service-account
  namespace: citadelbuy-mobile
  annotations:
    azure.workload.identity/client-id: "${MOBILE_CLIENT_ID}"
  labels:
    azure.workload.identity/use: "true"
