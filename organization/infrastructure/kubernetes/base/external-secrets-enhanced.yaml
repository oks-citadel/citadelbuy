# CitadelBuy External Secrets Configuration - Enhanced Version
# This file provides comprehensive examples for AWS Secrets Manager, Azure Key Vault, and HashiCorp Vault
# Choose the provider sections that match your infrastructure

---
# Namespace for External Secrets Operator
apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets-system

---
# Service Account for External Secrets Operator (AWS)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: citadelbuy
  annotations:
    # For AWS EKS with IRSA
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/citadelbuy-production-external-secrets
    # For Azure AKS with Workload Identity
    azure.workload.identity/client-id: CLIENT_ID
    azure.workload.identity/tenant-id: TENANT_ID

---
# =========================================
# AWS SECRETS MANAGER CONFIGURATION
# =========================================

# SecretStore for AWS Secrets Manager (namespace-scoped)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secretsmanager
  namespace: citadelbuy
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa

---
# ClusterSecretStore for AWS Secrets Manager (cluster-wide)
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secretsmanager-cluster
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: citadelbuy

---
# ExternalSecret for Database Credentials (AWS)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-database-aws
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore
  target:
    name: citadelbuy-database-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        DATABASE_URL: "{{ .url }}"
        POSTGRES_USER: "{{ .username }}"
        POSTGRES_PASSWORD: "{{ .password }}"
        POSTGRES_HOST: "{{ .host }}"
        POSTGRES_PORT: "{{ .port }}"
        POSTGRES_DB: "{{ .database }}"
  dataFrom:
    - extract:
        key: citadelbuy/production/postgres/credentials

---
# ExternalSecret for Redis Credentials (AWS)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-redis-aws
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore
  target:
    name: citadelbuy-redis-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        REDIS_URL: "{{ .url }}"
        REDIS_PASSWORD: "{{ .password }}"
        REDIS_HOST: "{{ .host }}"
        REDIS_PORT: "{{ .port }}"
  dataFrom:
    - extract:
        key: citadelbuy/production/redis/credentials

---
# ExternalSecret for JWT Secrets (AWS)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-jwt-aws
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore
  target:
    name: citadelbuy-jwt-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        JWT_SECRET: "{{ .access_token_secret }}"
        JWT_REFRESH_SECRET: "{{ .refresh_token_secret }}"
        JWT_EXPIRY: "{{ .access_token_expiry }}"
        JWT_REFRESH_EXPIRY: "{{ .refresh_token_expiry }}"
  dataFrom:
    - extract:
        key: citadelbuy/production/jwt/secrets

---
# ExternalSecret for Stripe Keys (AWS)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-stripe-aws
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore
  target:
    name: citadelbuy-stripe-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        STRIPE_SECRET_KEY: "{{ .secret_key }}"
        STRIPE_PUBLISHABLE_KEY: "{{ .publishable_key }}"
        STRIPE_WEBHOOK_SECRET: "{{ .webhook_secret }}"
  dataFrom:
    - extract:
        key: citadelbuy/production/stripe/keys

---
# ExternalSecret for OpenAI API Key (AWS)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-openai-aws
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore
  target:
    name: citadelbuy-openai-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        OPENAI_API_KEY: "{{ .api_key }}"
        OPENAI_MODEL: "{{ .model }}"
  dataFrom:
    - extract:
        key: citadelbuy/production/openai/key

---
# =========================================
# AZURE KEY VAULT CONFIGURATION
# =========================================

# SecretStore for Azure Key Vault (namespace-scoped)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-keyvault
  namespace: citadelbuy
spec:
  provider:
    azurekv:
      authType: WorkloadIdentity
      vaultUrl: "https://citadelbuy-production-kv.vault.azure.net"
      serviceAccountRef:
        name: external-secrets-sa

---
# ClusterSecretStore for Azure Key Vault
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: azure-keyvault-cluster
spec:
  provider:
    azurekv:
      authType: WorkloadIdentity
      vaultUrl: "https://citadelbuy-production-kv.vault.azure.net"
      serviceAccountRef:
        name: external-secrets-sa
        namespace: citadelbuy

---
# ExternalSecret for Database Credentials (Azure)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-database-azure
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault
    kind: SecretStore
  target:
    name: citadelbuy-database-secret
    creationPolicy: Owner
  data:
    - secretKey: DATABASE_URL
      remoteRef:
        key: postgres-url
    - secretKey: POSTGRES_USER
      remoteRef:
        key: postgres-username
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: postgres-password
    - secretKey: POSTGRES_HOST
      remoteRef:
        key: postgres-host
    - secretKey: POSTGRES_PORT
      remoteRef:
        key: postgres-port
    - secretKey: POSTGRES_DB
      remoteRef:
        key: postgres-database

---
# ExternalSecret for Redis Credentials (Azure)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-redis-azure
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault
    kind: SecretStore
  target:
    name: citadelbuy-redis-secret
    creationPolicy: Owner
  data:
    - secretKey: REDIS_URL
      remoteRef:
        key: redis-url
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: redis-password
    - secretKey: REDIS_HOST
      remoteRef:
        key: redis-host
    - secretKey: REDIS_PORT
      remoteRef:
        key: redis-port

---
# ExternalSecret for JWT Secrets (Azure)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-jwt-azure
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault
    kind: SecretStore
  target:
    name: citadelbuy-jwt-secret
    creationPolicy: Owner
  data:
    - secretKey: JWT_SECRET
      remoteRef:
        key: jwt-access-secret
    - secretKey: JWT_REFRESH_SECRET
      remoteRef:
        key: jwt-refresh-secret
    - secretKey: JWT_EXPIRY
      remoteRef:
        key: jwt-access-expiry
    - secretKey: JWT_REFRESH_EXPIRY
      remoteRef:
        key: jwt-refresh-expiry

---
# =========================================
# HASHICORP VAULT CONFIGURATION
# =========================================

# SecretStore for HashiCorp Vault (namespace-scoped)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault
  namespace: citadelbuy
spec:
  provider:
    vault:
      server: "https://vault.citadelbuy.internal:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "citadelbuy"
          serviceAccountRef:
            name: citadelbuy-api

---
# ClusterSecretStore for HashiCorp Vault
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-cluster
spec:
  provider:
    vault:
      server: "https://vault.citadelbuy.internal:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "citadelbuy"
          serviceAccountRef:
            name: citadelbuy-api
            namespace: citadelbuy

---
# ExternalSecret for Database Credentials (Vault)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-database-vault
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault
    kind: SecretStore
  target:
    name: citadelbuy-database-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        DATABASE_URL: "{{ .url }}"
        POSTGRES_USER: "{{ .username }}"
        POSTGRES_PASSWORD: "{{ .password }}"
        POSTGRES_HOST: "{{ .host }}"
        POSTGRES_PORT: "{{ .port }}"
        POSTGRES_DB: "{{ .database }}"
  dataFrom:
    - extract:
        key: citadelbuy/production/database/postgres

---
# ExternalSecret for Redis Credentials (Vault)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-redis-vault
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault
    kind: SecretStore
  target:
    name: citadelbuy-redis-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        REDIS_URL: "{{ .url }}"
        REDIS_PASSWORD: "{{ .password }}"
        REDIS_HOST: "{{ .host }}"
        REDIS_PORT: "{{ .port }}"
  dataFrom:
    - extract:
        key: citadelbuy/production/redis/connection

---
# =========================================
# COMBINED SECRETS FOR DEPLOYMENT
# =========================================

# ExternalSecret combining all secrets from AWS (recommended approach)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: citadelbuy-all-secrets-aws
  namespace: citadelbuy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore
  target:
    name: citadelbuy-all-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      mergePolicy: Merge
  data:
    # Database
    - secretKey: DATABASE_URL
      remoteRef:
        key: citadelbuy/production/postgres/credentials
        property: url
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: citadelbuy/production/postgres/credentials
        property: password
    # Redis
    - secretKey: REDIS_URL
      remoteRef:
        key: citadelbuy/production/redis/credentials
        property: url
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: citadelbuy/production/redis/credentials
        property: password
    # JWT
    - secretKey: JWT_SECRET
      remoteRef:
        key: citadelbuy/production/jwt/secrets
        property: access_token_secret
    - secretKey: JWT_REFRESH_SECRET
      remoteRef:
        key: citadelbuy/production/jwt/secrets
        property: refresh_token_secret
    # Stripe
    - secretKey: STRIPE_SECRET_KEY
      remoteRef:
        key: citadelbuy/production/stripe/keys
        property: secret_key
    - secretKey: STRIPE_PUBLISHABLE_KEY
      remoteRef:
        key: citadelbuy/production/stripe/keys
        property: publishable_key
    - secretKey: STRIPE_WEBHOOK_SECRET
      remoteRef:
        key: citadelbuy/production/stripe/keys
        property: webhook_secret
    # OpenAI
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: citadelbuy/production/openai/key
        property: api_key
    # Session
    - secretKey: SESSION_SECRET
      remoteRef:
        key: citadelbuy/production/session/secret
        property: secret
    # OAuth
    - secretKey: GOOGLE_CLIENT_ID
      remoteRef:
        key: citadelbuy/production/oauth/google
        property: client_id
    - secretKey: GOOGLE_CLIENT_SECRET
      remoteRef:
        key: citadelbuy/production/oauth/google
        property: client_secret
    - secretKey: FACEBOOK_APP_ID
      remoteRef:
        key: citadelbuy/production/oauth/facebook
        property: app_id
    - secretKey: FACEBOOK_APP_SECRET
      remoteRef:
        key: citadelbuy/production/oauth/facebook
        property: app_secret

---
# =========================================
# DEPLOYMENT EXAMPLE
# =========================================

# Example Deployment using External Secrets
apiVersion: apps/v1
kind: Deployment
metadata:
  name: citadelbuy-api
  namespace: citadelbuy
spec:
  replicas: 3
  selector:
    matchLabels:
      app: citadelbuy-api
  template:
    metadata:
      labels:
        app: citadelbuy-api
    spec:
      serviceAccountName: citadelbuy-api
      containers:
        - name: api
          image: citadelbuy/api:latest
          ports:
            - containerPort: 3000
          # Option 1: Use individual secret references
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: citadelbuy-database-secret
                  key: DATABASE_URL
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: citadelbuy-redis-secret
                  key: REDIS_URL
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: citadelbuy-jwt-secret
                  key: JWT_SECRET
          # Option 2: Use envFrom to load all secrets (recommended)
          # envFrom:
          #   - secretRef:
          #       name: citadelbuy-all-secrets

---
# =========================================
# MONITORING AND ALERTS
# =========================================

# ServiceMonitor for External Secrets Operator (if using Prometheus)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: external-secrets
  namespace: external-secrets-system
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: external-secrets
  endpoints:
    - port: metrics
      interval: 30s

---
# PrometheusRule for External Secrets alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: external-secrets-alerts
  namespace: external-secrets-system
spec:
  groups:
    - name: external-secrets
      interval: 30s
      rules:
        - alert: ExternalSecretSyncFailed
          expr: external_secrets_sync_calls_error > 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "External Secret sync failed"
            description: "ExternalSecret {{ $labels.name }} in namespace {{ $labels.namespace }} failed to sync"

        - alert: ExternalSecretStale
          expr: time() - external_secrets_sync_calls_total > 7200
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "External Secret not synced recently"
            description: "ExternalSecret {{ $labels.name }} hasn't synced in over 2 hours"
