# Data Residency Policies for Global Multi-Region Deployment
# Ensures data stays within appropriate geographic boundaries for compliance

apiVersion: v1
kind: Namespace
metadata:
  name: data-governance
  labels:
    name: data-governance
    purpose: data-residency-compliance

---
# ConfigMap for Data Residency Rules
apiVersion: v1
kind: ConfigMap
metadata:
  name: data-residency-rules
  namespace: data-governance
  labels:
    app: data-governance
data:
  # GDPR - European Union
  gdpr-countries.json: |
    {
      "region": "europe",
      "compliance": "GDPR",
      "dataResidency": "EU",
      "allowedLocations": ["westeurope", "northeurope", "francecentral", "germanywestcentral"],
      "countries": ["AT", "BE", "BG", "HR", "CY", "CZ", "DK", "EE", "FI", "FR", "DE", "GR", "HU", "IE", "IT", "LV", "LT", "LU", "MT", "NL", "PL", "PT", "RO", "SK", "SI", "ES", "SE"],
      "dataTransferRestrictions": true,
      "encryptionRequired": true,
      "retentionMaxDays": 2555
    }

  # POPIA - South Africa
  popia-regions.json: |
    {
      "region": "africa",
      "compliance": "POPIA",
      "dataResidency": "ZA",
      "allowedLocations": ["southafricanorth", "southafricawest"],
      "countries": ["ZA", "NA", "BW", "ZW", "MZ", "LS", "SZ"],
      "dataTransferRestrictions": true,
      "encryptionRequired": true,
      "retentionMaxDays": 365
    }

  # PDPA - Singapore and Southeast Asia
  pdpa-regions.json: |
    {
      "region": "asia-southeast",
      "compliance": "PDPA",
      "dataResidency": "SG",
      "allowedLocations": ["southeastasia"],
      "countries": ["SG", "MY", "TH", "VN", "ID", "PH"],
      "dataTransferRestrictions": true,
      "encryptionRequired": true,
      "retentionMaxDays": 730
    }

  # APPI - Japan
  appi-regions.json: |
    {
      "region": "asia-japan",
      "compliance": "APPI",
      "dataResidency": "JP",
      "allowedLocations": ["japaneast", "japanwest"],
      "countries": ["JP"],
      "dataTransferRestrictions": true,
      "encryptionRequired": true,
      "retentionMaxDays": 1095
    }

  # Privacy Act - Australia
  privacy-act-regions.json: |
    {
      "region": "australia",
      "compliance": "Privacy Act 1988",
      "dataResidency": "AU",
      "allowedLocations": ["australiaeast", "australiasoutheast"],
      "countries": ["AU", "NZ"],
      "dataTransferRestrictions": true,
      "encryptionRequired": true,
      "retentionMaxDays": 2555
    }

  # CCPA - California (US)
  ccpa-regions.json: |
    {
      "region": "us-california",
      "compliance": "CCPA",
      "dataResidency": "US-CA",
      "allowedLocations": ["westus", "westus2", "westus3"],
      "countries": ["US"],
      "dataTransferRestrictions": false,
      "encryptionRequired": true,
      "retentionMaxDays": 730
    }

  # Cross-border data transfer policy
  cross-border-policy.json: |
    {
      "allowedTransfers": {
        "EU-to-US": {
          "allowed": true,
          "mechanism": "Standard Contractual Clauses",
          "encryptionRequired": true,
          "auditRequired": true
        },
        "EU-to-Asia": {
          "allowed": true,
          "mechanism": "Binding Corporate Rules",
          "encryptionRequired": true,
          "auditRequired": true
        },
        "Asia-to-EU": {
          "allowed": true,
          "mechanism": "Standard Contractual Clauses",
          "encryptionRequired": true,
          "auditRequired": true
        },
        "Africa-to-EU": {
          "allowed": true,
          "mechanism": "Standard Contractual Clauses",
          "encryptionRequired": true,
          "auditRequired": true
        }
      },
      "blockedTransfers": {
        "China": ["ALL"],
        "Russia": ["EU", "US"],
        "Iran": ["ALL"],
        "North Korea": ["ALL"]
      }
    }

---
# NetworkPolicy - Enforce Regional Data Boundaries
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: regional-data-isolation
  namespace: data-governance
spec:
  podSelector:
    matchLabels:
      data-classification: sensitive
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          region: same-region-only
    - podSelector:
        matchLabels:
          data-classification: sensitive
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow only to same region
  - to:
    - namespaceSelector:
        matchLabels:
          region: same-region-only

---
# OPA Gatekeeper ConstraintTemplate for Data Residency
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: dataresidencyconstraint
  namespace: data-governance
spec:
  crd:
    spec:
      names:
        kind: DataResidencyConstraint
      validation:
        openAPIV3Schema:
          type: object
          properties:
            allowedRegions:
              type: array
              items:
                type: string
            dataClassification:
              type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package dataresidency

        violation[{"msg": msg}] {
          input.review.object.kind == "Pod"
          dataClass := input.review.object.metadata.labels["data-classification"]
          dataClass == "sensitive"

          nodeRegion := input.review.object.spec.nodeSelector["topology.kubernetes.io/region"]
          not allowed_region(nodeRegion)

          msg := sprintf("Pod with sensitive data cannot be scheduled in region: %v. Allowed regions: %v", [nodeRegion, input.parameters.allowedRegions])
        }

        allowed_region(region) {
          input.parameters.allowedRegions[_] == region
        }

---
# Data Residency Constraint for EU (GDPR)
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: DataResidencyConstraint
metadata:
  name: eu-gdpr-data-residency
  namespace: data-governance
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaceSelector:
      matchLabels:
        data-region: europe
  parameters:
    allowedRegions:
      - westeurope
      - northeurope
      - francecentral
      - germanywestcentral
    dataClassification: sensitive

---
# Data Residency Constraint for Africa (POPIA)
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: DataResidencyConstraint
metadata:
  name: africa-popia-data-residency
  namespace: data-governance
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaceSelector:
      matchLabels:
        data-region: africa
  parameters:
    allowedRegions:
      - southafricanorth
      - southafricawest
    dataClassification: sensitive

---
# Data Residency Constraint for Asia (PDPA/APPI)
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: DataResidencyConstraint
metadata:
  name: asia-pdpa-data-residency
  namespace: data-governance
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaceSelector:
      matchLabels:
        data-region: asia
  parameters:
    allowedRegions:
      - southeastasia
      - japaneast
      - australiaeast
    dataClassification: sensitive

---
# Service for Data Classification API
apiVersion: v1
kind: Service
metadata:
  name: data-classification-api
  namespace: data-governance
  labels:
    app: data-classification
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: data-classification

---
# Deployment for Data Classification Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-classification
  namespace: data-governance
  labels:
    app: data-classification
spec:
  replicas: 2
  selector:
    matchLabels:
      app: data-classification
  template:
    metadata:
      labels:
        app: data-classification
        data-classification: system
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
      - name: classifier
        image: broxivaprodacr.azurecr.io/broxiva-data-classification:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: ENABLE_GDPR
          value: "true"
        - name: ENABLE_POPIA
          value: "true"
        - name: ENABLE_PDPA
          value: "true"
        - name: ENABLE_APPI
          value: "true"
        - name: DEFAULT_RETENTION_DAYS
          value: "730"
        volumeMounts:
        - name: residency-rules
          mountPath: /app/config/residency
          readOnly: true
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: residency-rules
        configMap:
          name: data-residency-rules

---
# RBAC for Data Governance
apiVersion: v1
kind: ServiceAccount
metadata:
  name: data-governance-sa
  namespace: data-governance

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: data-governance-role
rules:
- apiGroups: [""]
  resources: ["pods", "namespaces"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["policy"]
  resources: ["podsecuritypolicies"]
  verbs: ["use"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: data-governance-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: data-governance-role
subjects:
- kind: ServiceAccount
  name: data-governance-sa
  namespace: data-governance

---
# Audit Policy for Data Access
apiVersion: audit.k8s.io/v1
kind: Policy
metadata:
  name: data-access-audit-policy
  namespace: data-governance
rules:
# Log all requests to sensitive data
- level: RequestResponse
  namespaces: ["production", "staging"]
  resources:
  - group: ""
    resources: ["secrets", "configmaps"]
  - group: "apps"
    resources: ["deployments", "statefulsets"]
  omitStages:
  - RequestReceived

# Log metadata for all other requests
- level: Metadata
  omitStages:
  - RequestReceived
