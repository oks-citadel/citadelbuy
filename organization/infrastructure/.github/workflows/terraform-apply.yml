name: Terraform Apply

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      plan_artifact:
        description: 'Plan artifact name (from terraform-plan workflow)'
        required: true
        type: string
      confirm:
        description: 'Type "APPLY" to confirm'
        required: true
        type: string

env:
  TF_VERSION: '1.6.0'
  WORKING_DIRECTORY: infrastructure/terraform

jobs:
  # ============================================
  # Validation
  # ============================================
  validate:
    name: Validate Input
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "APPLY" ]; then
            echo "Error: You must type 'APPLY' to confirm"
            exit 1
          fi

      - name: Validate environment
        run: |
          case "${{ github.event.inputs.environment }}" in
            dev|staging|prod)
              echo "Valid environment: ${{ github.event.inputs.environment }}"
              ;;
            *)
              echo "Error: Invalid environment"
              exit 1
              ;;
          esac

  # ============================================
  # Apply
  # ============================================
  apply:
    name: Apply (${{ github.event.inputs.environment }})
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ github.event.inputs.environment }}

    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ github.event.inputs.environment == 'prod' && secrets.AZURE_PROD_SUBSCRIPTION_ID || github.event.inputs.environment == 'staging' && secrets.AZURE_STAGING_SUBSCRIPTION_ID || secrets.AZURE_DEV_SUBSCRIPTION_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.plan_artifact }}
          path: ${{ env.WORKING_DIRECTORY }}/environments/${{ github.event.inputs.environment }}

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.WORKING_DIRECTORY }}/environments/${{ github.event.inputs.environment }}

      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve tfplan 2>&1 | tee apply_output.txt
        working-directory: ${{ env.WORKING_DIRECTORY }}/environments/${{ github.event.inputs.environment }}

      - name: Upload Apply Output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ github.event.inputs.environment }}-apply-output
          path: ${{ env.WORKING_DIRECTORY }}/environments/${{ github.event.inputs.environment }}/apply_output.txt
          retention-days: 30

      - name: Get Outputs
        id: outputs
        run: terraform output -json > outputs.json
        working-directory: ${{ env.WORKING_DIRECTORY }}/environments/${{ github.event.inputs.environment }}

      - name: Upload Outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.environment }}-outputs
          path: ${{ env.WORKING_DIRECTORY }}/environments/${{ github.event.inputs.environment }}/outputs.json
          retention-days: 30

  # ============================================
  # Post-Apply Verification
  # ============================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: apply
    if: success()

    steps:
      - name: Download Outputs
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.environment }}-outputs
          path: ./outputs

      - name: Verify Infrastructure
        run: |
          echo "Verifying infrastructure deployment..."

          # Parse outputs
          AKS_NAME=$(jq -r '.aks_name.value // empty' outputs/outputs.json)
          APP_HOSTNAME=$(jq -r '.app_service_hostname.value // empty' outputs/outputs.json)

          if [ -n "$AKS_NAME" ]; then
            echo "AKS Cluster: $AKS_NAME"
          fi

          if [ -n "$APP_HOSTNAME" ]; then
            echo "App Service: $APP_HOSTNAME"
            # Health check
            curl -sf "https://$APP_HOSTNAME/api/health" || echo "Health check pending..."
          fi

          echo "Infrastructure deployment verified!"

  # ============================================
  # Notify
  # ============================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [apply, verify]
    if: always()

    steps:
      - name: Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#infrastructure'
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            Infrastructure deployment to ${{ github.event.inputs.environment }}
            Status: ${{ needs.apply.result }}
            Triggered by: ${{ github.actor }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
