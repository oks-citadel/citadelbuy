---
# CitadelBuy Main Deployment Playbook
# This is the master playbook that orchestrates the entire deployment

- name: Deploy CitadelBuy Infrastructure
  hosts: all
  gather_facts: true
  become: true

  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install Python dependencies
      apt:
        name:
          - python3-pip
          - python3-setuptools
        state: present
      when: ansible_os_family == "Debian"

  roles:
    - common

- name: Setup Database Servers
  hosts: dev_db:staging_db:prod_db
  gather_facts: true
  become: true

  roles:
    - database

- name: Setup Application Servers
  hosts: dev_app:staging_app:prod_app
  gather_facts: true
  become: true

  roles:
    - backend

- name: Setup Web Servers
  hosts: dev_web:staging_web:prod_web
  gather_facts: true
  become: true

  roles:
    - frontend

- name: Setup Monitoring
  hosts: monitoring
  gather_facts: true
  become: true

  roles:
    - monitoring

- name: Post-deployment Health Checks
  hosts: all
  gather_facts: false
  become: true

  tasks:
    - name: Check Docker service
      systemd:
        name: docker
        state: started
      register: docker_status

    - name: Display deployment status
      debug:
        msg: "Deployment completed successfully on {{ inventory_hostname }}"
