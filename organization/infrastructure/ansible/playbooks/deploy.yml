---
# CitadelBuy Application Deployment Playbook
# Deploys application updates without infrastructure changes

- name: Deploy CitadelBuy Application Updates
  hosts: all
  gather_facts: true
  become: true
  serial: "{{ rolling_update_batch | default(1) }}"

  vars:
    deployment_strategy: "{{ strategy | default('rolling') }}"
    health_check_retries: 5
    health_check_delay: 10

  pre_tasks:
    - name: Check current deployment status
      command: docker ps --filter "name=citadelbuy" --format "{{.Names}}"
      register: running_containers
      changed_when: false

    - name: Display current containers
      debug:
        var: running_containers.stdout_lines

  tasks:
    - name: Pull latest Docker images
      community.docker.docker_image:
        name: "{{ docker_registry }}/citadelbuy-ecommerce:{{ item }}"
        tag: "{{ docker_image_tag }}"
        source: pull
        force_source: yes
      loop:
        - backend
        - frontend
      tags: pull

    - name: Stop current containers gracefully
      community.docker.docker_container:
        name: "{{ item }}"
        state: stopped
        stop_timeout: 30
      loop:
        - citadelbuy-backend
        - citadelbuy-frontend
      ignore_errors: yes
      tags: stop

    - name: Remove old containers
      community.docker.docker_container:
        name: "{{ item }}"
        state: absent
      loop:
        - citadelbuy-backend
        - citadelbuy-frontend
      tags: cleanup

    - name: Deploy backend container
      community.docker.docker_container:
        name: citadelbuy-backend
        image: "{{ docker_registry }}/citadelbuy-ecommerce:backend-{{ docker_image_tag }}"
        state: started
        restart_policy: "{{ docker_restart_policy }}"
        networks:
          - name: "{{ docker_network }}"
        env_file: /opt/citadelbuy/.env
        ports:
          - "{{ backend_port }}:4000"
        memory: "{{ backend_memory_limit }}"
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
          interval: 30s
          timeout: 10s
          retries: 3
          start_period: 40s
      tags: backend

    - name: Wait for backend to be healthy
      uri:
        url: "http://localhost:{{ backend_port }}/health"
        status_code: 200
      register: backend_health
      until: backend_health.status == 200
      retries: "{{ health_check_retries }}"
      delay: "{{ health_check_delay }}"
      tags: backend

    - name: Deploy frontend container
      community.docker.docker_container:
        name: citadelbuy-frontend
        image: "{{ docker_registry }}/citadelbuy-ecommerce:frontend-{{ docker_image_tag }}"
        state: started
        restart_policy: "{{ docker_restart_policy }}"
        networks:
          - name: "{{ docker_network }}"
        env_file: /opt/citadelbuy/.env.frontend
        ports:
          - "{{ frontend_port }}:3000"
        memory: "{{ frontend_memory_limit }}"
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:3000"]
          interval: 30s
          timeout: 10s
          retries: 3
          start_period: 40s
      tags: frontend

    - name: Wait for frontend to be healthy
      uri:
        url: "http://localhost:{{ frontend_port }}"
        status_code: 200
      register: frontend_health
      until: frontend_health.status == 200
      retries: "{{ health_check_retries }}"
      delay: "{{ health_check_delay }}"
      tags: frontend

    - name: Run database migrations
      community.docker.docker_container_exec:
        container: citadelbuy-backend
        command: npm run prisma:migrate:deploy
      register: migration_result
      tags: migration

    - name: Display migration result
      debug:
        var: migration_result.stdout_lines
      tags: migration

  post_tasks:
    - name: Verify deployment
      command: docker ps --filter "name=citadelbuy" --format "{{.Names}} - {{.Status}}"
      register: final_status
      changed_when: false

    - name: Display deployment status
      debug:
        msg: "Deployment completed: {{ final_status.stdout_lines }}"

    - name: Send deployment notification
      debug:
        msg: "CitadelBuy deployed successfully on {{ inventory_hostname }} at {{ ansible_date_time.iso8601 }}"
