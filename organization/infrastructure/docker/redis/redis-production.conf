# ==================================
# Broxiva Redis Production Configuration
# ==================================
# SECURITY HARDENED CONFIGURATION
# This configuration file is designed for production use with enhanced security.
# Password authentication is REQUIRED and must be set via command-line or environment variable.
# ==================================

# ==================================
# NETWORK
# ==================================
# Bind to all interfaces (Docker networking will handle isolation)
bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

# ==================================
# GENERAL
# ==================================
daemonize no
supervised no
pidfile /var/run/redis_6379.pid
loglevel notice
logfile ""
databases 16

# ==================================
# SNAPSHOTTING
# ==================================
# Save the DB to disk periodically
save 900 1      # After 900 seconds (15 min) if at least 1 key changed
save 300 10     # After 300 seconds (5 min) if at least 10 keys changed
save 60 10000   # After 60 seconds if at least 10000 keys changed

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# ==================================
# REPLICATION
# ==================================
replica-serve-stale-data yes
replica-read-only yes
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-disable-tcp-nodelay no
replica-priority 100

# ==================================
# SECURITY
# ==================================
# Password protection is REQUIRED for production
# Set password via command line: --requirepass "your-secure-password"
# Or via environment variable: REDIS_PASSWORD
# NOTE: Password is set in docker-compose.yml command, not here

# Disable dangerous commands in production
# These are renamed to prevent accidental or malicious use
# Commands will be renamed via docker-compose command line
# rename-command CONFIG ""
# rename-command DEBUG ""
# rename-command SHUTDOWN ""
# rename-command FLUSHALL ""
# rename-command FLUSHDB ""

# Protected mode (automatically disabled when password is set)
protected-mode yes

# ==================================
# LIMITS
# ==================================
# Maximum number of connected clients
maxclients 10000

# Maximum memory usage (256MB default, adjust based on your needs)
# For production with high traffic, consider 1GB or more
maxmemory 512mb

# Eviction policy when maxmemory is reached
# allkeys-lru: Evict any key using LRU algorithm
maxmemory-policy allkeys-lru

# Number of samples for LRU/LFU algorithms
maxmemory-samples 5

# ==================================
# APPEND ONLY MODE (AOF)
# ==================================
# Enable AOF for better durability
appendonly yes
appendfilename "appendonly.aof"

# Fsync policy:
# - always: Very safe but slow
# - everysec: Good compromise (recommended for production)
# - no: Fast but less safe
appendfsync everysec

no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# ==================================
# LUA SCRIPTING
# ==================================
lua-time-limit 5000

# ==================================
# SLOW LOG
# ==================================
# Log queries slower than 10ms (10000 microseconds)
slowlog-log-slower-than 10000
slowlog-max-len 128

# ==================================
# LATENCY MONITOR
# ==================================
# Collect latency data (0 = disabled)
# Set to 100 to log latency events over 100ms
latency-monitor-threshold 100

# ==================================
# EVENT NOTIFICATION
# ==================================
# Keyspace notifications (disabled by default for performance)
# Enable if needed for your application
notify-keyspace-events ""

# ==================================
# ADVANCED CONFIG
# ==================================
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Redis process scheduling
hz 10
dynamic-hz yes

# AOF/RDB file writing (more efficient on modern systems)
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes

# ==================================
# TLS/SSL (Optional - Uncomment to enable)
# ==================================
# For maximum security, enable TLS encryption
# Requires certificate files to be mounted in the container
#
# port 0
# tls-port 6379
# tls-cert-file /etc/redis/ssl/redis.crt
# tls-key-file /etc/redis/ssl/redis.key
# tls-ca-cert-file /etc/redis/ssl/ca.crt
# tls-auth-clients optional
# tls-replication yes
# tls-cluster yes

# ==================================
# PRODUCTION SECURITY CHECKLIST
# ==================================
# [ ] Password authentication enabled (via --requirepass)
# [ ] Protected mode enabled
# [ ] Dangerous commands renamed/disabled
# [ ] Bind address configured correctly
# [ ] Firewall rules in place
# [ ] TLS/SSL enabled (recommended)
# [ ] Regular backups configured
# [ ] Monitoring and alerting set up
# [ ] Log aggregation configured
# [ ] Resource limits appropriate for workload
# [ ] Redis version is latest stable
# [ ] Security patches applied
#
# For more information:
# - https://redis.io/topics/security
# - https://redis.io/topics/admin
# - docs/DOCKER_SECURITY.md
# ==================================
