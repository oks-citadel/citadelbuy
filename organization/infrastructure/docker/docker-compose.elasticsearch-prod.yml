# =========================================================
# CitadelBuy Elasticsearch Production Configuration
# =========================================================
# SECURITY NOTICE: This configuration enables X-Pack security
# Generate passwords with: docker run --rm docker.elastic.co/elasticsearch/elasticsearch:8.11.0 bin/elasticsearch-setup-passwords auto
# =========================================================

version: '3.9'

networks:
  citadelbuy-network:
    driver: bridge
  elasticsearch-network:
    driver: bridge

volumes:
  elasticsearch-data-01:
    driver: local
  elasticsearch-data-02:
    driver: local
  elasticsearch-data-03:
    driver: local
  kibana-data:
    driver: local

# =========================================================
# Production Elasticsearch Cluster (3 Nodes)
# =========================================================
services:
  # Node 1 - Master & Data
  elasticsearch-01:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: citadelbuy-elasticsearch-01
    restart: unless-stopped
    environment:
      # Cluster Configuration
      - cluster.name=citadelbuy-production
      - node.name=es-node-01
      - node.roles=master,data,ingest

      # Discovery & Cluster Formation
      - discovery.seed_hosts=elasticsearch-02,elasticsearch-03
      - cluster.initial_master_nodes=es-node-01,es-node-02,es-node-03

      # Network Configuration
      - network.host=0.0.0.0
      - http.port=9200
      - transport.port=9300

      # Memory & Performance
      - ES_JAVA_OPTS=-Xms2g -Xmx2g
      - bootstrap.memory_lock=true

      # Security - X-Pack
      - xpack.security.enabled=true
      - xpack.security.enrollment.enabled=true
      - xpack.security.http.ssl.enabled=false  # Enable in production with proper certs
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.verification_mode=certificate
      - xpack.security.transport.ssl.key=/usr/share/elasticsearch/config/certificates/es-node-01/es-node-01.key
      - xpack.security.transport.ssl.certificate=/usr/share/elasticsearch/config/certificates/es-node-01/es-node-01.crt
      - xpack.security.transport.ssl.certificate_authorities=/usr/share/elasticsearch/config/certificates/ca/ca.crt

      # Authentication
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}

      # Index Settings
      - action.auto_create_index=.monitoring*,.watches,.triggered_watches,.watcher-history*,.ml*,citadelbuy-*
      - action.destructive_requires_name=true

      # Performance Tuning
      - indices.memory.index_buffer_size=30%
      - indices.queries.cache.size=15%
      - thread_pool.write.queue_size=1000
      - thread_pool.search.queue_size=1000
    volumes:
      - elasticsearch-data-01:/usr/share/elasticsearch/data
      - ./elasticsearch/certificates:/usr/share/elasticsearch/config/certificates:ro
      - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - citadelbuy-network
      - elasticsearch-network
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -s -u elastic:${ELASTICSEARCH_PASSWORD} http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      - "com.citadelbuy.service=elasticsearch-master"
      - "com.citadelbuy.description=Elasticsearch Master Node 01"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Node 2 - Master & Data
  elasticsearch-02:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: citadelbuy-elasticsearch-02
    restart: unless-stopped
    environment:
      - cluster.name=citadelbuy-production
      - node.name=es-node-02
      - node.roles=master,data,ingest
      - discovery.seed_hosts=elasticsearch-01,elasticsearch-03
      - cluster.initial_master_nodes=es-node-01,es-node-02,es-node-03
      - network.host=0.0.0.0
      - ES_JAVA_OPTS=-Xms2g -Xmx2g
      - bootstrap.memory_lock=true
      - xpack.security.enabled=true
      - xpack.security.enrollment.enabled=true
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.verification_mode=certificate
      - xpack.security.transport.ssl.key=/usr/share/elasticsearch/config/certificates/es-node-02/es-node-02.key
      - xpack.security.transport.ssl.certificate=/usr/share/elasticsearch/config/certificates/es-node-02/es-node-02.crt
      - xpack.security.transport.ssl.certificate_authorities=/usr/share/elasticsearch/config/certificates/ca/ca.crt
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - action.auto_create_index=.monitoring*,.watches,.triggered_watches,.watcher-history*,.ml*,citadelbuy-*
      - action.destructive_requires_name=true
      - indices.memory.index_buffer_size=30%
      - indices.queries.cache.size=15%
    volumes:
      - elasticsearch-data-02:/usr/share/elasticsearch/data
      - ./elasticsearch/certificates:/usr/share/elasticsearch/config/certificates:ro
      - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
    networks:
      - citadelbuy-network
      - elasticsearch-network
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -s -u elastic:${ELASTICSEARCH_PASSWORD} http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      - "com.citadelbuy.service=elasticsearch-master"
      - "com.citadelbuy.description=Elasticsearch Master Node 02"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Node 3 - Data Node
  elasticsearch-03:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: citadelbuy-elasticsearch-03
    restart: unless-stopped
    environment:
      - cluster.name=citadelbuy-production
      - node.name=es-node-03
      - node.roles=data,ingest
      - discovery.seed_hosts=elasticsearch-01,elasticsearch-02
      - cluster.initial_master_nodes=es-node-01,es-node-02,es-node-03
      - network.host=0.0.0.0
      - ES_JAVA_OPTS=-Xms2g -Xmx2g
      - bootstrap.memory_lock=true
      - xpack.security.enabled=true
      - xpack.security.enrollment.enabled=true
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.verification_mode=certificate
      - xpack.security.transport.ssl.key=/usr/share/elasticsearch/config/certificates/es-node-03/es-node-03.key
      - xpack.security.transport.ssl.certificate=/usr/share/elasticsearch/config/certificates/es-node-03/es-node-03.crt
      - xpack.security.transport.ssl.certificate_authorities=/usr/share/elasticsearch/config/certificates/ca/ca.crt
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - action.auto_create_index=.monitoring*,.watches,.triggered_watches,.watcher-history*,.ml*,citadelbuy-*
      - action.destructive_requires_name=true
      - indices.memory.index_buffer_size=30%
      - indices.queries.cache.size=15%
    volumes:
      - elasticsearch-data-03:/usr/share/elasticsearch/data
      - ./elasticsearch/certificates:/usr/share/elasticsearch/config/certificates:ro
      - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
    networks:
      - citadelbuy-network
      - elasticsearch-network
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -s -u elastic:${ELASTICSEARCH_PASSWORD} http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      - "com.citadelbuy.service=elasticsearch-data"
      - "com.citadelbuy.description=Elasticsearch Data Node 03"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # =========================================================
  # Kibana - Elasticsearch Dashboard & Management
  # =========================================================
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: citadelbuy-kibana
    restart: unless-stopped
    ports:
      - "5601:5601"
    environment:
      - SERVERNAME=kibana
      - ELASTICSEARCH_HOSTS=http://elasticsearch-01:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - XPACK_SECURITY_ENABLED=true
      - XPACK_MONITORING_ENABLED=true
      - KIBANA_DEFAULTAPPID=dashboard
    volumes:
      - kibana-data:/usr/share/kibana/data
      - ./kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
    networks:
      - citadelbuy-network
      - elasticsearch-network
    depends_on:
      elasticsearch-01:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "com.citadelbuy.service=kibana"
      - "com.citadelbuy.description=Kibana Dashboard"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

# =========================================================
# IMPORTANT NOTES:
# =========================================================
# 1. Generate SSL certificates before starting:
#    ./scripts/setup-elasticsearch-certs.sh
#
# 2. Set ELASTICSEARCH_PASSWORD environment variable:
#    export ELASTICSEARCH_PASSWORD=$(openssl rand -base64 32)
#
# 3. First-time setup:
#    docker-compose -f docker-compose.elasticsearch-prod.yml up -d
#    docker exec citadelbuy-elasticsearch-01 bin/elasticsearch-setup-passwords auto
#
# 4. Configure OS settings on host:
#    sudo sysctl -w vm.max_map_count=262144
#    echo "vm.max_map_count=262144" | sudo tee -a /etc/sysctl.conf
#
# 5. Backup strategy:
#    - Use Elasticsearch snapshots to S3/Azure Blob
#    - Configure snapshot repository
#    - Schedule daily automated backups
#
# 6. Monitoring:
#    - Kibana: http://localhost:5601
#    - Cluster health: GET /_cluster/health
#    - Node stats: GET /_nodes/stats
# =========================================================
