version: '3.8'

#===========================================
# Broxiva Complete Docker Stack
# Includes: App Services, Database, Cache, Monitoring
#===========================================
# CRITICAL SECURITY WARNING:
# - ALL passwords MUST be set via environment variables in .env file
# - Required variables: POSTGRES_PASSWORD, GRAFANA_ADMIN_PASSWORD, PGADMIN_PASSWORD
# - NEVER use default passwords in production or staging environments
# - See .env.docker.example in project root for required environment variables
# - Generate secure passwords: openssl rand -base64 32
# - Default fallback passwords below are WEAK and for development only!
#===========================================

services:
  #-----------------------------------------
  # Database Services
  #-----------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: broxiva-postgres
    restart: unless-stopped
    ports:
      - '5432:5432'
    environment:
      # Set POSTGRES_PASSWORD in .env file - do not use the default!
      POSTGRES_USER: ${POSTGRES_USER:-broxiva}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set in .env file}
      POSTGRES_DB: ${POSTGRES_DB:-broxiva_dev}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    networks:
      - broxiva-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-broxiva}']
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  #-----------------------------------------
  # Cache Services
  #-----------------------------------------
  redis:
    image: redis:7-alpine
    container_name: broxiva-redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    volumes:
      - redis-data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - broxiva-network
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  #-----------------------------------------
  # Application Services
  #-----------------------------------------
  backend:
    image: broxiva/broxiva-ecommerce:backend-latest
    container_name: broxiva-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - '4000:4000'
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4000
      # DATABASE_URL uses POSTGRES_PASSWORD from .env file
      DATABASE_URL: postgresql://${POSTGRES_USER:-broxiva}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-broxiva_dev}
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    volumes:
      - backend-uploads:/app/uploads
      - backend-logs:/app/logs
    networks:
      - broxiva-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    image: broxiva/broxiva-ecommerce:frontend-latest
    container_name: broxiva-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:4000}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
    networks:
      - broxiva-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  #-----------------------------------------
  # Nginx Reverse Proxy
  #-----------------------------------------
  nginx:
    image: nginx:alpine
    container_name: broxiva-nginx
    restart: unless-stopped
    depends_on:
      - backend
      - frontend
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-cache:/var/cache/nginx
      - nginx-logs:/var/log/nginx
    networks:
      - broxiva-network
    healthcheck:
      test: ['CMD', 'nginx', '-t']
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  #-----------------------------------------
  # Monitoring Services
  #-----------------------------------------
  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: broxiva-prometheus
    restart: unless-stopped
    ports:
      - '9090:9090'
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alerts:/etc/prometheus/alerts:ro
      - prometheus-data:/prometheus
    networks:
      - broxiva-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  grafana:
    image: grafana/grafana:11.3.0
    container_name: broxiva-grafana
    restart: unless-stopped
    depends_on:
      - prometheus
    ports:
      - '3001:3000'
    environment:
      # Set GRAFANA_ADMIN_PASSWORD in .env file - do not use the default!
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD must be set in .env file}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
      GF_USERS_ALLOW_SIGN_UP: false
    volumes:
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - grafana-data:/var/lib/grafana
    networks:
      - broxiva-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  node-exporter:
    image: prom/node-exporter:v1.8.2
    container_name: broxiva-node-exporter
    restart: unless-stopped
    ports:
      - '9100:9100'
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - broxiva-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: broxiva-cadvisor
    restart: unless-stopped
    ports:
      - '8080:8080'
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    networks:
      - broxiva-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  #-----------------------------------------
  # Management Tools
  #-----------------------------------------
  pgadmin:
    image: dpage/pgadmin4:8.13
    container_name: broxiva-pgadmin
    restart: unless-stopped
    depends_on:
      - postgres
    ports:
      - '5050:80'
    environment:
      # Set PGADMIN_PASSWORD in .env file - do not use the default!
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@broxiva.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:?PGADMIN_PASSWORD must be set in .env file}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - broxiva-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

#-----------------------------------------
# Volumes
#-----------------------------------------
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  backend-uploads:
    driver: local
  backend-logs:
    driver: local
  nginx-cache:
    driver: local
  nginx-logs:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  pgadmin-data:
    driver: local

#-----------------------------------------
# Networks
#-----------------------------------------
networks:
  broxiva-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
