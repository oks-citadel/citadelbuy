name: Cost Optimization - Shutdown Dev/Test

on:
  schedule:
    # Run at 8 PM UTC (end of business) weekdays
    - cron: '0 20 * * 1-5'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'shutdown'
        type: choice
        options:
          - shutdown
          - startup
          - status
      environments:
        description: 'Environments to manage'
        required: true
        default: 'dev,staging'
        type: string
      confirm:
        description: 'Type "CONFIRM" to proceed'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

env:
  PRODUCTION_PROTECTED: true

jobs:
  validate:
    name: Validate Action
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.parse.outputs.environments }}
      action: ${{ steps.parse.outputs.action }}
    steps:
      - name: Parse inputs
        id: parse
        run: |
          ACTION="${{ github.event.inputs.action || 'shutdown' }}"
          ENVS="${{ github.event.inputs.environments || 'dev,staging' }}"

          # Ensure production is never included
          ENVS=$(echo "$ENVS" | sed 's/production//g' | sed 's/prod//g' | sed 's/,,/,/g' | sed 's/^,//' | sed 's/,$//')

          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "environments=$ENVS" >> $GITHUB_OUTPUT

          echo "### Cost Optimization Action" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** $ACTION" >> $GITHUB_STEP_SUMMARY
          echo "- **Environments:** $ENVS" >> $GITHUB_STEP_SUMMARY
          echo "- **Production Protected:** Yes (never included)" >> $GITHUB_STEP_SUMMARY

      - name: Confirm for shutdown
        if: github.event.inputs.action == 'shutdown' && github.event.inputs.confirm != 'CONFIRM'
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "::error::Please type 'CONFIRM' to proceed with shutdown"
            exit 1
          fi
          # Scheduled runs don't need confirmation
          echo "Scheduled shutdown - proceeding automatically"

  shutdown-aks:
    name: Shutdown AKS Clusters
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.action == 'shutdown'
    strategy:
      matrix:
        environment: [dev, staging]
    steps:
      - name: Skip if environment not included
        if: "!contains(needs.validate.outputs.environments, matrix.environment)"
        run: echo "Skipping ${{ matrix.environment }}"

      - name: Azure Login
        if: contains(needs.validate.outputs.environments, matrix.environment)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Stop AKS cluster - ${{ matrix.environment }}
        if: contains(needs.validate.outputs.environments, matrix.environment)
        run: |
          CLUSTER_NAME="broxiva-${{ matrix.environment }}-aks"
          RG_NAME="broxiva-${{ matrix.environment }}-rg"

          echo "Stopping AKS cluster: $CLUSTER_NAME in $RG_NAME"

          # Check if cluster exists
          if az aks show --name $CLUSTER_NAME --resource-group $RG_NAME &>/dev/null; then
            az aks stop --name $CLUSTER_NAME --resource-group $RG_NAME --no-wait || echo "Could not stop cluster"
            echo "AKS cluster stop initiated: $CLUSTER_NAME"
          else
            echo "AKS cluster not found: $CLUSTER_NAME"
          fi

  shutdown-app-services:
    name: Shutdown App Services
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.action == 'shutdown'
    strategy:
      matrix:
        environment: [dev, staging]
    steps:
      - name: Skip if environment not included
        if: "!contains(needs.validate.outputs.environments, matrix.environment)"
        run: echo "Skipping ${{ matrix.environment }}"

      - name: Azure Login
        if: contains(needs.validate.outputs.environments, matrix.environment)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Stop App Services - ${{ matrix.environment }}
        if: contains(needs.validate.outputs.environments, matrix.environment)
        run: |
          RG_NAME="broxiva-${{ matrix.environment }}-rg"

          echo "Stopping App Services in: $RG_NAME"

          # Get all app services in resource group
          APPS=$(az webapp list --resource-group $RG_NAME --query "[].name" -o tsv 2>/dev/null || echo "")

          for app in $APPS; do
            echo "Stopping App Service: $app"
            az webapp stop --name $app --resource-group $RG_NAME || echo "Could not stop $app"
          done

          # Get all function apps
          FUNCTIONS=$(az functionapp list --resource-group $RG_NAME --query "[].name" -o tsv 2>/dev/null || echo "")

          for func in $FUNCTIONS; do
            echo "Stopping Function App: $func"
            az functionapp stop --name $func --resource-group $RG_NAME || echo "Could not stop $func"
          done

  shutdown-databases:
    name: Scale Down Databases
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.action == 'shutdown'
    strategy:
      matrix:
        environment: [dev, staging]
    steps:
      - name: Skip if environment not included
        if: "!contains(needs.validate.outputs.environments, matrix.environment)"
        run: echo "Skipping ${{ matrix.environment }}"

      - name: Azure Login
        if: contains(needs.validate.outputs.environments, matrix.environment)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Scale down PostgreSQL - ${{ matrix.environment }}
        if: contains(needs.validate.outputs.environments, matrix.environment)
        run: |
          RG_NAME="broxiva-${{ matrix.environment }}-rg"
          SERVER_NAME="broxiva-${{ matrix.environment }}-postgres"

          echo "Scaling down PostgreSQL: $SERVER_NAME"

          # Check if server exists and scale down
          if az postgres flexible-server show --name $SERVER_NAME --resource-group $RG_NAME &>/dev/null; then
            az postgres flexible-server stop --name $SERVER_NAME --resource-group $RG_NAME || echo "Could not stop PostgreSQL"
          else
            echo "PostgreSQL server not found: $SERVER_NAME"
          fi

  startup-resources:
    name: Startup Resources
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.action == 'startup'
    strategy:
      matrix:
        environment: [dev, staging]
    steps:
      - name: Skip if environment not included
        if: "!contains(needs.validate.outputs.environments, matrix.environment)"
        run: echo "Skipping ${{ matrix.environment }}"

      - name: Azure Login
        if: contains(needs.validate.outputs.environments, matrix.environment)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Start all resources - ${{ matrix.environment }}
        if: contains(needs.validate.outputs.environments, matrix.environment)
        run: |
          RG_NAME="broxiva-${{ matrix.environment }}-rg"

          echo "Starting resources in: $RG_NAME"

          # Start PostgreSQL first
          SERVER_NAME="broxiva-${{ matrix.environment }}-postgres"
          az postgres flexible-server start --name $SERVER_NAME --resource-group $RG_NAME 2>/dev/null || echo "PostgreSQL not found or could not start"

          # Start AKS
          CLUSTER_NAME="broxiva-${{ matrix.environment }}-aks"
          az aks start --name $CLUSTER_NAME --resource-group $RG_NAME --no-wait 2>/dev/null || echo "AKS not found or could not start"

          # Start App Services
          APPS=$(az webapp list --resource-group $RG_NAME --query "[].name" -o tsv 2>/dev/null || echo "")
          for app in $APPS; do
            az webapp start --name $app --resource-group $RG_NAME || true
          done

          # Start Function Apps
          FUNCTIONS=$(az functionapp list --resource-group $RG_NAME --query "[].name" -o tsv 2>/dev/null || echo "")
          for func in $FUNCTIONS; do
            az functionapp start --name $func --resource-group $RG_NAME || true
          done

  status-check:
    name: Check Resource Status
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.action == 'status' || always()
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check all environments
        run: |
          echo "### Resource Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Resource Type | Name | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|---------------|------|--------|" >> $GITHUB_STEP_SUMMARY

          for ENV in dev staging prod; do
            RG_NAME="broxiva-${ENV}-rg"

            # Check AKS
            AKS_NAME="broxiva-${ENV}-aks"
            AKS_STATE=$(az aks show --name $AKS_NAME --resource-group $RG_NAME --query "powerState.code" -o tsv 2>/dev/null || echo "NotFound")
            echo "| $ENV | AKS | $AKS_NAME | $AKS_STATE |" >> $GITHUB_STEP_SUMMARY

            # Check PostgreSQL
            PG_NAME="broxiva-${ENV}-postgres"
            PG_STATE=$(az postgres flexible-server show --name $PG_NAME --resource-group $RG_NAME --query "state" -o tsv 2>/dev/null || echo "NotFound")
            echo "| $ENV | PostgreSQL | $PG_NAME | $PG_STATE |" >> $GITHUB_STEP_SUMMARY
          done

      - name: Calculate cost savings
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Estimated Cost Savings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "When dev and staging are shut down:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Hourly Cost | Daily Savings (16h) | Monthly Savings |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|---------------------|-----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| AKS (Dev) | ~\$0.10/node | ~\$4.80 | ~\$144 |" >> $GITHUB_STEP_SUMMARY
          echo "| AKS (Staging) | ~\$0.10/node | ~\$4.80 | ~\$144 |" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL (Dev) | ~\$0.05 | ~\$2.40 | ~\$72 |" >> $GITHUB_STEP_SUMMARY
          echo "| PostgreSQL (Staging) | ~\$0.08 | ~\$3.84 | ~\$115 |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Estimated** | - | ~\$15.84 | ~\$475+ |" >> $GITHUB_STEP_SUMMARY

  generate-report:
    name: Generate Cost Report
    runs-on: ubuntu-latest
    needs: [validate, shutdown-aks, shutdown-app-services, shutdown-databases, status-check]
    if: always()
    steps:
      - name: Generate cost optimization report
        run: |
          cat > cost-optimization-report.json << EOF
          {
            "report_type": "cost_optimization",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "action_performed": "${{ needs.validate.outputs.action }}",
            "environments_affected": "${{ needs.validate.outputs.environments }}",
            "production_protected": true,
            "shutdown_results": {
              "aks_clusters": "${{ needs.shutdown-aks.result || 'skipped' }}",
              "app_services": "${{ needs.shutdown-app-services.result || 'skipped' }}",
              "databases": "${{ needs.shutdown-databases.result || 'skipped' }}"
            },
            "estimated_savings": {
              "daily": "$15.84",
              "monthly": "$475+",
              "currency": "USD"
            },
            "how_to_restart": "Run this workflow with action=startup",
            "next_scheduled_shutdown": "8 PM UTC weekdays",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF

      - name: Upload cost report
        uses: actions/upload-artifact@v4
        with:
          name: cost-optimization-report
          path: cost-optimization-report.json
          retention-days: 90

  notify:
    name: Notify Cost Optimization
    runs-on: ubuntu-latest
    needs: [validate, shutdown-aks, shutdown-app-services, shutdown-databases]
    if: always()
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Cost Optimization Complete",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Cost Optimization - ${{ needs.validate.outputs.action }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Environments:*\n${{ needs.validate.outputs.environments }}"},
                    {"type": "mrkdwn", "text": "*AKS:*\n${{ needs.shutdown-aks.result || 'skipped' }}"},
                    {"type": "mrkdwn", "text": "*App Services:*\n${{ needs.shutdown-app-services.result || 'skipped' }}"},
                    {"type": "mrkdwn", "text": "*Databases:*\n${{ needs.shutdown-databases.result || 'skipped' }}"}
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Estimated Monthly Savings:* $475+ USD\n*Production Status:* Protected (always running)"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        if: env.SLACK_WEBHOOK_URL != ''
