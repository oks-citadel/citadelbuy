name: Deploy to Production (Broxiva)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (must be tested in staging)'
        required: true
        type: string
      deployment_reason:
        description: 'Reason for production deployment'
        required: true
        type: string
      skip_security_scan:
        description: 'Skip security scans (NOT RECOMMENDED)'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - 'infrastructure/terraform/**'
      - 'apps/**'
      - '.github/workflows/deploy-production-broxiva.yml'

permissions:
  id-token: write
  contents: read
  packages: read
  deployments: write
  security-events: write

env:
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AKS_CLUSTER_NAME: broxiva-prod-aks
  AKS_RESOURCE_GROUP: broxiva-prod-rg
  KUBERNETES_NAMESPACE: broxiva-production
  CONTAINER_REGISTRY: ghcr.io/broxiva
  TF_VERSION: "1.6.0"

jobs:
  pre-deployment-validation:
    name: Pre-Deployment Security & Validation
    runs-on: ubuntu-latest
    outputs:
      security_passed: ${{ steps.security-check.outputs.passed }}
      validation_passed: ${{ steps.validation.outputs.passed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run secret scanning
        if: github.event.inputs.skip_security_scan != 'true'
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Run Trivy security scan
        if: github.event.inputs.skip_security_scan != 'true'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'infrastructure/terraform'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to Security tab
        if: github.event.inputs.skip_security_scan != 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'infrastructure'

      - name: Run tfsec
        if: github.event.inputs.skip_security_scan != 'true'
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infrastructure/terraform
          soft_fail: false

      - name: Security Check Status
        id: security-check
        run: |
          echo "passed=true" >> $GITHUB_OUTPUT
          echo "Security scans completed successfully"

      - name: Validate deployment readiness
        id: validation
        run: |
          echo "### Pre-Deployment Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure Validation: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Image Tag: ${{ github.event.inputs.image_tag || 'latest' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment Reason: ${{ github.event.inputs.deployment_reason || 'Automated deployment from main' }}" >> $GITHUB_STEP_SUMMARY
          echo "passed=true" >> $GITHUB_OUTPUT

  terraform-plan:
    name: Terraform Plan - Production
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    if: needs.pre-deployment-validation.outputs.security_passed == 'true'
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
      plan_summary: ${{ steps.summary.outputs.text }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/prod
        run: |
          terraform init \
            -backend-config="resource_group_name=broxiva-tfstate-rg" \
            -backend-config="storage_account_name=broxivatfstate" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=prod.terraform.tfstate"

      - name: Terraform Plan
        id: plan
        working-directory: infrastructure/terraform/environments/prod
        env:
          TF_VAR_azure_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_azure_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_cloud_provider: azure
          TF_VAR_db_admin_password: ${{ secrets.DB_ADMIN_PASSWORD_PROD }}
          TF_VAR_oncall_email: ${{ secrets.ONCALL_EMAIL }}
          TF_VAR_team_email: ${{ secrets.TEAM_EMAIL }}
        run: |
          terraform plan -detailed-exitcode -out=tfplan 2>&1 | tee plan-output.txt
          exitcode=$?
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
          exit 0

      - name: Generate Plan Summary
        id: summary
        run: |
          cd infrastructure/terraform/environments/prod

          if [ "${{ steps.plan.outputs.exitcode }}" == "0" ]; then
            SUMMARY="No infrastructure changes required"
          elif [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
            SUMMARY="Infrastructure changes detected - approval required"
          else
            SUMMARY="Plan failed - review required"
          fi

          echo "text=$SUMMARY" >> $GITHUB_OUTPUT

          echo "## Terraform Plan - Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $SUMMARY" >> $GITHUB_STEP_SUMMARY
          echo "**Exit Code:** ${{ steps.plan.outputs.exitcode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>View Plan Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```hcl' >> $GITHUB_STEP_SUMMARY
          tail -200 plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-prod-${{ github.sha }}
          path: |
            infrastructure/terraform/environments/prod/tfplan
            infrastructure/terraform/environments/prod/plan-output.txt
          retention-days: 30

  production-approval:
    name: Production Deployment Approval Gate
    needs: [pre-deployment-validation, terraform-plan]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://broxiva.com
    steps:
      - name: Approval Checkpoint
        run: |
          echo "================================================"
          echo "     PRODUCTION DEPLOYMENT APPROVED"
          echo "================================================"
          echo ""
          echo "Environment: PRODUCTION (broxiva.com)"
          echo "Approver: ${{ github.actor }}"
          echo "Reason: ${{ github.event.inputs.deployment_reason || 'Automated deployment from main branch' }}"
          echo "Image Tag: ${{ github.event.inputs.image_tag || 'latest from main' }}"
          echo "Terraform Changes: ${{ needs.terraform-plan.outputs.plan_summary }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "================================================"

      - name: Create deployment tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Production Deployment - ${new Date().toISOString().split('T')[0]}`,
              body: `## Broxiva Production Deployment\n\n**Status:** In Progress\n**Approved by:** @${{ github.actor }}\n**Reason:** ${{ github.event.inputs.deployment_reason || 'Automated deployment' }}\n**Image Tag:** ${{ github.event.inputs.image_tag || 'latest' }}\n**Timestamp:** ${new Date().toISOString()}\n\n### Infrastructure Changes\n\n${{ needs.terraform-plan.outputs.plan_summary }}\n\n### Workflow\n\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n---\n\n**Environment:** https://broxiva.com`,
              labels: ['deployment', 'production', 'broxiva']
            });

            core.setOutput('issue_number', issue.data.number);

  deploy-infrastructure:
    name: Deploy Infrastructure to Production
    needs: [terraform-plan, production-approval]
    runs-on: ubuntu-latest
    if: needs.terraform-plan.outputs.plan_exitcode == '2'
    environment:
      name: production
      url: https://broxiva.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-prod-${{ github.sha }}
          path: infrastructure/terraform/environments/prod

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/prod
        run: |
          terraform init \
            -backend-config="resource_group_name=broxiva-tfstate-rg" \
            -backend-config="storage_account_name=broxivatfstate" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=prod.terraform.tfstate"

      - name: Create State Backup
        run: |
          echo "Creating state backup before production deployment..."
          mkdir -p backups
          az storage blob download \
            --account-name broxivatfstate \
            --container-name tfstate \
            --name prod.terraform.tfstate \
            --file backups/prod-state-backup-${{ github.sha }}.tfstate || echo "No existing state to backup"

      - name: Terraform Apply
        id: apply
        working-directory: infrastructure/terraform/environments/prod
        run: |
          echo "Applying Terraform changes to PRODUCTION environment..."
          terraform apply -auto-approve tfplan 2>&1 | tee apply-output.txt

      - name: Upload Apply Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apply-output-prod-${{ github.sha }}
          path: infrastructure/terraform/environments/prod/apply-output.txt
          retention-days: 365

      - name: Upload State Backup
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: state-backup-prod-${{ github.sha }}
          path: backups/
          retention-days: 365

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Production Infrastructure Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ steps.apply.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | Production (Broxiva) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Approved By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.apply.outcome }}" == "success" ]; then
            echo "### Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure changes have been applied to production." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "CRITICAL: Infrastructure deployment failed. Review logs immediately." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::CRITICAL - Production infrastructure deployment failed"
          exit 1

  post-deployment-verification:
    name: Post-Deployment Verification
    needs: [deploy-infrastructure]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Azure Resources
        run: |
          echo "Verifying deployed resources in production..."

          # Check Resource Group
          echo "## Resource Group Status"
          az group show --name broxiva-prod-rg --query "{Name:name, Location:location, State:properties.provisioningState}" -o table

          # List all resources
          echo ""
          echo "## Resources in broxiva-prod-rg"
          az resource list --resource-group broxiva-prod-rg --query "[].{Name:name, Type:type, Location:location}" -o table

      - name: Verify AKS Cluster
        run: |
          echo "Verifying AKS cluster..."
          az aks show \
            --resource-group broxiva-prod-rg \
            --name broxiva-prod-aks \
            --query "{Name:name, Status:powerState.code, Version:kubernetesVersion, Nodes:agentPoolProfiles[0].count}" \
            -o table || echo "AKS cluster not found or not accessible"
        continue-on-error: true

      - name: Verify Database
        run: |
          echo "Verifying PostgreSQL database..."
          az postgres flexible-server show \
            --name broxiva-prod-postgres \
            --resource-group broxiva-prod-rg \
            --query "{Name:name, State:state, Version:version, Tier:sku.tier}" \
            -o table || echo "PostgreSQL server not found"
        continue-on-error: true

      - name: Health Checks
        run: |
          echo "Running production health checks..."
          sleep 30

          # Add your health check endpoints here
          # Example: curl -f https://broxiva.com/health || exit 1
          # Example: curl -f https://api.broxiva.com/health || exit 1

          echo "Health checks completed"
        continue-on-error: true

      - name: Verification Summary
        run: |
          echo "## Post-Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verification completed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Production URL:** https://broxiva.com" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL:** https://api.broxiva.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group:** broxiva-prod-rg" >> $GITHUB_STEP_SUMMARY
          echo "- **AKS Cluster:** broxiva-prod-aks" >> $GITHUB_STEP_SUMMARY
          echo "- **Verification Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  notification:
    name: Send Deployment Notifications
    needs: [deploy-infrastructure, post-deployment-verification]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Determine deployment status
        id: status
        run: |
          if [ "${{ needs.deploy-infrastructure.result }}" == "success" ] && [ "${{ needs.post-deployment-verification.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Production deployment completed successfully" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
            echo "emoji=:white_check_mark:" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Production deployment failed or requires attention" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "emoji=:x:" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} Production Deployment - ${{ steps.status.outputs.status }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.status.outputs.emoji }} Production Deployment - Broxiva"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Status:*\n${{ steps.status.outputs.status }}"},
                    {"type": "mrkdwn", "text": "*Environment:*\nProduction"},
                    {"type": "mrkdwn", "text": "*Deployed By:*\n@${{ github.actor }}"},
                    {"type": "mrkdwn", "text": "*Timestamp:*\n$(date -u '+%Y-%m-%d %H:%M:%S UTC')"}
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Reason:* ${{ github.event.inputs.deployment_reason || 'Automated deployment from main branch' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*URL:* https://broxiva.com"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Visit Site"
                      },
                      "url": "https://broxiva.com"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        if: env.SLACK_WEBHOOK_URL != ''

      - name: Send Teams notification
        uses: jdcargile/ms-teams-notification@v1.4
        with:
          github-token: ${{ github.token }}
          ms-teams-webhook-uri: ${{ secrets.TEAMS_WEBHOOK_URL }}
          notification-summary: "Production Deployment: ${{ steps.status.outputs.message }}"
          notification-color: ${{ steps.status.outputs.color }}
          timezone: UTC
        if: env.TEAMS_WEBHOOK_URL != ''
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
