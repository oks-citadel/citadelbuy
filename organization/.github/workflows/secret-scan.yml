name: Secret Detection & Scanning

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run every Monday at 5 AM UTC
    - cron: '0 5 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  gitleaks:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run Gitleaks with detailed output
        run: |
          docker run --rm -v $(pwd):/code zricethezav/gitleaks:latest \
            detect \
            --source=/code \
            --report-format=json \
            --report-path=/code/gitleaks-report.json \
            --verbose \
            --no-git || true

      - name: Run Gitleaks SARIF output
        run: |
          docker run --rm -v $(pwd):/code zricethezav/gitleaks:latest \
            detect \
            --source=/code \
            --report-format=sarif \
            --report-path=/code/gitleaks-results.sarif \
            --no-git || true

      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks-results.sarif
          category: gitleaks
        if: always()

      - name: Analyze Gitleaks results
        id: gitleaks-analysis
        run: |
          if [ -f gitleaks-report.json ]; then
            FINDINGS=$(jq '. | length' gitleaks-report.json)
            echo "findings=$FINDINGS" >> $GITHUB_OUTPUT

            echo "### Gitleaks Secret Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Total secrets found: $FINDINGS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ $FINDINGS -gt 0 ]; then
              echo "#### Detected Secrets:" >> $GITHUB_STEP_SUMMARY
              jq -r '.[] | "- **\(.RuleID)** in \(.File):\(.StartLine)"' gitleaks-report.json >> $GITHUB_STEP_SUMMARY
              echo "::error::Found $FINDINGS exposed secrets in repository"
              exit 1
            else
              echo "No secrets detected." >> $GITHUB_STEP_SUMMARY
            fi
          fi
        if: always()

      - name: Upload Gitleaks results
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-results
          path: |
            gitleaks-report.json
            gitleaks-results.sarif
          retention-days: 90
        if: always()

  trufflehog:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified --json --output=trufflehog-results.json

      - name: Run TruffleHog scan
        run: |
          docker run --rm -v $(pwd):/code trufflesecurity/trufflehog:latest \
            filesystem /code \
            --json \
            --no-update \
            > trufflehog-detailed.json || true

      - name: Analyze TruffleHog results
        id: trufflehog-analysis
        run: |
          if [ -f trufflehog-results.json ]; then
            VERIFIED=$(jq -s '[.[] | select(.Verified == true)] | length' trufflehog-results.json)
            UNVERIFIED=$(jq -s '[.[] | select(.Verified == false)] | length' trufflehog-results.json)

            echo "verified=$VERIFIED" >> $GITHUB_OUTPUT
            echo "unverified=$UNVERIFIED" >> $GITHUB_OUTPUT

            echo "### TruffleHog Secret Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Verified secrets: $VERIFIED" >> $GITHUB_STEP_SUMMARY
            echo "- Unverified secrets: $UNVERIFIED" >> $GITHUB_STEP_SUMMARY

            if [ $VERIFIED -gt 0 ]; then
              echo "::error::Found $VERIFIED verified secrets"
              exit 1
            fi
          fi
        if: always()

      - name: Upload TruffleHog results
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-results
          path: |
            trufflehog-results.json
            trufflehog-detailed.json
          retention-days: 90
        if: always()

  detect-secrets:
    name: Yelp Detect-Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: |
          pip install detect-secrets

      - name: Run detect-secrets scan
        run: |
          detect-secrets scan --all-files \
            --exclude-files 'node_modules/.*' \
            --exclude-files 'dist/.*' \
            --exclude-files 'build/.*' \
            --exclude-files '.*\.lock' \
            > detect-secrets-baseline.json || true

      - name: Run detect-secrets audit
        run: |
          detect-secrets audit detect-secrets-baseline.json --report \
            > detect-secrets-report.txt || true

      - name: Analyze detect-secrets results
        run: |
          if [ -f detect-secrets-baseline.json ]; then
            SECRETS_COUNT=$(jq '.results | to_entries | length' detect-secrets-baseline.json)

            echo "### Detect-Secrets Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Potential secrets found: $SECRETS_COUNT" >> $GITHUB_STEP_SUMMARY

            if [ $SECRETS_COUNT -gt 0 ]; then
              echo "::warning::Found $SECRETS_COUNT potential secrets"
            fi
          fi
        if: always()

      - name: Upload detect-secrets results
        uses: actions/upload-artifact@v4
        with:
          name: detect-secrets-results
          path: |
            detect-secrets-baseline.json
            detect-secrets-report.txt
          retention-days: 30
        if: always()

  secretlint:
    name: Secretlint Pattern Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Secretlint
        run: |
          npm install -g @secretlint/secretlint @secretlint/secretlint-rule-preset-recommend

      - name: Create Secretlint config
        run: |
          cat > .secretlintrc.json << 'EOF'
          {
            "rules": [
              {
                "id": "@secretlint/secretlint-rule-preset-recommend"
              }
            ]
          }
          EOF

      - name: Run Secretlint
        run: |
          secretlint "**/*" \
            --format json \
            --output-file secretlint-results.json \
            || true

      - name: Analyze Secretlint results
        run: |
          if [ -f secretlint-results.json ]; then
            MESSAGES=$(jq '[.[] | .messages[]] | length' secretlint-results.json)

            echo "### Secretlint Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Issues found: $MESSAGES" >> $GITHUB_STEP_SUMMARY
          fi
        if: always()

      - name: Upload Secretlint results
        uses: actions/upload-artifact@v4
        with:
          name: secretlint-results
          path: secretlint-results.json
          retention-days: 30
        if: always()

  git-secrets:
    name: AWS Git-Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-secrets
        run: |
          git clone https://github.com/awslabs/git-secrets.git
          cd git-secrets
          sudo make install

      - name: Configure git-secrets
        run: |
          git secrets --register-aws
          git secrets --add 'password\s*=\s*.+'
          git secrets --add 'api[_-]?key\s*=\s*.+'
          git secrets --add 'secret[_-]?key\s*=\s*.+'
          git secrets --add 'private[_-]?key\s*=\s*.+'
          git secrets --add 'token\s*=\s*.+'

      - name: Scan repository with git-secrets
        run: |
          git secrets --scan > git-secrets-results.txt 2>&1 || true

      - name: Scan history with git-secrets
        run: |
          git secrets --scan-history >> git-secrets-results.txt 2>&1 || true

      - name: Analyze git-secrets results
        run: |
          if [ -f git-secrets-results.txt ]; then
            FINDINGS=$(grep -c "ERROR" git-secrets-results.txt || echo "0")

            echo "### Git-Secrets Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Findings: $FINDINGS" >> $GITHUB_STEP_SUMMARY

            if [ $FINDINGS -gt 0 ]; then
              echo "::warning::Git-secrets found $FINDINGS potential issues"
              cat git-secrets-results.txt
            fi
          fi
        if: always()

      - name: Upload git-secrets results
        uses: actions/upload-artifact@v4
        with:
          name: git-secrets-results
          path: git-secrets-results.txt
          retention-days: 30
        if: always()

  env-file-check:
    name: Check for Exposed Environment Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for sensitive files
        run: |
          cat > check_sensitive_files.sh << 'EOF'
          #!/bin/bash

          SENSITIVE_FILES=(
            ".env"
            ".env.local"
            ".env.production"
            ".env.development"
            "credentials.json"
            "serviceAccount.json"
            "id_rsa"
            "id_dsa"
            "id_ecdsa"
            "id_ed25519"
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            "*.jks"
            ".aws/credentials"
            ".ssh/id_rsa"
            "secret.yml"
            "secrets.yml"
          )

          echo "Checking for exposed sensitive files..."
          FOUND=0

          for pattern in "${SENSITIVE_FILES[@]}"; do
            files=$(find . -type f -name "$pattern" ! -path "*/node_modules/*" ! -path "*/.git/*" 2>/dev/null)
            if [ ! -z "$files" ]; then
              echo "WARNING: Found sensitive file pattern: $pattern"
              echo "$files"
              FOUND=$((FOUND + 1))
            fi
          done

          if [ $FOUND -gt 0 ]; then
            echo "::error::Found $FOUND types of sensitive files in repository"
            exit 1
          else
            echo "No sensitive files found."
          fi
          EOF

          chmod +x check_sensitive_files.sh
          ./check_sensitive_files.sh > sensitive-files-check.txt 2>&1

      - name: Upload sensitive files check results
        uses: actions/upload-artifact@v4
        with:
          name: sensitive-files-check
          path: sensitive-files-check.txt
          retention-days: 30
        if: always()

  secret-report:
    name: Generate Secret Scanning Report
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, detect-secrets, secretlint, git-secrets, env-file-check]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: secret-scan-results

      - name: Generate consolidated report
        run: |
          cat > secret-scanning-report.md << 'EOF'
          # Secret Scanning Report

          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}

          ## Scan Summary

          | Tool | Purpose | Status |
          |------|---------|--------|
          | Gitleaks | Git history secret detection | ${{ needs.gitleaks.result }} |
          | TruffleHog | Verified secret detection | ${{ needs.trufflehog.result }} |
          | Detect-Secrets | Pattern-based detection | ${{ needs.detect-secrets.result }} |
          | Secretlint | Configurable secret linting | ${{ needs.secretlint.result }} |
          | Git-Secrets | AWS-focused detection | ${{ needs.git-secrets.result }} |
          | File Check | Sensitive file detection | ${{ needs.env-file-check.result }} |

          ## Severity Assessment

          - **Critical**: Verified, active credentials found
          - **High**: High-confidence secret patterns detected
          - **Medium**: Potential secrets requiring review
          - **Low**: False positive candidates

          ## Immediate Actions Required

          If secrets are detected:

          1. **Revoke/Rotate Immediately**
             - Treat all detected secrets as compromised
             - Rotate credentials in affected services
             - Update secret management systems

          2. **Remove from Git History**
             ```bash
             # Use BFG Repo-Cleaner or git filter-repo
             git filter-repo --path-glob '**/*secret*' --invert-paths
             ```

          3. **Prevent Future Exposure**
             - Add pre-commit hooks for secret detection
             - Use secret management solutions (AWS Secrets Manager, HashiCorp Vault)
             - Never commit secrets to version control
             - Use .env files with .gitignore

          4. **Audit Access**
             - Review who had access to compromised secrets
             - Check audit logs for unauthorized usage
             - Notify security team

          ## Best Practices

          ### Secret Management
          - Use environment variables for configuration
          - Store secrets in secure secret management systems
          - Use short-lived, rotated credentials where possible
          - Implement least-privilege access

          ### Git Hygiene
          - Configure git-secrets pre-commit hooks
          - Use .gitignore for sensitive file patterns
          - Review PRs for accidental secret inclusion
          - Scan before pushing with `gitleaks protect`

          ### CI/CD Security
          - Use GitHub Secrets for workflow credentials
          - Enable secret scanning in GitHub Security
          - Audit secret access in workflow logs
          - Rotate secrets regularly

          ## Resources

          - [GitHub Secret Scanning](https://docs.github.com/en/code-security/secret-scanning)
          - [OWASP Secrets Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html)
          - [AWS Secrets Manager](https://aws.amazon.com/secrets-manager/)
          - [HashiCorp Vault](https://www.vaultproject.io/)

          ## Pre-commit Hook Setup

          Add to `.git/hooks/pre-commit`:

          ```bash
          #!/bin/sh
          gitleaks protect --verbose --redact --staged
          ```

          Or use pre-commit framework:

          ```yaml
          repos:
          - repo: https://github.com/gitleaks/gitleaks
            rev: latest
            hooks:
              - id: gitleaks
          ```

          EOF

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: secret-scanning-report
          path: secret-scanning-report.md
          retention-days: 90

  notify-on-secrets:
    name: Notify on Secret Detection
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog]
    if: failure()

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "SECRET EXPOSURE ALERT",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":rotating_light: SECRETS DETECTED IN REPOSITORY"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":warning: *IMMEDIATE ACTION REQUIRED*\n\n1. Revoke/rotate detected credentials immediately\n2. Review scan results for affected secrets\n3. Remove secrets from git history\n4. Audit access logs for potential compromise"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Scan Results"
                      },
                      "style": "danger",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        if: env.SLACK_WEBHOOK_URL != ''

      - name: Send Teams notification
        uses: jdcargile/ms-teams-notification@v1.4
        with:
          github-token: ${{ github.token }}
          ms-teams-webhook-uri: ${{ secrets.TEAMS_SECURITY_WEBHOOK }}
          notification-summary: "CRITICAL: Secrets detected in ${{ github.repository }}"
          notification-color: dc3545
          timezone: UTC
        if: env.TEAMS_WEBHOOK_URL != ''
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_SECURITY_WEBHOOK }}

  block-pr-on-secrets:
    name: Block PR on Secret Detection
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog]
    if: github.event_name == 'pull_request'

    steps:
      - name: Check for secrets
        run: |
          if [ "${{ needs.gitleaks.result }}" == "failure" ] || [ "${{ needs.trufflehog.result }}" == "failure" ]; then
            echo "::error::Secrets detected in pull request"
            exit 1
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## :rotating_light: SECRET DETECTION ALERT\n\n**Secrets or credentials have been detected in this pull request.**\n\n### Immediate Actions Required:\n\n1. **DO NOT MERGE** this pull request\n2. Remove all secrets from the code\n3. Revoke and rotate any exposed credentials\n4. Use environment variables or secret management\n5. Add sensitive patterns to .gitignore\n\n### How to Fix:\n\n```bash\n# Remove secrets from files\n# Then amend your commit\ngit add .\ngit commit --amend\ngit push --force\n```\n\n### Resources:\n- [Removing sensitive data from GitHub](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository)\n- [Secret management best practices](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html)\n\n**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n:lock: **This PR is blocked until all secrets are removed.**'
            })
