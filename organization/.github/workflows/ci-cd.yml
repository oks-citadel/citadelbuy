# CitadelBuy - CI/CD Pipeline
# Full deployment pipeline for Azure infrastructure

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  AZURE_CONTAINER_REGISTRY: citadelbuyacr.azurecr.io
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ============================================
  # LINT & TYPE CHECK
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: Run TypeScript Check
        run: pnpm type-check

  # ============================================
  # UNIT TESTS
  # ============================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run API tests
        working-directory: apps/api
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test?schema=public
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-jwt-secret
        run: |
          npx prisma migrate deploy
          pnpm test:cov

      - name: Run Web tests
        working-directory: apps/web
        run: pnpm test

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./apps/api/coverage/lcov.info,./apps/web/coverage/lcov.info
          flags: unittests

  # ============================================
  # BUILD DOCKER IMAGES
  # ============================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      api_image: ${{ steps.build-api.outputs.image }}
      web_image: ${{ steps.build-web.outputs.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.AZURE_CONTAINER_REGISTRY }}
          username: ${{ secrets.AZURE_ACR_USERNAME }}
          password: ${{ secrets.AZURE_ACR_PASSWORD }}

      - name: Generate image tags
        id: tags
        run: |
          SHA=$(echo ${{ github.sha }} | cut -c1-7)
          BRANCH=$(echo ${{ github.ref_name }} | tr '/' '-')
          echo "sha_tag=$SHA" >> $GITHUB_OUTPUT
          echo "branch_tag=$BRANCH" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: Build and push API image
        id: build-api
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile
          push: true
          tags: |
            ${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-api:${{ steps.tags.outputs.sha_tag }}
            ${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-api:${{ steps.tags.outputs.branch_tag }}
            ${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-api:latest
          cache-from: type=registry,ref=${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-api:buildcache
          cache-to: type=registry,ref=${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-api:buildcache,mode=max
          build-args: |
            NODE_ENV=production

      - name: Build and push Web image
        id: build-web
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-web:${{ steps.tags.outputs.sha_tag }}
            ${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-web:${{ steps.tags.outputs.branch_tag }}
            ${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-web:latest
          cache-from: type=registry,ref=${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-web:buildcache
          cache-to: type=registry,ref=${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-web:buildcache,mode=max
          build-args: |
            NODE_ENV=production
            NEXT_PUBLIC_API_URL=${{ vars.API_URL }}

  # ============================================
  # DEPLOY TO STAGING
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.citadelbuy.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group citadelbuy-staging-rg \
            --name citadelbuy-staging-aks \
            --overwrite-existing

      - name: Deploy to AKS
        run: |
          # Update image tags in manifests
          SHA=$(echo ${{ github.sha }} | cut -c1-7)

          # Apply Kubernetes manifests
          kubectl apply -f infrastructure/kubernetes/staging/

          # Update deployments with new images
          kubectl set image deployment/api \
            api=${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-api:$SHA \
            -n citadelbuy-staging

          kubectl set image deployment/web \
            web=${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-web:$SHA \
            -n citadelbuy-staging

          # Wait for rollout
          kubectl rollout status deployment/api -n citadelbuy-staging --timeout=300s
          kubectl rollout status deployment/web -n citadelbuy-staging --timeout=300s

      - name: Run database migrations
        run: |
          kubectl exec -n citadelbuy-staging \
            $(kubectl get pod -n citadelbuy-staging -l app=api -o jsonpath='{.items[0].metadata.name}') \
            -- npx prisma migrate deploy

      - name: Verify deployment
        run: |
          # Health check
          curl -f https://staging.citadelbuy.com/api/health || exit 1

  # ============================================
  # DEPLOY TO PRODUCTION
  # ============================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://citadelbuy.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group citadelbuy-prod-rg \
            --name citadelbuy-prod-aks \
            --overwrite-existing

      - name: Blue-Green Deployment
        run: |
          SHA=$(echo ${{ github.sha }} | cut -c1-7)

          # Deploy to green slot
          kubectl apply -f infrastructure/kubernetes/production/

          # Update green deployment
          kubectl set image deployment/api-green \
            api=${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-api:$SHA \
            -n citadelbuy-prod

          kubectl set image deployment/web-green \
            web=${{ env.AZURE_CONTAINER_REGISTRY }}/citadelbuy-web:$SHA \
            -n citadelbuy-prod

          # Wait for green deployment
          kubectl rollout status deployment/api-green -n citadelbuy-prod --timeout=300s
          kubectl rollout status deployment/web-green -n citadelbuy-prod --timeout=300s

      - name: Run database migrations
        run: |
          kubectl exec -n citadelbuy-prod \
            $(kubectl get pod -n citadelbuy-prod -l app=api-green -o jsonpath='{.items[0].metadata.name}') \
            -- npx prisma migrate deploy

      - name: Smoke tests
        run: |
          # Run smoke tests against green deployment
          GREEN_URL="https://green.citadelbuy.com"
          curl -f "$GREEN_URL/api/health" || exit 1
          # Add more smoke tests as needed

      - name: Switch traffic to green
        run: |
          # Update service to point to green deployment
          kubectl patch service api-service -n citadelbuy-prod \
            -p '{"spec":{"selector":{"app":"api-green"}}}'
          kubectl patch service web-service -n citadelbuy-prod \
            -p '{"spec":{"selector":{"app":"web-green"}}}'

      - name: Verify production
        run: |
          sleep 30
          curl -f https://citadelbuy.com/api/health || exit 1
          curl -f https://citadelbuy.com || exit 1

      - name: Notify deployment
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: 'deployments'
          slack-message: "ðŸš€ Production deployment completed: ${{ github.sha }}"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  # ============================================
  # E2E TESTS
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Playwright
        run: |
          pnpm install --frozen-lockfile
          npx playwright install --with-deps

      - name: Run E2E tests
        working-directory: tests/e2e
        run: pnpm test:e2e
        env:
          BASE_URL: https://staging.citadelbuy.com
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 30

  # ============================================
  # TERRAFORM PLAN/APPLY
  # ============================================
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    defaults:
      run:
        working-directory: infrastructure/terraform/environments/prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -out=tfplan
        env:
          TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          TF_VAR_db_admin_username: ${{ secrets.DB_ADMIN_USERNAME }}
          TF_VAR_db_admin_password: ${{ secrets.DB_ADMIN_PASSWORD }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}

      - name: Comment Plan on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const output = `#### Terraform Plan ðŸ“–
            \`\`\`
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            *Pushed by: @${{ github.actor }}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve tfplan
