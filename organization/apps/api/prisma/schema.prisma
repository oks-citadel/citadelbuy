// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  VENDOR
  SUPPORT
  ADMIN
  ORGANIZATION_ADMIN
  MARKETING
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  COMPLETED
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  emailVerified   Boolean?  @default(false)
  phoneNumber     String?
  phoneVerified   Boolean   @default(false)
  phoneVerifiedAt DateTime?
  password        String
  name            String
  role            UserRole  @default(CUSTOMER)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  orders                 Order[]
  products               Product[]
  reviews                Review[]
  wishlist               Wishlist[]
  adCampaigns            AdCampaign[]
  advertisements         Advertisement[]
  subscriptions          Subscription[]
  bnplPaymentPlans       BnplPaymentPlan[]
  searchQueries          SearchQuery[]
  productViews           ProductView[]
  savedSearches          SavedSearch[]
  vendorAnalytics        VendorAnalytics[]
  loyalty                CustomerLoyalty?
  dealPurchases          DealPurchase[]
  dealNotifications      DealNotification[]
  giftCardsPurchased     GiftCard[]              @relation("GiftCardPurchaser")
  giftCardsRedeemed      GiftCard[]              @relation("GiftCardRedeemer")
  giftCardTransactions   GiftCardTransaction[]
  storeCredit            StoreCredit?
  vendorProfile          VendorProfile?
  returnRequests         ReturnRequest[]
  refunds                Refund[]
  taxExemptions          TaxExemption[]
  couponUsages           CouponUsage[]
  carts                  Cart[]
  wishlistCollections    WishlistCollection[]
  emailLogs              EmailLog[]
  notificationPreference NotificationPreference?
  auditLogs              AuditLog[]
  apiKeys                ApiKey[]
  twoFactorAuth          TwoFactorAuth?
  sessions               UserSession[]
  dataExportRequests     DataExportRequest[]
  supportTickets         SupportTicket[]         @relation("UserTickets")
  assignedTickets        SupportTicket[]         @relation("AssignedTickets")
  ticketMessages         TicketMessage[]
  ticketNotes            TicketNote[]
  knowledgeBaseArticles  KnowledgeBaseArticle[]
  cannedResponses        CannedResponse[]
  chatSessions           LiveChatSession[]
  assignedChats          LiveChatSession[]       @relation("AssignedChats")
  chatMessages           ChatMessage[]
  productShares          ProductShare[]
  reviewHelpful          ReviewHelpful[]
  following              VendorFollow[]          @relation("UserFollowing")
  followers              VendorFollow[]          @relation("VendorFollowers")
  activityFeed           ActivityFeed[]
  interactions           UserInteraction[]
  socialComments         SocialComment[]
  badges                 UserBadge[]
  customerInsight        CustomerInsight?
  dashboardWidgets       DashboardWidget[]
  pushTokens             PushNotificationToken[]
  mobileNotifications    MobileNotification[]
  mobileSessions         MobileSession[]
  offlineSyncQueue       OfflineSyncQueue[]
  categoryViews          CategoryView[]
  categoriesCreated      Category[]              @relation("CategoryCreatedBy")
  categoriesUpdated      Category[]              @relation("CategoryUpdatedBy")

  // Privacy and consent relations (GDPR/CCPA compliance)
  consentLogs          ConsentLog[]
  dataDeletionRequests DataDeletionRequest[]
  agreedTerms          AgreedTerms[]
  processingRestricted Boolean               @default(false)

  // Organization relations
  organizationsOwned      Organization[]
  organizationMemberships OrganizationMember[]

  // Escrow relations
  escrowAccountsAsBuyer  EscrowAccount[] @relation("EscrowBuyer")
  escrowAccountsAsSeller EscrowAccount[] @relation("EscrowSeller")
  escrowDisputes         EscrowDispute[]
  escrowsAsBuyer         Escrow[]        @relation("MilestoneEscrowBuyer")
  escrowsAsSeller        Escrow[]        @relation("MilestoneEscrowSeller")

  // Growth & Marketing relations
  churnRisk ChurnRisk?   @relation("UserChurnRisk")
  leadScore LeadScore?
  profile   UserProfile?

  // Phone verification
  phoneVerificationCodes PhoneVerificationCode[]

  // MFA settings
  userMfa UserMfa?
  trustedDevices TrustedDevice[]

  // Email verification
  emailVerificationTokens EmailVerificationToken[]

  // Impersonation relations
  impersonationSessionsAsTarget       ImpersonationSession[] @relation("ImpersonationTarget")
  impersonationSessionsAsImpersonator ImpersonationSession[] @relation("Impersonator")

  // Device fingerprinting relations
  deviceAssociations UserDeviceAssociation[]

  // Multi-tenant marketplace preferences
  userPreference UserPreference?

  @@map("users")
}

// User Profile for additional user information
model UserProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Profile details
  firstName   String?
  lastName    String?
  bio         String?
  avatarUrl   String?
  companyName String?
  jobTitle    String?
  phoneNumber String?
  address     Json?
  timezone    String?
  locale      String? @default("en")

  // Preferences
  preferences Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("user_profiles")
}

model Category {
  id              String         @id @default(uuid())
  name            String
  slug            String         @unique
  description     String?
  parentId        String?
  level           Int            @default(0)
  sortOrder       Int            @default(0)
  iconUrl         String?
  bannerImageUrl  String?
  thumbnailUrl    String?
  status          CategoryStatus @default(ACTIVE)
  isFeatured      Boolean        @default(false)
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  seoContent      String?
  productCount    Int            @default(0)
  viewCount       BigInt         @default(0)
  createdById     String?
  updatedById     String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?

  // Self-referencing relation for hierarchy
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  // Creator/updater relations
  createdBy User? @relation("CategoryCreatedBy", fields: [createdById], references: [id])
  updatedBy User? @relation("CategoryUpdatedBy", fields: [updatedById], references: [id])

  // Existing relations
  products          Product[]
  categoryAnalytics CategoryAnalytics[]
  translations      CategoryTranslation[]
  taxExemptions     TaxExemption[]
  featuredSlots     FeaturedSlot[]

  // New relations for enhanced category system
  attributes         CategoryAttribute[]
  filters            CategoryFilter[]
  promotions         CategoryPromotion[]
  closureAncestors   CategoryClosure[]   @relation("ClosureAncestor")
  closureDescendants CategoryClosure[]   @relation("ClosureDescendant")
  categoryViews      CategoryView[]

  @@unique([parentId, name])
  @@index([parentId])
  @@index([status])
  @@index([level])
  @@index([sortOrder])
  @@index([isFeatured])
  @@index([deletedAt])
  @@map("categories")
}

enum CategoryStatus {
  ACTIVE
  INACTIVE
  DRAFT
  ARCHIVED
}

// Category Closure table for efficient hierarchy queries
model CategoryClosure {
  ancestorId   String
  descendantId String
  depth        Int

  ancestor   Category @relation("ClosureAncestor", fields: [ancestorId], references: [id], onDelete: Cascade)
  descendant Category @relation("ClosureDescendant", fields: [descendantId], references: [id], onDelete: Cascade)

  @@id([ancestorId, descendantId])
  @@index([ancestorId])
  @@index([descendantId])
  @@index([depth])
  @@map("category_closure")
}

// Category attributes for custom fields per category
model CategoryAttribute {
  id             String                @id @default(uuid())
  categoryId     String
  attributeKey   String
  attributeValue String?
  attributeType  CategoryAttributeType @default(STRING)
  isFilterable   Boolean               @default(false)
  displayOrder   Int                   @default(0)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, attributeKey])
  @@index([categoryId])
  @@index([isFilterable])
  @@map("category_attributes")
}

enum CategoryAttributeType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// Category filters for product filtering
model CategoryFilter {
  id            String     @id @default(uuid())
  categoryId    String
  filterName    String
  filterKey     String
  filterType    FilterType @default(CHECKBOX)
  filterOptions Json?
  isActive      Boolean    @default(true)
  displayOrder  Int        @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, filterKey])
  @@index([categoryId])
  @@index([isActive])
  @@map("category_filters")
}

enum FilterType {
  RANGE
  CHECKBOX
  RADIO
  DROPDOWN
  COLOR
  DATE_RANGE
}

// Category promotions
model CategoryPromotion {
  id                 String   @id @default(uuid())
  categoryId         String
  title              String
  description        String?
  bannerUrl          String?
  discountPercentage Float?
  discountAmount     Float?
  startDate          DateTime
  endDate            DateTime
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@map("category_promotions")
}

// Category views for analytics
model CategoryView {
  id         String   @id @default(uuid())
  categoryId String
  userId     String?
  sessionId  String
  ipAddress  String?
  userAgent  String?
  referer    String?
  createdAt  DateTime @default(now())

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("category_views")
}

model Product {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String
  price       Float
  images      String[]
  stock       Int      @default(0)
  vendorId    String
  categoryId  String
  tenantId    String?  // Multi-tenant: which organization/tenant owns this product
  status      String?  @default("ACTIVE") // ACTIVE, INACTIVE, DRAFT, etc.
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // SEO fields
  metaTitle       String?
  metaDescription String?

  // Relations
  vendor             User                   @relation(fields: [vendorId], references: [id])
  vendorEntity       Vendor?                @relation("VendorProducts", fields: [vendorId], references: [id], map: "fk_product_vendor_entity")
  category           Category               @relation(fields: [categoryId], references: [id])
  tenant             Organization?          @relation("TenantProducts", fields: [tenantId], references: [id])
  orderItems         OrderItem[]
  reviews            Review[]
  wishlist           Wishlist[]
  variants           ProductVariant[]
  variantOptions     ProductVariantOption[]
  advertisements     Advertisement[]
  productViews       ProductView[]
  productAnalytics   ProductAnalytics[]
  translations       ProductTranslation[]
  dealProducts       DealProduct[]
  inventoryItems     InventoryItem[]
  stockTransfers     StockTransfer[]
  returnItems        ReturnItem[]
  taxExemptions      TaxExemption[]
  cartItems          CartItem[]
  wishlistItems      WishlistItem[]
  productShares      ProductShare[]
  productPerformance ProductPerformance?
  featuredListings   FeaturedListing[]

  // Product source mapping (connector integrations)
  productSources     ProductSource[]

  trackInventory Boolean  @default(true)
  allowBackorder Boolean  @default(false)
  sku            String?  @unique
  barcode        String?  @unique
  weight         Float?
  length         Float?
  width          Float?
  height         Float?
  dimensions     String? // JSON string for custom dimensions
  tags           String[] @default([])

  @@index([vendorId])
  @@index([categoryId])
  @@index([slug])
  @@index([tenantId])
  @@index([tenantId, id])
  @@index([tenantId, sku])
  @@map("products")
}

model Order {
  id              String      @id @default(uuid())
  userId          String? // Optional for guest checkout
  total           Float
  subtotal        Float
  tax             Float
  shipping        Float
  shippingCost    Float? // Explicit shipping cost field
  status          OrderStatus @default(PENDING)
  shippingAddress String // JSON string containing full shipping address
  paymentMethod   String?
  paymentIntentId String?

  // Additional financial fields
  currency  String? @default("USD")
  insurance Float? // Insurance cost
  officeId  String? // Office that processed the order

  // Guest checkout fields
  guestEmail   String?
  guestPhone   String?
  isGuestOrder Boolean @default(false)

  // Tracking and Shipping
  trackingNumber        String?
  carrier               String? // UPS, FedEx, USPS, DHL, etc.
  shippingMethod        String? // Standard, Express, Overnight
  estimatedDeliveryDate DateTime?
  actualDeliveryDate    DateTime?
  statusHistory         Json? // Array of status changes with timestamps
  notes                 String? // Internal notes or customer notes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                    User?                    @relation(fields: [userId], references: [id], onDelete: SetNull)
  items                   OrderItem[]
  bnplPaymentPlan         BnplPaymentPlan?
  pointTransactions       PointTransaction[]
  rewardRedemptions       RewardRedemption[]
  dealPurchases           DealPurchase[]
  giftCardsApplied        GiftCard[]               @relation("OrderGiftCards")
  giftCardTransactions    GiftCardTransaction[]    @relation("GiftCardTransactionOrder")
  storeCreditTransactions StoreCreditTransaction[] @relation("StoreCreditTransactionOrder")
  giftCardsPurchased      GiftCard[] // Gift cards purchased in this order
  giftCardAmount          Float? // Amount paid with gift cards
  storeCreditAmount       Float? // Amount paid with store credit
  returnRequests          ReturnRequest[]
  refunds                 Refund[]
  taxCalculation          TaxCalculation?
  couponUsages            CouponUsage[]
  supportTickets          SupportTicket[]
  escrowAccount           EscrowAccount?
  escrows                 Escrow[]
  billingAuditLogs        BillingAuditLog[]
  fxSnapshot              OrderFxSnapshot?     // FX rate snapshot at time of order

  @@index([userId])
  @@index([status])
  @@index([trackingNumber])
  @@index([officeId])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String?
  quantity  Int
  price     Float
  createdAt DateTime @default(now())

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

model Review {
  id                 String       @id @default(uuid())
  userId             String?
  productId          String
  rating             Int // 1-5
  comment            String?
  isVerifiedPurchase Boolean      @default(false)
  helpfulCount       Int          @default(0)
  status             ReviewStatus @default(APPROVED)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  // Relations
  user         User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  product      Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  votes        ReviewVote[]
  helpfulVotes ReviewHelpful[]

  @@unique([userId, productId])
  @@index([productId])
  @@index([status])
  @@map("reviews")
}

model ReviewVote {
  id        String   @id @default(uuid())
  reviewId  String
  userId    String
  isHelpful Boolean
  createdAt DateTime @default(now())

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@map("review_votes")
}

model PasswordReset {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
  @@map("password_resets")
}

/// Enhanced Wishlist Collections
model WishlistCollection {
  id          String  @id @default(uuid())
  userId      String
  name        String // e.g., "Birthday Ideas", "Christmas List", "Dream Setup"
  description String?
  isDefault   Boolean @default(false)

  // Privacy & Sharing
  isPublic   Boolean @default(false)
  shareToken String? @unique // For sharing wishlists

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items WishlistItem[]

  @@index([userId])
  @@index([shareToken])
  @@index([isPublic])
  @@map("wishlist_collections")
}

/// Items in wishlist collection
model WishlistItem {
  id         String  @id @default(uuid())
  wishlistId String
  productId  String
  variantId  String? // If specific variant is wishlisted

  // Enhanced fields
  notes    String? // Personal notes about the item
  priority Int     @default(0) // 0=none, 1=low, 2=medium, 3=high
  quantity Int     @default(1) // Desired quantity

  // Price tracking
  priceAtAddition   Float // Price when added to wishlist
  notifyOnPriceDrop Boolean @default(false)
  targetPrice       Float? // Notify when price drops below this

  // Stock notifications
  notifyWhenInStock Boolean @default(false)

  addedAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  wishlist WishlistCollection @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product  Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant  ProductVariant?    @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([wishlistId, productId, variantId])
  @@index([wishlistId])
  @@index([productId])
  @@index([variantId])
  @@index([notifyOnPriceDrop])
  @@index([notifyWhenInStock])
  @@map("wishlist_items")
}

/// Legacy wishlist model (kept for backwards compatibility)
model Wishlist {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("wishlist")
}

model ProductVariant {
  id         String   @id @default(uuid())
  productId  String
  sku        String   @unique
  name       String // e.g., "Red - Large", "Blue - Small"
  price      Float? // Override product price if set
  stock      Int      @default(0)
  attributes Json // { "color": "Red", "size": "Large", "material": "Cotton" }
  images     String[] // Variant-specific images (optional)
  isDefault  Boolean  @default(false)

  // Enhanced fields
  compareAtPrice                Float? // Original price for showing discounts
  costPerItem                   Float? // Cost price for profit tracking
  weight                        Float? // Override product weight
  barcode                       String? @unique
  taxable                       Boolean @default(true)
  trackQuantity                 Boolean @default(true)
  continueSellingWhenOutOfStock Boolean @default(false)
  requiresShipping              Boolean @default(true)
  position                      Int     @default(0) // Display order
  isAvailable                   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product       Product                     @relation(fields: [productId], references: [id], onDelete: Cascade)
  optionValues  ProductVariantOptionValue[]
  cartItems     CartItem[]
  wishlistItems WishlistItem[]

  @@index([productId])
  @@index([sku])
  @@index([isAvailable])
  @@index([position])
  @@map("product_variants")
}

// ============================================
// ADVERTISING SYSTEM
// ============================================

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

enum AdType {
  SPONSORED_PRODUCT // Product listing ads
  SEARCH // Keyword-based search ads
  DISPLAY // Banner/display ads
  CATEGORY // Category page ads
}

enum AdStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  PAUSED
  REJECTED
  COMPLETED
  OUT_OF_BUDGET
}

model AdCampaign {
  id          String         @id @default(uuid())
  vendorId    String
  name        String
  description String?
  status      CampaignStatus @default(DRAFT)

  // Budget management
  totalBudget Float // Total campaign budget
  dailyBudget Float? // Optional daily spending limit
  spentAmount Float  @default(0)

  // Campaign duration
  startDate DateTime
  endDate   DateTime?

  // Performance metrics (cached)
  impressions Int @default(0)
  clicks      Int @default(0)
  conversions Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vendor         User            @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  advertisements Advertisement[]

  @@index([vendorId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("ad_campaigns")
}

model Advertisement {
  id         String  @id @default(uuid())
  campaignId String
  vendorId   String
  productId  String? // For sponsored product ads

  type   AdType
  status AdStatus @default(DRAFT)

  // Ad content
  title       String
  description String?
  imageUrl    String?
  targetUrl   String? // Landing page URL

  // Bidding and budget
  bidAmount   Float // Cost per click (CPC) bid
  dailyBudget Float? // Ad-specific daily budget
  spentAmount Float  @default(0)

  // Targeting
  targetCategories String[] // Category IDs to target
  targetKeywords   String[] // Keywords for search ads
  targetLocations  String[] // Geographic targeting

  // Performance metrics (cached)
  impressions Int @default(0)
  clicks      Int @default(0)
  conversions Int @default(0)

  // Schedule
  startDate DateTime
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  campaign        AdCampaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  vendor          User           @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  product         Product?       @relation(fields: [productId], references: [id], onDelete: Cascade)
  impressions_log AdImpression[]
  clicks_log      AdClick[]
  keywords        AdKeyword[]

  @@index([campaignId])
  @@index([vendorId])
  @@index([productId])
  @@index([type])
  @@index([status])
  @@index([startDate, endDate])
  @@map("advertisements")
}

model AdKeyword {
  id          String   @id @default(uuid())
  adId        String
  keyword     String
  bidAmount   Float // Keyword-specific bid
  impressions Int      @default(0)
  clicks      Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  advertisement Advertisement @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@unique([adId, keyword])
  @@index([adId])
  @@index([keyword])
  @@map("ad_keywords")
}

model AdImpression {
  id        String   @id @default(uuid())
  adId      String
  userId    String? // Null for guest users
  ipAddress String?
  userAgent String?
  location  String? // Country/city
  placement String? // Where ad was shown (homepage, search, product_page)
  timestamp DateTime @default(now())

  // Relations
  advertisement Advertisement @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId])
  @@index([userId])
  @@index([timestamp])
  @@map("ad_impressions")
}

model AdClick {
  id        String   @id @default(uuid())
  adId      String
  userId    String? // Null for guest users
  ipAddress String?
  userAgent String?
  location  String?
  placement String?
  cost      Float // CPC cost at time of click
  converted Boolean  @default(false) // Whether it led to purchase
  orderId   String? // If converted, the order ID
  timestamp DateTime @default(now())

  // Relations
  advertisement Advertisement @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId])
  @@index([userId])
  @@index([timestamp])
  @@index([converted])
  @@map("ad_clicks")
}

// ============================================
// SUBSCRIPTION SYSTEM
// ============================================

enum SubscriptionPlanType {
  // Customer tiers
  CUSTOMER_BASIC // Free tier for customers
  CUSTOMER_PREMIUM // Premium customer membership (Prime-style)
  CUSTOMER_PRO // Pro customer with all benefits

  // Vendor tiers (6 tiers)
  VENDOR_FREE // Free tier - $0/month, 3% fee, 10 products max
  VENDOR_SILVER // Silver - $29.99/month, 2.5% fee, 100 products max
  VENDOR_GOLD // Gold - $79.99/month, 2% fee, 500 products max
  VENDOR_PLATINUM // Platinum - $199.99/month, 1.5% fee, 2500 products max
  VENDOR_DIAMOND // Diamond - $499.99/month, 1% fee, unlimited products
  VENDOR_ENTERPRISE // Enterprise - Custom pricing, negotiated fee

  // Legacy types (deprecated)
  VENDOR_STARTER // @deprecated - Use VENDOR_FREE
  VENDOR_PROFESSIONAL // @deprecated - Use VENDOR_GOLD
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
  TRIAL
  SUSPENDED
}

enum BillingInterval {
  MONTHLY
  QUARTERLY
  YEARLY
}

model SubscriptionPlan {
  id              String               @id @default(uuid())
  name            String
  slug            String               @unique // URL-friendly identifier (e.g., "free", "silver", "gold")
  description     String?
  type            SubscriptionPlanType
  price           Float // Monthly price in dollars
  yearlyPrice     Float? // Annual price (typically 20% discount)
  billingInterval BillingInterval      @default(MONTHLY)
  trialDays       Int                  @default(0) // Free trial period
  isActive        Boolean              @default(true)
  isPopular       Boolean              @default(false) // Highlight as popular choice
  displayOrder    Int                  @default(0) // Order in pricing table

  // Transaction fees
  transactionFee Float @default(0) // Percentage fee on transactions

  // Limits and quotas
  maxProducts         Int? // Max products (null = unlimited)
  maxOrders           Int? // Max orders per month (null = unlimited)
  maxAdminUsers       Int  @default(1) // Max admin users
  maxDiscountCodes    Int? // Max discount codes per month
  maxFeaturedListings Int  @default(0) // Featured listings per month

  // Support options
  supportType String @default("email") // email, chat, phone, dedicated
  supportSLA  Int    @default(48) // Response time in hours

  // Features (JSON format for detailed feature flags)
  features Json // Detailed feature flags object
  benefits Json // Legacy benefits field for compatibility

  // Platform settings
  commissionRate   Float? // Platform commission rate for vendors
  prioritySupport  Boolean @default(false)
  removeBranding   Boolean @default(false) // Remove Broxiva branding
  customDomain     Boolean @default(false) // Allow custom domain
  apiAccess        Boolean @default(false) // API access enabled
  apiCallsPerMonth Int? // API calls limit (null = unlimited)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions Subscription[]

  @@index([type])
  @@index([isActive])
  @@index([slug])
  @@map("subscription_plans")
}

model Subscription {
  id     String             @id @default(uuid())
  userId String
  planId String
  status SubscriptionStatus @default(ACTIVE)

  // Billing details
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  cancelledAt        DateTime?

  // Payment integration
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  // Metadata
  metadata Json? // Additional subscription data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan     SubscriptionPlan      @relation(fields: [planId], references: [id])
  invoices SubscriptionInvoice[]

  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model SubscriptionInvoice {
  id             String @id @default(uuid())
  subscriptionId String
  amount         Float
  currency       String @default("USD")
  status         String // paid, pending, failed

  // Stripe integration
  stripeInvoiceId       String? @unique
  stripePaymentIntentId String?

  // Invoice period
  periodStart DateTime
  periodEnd   DateTime

  // Payment details
  paidAt      DateTime?
  attemptedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([stripeInvoiceId])
  @@map("subscription_invoices")
}

// ============================================
// BUY NOW PAY LATER (BNPL) SYSTEM
// ============================================

enum BnplProvider {
  KLARNA
  AFFIRM
  AFTERPAY
  SEZZLE
}

enum BnplPaymentPlanStatus {
  PENDING // Awaiting first payment
  ACTIVE // Payment plan in progress
  COMPLETED // All installments paid
  CANCELLED // Plan cancelled
  DEFAULTED // Missed payments
}

enum BnplInstallmentStatus {
  PENDING // Not yet due
  PAID // Successfully paid
  FAILED // Payment failed
  OVERDUE // Past due date
  REFUNDED // Refunded
}

model BnplPaymentPlan {
  id       String                @id @default(uuid())
  orderId  String                @unique
  userId   String
  provider BnplProvider
  status   BnplPaymentPlanStatus @default(PENDING)

  // Plan details
  totalAmount          Float // Total order amount
  downPayment          Float  @default(0) // Initial payment
  numberOfInstallments Int // Number of installments
  installmentAmount    Float // Amount per installment
  frequency            String @default("MONTHLY") // WEEKLY, BIWEEKLY, MONTHLY

  // Provider integration
  providerPlanId   String? @unique // External provider's plan ID
  providerMetadata Json? // Provider-specific data

  // Dates
  firstPaymentDate DateTime
  finalPaymentDate DateTime

  // Financial tracking
  totalPaid        Float @default(0)
  remainingBalance Float
  interestRate     Float @default(0) // APR if applicable
  fees             Float @default(0) // Any fees charged

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order        Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id])
  installments BnplInstallment[]

  @@index([orderId])
  @@index([userId])
  @@index([provider])
  @@index([status])
  @@map("bnpl_payment_plans")
}

model BnplInstallment {
  id                String                @id @default(uuid())
  paymentPlanId     String
  installmentNumber Int // 1, 2, 3, etc.
  amount            Float
  dueDate           DateTime
  paidDate          DateTime?
  status            BnplInstallmentStatus @default(PENDING)

  // Provider integration
  providerPaymentId String? @unique // External provider's payment ID

  // Payment tracking
  paymentMethod   String? // Card, bank account, etc.
  failureReason   String? // If payment failed
  attemptCount    Int       @default(0)
  lastAttemptDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  paymentPlan BnplPaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@unique([paymentPlanId, installmentNumber])
  @@index([paymentPlanId])
  @@index([status])
  @@index([dueDate])
  @@map("bnpl_installments")
}

// ============================================
// AI RECOMMENDATION SYSTEM
// ============================================

enum UserActionType {
  VIEW
  CLICK
  ADD_TO_CART
  PURCHASE
  WISHLIST
  SEARCH
}

model UserBehavior {
  id          String         @id @default(uuid())
  userId      String? // Null for guest users
  sessionId   String? // Track guest sessions
  productId   String?
  categoryId  String?
  actionType  UserActionType
  searchQuery String? // For search actions
  metadata    Json? // Additional context
  createdAt   DateTime       @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([productId])
  @@index([categoryId])
  @@index([actionType])
  @@index([createdAt])
  @@map("user_behaviors")
}

model ProductRecommendation {
  id                   String   @id @default(uuid())
  productId            String // Source product
  recommendedProductId String // Recommended product
  score                Float // Recommendation strength (0-1)
  type                 String // SIMILAR, FREQUENTLY_BOUGHT_TOGETHER, COMPLEMENTARY
  updatedAt            DateTime @updatedAt

  @@unique([productId, recommendedProductId, type])
  @@index([productId, type])
  @@index([score])
  @@map("product_recommendations")
}

// ============================================
// PHASE 22: ENHANCED SEARCH & DISCOVERY
// ============================================

model SearchQuery {
  id           String       @id @default(uuid())
  userId       String?
  sessionId    String?
  query        String
  filters      Json? // Applied filters
  resultsCount Int
  clickedItems String[]     @default([])
  converted    Boolean      @default(false) // Did search lead to purchase
  source       SearchSource @default(SEARCH_BAR)
  metadata     Json?
  createdAt    DateTime     @default(now())
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([query])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("search_queries")
}

model SearchSuggestion {
  id          String   @id @default(uuid())
  keyword     String   @unique
  searchCount Int      @default(0)
  category    String?
  priority    Int      @default(0)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([keyword])
  @@index([searchCount])
  @@map("search_suggestions")
}

model ProductView {
  id        String   @id @default(uuid())
  productId String
  userId    String?
  sessionId String?
  source    String? // search, recommendation, direct, etc.
  metadata  Json?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("product_views")
}

model SavedSearch {
  id          String   @id @default(uuid())
  userId      String
  name        String
  query       String
  filters     Json?
  notifyOnNew Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("saved_searches")
}

enum SearchSource {
  SEARCH_BAR
  AUTOCOMPLETE
  CATEGORY_FILTER
  VOICE_SEARCH
  VISUAL_SEARCH
  BARCODE_SCAN
}

// ============================================
// PHASE 23: ADVANCED ANALYTICS DASHBOARD
// ============================================

model VendorAnalytics {
  id       String          @id @default(uuid())
  vendorId String
  period   AnalyticsPeriod @default(DAILY)
  date     DateTime // Start of period

  // Sales Metrics
  totalRevenue      Float @default(0)
  totalOrders       Int   @default(0)
  averageOrderValue Float @default(0)
  totalUnits        Int   @default(0)

  // Product Metrics
  totalProducts  Int @default(0)
  activeProducts Int @default(0)
  outOfStock     Int @default(0)

  // Traffic Metrics
  totalViews     Int   @default(0)
  uniqueVisitors Int   @default(0)
  conversionRate Float @default(0)

  // Customer Metrics
  newCustomers       Int @default(0)
  returningCustomers Int @default(0)

  // Ad Metrics
  adSpend       Float @default(0)
  adImpressions Int   @default(0)
  adClicks      Int   @default(0)
  adConversions Int   @default(0)

  // Subscription Metrics
  subscriptionRevenue Float @default(0)

  // Review Metrics
  averageRating Float @default(0)
  totalReviews  Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vendor User @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([vendorId, period, date])
  @@index([vendorId, period, date])
  @@index([date])
  @@map("vendor_analytics")
}

model ProductAnalytics {
  id        String          @id @default(uuid())
  productId String
  period    AnalyticsPeriod @default(DAILY)
  date      DateTime

  // Performance Metrics
  views       Int   @default(0)
  uniqueViews Int   @default(0)
  addToCart   Int   @default(0)
  purchases   Int   @default(0)
  revenue     Float @default(0)

  // Conversion Funnel
  viewToCart         Float @default(0) // %
  cartToCheckout     Float @default(0) // %
  checkoutToPurchase Float @default(0) // %

  // Engagement
  averageTimeOnPage Int   @default(0) // seconds
  bounceRate        Float @default(0)

  // Inventory
  stockLevel Int @default(0)
  stockouts  Int @default(0)

  // Reviews
  newReviews    Int   @default(0)
  averageRating Float @default(0)

  // Traffic Sources
  searchTraffic         Int @default(0)
  directTraffic         Int @default(0)
  recommendationTraffic Int @default(0)
  adTraffic             Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, period, date])
  @@index([productId, period, date])
  @@index([date])
  @@map("product_analytics")
}

model CategoryAnalytics {
  id         String          @id @default(uuid())
  categoryId String
  period     AnalyticsPeriod @default(DAILY)
  date       DateTime

  // Sales Metrics
  totalRevenue Float @default(0)
  totalOrders  Int   @default(0)
  totalUnits   Int   @default(0)

  // Product Metrics
  totalProducts  Int @default(0)
  activeProducts Int @default(0)

  // Traffic Metrics
  views    Int @default(0)
  searches Int @default(0)

  // Performance
  conversionRate Float @default(0)
  averageRating  Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, period, date])
  @@index([categoryId, period, date])
  @@index([date])
  @@map("category_analytics")
}

model RevenueAnalytics {
  id     String          @id @default(uuid())
  period AnalyticsPeriod @default(DAILY)
  date   DateTime

  // Revenue Breakdown
  productRevenue      Float @default(0)
  subscriptionRevenue Float @default(0)
  adRevenue           Float @default(0)
  bnplRevenue         Float @default(0)

  // Fees & Commissions
  platformFees Float @default(0)
  paymentFees  Float @default(0)

  // Net Revenue
  grossRevenue Float @default(0)
  netRevenue   Float @default(0)

  // Orders
  totalOrders     Int @default(0)
  completedOrders Int @default(0)
  cancelledOrders Int @default(0)
  refundedOrders  Int @default(0)

  // Refunds
  totalRefunds Float @default(0)
  refundRate   Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([period, date])
  @@index([period, date])
  @@index([date])
  @@map("revenue_analytics")
}

model TrafficAnalytics {
  id     String          @id @default(uuid())
  period AnalyticsPeriod @default(DAILY)
  date   DateTime

  // Visitors
  totalVisitors     Int @default(0)
  uniqueVisitors    Int @default(0)
  newVisitors       Int @default(0)
  returningVisitors Int @default(0)

  // Page Views
  totalPageViews   Int   @default(0)
  avgPagesPerVisit Float @default(0)

  // Engagement
  avgSessionDuration Int   @default(0) // seconds
  bounceRate         Float @default(0)

  // Traffic Sources
  directTraffic   Int @default(0)
  searchTraffic   Int @default(0)
  socialTraffic   Int @default(0)
  referralTraffic Int @default(0)
  adTraffic       Int @default(0)

  // Devices
  mobileVisitors  Int @default(0)
  desktopVisitors Int @default(0)
  tabletVisitors  Int @default(0)

  // Conversions
  conversionRate   Float @default(0)
  totalConversions Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([period, date])
  @@index([period, date])
  @@index([date])
  @@map("traffic_analytics")
}

enum AnalyticsPeriod {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

// ============================================
// PHASE 24: MULTI-LANGUAGE SUPPORT (i18n)
// ============================================

model Language {
  id         String   @id @default(uuid())
  code       String   @unique // ISO 639-1 code (en, es, fr, etc.)
  name       String // English name (English, Spanish, French)
  nativeName String // Native name (English, Español, Français)
  isDefault  Boolean  @default(false)
  isEnabled  Boolean  @default(true)
  isRTL      Boolean  @default(false) // Right-to-left languages
  flag       String? // Country flag emoji or URL
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  productTranslations  ProductTranslation[]
  categoryTranslations CategoryTranslation[]
  translations         Translation[]

  @@index([code])
  @@index([isDefault, isEnabled])
  @@map("languages")
}

model ProductTranslation {
  id              String            @id @default(uuid())
  productId       String
  languageCode    String
  name            String
  description     String            @db.Text // Allow long descriptions
  metaTitle       String?
  metaDescription String?
  slug            String?
  status          TranslationStatus @default(DRAFT) // Translation workflow status
  translatedBy    String?           // "auto" | "human" | user_id
  publishedAt     DateTime?         // When translation was published
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageCode], references: [code], onDelete: Cascade)

  @@unique([productId, languageCode])
  @@index([productId])
  @@index([languageCode])
  @@index([slug])
  @@index([status])
  @@map("product_translations")
}

model CategoryTranslation {
  id           String   @id @default(uuid())
  categoryId   String
  languageCode String
  name         String
  description  String?
  slug         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageCode], references: [code], onDelete: Cascade)

  @@unique([categoryId, languageCode])
  @@index([categoryId])
  @@index([languageCode])
  @@index([slug])
  @@map("category_translations")
}

model Translation {
  id           String   @id @default(uuid())
  languageCode String
  key          String // Translation key (e.g., "common.add_to_cart")
  value        String // Translated text
  namespace    String   @default("common") // Namespace for organization
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  language Language @relation(fields: [languageCode], references: [code], onDelete: Cascade)

  @@unique([languageCode, key, namespace])
  @@index([languageCode, namespace])
  @@index([key])
  @@map("translations")
}

// ============================================
// LOYALTY & REWARDS PROGRAM (Phase 25)
// ============================================

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum PointTransactionType {
  EARNED_PURCHASE // Points earned from purchase
  EARNED_REVIEW // Points earned from product review
  EARNED_REFERRAL // Points earned from successful referral
  EARNED_SIGNUP // Welcome bonus
  EARNED_BIRTHDAY // Birthday reward
  EARNED_SOCIAL_SHARE // Social media share
  EARNED_PROMOTION // Special promotion
  REDEEMED_DISCOUNT // Points redeemed for discount
  REDEEMED_PRODUCT // Points redeemed for free product
  EXPIRED // Points expired
  ADJUSTED_MANUAL // Manual adjustment by admin
  REVERSED_RETURN // Points reversed due to order return
}

enum RewardType {
  DISCOUNT_PERCENTAGE // Percentage discount
  DISCOUNT_FIXED // Fixed amount discount
  FREE_SHIPPING // Free shipping on order
  EARLY_ACCESS // Early access to sales
  EXCLUSIVE_PRODUCT // Access to exclusive products
  PRIORITY_SUPPORT // Priority customer support
  BONUS_POINTS // Bonus points multiplier
  FREE_PRODUCT // Free product reward
}

enum ReferralStatus {
  PENDING // Referral link shared, not used
  COMPLETED // Referee made qualifying purchase
  REWARDED // Rewards distributed
  EXPIRED // Referral expired
  CANCELLED // Referral cancelled
}

model LoyaltyProgram {
  id          String  @id @default(uuid())
  name        String
  description String?
  isActive    Boolean @default(true)

  // Points configuration
  pointsPerDollar     Float @default(1) // Points earned per dollar spent
  minimumRedeemPoints Int   @default(100) // Minimum points to redeem
  pointsExpiryDays    Int? // Days until points expire (null = never)

  // Signup bonus
  signupBonusPoints Int @default(100)

  // Review rewards
  reviewRewardPoints Int @default(50)

  // Birthday reward
  birthdayRewardPoints Int @default(200)

  // Referral rewards
  referrerRewardPoints Int   @default(500) // Points for referrer
  refereeRewardPoints  Int   @default(250) // Points for new customer
  referralMinPurchase  Float @default(50) // Minimum purchase for referral to count

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("loyalty_programs")
}

model CustomerLoyalty {
  id     String  @id @default(uuid())
  userId String  @unique
  email  String? // Email for notifications
  name   String? // Customer name for display

  // Points
  totalPointsEarned Int @default(0)
  currentPoints     Int @default(0)
  lifetimePoints    Int @default(0)

  // Tier
  currentTier LoyaltyTier @default(BRONZE)
  tierSince   DateTime    @default(now())

  // Spending tracking
  lifetimeSpending Float @default(0)
  tierSpending     Float @default(0) // Spending in current tier period

  // Referral
  referralCode String  @unique
  referredBy   String? // User ID of referrer

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  pointTransactions PointTransaction[]
  referrals         Referral[]         @relation("Referrer")
  referredUsers     Referral[]         @relation("Referee")
  rewardRedemptions RewardRedemption[]

  @@index([currentTier])
  @@index([referralCode])
  @@map("customer_loyalty")
}

model PointTransaction {
  id        String @id @default(uuid())
  loyaltyId String

  type        PointTransactionType
  points      Int // Positive for earned, negative for redeemed
  description String

  // Reference data
  orderId    String? // Related order if applicable
  productId  String? // Related product if applicable
  referralId String? // Related referral if applicable

  // Expiry
  expiresAt DateTime?
  isExpired Boolean   @default(false)

  createdAt DateTime @default(now())

  loyalty CustomerLoyalty @relation(fields: [loyaltyId], references: [id], onDelete: Cascade)
  order   Order?          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([loyaltyId, createdAt])
  @@index([orderId])
  @@index([expiresAt])
  @@map("point_transactions")
}

model LoyaltyTierBenefit {
  id          String      @id @default(uuid())
  tier        LoyaltyTier
  name        String
  description String?

  // Tier requirements
  minimumSpending Float @default(0) // Minimum lifetime spending
  minimumPoints   Int   @default(0) // Minimum lifetime points

  // Benefits
  pointsMultiplier   Float   @default(1) // Points earning multiplier
  discountPercentage Float   @default(0) // Discount on all purchases
  freeShipping       Boolean @default(false)
  earlyAccessHours   Int     @default(0) // Hours of early access to sales
  prioritySupport    Boolean @default(false)
  exclusiveProducts  Boolean @default(false)

  // Badge
  badgeIcon  String?
  badgeColor String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tier])
  @@map("loyalty_tier_benefits")
}

model Reward {
  id          String     @id @default(uuid())
  name        String
  description String
  type        RewardType

  // Cost
  pointsCost Int

  // Reward value
  discountPercentage Float? // For DISCOUNT_PERCENTAGE
  discountAmount     Float? // For DISCOUNT_FIXED
  productId          String? // For FREE_PRODUCT

  // Availability
  isActive   Boolean   @default(true)
  stock      Int? // Limited quantity (null = unlimited)
  validFrom  DateTime?
  validUntil DateTime?

  // Restrictions
  minimumTier     LoyaltyTier? // Minimum tier required
  minimumPurchase Float? // Minimum purchase amount to use reward

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  redemptions RewardRedemption[]

  @@index([type])
  @@index([isActive])
  @@map("rewards")
}

model RewardRedemption {
  id        String @id @default(uuid())
  loyaltyId String
  rewardId  String

  pointsSpent Int

  // Usage
  isUsed  Boolean   @default(false)
  usedAt  DateTime?
  orderId String? // Order where reward was applied

  // Validity
  expiresAt DateTime?

  createdAt DateTime @default(now())

  loyalty CustomerLoyalty @relation(fields: [loyaltyId], references: [id], onDelete: Cascade)
  reward  Reward          @relation(fields: [rewardId], references: [id])
  order   Order?          @relation(fields: [orderId], references: [id])

  @@index([loyaltyId])
  @@index([rewardId])
  @@index([orderId])
  @@map("reward_redemptions")
}

model Referral {
  id             String  @id @default(uuid())
  referrerId     String
  refereeId      String? // Null until referee signs up
  programId      String? // Link to referral program
  referralCodeId String? // Link to referral code used

  refereeEmail String? // Email of person being referred
  refereePhone String?

  status ReferralStatus @default(PENDING)

  // Tracking
  firstPurchaseId     String? // First purchase by referee
  firstPurchaseAmount Float?

  // Rewards
  referrerRewarded   Boolean   @default(false)
  referrerRewardedAt DateTime?
  referrerPoints     Int?

  refereeRewarded   Boolean   @default(false)
  refereeRewardedAt DateTime?
  refereePoints     Int?

  // Validity
  expiresAt   DateTime?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  referrer CustomerLoyalty  @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referee  CustomerLoyalty? @relation("Referee", fields: [refereeId], references: [id], onDelete: SetNull)
  program  ReferralProgram? @relation("ReferralProgram", fields: [programId], references: [id], onDelete: SetNull)

  @@index([referrerId])
  @@index([refereeId])
  @@index([refereeEmail])
  @@index([status])
  @@index([programId])
  @@map("referrals")
}

// ============================================
// FLASH SALES & DEALS SYSTEM (Phase 26)
// ============================================

enum DealType {
  FLASH_SALE // Time-limited flash sale
  DAILY_DEAL // Deal of the day
  BUNDLE_DEAL // Bundle discount
  BOGO // Buy one get one
  PERCENTAGE_DISCOUNT // Percentage off
  FIXED_DISCOUNT // Fixed amount off
  VOLUME_DISCOUNT // Bulk purchase discount
  SEASONAL_SALE // Seasonal promotion
}

enum DealStatus {
  SCHEDULED // Not started yet
  ACTIVE // Currently running
  ENDED // Finished
  CANCELLED // Cancelled
  PAUSED // Temporarily paused
}

model Deal {
  id          String     @id @default(uuid())
  name        String
  description String
  type        DealType
  status      DealStatus @default(SCHEDULED)

  // Timing
  startTime DateTime
  endTime   DateTime

  // Early access for loyalty tiers
  earlyAccessHours Int          @default(0) // Hours before public start
  minimumTier      LoyaltyTier? // Minimum tier for early access

  // Discount configuration
  discountPercentage Float? // For percentage discounts
  discountAmount     Float? // For fixed discounts
  buyQuantity        Int? // For BOGO (buy this many)
  getQuantity        Int? // For BOGO (get this many free)
  minimumPurchase    Float? // Minimum purchase amount required

  // Stock and limits
  totalStock       Int? // Total deal stock (null = unlimited)
  remainingStock   Int? // Remaining stock
  limitPerCustomer Int? // Max purchases per customer

  // Display
  badge         String? // Badge text (e.g., "FLASH SALE", "50% OFF")
  badgeColor    String? // Badge color
  featuredOrder Int? // Order for featured deals (lower = higher priority)
  isFeatured    Boolean @default(false)
  bannerImage   String? // Banner image URL

  // Stacking rules
  stackableWithCoupons Boolean @default(false)
  stackableWithLoyalty Boolean @default(true)

  // Metadata
  views       Int   @default(0)
  clicks      Int   @default(0)
  conversions Int   @default(0)
  revenue     Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dealProducts  DealProduct[]
  dealPurchases DealPurchase[]

  @@index([status, startTime, endTime])
  @@index([type])
  @@index([isFeatured, featuredOrder])
  @@map("deals")
}

model DealProduct {
  id        String @id @default(uuid())
  dealId    String
  productId String

  // Product-specific pricing
  dealPrice     Float? // Override deal price for this product
  originalPrice Float // Original price for comparison

  // Stock allocation for this product in the deal
  stockAllocated Int? // Stock allocated to this deal
  stockRemaining Int? // Remaining stock for this deal

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deal    Deal    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([dealId, productId])
  @@index([dealId, isActive])
  @@index([productId])
  @@map("deal_products")
}

model DealPurchase {
  id      String @id @default(uuid())
  dealId  String
  userId  String
  orderId String

  quantity  Int
  dealPrice Float // Price paid
  savings   Float // Amount saved

  purchasedAt DateTime @default(now())

  deal  Deal  @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([userId])
  @@index([orderId])
  @@map("deal_purchases")
}

model DealNotification {
  id        String  @id @default(uuid())
  userId    String
  dealId    String? // Null for general deal notifications
  productId String? // Null for general notifications

  // Notification preferences
  notifyOnStart     Boolean @default(true) // Notify when deal starts
  notifyOnPriceDrop Boolean @default(true) // Notify on price drops
  notifyBeforeEnd   Boolean @default(true) // Notify 1 hour before end
  hoursBeforeEnd    Int     @default(1) // Hours before end to notify

  isActive       Boolean   @default(true)
  lastNotifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([dealId])
  @@index([productId])
  @@map("deal_notifications")
}

model DealAnalytics {
  id     String @id @default(uuid())
  dealId String @unique

  // Traffic metrics
  totalViews       Int   @default(0)
  uniqueViews      Int   @default(0)
  clicks           Int   @default(0)
  clickThroughRate Float @default(0)

  // Conversion metrics
  totalPurchases    Int   @default(0)
  totalRevenue      Float @default(0)
  totalSavings      Float @default(0)
  conversionRate    Float @default(0)
  averageOrderValue Float @default(0)

  // Stock metrics
  initialStock    Int?
  stockSold       Int   @default(0)
  stockRemaining  Int?
  sellThroughRate Float @default(0)

  // Time metrics
  peakHour             Int? // Hour of day with most sales (0-23)
  averageTimeToConvert Float? // Average seconds from view to purchase

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("deal_analytics")
}

// ==================== PHASE 27: GIFT CARDS & STORE CREDIT ====================

enum GiftCardStatus {
  ACTIVE
  REDEEMED
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum GiftCardType {
  DIGITAL // Email delivery
  PHYSICAL // Shipped card
  PROMOTIONAL // Marketing/promotional cards
}

enum StoreCreditType {
  REFUND // From order returns
  COMPENSATION // Customer service compensation
  PROMOTIONAL // Marketing promotions
  GIFT // Converted from gift card
  LOYALTY // Converted from loyalty points
}

enum TransactionType {
  PURCHASE // Initial purchase/creation
  REDEMPTION // Partial or full redemption
  REFUND // Refund back to card
  ADJUSTMENT // Manual adjustment
  EXPIRATION // Card expired
  CANCELLATION // Card cancelled
  TRANSFER // Balance transfer
}

// Gift Card Model
model GiftCard {
  id     String         @id @default(uuid())
  code   String         @unique // Unique redemption code
  type   GiftCardType   @default(DIGITAL)
  status GiftCardStatus @default(ACTIVE)

  // Amount details
  initialAmount  Float // Original value
  currentBalance Float // Remaining balance
  currency       String @default("USD")

  // Purchaser information
  purchasedBy String? // User who purchased (nullable for promotional)
  purchaser   User?   @relation("GiftCardPurchaser", fields: [purchasedBy], references: [id], onDelete: SetNull)

  // Recipient information
  recipientEmail  String? // Delivery email
  recipientName   String? // Recipient name
  senderName      String? // Purchaser's name
  personalMessage String? // Custom message

  // Redemption tracking
  redeemedBy String? // User who redeemed
  redeemer   User?     @relation("GiftCardRedeemer", fields: [redeemedBy], references: [id], onDelete: SetNull)
  redeemedAt DateTime? // First redemption date

  // Validity dates
  purchaseDate   DateTime  @default(now())
  activationDate DateTime  @default(now()) // When card becomes active
  expirationDate DateTime? // Expiry date (null = no expiry)

  // Design customization
  designTemplate String? // Template ID/name
  customImage    String? // Custom image URL

  // Delivery
  isScheduled       Boolean   @default(false)
  scheduledDelivery DateTime? // Scheduled email delivery time
  deliveredAt       DateTime? // When email was sent

  // Order relationship
  orderId String? // Order if purchased as product
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Restrictions
  minimumPurchase   Float? // Min order value to use card
  allowedCategories String[] // Restrict to specific categories
  excludedProducts  String[] // Products that can't be purchased

  // Tracking
  lastUsedAt DateTime? // Last redemption
  usageCount Int       @default(0) // Number of times used

  // Relationships
  transactions    GiftCardTransaction[]
  appliedToOrders Order[]               @relation("OrderGiftCards")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@index([purchasedBy])
  @@index([redeemedBy])
  @@index([recipientEmail])
  @@index([expirationDate])
  @@map("gift_cards")
}

// Gift Card Transaction History
model GiftCardTransaction {
  id         String   @id @default(uuid())
  giftCardId String
  giftCard   GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)

  type          TransactionType
  amount        Float // Transaction amount
  balanceBefore Float // Balance before transaction
  balanceAfter  Float // Balance after transaction

  // Related entities
  orderId String? // Order if redemption
  order   Order?  @relation("GiftCardTransactionOrder", fields: [orderId], references: [id], onDelete: SetNull)

  userId String? // User who performed action
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Details
  description String? // Transaction description
  notes       String? // Admin notes

  // Metadata
  ipAddress String? // User's IP
  userAgent String? // User's browser

  createdAt DateTime @default(now())

  @@index([giftCardId])
  @@index([orderId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("gift_card_transactions")
}

// Store Credit Model
model StoreCredit {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Balance
  currentBalance Float  @default(0)
  totalEarned    Float  @default(0)
  totalSpent     Float  @default(0)
  currency       String @default("USD")

  // Restrictions
  expirationDate  DateTime? // When all credit expires
  minimumPurchase Float? // Minimum order value to use credit

  // Relationships
  transactions StoreCreditTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("store_credits")
}

// Store Credit Transaction History
model StoreCreditTransaction {
  id            String      @id @default(uuid())
  storeCreditId String
  storeCredit   StoreCredit @relation(fields: [storeCreditId], references: [id], onDelete: Cascade)

  type            StoreCreditType
  transactionType TransactionType @default(PURCHASE)

  amount        Float // Transaction amount
  balanceBefore Float // Balance before transaction
  balanceAfter  Float // Balance after transaction

  // Related entities
  orderId String? // Related order
  order   Order?  @relation("StoreCreditTransactionOrder", fields: [orderId], references: [id], onDelete: SetNull)

  giftCardId String? // If converted from gift card

  // Details
  description String
  notes       String? // Admin notes
  expiresAt   DateTime? // Expiration date for this credit

  // Metadata
  createdBy String? // Admin who created (for manual adjustments)

  createdAt DateTime @default(now())

  @@index([storeCreditId])
  @@index([orderId])
  @@index([type])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("store_credit_transactions")
}

// ============================================
// VENDOR MANAGEMENT SYSTEM
// ============================================

enum VendorStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  REJECTED
  INACTIVE
}

enum VendorApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PayoutMethod {
  BANK_TRANSFER
  PAYPAL
  STRIPE
  CHECK
}

// Vendor Profile - Extended vendor information
model VendorProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Business Information
  name            String? // Vendor name (alias/copy of businessName for queries)
  businessName    String
  businessType    String? // LLC, Corporation, Sole Proprietor, etc.
  taxId           String? // EIN or SSN (encrypted)
  businessAddress String? // JSON: street, city, state, zip, country
  businessPhone   String?
  businessEmail   String?
  website         String?

  // Legal & Compliance
  businessLicense       String? // License number
  businessDocuments     String[] @default([]) // URLs to uploaded documents
  verificationDocuments String[] @default([]) // ID, proof of address, etc.

  // Banking Information (encrypted)
  bankName        String?
  accountNumber   String? // Encrypted
  routingNumber   String? // Encrypted
  paypalEmail     String?
  stripeAccountId String?

  // Vendor Settings
  status              VendorStatus @default(PENDING_VERIFICATION)
  commissionRate      Float        @default(15) // Percentage
  isVerified          Boolean      @default(false)
  canSell             Boolean      @default(false)
  autoApproveProducts Boolean      @default(false)

  // Branding
  logoUrl     String?
  bannerUrl   String?
  description String?
  socialMedia Json? // Twitter, Facebook, Instagram links

  // Metrics (cached)
  rating          Float @default(0) // Vendor rating (for RFQ service)
  totalSales      Float @default(0)
  totalOrders     Int   @default(0)
  averageRating   Float @default(0)
  totalProducts   Int   @default(0)
  totalRevenue    Float @default(0)
  totalCommission Float @default(0)

  // Dates
  verifiedAt   DateTime?
  lastPayoutAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  application         VendorApplication?
  payouts             VendorPayout[]
  commissionRules     VendorCommissionRule[]
  performanceMetrics  VendorPerformanceMetric[]
  bulkUploadJobs      BulkUploadJob[]
  featuredListings    FeaturedListing[]
  vendorCoupons       VendorCoupon[]
  rfqResponses        RFQResponse[]             @relation("RFQResponseVendor")
  enterpriseContracts EnterpriseContract[]      @relation("EnterpriseContractVendor")

  @@index([userId])
  @@index([status])
  @@index([isVerified])
  @@index([businessName])
  @@map("vendor_profiles")
}

// Vendor Application - Onboarding workflow
model VendorApplication {
  id              String        @id @default(uuid())
  vendorProfileId String        @unique
  vendorProfile   VendorProfile @relation(fields: [vendorProfileId], references: [id], onDelete: Cascade)

  // Application Details
  status          VendorApplicationStatus @default(PENDING)
  applicationData Json // All submitted application data

  // Documents
  documentsSubmitted String[] // URLs to uploaded documents
  documentsVerified  Boolean  @default(false)

  // Review Process
  reviewedBy      String? // Admin user ID who reviewed
  reviewedAt      DateTime?
  reviewNotes     String? // Internal notes
  rejectionReason String?

  // Onboarding Checklist
  businessInfoComplete Boolean @default(false)
  bankingInfoComplete  Boolean @default(false)
  documentsComplete    Boolean @default(false)
  agreementSigned      Boolean @default(false)

  // Dates
  submittedAt DateTime?
  approvedAt  DateTime?
  rejectedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([submittedAt])
  @@map("vendor_applications")
}

// Vendor Payout - Payment tracking
model VendorPayout {
  id              String        @id @default(uuid())
  vendorProfileId String
  vendorProfile   VendorProfile @relation(fields: [vendorProfileId], references: [id], onDelete: Cascade)

  // Payout Details
  amount   Float
  currency String       @default("USD")
  status   PayoutStatus @default(PENDING)
  method   PayoutMethod

  // Period
  periodStart DateTime
  periodEnd   DateTime

  // Breakdown
  totalSales      Float // Total sales in period
  totalCommission Float // Commission amount
  platformFees    Float @default(0)
  adjustments     Float @default(0) // Manual adjustments
  netAmount       Float // Final payout amount

  // Transaction Details
  transactionId String? // External payment transaction ID
  reference     String? // Internal reference number
  description   String?

  // Processing
  processedBy   String? // Admin who processed
  processedAt   DateTime?
  failureReason String?

  // Metadata
  orderIds String[] // Orders included in this payout
  metadata Json? // Additional data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vendorProfileId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([createdAt])
  @@map("vendor_payouts")
}

// Vendor Commission Rules - Flexible commission structure
model VendorCommissionRule {
  id              String        @id @default(uuid())
  vendorProfileId String
  vendorProfile   VendorProfile @relation(fields: [vendorProfileId], references: [id], onDelete: Cascade)

  // Rule Configuration
  name        String
  description String?
  isActive    Boolean @default(true)

  // Commission Structure
  commissionRate Float // Percentage
  minCommission  Float? // Minimum commission amount
  maxCommission  Float? // Maximum commission amount

  // Conditions
  categoryId    String? // Apply to specific category
  minOrderValue Float? // Minimum order value
  maxOrderValue Float? // Maximum order value

  // Priority
  priority Int @default(0) // Higher priority rules apply first

  // Dates
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([vendorProfileId])
  @@index([isActive])
  @@index([effectiveFrom, effectiveTo])
  @@map("vendor_commission_rules")
}

// Vendor Performance Metrics - Track vendor performance
model VendorPerformanceMetric {
  id              String        @id @default(uuid())
  vendorProfileId String
  vendorProfile   VendorProfile @relation(fields: [vendorProfileId], references: [id], onDelete: Cascade)

  // Time Period
  period     String // DAILY, WEEKLY, MONTHLY, YEARLY
  periodDate DateTime // Start of the period

  // Sales Metrics
  totalSales        Float @default(0)
  totalOrders       Int   @default(0)
  totalRevenue      Float @default(0)
  totalCommission   Float @default(0)
  averageOrderValue Float @default(0)

  // Product Metrics
  productsListed     Int @default(0)
  productsSold       Int @default(0)
  outOfStockProducts Int @default(0)

  // Customer Metrics
  uniqueCustomers   Int   @default(0)
  repeatCustomers   Int   @default(0)
  customerRetention Float @default(0) // Percentage

  // Order Fulfillment
  ordersShipped       Int   @default(0)
  ordersDelivered     Int   @default(0)
  ordersCancelled     Int   @default(0)
  ordersReturned      Int   @default(0)
  averageShippingTime Float @default(0) // Days

  // Quality Metrics
  averageRating   Float @default(0)
  totalReviews    Int   @default(0)
  positiveReviews Int   @default(0)
  negativeReviews Int   @default(0)

  // Performance Score
  overallScore Float @default(0) // Calculated score 0-100

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([vendorProfileId, period, periodDate])
  @@index([vendorProfileId])
  @@index([periodDate])
  @@index([overallScore])
  @@map("vendor_performance_metrics")
}

// ============================================================================
// INVENTORY MANAGEMENT SYSTEM
// ============================================================================
// Phase: Inventory Management
// Date: November 18, 2025
// Features: Multi-warehouse, stock tracking, reordering, forecasting
// ============================================================================

enum StockStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  BACKORDER
  DISCONTINUED
}

enum StockMovementType {
  PURCHASE
  SALE
  TRANSFER_IN
  TRANSFER_OUT
  ADJUSTMENT
  RETURN
  DAMAGE
  THEFT
  EXPIRED
}

enum TransferStatus {
  PENDING
  IN_TRANSIT
  COMPLETED
  CANCELLED
}

enum ReorderStatus {
  PENDING
  ORDERED
  RECEIVED
  CANCELLED
}

model Warehouse {
  id         String  @id @default(uuid())
  name       String
  code       String  @unique
  address    String
  city       String
  state      String
  country    String
  postalCode String
  phone      String?
  email      String?
  managerId  String?
  isActive   Boolean @default(true)
  isPrimary  Boolean @default(false)

  inventory     InventoryItem[]
  transfersFrom StockTransfer[] @relation("WarehouseFrom")
  transfersTo   StockTransfer[] @relation("WarehouseTo")
  shipments     Shipment[]
  returnItems   ReturnItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}

model InventoryItem {
  id          String @id @default(uuid())
  productId   String
  warehouseId String

  quantity     Int @default(0)
  reservedQty  Int @default(0)
  availableQty Int @default(0)

  reorderPoint    Int  @default(10)
  reorderQuantity Int  @default(50)
  minStockLevel   Int  @default(5)
  maxStockLevel   Int?

  status StockStatus @default(IN_STOCK)

  lastRestockDate DateTime?
  lastSaleDate    DateTime?
  lastCountDate   DateTime?

  lowStockAlertSent   Boolean @default(false)
  outOfStockAlertSent Boolean @default(false)

  product    Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse  Warehouse        @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  movements  StockMovement[]
  reorders   ReorderRequest[]
  backorders Backorder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, warehouseId])
  @@index([productId])
  @@index([warehouseId])
  @@index([status])
  @@index([quantity])
}

model StockMovement {
  id              String @id @default(uuid())
  inventoryItemId String
  productId       String
  warehouseId     String

  type        StockMovementType
  quantity    Int
  previousQty Int
  newQty      Int

  orderId    String?
  transferId String?
  userId     String?

  reason String?
  notes  String?

  unitCost  Float?
  totalCost Float?

  inventoryItem InventoryItem  @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  transfer      StockTransfer? @relation(fields: [transferId], references: [id])

  createdAt DateTime @default(now())

  @@index([inventoryItemId])
  @@index([productId])
  @@index([warehouseId])
  @@index([type])
  @@index([createdAt])
}

model StockTransfer {
  id             String @id @default(uuid())
  transferNumber String @unique

  fromWarehouseId String
  toWarehouseId   String
  productId       String

  quantity Int
  status   TransferStatus @default(PENDING)

  requestedDate DateTime  @default(now())
  shippedDate   DateTime?
  receivedDate  DateTime?
  cancelledDate DateTime?

  requestedBy String?
  approvedBy  String?
  receivedBy  String?

  trackingNumber   String?
  carrier          String?
  estimatedArrival DateTime?

  notes              String?
  cancellationReason String?

  fromWarehouse Warehouse       @relation("WarehouseFrom", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse       @relation("WarehouseTo", fields: [toWarehouseId], references: [id])
  product       Product         @relation(fields: [productId], references: [id])
  movements     StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transferNumber])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@index([status])
  @@index([createdAt])
}

model ReorderRequest {
  id            String @id @default(uuid())
  requestNumber String @unique

  inventoryItemId String
  productId       String
  warehouseId     String

  quantityRequested Int
  quantityOrdered   Int?
  quantityReceived  Int?

  status ReorderStatus @default(PENDING)

  supplierId    String?
  estimatedCost Float?
  actualCost    Float?

  requestDate  DateTime  @default(now())
  orderDate    DateTime?
  expectedDate DateTime?
  receivedDate DateTime?

  purchaseOrderId String?

  notes String?

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requestNumber])
  @@index([inventoryItemId])
  @@index([productId])
  @@index([status])
  @@index([requestDate])
}

model Backorder {
  id              String @id @default(uuid())
  backorderNumber String @unique

  orderId         String
  orderItemId     String
  customerId      String
  productId       String
  inventoryItemId String?

  quantityOrdered   Int
  quantityFulfilled Int @default(0)
  quantityRemaining Int

  isActive Boolean @default(true)

  createdDate   DateTime  @default(now())
  expectedDate  DateTime?
  fulfilledDate DateTime?
  cancelledDate DateTime?

  customerNotified Boolean   @default(false)
  notificationDate DateTime?

  priority Int @default(1)

  notes String?

  inventoryItem InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([backorderNumber])
  @@index([orderId])
  @@index([customerId])
  @@index([productId])
  @@index([isActive])
  @@index([createdDate])
}

model StockAlert {
  id          String @id @default(uuid())
  alertNumber String @unique

  productId       String
  warehouseId     String
  inventoryItemId String

  alertType String
  severity  String

  currentQty Int
  threshold  Int

  message String

  isActive     Boolean   @default(true)
  isResolved   Boolean   @default(false)
  resolvedDate DateTime?

  notificationSent Boolean  @default(false)
  notifiedUsers    String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([warehouseId])
  @@index([isActive])
  @@index([alertType])
  @@index([severity])
  @@index([createdAt])
}

model InventoryForecast {
  id          String  @id @default(uuid())
  productId   String
  warehouseId String?

  forecastPeriod String
  periodDate     DateTime

  historicalSales   Int
  averageDailySales Float

  forecastedDemand Int
  recommendedStock Int

  confidenceLevel Float

  seasonalFactor    Float?
  trendFactor       Float?
  promotionalImpact Float?

  calculatedAt DateTime @default(now())
  validUntil   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, warehouseId, forecastPeriod, periodDate])
  @@index([productId])
  @@index([periodDate])
}

// ==================== SHIPPING & FULFILLMENT ====================

enum ShippingCarrier {
  UPS
  FEDEX
  USPS
  DHL
  CANADA_POST
  CUSTOM
}

enum ShipmentStatus {
  PENDING
  LABEL_CREATED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  RETURNED
  EXCEPTION
  CANCELLED
}

enum PackageType {
  ENVELOPE
  SMALL_PACKAGE
  MEDIUM_PACKAGE
  LARGE_PACKAGE
  PALLET
  CUSTOM
}

enum ServiceLevel {
  GROUND
  TWO_DAY
  NEXT_DAY
  INTERNATIONAL
  FREIGHT
}

model ShippingProvider {
  id       String          @id @default(uuid())
  carrier  ShippingCarrier
  name     String
  isActive Boolean         @default(true)

  // API Credentials (encrypted)
  apiKey        String?
  apiSecret     String?
  accountNumber String?
  meterNumber   String? // For FedEx

  // Configuration
  config   Json? // Additional provider-specific config
  testMode Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shipments Shipment[]
  zones     ShippingZone[]

  @@unique([carrier])
  @@map("shipping_providers")
}

model ShippingZone {
  id          String  @id @default(uuid())
  providerId  String
  name        String
  description String?

  // Geographic Coverage
  countries   String[] // Array of ISO country codes
  states      String[] // Array of state/province codes
  postalCodes String[] // Specific postal codes or patterns

  isActive Boolean @default(true)
  priority Int     @default(0) // Lower number = higher priority

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  provider ShippingProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  rules    ShippingRule[]

  @@index([providerId])
  @@map("shipping_zones")
}

model ShippingRule {
  id          String  @id @default(uuid())
  zoneId      String
  name        String
  description String?

  // Conditions
  minWeight    Float? // in pounds or kg
  maxWeight    Float?
  minValue     Float? // order value
  maxValue     Float?
  serviceLevel ServiceLevel?

  // Pricing
  baseRate      Float
  perPoundRate  Float?
  perItemRate   Float?
  freeThreshold Float? // Free shipping over this amount

  isActive Boolean @default(true)
  priority Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  zone ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId])
  @@map("shipping_rules")
}

model ShippingRate {
  id           String          @id @default(uuid())
  providerId   String?
  carrier      ShippingCarrier
  serviceName  String
  serviceLevel ServiceLevel

  // Package Details
  fromZip String
  toZip   String
  weight  Float

  // Pricing
  baseRate      Float
  fuelSurcharge Float?
  insurance     Float?
  totalRate     Float

  // Timing
  estimatedDays      Int?
  guaranteedDelivery Boolean @default(false)

  // Cache
  validUntil DateTime

  createdAt DateTime @default(now())

  @@index([fromZip, toZip])
  @@index([carrier, serviceLevel])
  @@map("shipping_rates")
}

model Shipment {
  id          String  @id @default(uuid())
  orderId     String
  providerId  String
  warehouseId String?

  // Carrier Info
  carrier        ShippingCarrier
  serviceLevel   ServiceLevel
  trackingNumber String?         @unique

  // Package Details
  packageType PackageType @default(SMALL_PACKAGE)
  weight      Float
  length      Float?
  width       Float?
  height      Float?

  // Addresses
  fromAddress Json // Warehouse/sender address
  toAddress   Json // Customer shipping address

  // Shipping Details
  status       ShipmentStatus @default(PENDING)
  shippingCost Float
  insurance    Float?
  signature    Boolean        @default(false)

  // Delivery
  estimatedDelivery DateTime?
  actualDelivery    DateTime?

  // Label
  labelUrl    String?
  labelFormat String? // PDF, PNG, ZPL

  // Additional
  isInternational    Boolean @default(false)
  customsValue       Float?
  customsDescription String?
  notes              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  provider             ShippingProvider      @relation(fields: [providerId], references: [id])
  warehouse            Warehouse?            @relation(fields: [warehouseId], references: [id])
  trackingEvents       TrackingEvent[]
  returnLabel          ReturnLabel?
  deliveryConfirmation DeliveryConfirmation?

  @@index([orderId])
  @@index([trackingNumber])
  @@index([status])
  @@map("shipments")
}

model TrackingEvent {
  id         String @id @default(uuid())
  shipmentId String

  status      String
  description String
  location    String?

  timestamp DateTime
  createdAt DateTime @default(now())

  // Relations
  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId])
  @@index([timestamp])
  @@map("tracking_events")
}

model ReturnLabel {
  id         String @id @default(uuid())
  shipmentId String @unique
  orderId    String

  carrier        ShippingCarrier
  trackingNumber String?         @unique

  labelUrl    String?
  labelFormat String?

  reason String?
  status String  @default("CREATED") // CREATED, USED, EXPIRED

  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shipment      Shipment       @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  returnRequest ReturnRequest?

  @@index([orderId])
  @@index([trackingNumber])
  @@map("return_labels")
}

model DeliveryConfirmation {
  id         String @id @default(uuid())
  shipmentId String @unique
  orderId    String

  deliveredAt DateTime
  signedBy    String?
  location    String?
  photo       String? // URL to delivery photo

  webhookReceived DateTime @default(now())
  webhookData     Json?

  createdAt DateTime @default(now())

  // Relations
  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("delivery_confirmations")
}

// ============================================
// RETURN & REFUND MANAGEMENT SYSTEM
// ============================================

enum ReturnStatus {
  REQUESTED // Customer submitted return request
  PENDING_APPROVAL // Awaiting admin approval
  APPROVED // Return approved, awaiting shipment
  LABEL_SENT // Return label sent to customer
  IN_TRANSIT // Package in transit back to warehouse
  RECEIVED // Package received at warehouse
  INSPECTING // Quality inspection in progress
  APPROVED_REFUND // Approved for refund after inspection
  REJECTED // Return rejected (wrong item, damaged by customer, etc.)
  COMPLETED // Return fully processed
  CANCELLED // Return cancelled by customer
}

enum ReturnReason {
  DEFECTIVE // Product defective or damaged
  WRONG_ITEM // Wrong item received
  NOT_AS_DESCRIBED // Product not as described
  SIZE_FIT // Size or fit issues
  CHANGED_MIND // Customer changed mind
  BETTER_PRICE // Found better price elsewhere
  LATE_DELIVERY // Arrived too late
  QUALITY_ISSUE // Quality not as expected
  GIFT_RETURN // Gift return
  OTHER // Other reason
}

enum ReturnType {
  REFUND // Full refund to original payment
  EXCHANGE // Exchange for different item
  STORE_CREDIT // Issue store credit
  PARTIAL_REFUND // Partial refund (restocking fee, etc.)
}

enum RefundStatus {
  PENDING // Refund initiated
  PROCESSING // Processing refund
  COMPLETED // Refund completed
  FAILED // Refund failed
  CANCELLED // Refund cancelled
}

enum RefundMethod {
  ORIGINAL_PAYMENT // Refund to original payment method
  STORE_CREDIT // Issue as store credit
  BANK_TRANSFER // Bank transfer
  CHECK // Physical check
}

model ReturnRequest {
  id        String @id @default(uuid())
  rmaNumber String @unique // Return Merchandise Authorization number
  orderId   String
  userId    String

  status     ReturnStatus @default(REQUESTED)
  returnType ReturnType   @default(REFUND)

  // Return details
  reason   ReturnReason
  comments String?      @db.Text

  // Approval workflow
  requestedAt    DateTime  @default(now())
  approvedAt     DateTime?
  approvedBy     String? // Admin user ID
  rejectedAt     DateTime?
  rejectedReason String?   @db.Text

  // Shipping
  returnLabelId  String?          @unique
  trackingNumber String?
  carrier        ShippingCarrier?
  shippedAt      DateTime?
  receivedAt     DateTime?

  // Inspection
  inspectedAt      DateTime?
  inspectedBy      String? // Admin/warehouse user ID
  inspectionNotes  String?   @db.Text
  inspectionPhotos Json? // Array of photo URLs

  // Financial
  refundAmount   Float? // Total refund amount
  restockingFee  Float  @default(0)
  shippingRefund Float  @default(0)

  // Store credit (tracked via StoreCreditTransaction)
  storeCreditAmount        Float? // Amount issued as store credit
  storeCreditTransactionId String? // Reference to store credit transaction

  // Metadata
  completedAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order       Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  returnLabel ReturnLabel?     @relation(fields: [returnLabelId], references: [id])
  items       ReturnItem[]
  refund      Refund?
  timeline    ReturnTimeline[]

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([rmaNumber])
  @@map("return_requests")
}

model ReturnItem {
  id              String @id @default(uuid())
  returnRequestId String
  orderItemId     String
  productId       String

  quantity  Int // Number of units being returned
  reason    ReturnReason
  condition String? // Product condition when returned
  notes     String?      @db.Text

  // Pricing
  itemPrice     Float // Original item price
  refundAmount  Float? // Actual refund amount for this item
  restockingFee Float  @default(0)

  // Inventory
  restocked   Boolean   @default(false)
  restockedAt DateTime?
  restockedBy String? // Admin user ID
  warehouseId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  returnRequest ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])
  warehouse     Warehouse?    @relation(fields: [warehouseId], references: [id])

  @@index([returnRequestId])
  @@index([productId])
  @@map("return_items")
}

model Refund {
  id              String @id @default(uuid())
  returnRequestId String @unique
  orderId         String
  userId          String?

  status RefundStatus @default(PENDING)
  method RefundMethod @default(ORIGINAL_PAYMENT)

  // Amounts
  subtotal       Float // Items refund
  shippingRefund Float @default(0)
  taxRefund      Float @default(0)
  restockingFee  Float @default(0)
  totalAmount    Float // Net refund amount

  // Payment details
  paymentIntentId String? // Stripe/payment gateway reference
  transactionId   String? // Payment gateway transaction ID

  // Processing
  processedAt  DateTime?
  processedBy  String? // Admin user ID
  failedReason String?   @db.Text

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  returnRequest ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user          User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("refunds")
}

model ReturnTimeline {
  id              String @id @default(uuid())
  returnRequestId String

  status      ReturnStatus
  description String
  performedBy String? // User ID of person who performed action
  metadata    Json?

  createdAt DateTime @default(now())

  // Relations
  returnRequest ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)

  @@index([returnRequestId])
  @@map("return_timeline")
}

// ==============================================
// TAX SYSTEM
// ==============================================

enum TaxType {
  SALES_TAX // US Sales Tax
  VAT // Value Added Tax (EU, UK, etc.)
  GST // Goods and Services Tax (Canada, Australia, India, etc.)
  HST // Harmonized Sales Tax (Canada)
  PST // Provincial Sales Tax (Canada)
  EXCISE_TAX // Special taxes on specific goods
  CUSTOMS_DUTY // Import/export taxes
}

enum TaxCalculationMethod {
  PERCENTAGE // Fixed percentage rate
  FLAT_RATE // Fixed amount
  TIERED // Different rates for different amounts
  COMPOUND // Tax on tax (e.g., Canada HST+GST)
}

enum TaxExemptionType {
  CUSTOMER_EXEMPT // Customer has tax exemption certificate
  PRODUCT_EXEMPT // Product is tax-exempt (e.g., food, medical)
  LOCATION_EXEMPT // Location doesn't require tax
  THRESHOLD_EXEMPT // Under minimum taxable amount
  WHOLESALE // Wholesale/resale exemption
  GOVERNMENT // Government entity exemption
  NON_PROFIT // Non-profit organization exemption
}

enum TaxRateStatus {
  ACTIVE
  INACTIVE
  SCHEDULED // Will become active on a future date
  EXPIRED
}

model TaxRate {
  id String @id @default(uuid())

  // Identification
  name        String // e.g., "California State Sales Tax"
  code        String  @unique // e.g., "US-CA-SALES"
  description String? @db.Text

  // Tax Configuration
  taxType           TaxType
  calculationMethod TaxCalculationMethod @default(PERCENTAGE)
  rate              Float // Percentage (e.g., 7.5 for 7.5%) or flat amount

  // Location (Jurisdiction)
  country String // ISO country code (e.g., "US", "CA", "GB")
  state   String? // State/Province code (e.g., "CA", "NY", "ON")
  city    String? // City name
  zipCode String? // Postal/ZIP code (supports wildcards: "900*")
  county  String? // County name

  // Applicability
  applyToShipping  Boolean @default(false)
  applyToGiftCards Boolean @default(false)
  compoundTax      Boolean @default(false) // Tax on tax

  // Priority (when multiple rates apply)
  priority Int @default(0)

  // Status and Dates
  status        TaxRateStatus @default(ACTIVE)
  effectiveFrom DateTime      @default(now())
  effectiveTo   DateTime?

  // External Integration
  externalId       String? // TaxJar/Avalara tax code
  externalProvider String? // "taxjar", "avalara", "manual"

  // Product Categories (optional - specific categories only)
  categoryIds String[] // Apply to specific categories only

  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taxCalculations TaxCalculation[]
  exemptions      TaxExemption[]

  @@index([country, state, city])
  @@index([zipCode])
  @@index([status])
  @@index([effectiveFrom, effectiveTo])
  @@map("tax_rates")
}

model TaxExemption {
  id String @id @default(uuid())

  // Customer or Product exemption
  userId     String? // If customer-specific
  productId  String? // If product-specific
  categoryId String? // If category-specific
  taxRateId  String? // If specific tax rate exemption

  // Exemption Details
  exemptionType     TaxExemptionType
  exemptionReason   String           @db.Text
  certificateNumber String? // Tax exemption certificate number
  certificateFile   String? // URL to uploaded certificate

  // Jurisdiction
  country String // ISO country code
  state   String?

  // Validity
  validFrom  DateTime  @default(now())
  validUntil DateTime?
  isActive   Boolean   @default(true)

  // Verification
  verifiedBy        String? // Admin user ID who verified
  verifiedAt        DateTime?
  verificationNotes String?   @db.Text

  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taxRate  TaxRate?  @relation(fields: [taxRateId], references: [id])
  user     User?     @relation(fields: [userId], references: [id])
  product  Product?  @relation(fields: [productId], references: [id])
  category Category? @relation(fields: [categoryId], references: [id])

  @@index([userId])
  @@index([productId])
  @@index([categoryId])
  @@index([taxRateId])
  @@index([country, state])
  @@index([isActive])
  @@map("tax_exemptions")
}

model TaxCalculation {
  id String @id @default(uuid())

  // Reference
  orderId String @unique

  // Location Details
  country String
  state   String?
  city    String?
  zipCode String?

  // Amounts
  subtotal       Float // Amount before tax
  shippingAmount Float @default(0)
  taxableAmount  Float // Amount subject to tax
  taxAmount      Float // Total tax calculated

  // Tax Breakdown (stored as JSON for flexibility)
  taxBreakdown Json // Array of {taxRateId, name, rate, amount}

  // Calculation Details
  calculationMethod     String // "automatic", "manual", "external_api"
  externalProvider      String? // "taxjar", "avalara", etc.
  externalTransactionId String?

  // Applied Exemptions
  exemptionsApplied Json? // Array of exemption details

  // Timestamps
  calculatedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  order    Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  taxRates TaxRate[]

  @@index([orderId])
  @@index([country, state, zipCode])
  @@index([calculatedAt])
  @@map("tax_calculations")
}

model TaxReport {
  id String @id @default(uuid())

  // Report Period
  reportType  String // "daily", "weekly", "monthly", "quarterly", "annual"
  periodStart DateTime
  periodEnd   DateTime

  // Jurisdiction
  country String
  state   String?

  // Summary
  totalOrders       Int   @default(0)
  taxableAmount     Float @default(0)
  totalTaxCollected Float @default(0)
  totalExemptions   Float @default(0)

  // Breakdown by Tax Type
  breakdown Json // Detailed breakdown by tax type and rate

  // Status
  status  String    @default("draft") // draft, finalized, filed
  filedAt DateTime?
  filedBy String? // Admin user ID

  // Files
  reportFile String? // URL to generated report PDF

  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reportType, periodStart, periodEnd])
  @@index([country, state])
  @@index([status])
  @@map("tax_reports")
}

model TaxConfiguration {
  id String @id @default(uuid())

  // Global Settings
  taxEnabled         Boolean @default(true)
  defaultTaxBehavior String  @default("tax_exclusive") // "tax_exclusive" or "tax_inclusive"

  // External Integration
  externalProvider String? // "taxjar", "avalara", "manual"
  apiKey           String? @db.Text // Encrypted
  apiEndpoint      String?

  // Business Details (for tax calculation APIs)
  businessName String?
  taxId        String? // Business tax ID/EIN
  address      Json? // Business address for nexus

  // Nexus (tax obligations by location)
  nexusLocations Json // Array of {country, state} where business has tax obligations

  // Rounding
  roundingMode      String @default("half_up") // "up", "down", "half_up", "half_down"
  roundingPrecision Int    @default(2)

  // Display Settings
  displayTaxInPrice Boolean @default(false)
  displayTaxLabel   String  @default("Tax")

  // Metadata
  metadata  Json?
  updatedAt DateTime @updatedAt
  updatedBy String? // Admin user ID

  @@map("tax_configuration")
}

// ============================================
// ENHANCED PRODUCT VARIANTS SYSTEM
// ============================================

/// Variant options like "Size", "Color", "Material", etc.
model VariantOption {
  id          String            @id @default(uuid())
  name        String // e.g., "Size", "Color", "Material"
  displayName String // e.g., "Choose Size", "Select Color"
  type        VariantOptionType @default(SELECT)
  position    Int               @default(0) // Display order
  isRequired  Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  values                VariantOptionValue[]
  productVariantOptions ProductVariantOption[]

  @@unique([name])
  @@index([position])
  @@map("variant_options")
}

/// Values for variant options like "Small", "Medium", "Large" for Size option
model VariantOptionValue {
  id              String   @id @default(uuid())
  optionId        String
  value           String // e.g., "Small", "Red", "Cotton"
  displayValue    String // e.g., "Small (S)", "Fire Engine Red"
  hexColor        String? // For color options: #FF0000
  imageUrl        String? // Image representation of this value
  position        Int      @default(0)
  isAvailable     Boolean  @default(true)
  priceAdjustment Float    @default(0) // Additional price for this option
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  option              VariantOption               @relation(fields: [optionId], references: [id], onDelete: Cascade)
  variantOptionValues ProductVariantOptionValue[]

  @@index([optionId])
  @@index([value])
  @@index([position])
  @@map("variant_option_values")
}

/// Links products to variant options (which options apply to this product)
model ProductVariantOption {
  id        String   @id @default(uuid())
  productId String
  optionId  String
  position  Int      @default(0) // Display order for this product
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  option  VariantOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([productId, optionId])
  @@index([productId])
  @@index([optionId])
  @@map("product_variant_options")
}

/// Links variant to option values (which values make up this variant)
model ProductVariantOptionValue {
  id        String   @id @default(uuid())
  variantId String
  valueId   String
  createdAt DateTime @default(now())

  // Relations
  variant ProductVariant     @relation(fields: [variantId], references: [id], onDelete: Cascade)
  value   VariantOptionValue @relation(fields: [valueId], references: [id], onDelete: Cascade)

  @@unique([variantId, valueId])
  @@index([variantId])
  @@index([valueId])
  @@map("product_variant_option_values")
}

enum VariantOptionType {
  SELECT // Dropdown selection
  COLOR // Color picker/swatches
  BUTTON // Button group
  RADIO // Radio buttons
  IMAGE // Image selection
}

// ============================================
// COUPON & DISCOUNT SYSTEM
// ============================================

/// Coupon codes for discounts
model Coupon {
  id          String  @id @default(uuid())
  code        String  @unique // Coupon code (e.g., "SUMMER2024")
  name        String // Display name
  description String? // Description of the offer
  userId      String? // Creator/owner of the coupon (nullable for system-wide coupons)
  source      String? // Source of the coupon

  // Discount Configuration
  type  CouponType // PERCENTAGE, FIXED_AMOUNT, BUY_X_GET_Y, FREE_SHIPPING, TIERED
  value Float // Discount value (percentage or amount)

  // Buy X Get Y Configuration (only for BUY_X_GET_Y type)
  buyQuantity Int? // Buy X items
  getQuantity Int? // Get Y items free

  // Tiered Discount Configuration (only for TIERED type)
  tieredRules Json? // [{minAmount: 50, discount: 10}, {minAmount: 100, discount: 20}]

  // Usage Restrictions
  minOrderValue     Float? // Minimum order value to apply coupon
  maxDiscountAmount Float? // Maximum discount cap
  usageLimitPerUser Int? // How many times a user can use this
  totalUsageLimit   Int? // Total number of times this can be used
  firstTimeOnly     Boolean @default(false) // Only for first-time customers

  // Validity Period
  startDate DateTime
  endDate   DateTime?

  // Target Restrictions
  applicableProductIds  String[] // Empty = all products
  applicableCategoryIds String[] // Empty = all categories
  excludedProductIds    String[] @default([])
  excludedCategoryIds   String[] @default([])
  userGroupIds          String[] @default([]) // Specific user groups only

  // Stacking Rules
  canStackWithOthers Boolean @default(false)

  // Status
  isActive    Boolean @default(true)
  isAutomatic Boolean @default(false) // Automatically applied if conditions met

  // Usage Tracking
  timesUsed Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usages CouponUsage[]

  @@index([code])
  @@index([type])
  @@index([isActive])
  @@index([userId])
  @@index([startDate, endDate])
  @@map("coupons")
}

/// Tracks coupon usage by users
model CouponUsage {
  id       String  @id @default(uuid())
  couponId String
  userId   String
  orderId  String? // Link to order if used

  discountAmount Float // Actual discount amount applied

  usedAt DateTime @default(now())

  // Relations
  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  order  Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([couponId])
  @@index([userId])
  @@index([orderId])
  @@index([usedAt])
  @@map("coupon_usages")
}

/// Automatic discounts applied without codes
model AutomaticDiscount {
  id          String  @id @default(uuid())
  name        String // Internal name
  description String? // Description

  // Discount Configuration
  type  DiscountType // PERCENTAGE, FIXED_AMOUNT, FREE_SHIPPING
  value Float

  // Trigger Rules (JSON for flexibility)
  rules Json // {type: "min_cart_value", value: 100, operator: "gte"}

  // Priority (higher number = higher priority)
  priority Int @default(0)

  // Target Restrictions
  applicableProductIds  String[] @default([])
  applicableCategoryIds String[] @default([])
  excludedProductIds    String[] @default([])
  excludedCategoryIds   String[] @default([])

  // Validity
  startDate DateTime
  endDate   DateTime?

  // Status
  isActive Boolean @default(true)

  // Usage Tracking
  timesApplied Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([priority])
  @@index([startDate, endDate])
  @@map("automatic_discounts")
}

enum CouponType {
  PERCENTAGE // 10% off
  FIXED_AMOUNT // $10 off
  BUY_X_GET_Y // Buy 2 get 1 free
  FREE_SHIPPING // Free shipping
  TIERED // Spend $100 get 15% off, spend $200 get 25% off
}

enum DiscountType {
  PERCENTAGE // 10% off
  FIXED_AMOUNT // $10 off
  FREE_SHIPPING // Free shipping
}

/// Promo-based referral codes for marketing campaigns
model PromoReferralCode {
  id   String @id @default(uuid())
  code String @unique // The promo code (e.g., "JOHN2024")

  // Referrer (person who shares the code)
  referrerId String

  // Rewards Configuration
  referrerReward Float                   @default(10) // Reward for the referrer (e.g., $10 or 10%)
  refereeReward  Float                   @default(10) // Reward for the new customer
  rewardType     PromoReferralRewardType @default(FIXED_AMOUNT) // PERCENTAGE or FIXED_AMOUNT

  // Usage Tracking
  timesUsed         Int   @default(0)
  totalRewardsGiven Float @default(0)
  maxUses           Int? // Limit on how many times this can be used

  // Status
  isActive Boolean @default(true)

  // Validity
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usages PromoReferralUsage[]

  @@index([code])
  @@index([referrerId])
  @@index([isActive])
  @@map("promo_referral_codes")
}

/// Tracks promo referral code usage
model PromoReferralUsage {
  id          String            @id @default(uuid())
  promoCodeId String
  promoCode   PromoReferralCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)

  // Referee (new customer who used the code)
  refereeId String

  // Tracking
  referrerRewardAmount   Float?
  refereeRewardAmount    Float?
  referrerRewardIssued   Boolean   @default(false)
  refereeRewardIssued    Boolean   @default(false)
  referrerRewardIssuedAt DateTime?
  refereeRewardIssuedAt  DateTime?

  // Associated order that triggered the referral
  orderId String?

  // Status
  status PromoReferralUsageStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([promoCodeId, refereeId]) // User can only use code once
  @@index([refereeId])
  @@index([status])
  @@map("promo_referral_usages")
}

enum PromoReferralRewardType {
  PERCENTAGE
  FIXED_AMOUNT
  STORE_CREDIT
}

enum PromoReferralUsageStatus {
  PENDING // User signed up but hasn't made qualifying purchase
  QUALIFIED // Qualifying purchase made, pending reward
  REWARDED // Rewards have been issued
  CANCELLED // Referral cancelled (e.g., refund)
}

/// Marketing campaigns for coordinated promotions
model MarketingCampaign {
  id          String  @id @default(uuid())
  name        String
  description String?

  // Campaign Type
  type MarketingCampaignType // FLASH_SALE, SEASONAL, LOYALTY, CLEARANCE, LAUNCH

  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Scheduling
  startDate DateTime?
  endDate   DateTime?

  // Budget & Goals
  budget        Float? // Maximum discount budget
  budgetUsed    Float  @default(0)
  targetRevenue Float?
  actualRevenue Float  @default(0)
  currency      String @default("USD")

  // Performance Metrics
  totalOrders   Int   @default(0)
  totalDiscount Float @default(0)
  impressions   Int   @default(0)
  clicks        Int   @default(0)
  conversions   Int   @default(0)
  metrics       Json? // Additional metrics like spend, revenue, etc.

  // Status
  status MarketingCampaignStatus @default(DRAFT)

  // Targeting and Content
  targeting Json? // Targeting configuration
  content   Json? // Campaign content

  // Metadata
  tags     String[] @default([])
  metadata Json? // Additional campaign settings

  createdById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  coupons      CampaignCoupon[]
  landingPages LandingPage[]

  @@index([status])
  @@index([type])
  @@index([organizationId])
  @@index([startDate, endDate])
  @@map("marketing_campaigns")
}

/// Links coupons to campaigns for tracking
model CampaignCoupon {
  id         String @id @default(uuid())
  campaignId String
  couponId   String

  // Performance for this coupon in this campaign
  usageCount Int   @default(0)
  revenue    Float @default(0)
  discount   Float @default(0)

  createdAt DateTime @default(now())

  campaign MarketingCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, couponId])
  @@index([couponId])
  @@map("campaign_coupons")
}

enum MarketingCampaignType {
  // Promotional campaigns
  FLASH_SALE // Short-duration high-discount
  SEASONAL // Holiday/seasonal promotions
  LOYALTY // Loyalty program rewards
  CLEARANCE // Inventory clearance
  LAUNCH // Product launch
  REFERRAL // Referral program
  WIN_BACK // Re-engagement campaign

  // Channel-based campaigns (from campaign.dto.ts)
  EMAIL // Email marketing
  SMS // SMS marketing
  PUSH // Push notifications
  MULTI_CHANNEL // Multi-channel campaigns
  SOCIAL // Social media campaigns
  DISPLAY // Display advertising
}

enum MarketingCampaignStatus {
  DRAFT // Not yet scheduled
  SCHEDULED // Scheduled for future
  ACTIVE // Active campaign (matches CampaignStatus.ACTIVE from code)
  RUNNING // Currently running (matches CampaignStatus.RUNNING from DTOs)
  PAUSED // Temporarily paused
  COMPLETED // Finished
  CANCELLED // Cancelled
}

// ============================================
// ABM (ACCOUNT-BASED MARKETING) SYSTEM
// ============================================

enum ABMAccountTier {
  STRATEGIC
  PRIORITY
  STANDARD
}

enum ABMAccountStatus {
  TARGET
  ENGAGED
  QUALIFIED
  CUSTOMER
  LOST
}

enum ABMCampaignStrategy {
  ONE_TO_ONE
  ONE_TO_FEW
  ONE_TO_MANY
}

enum ABMCampaignStatus {
  PLANNING
  ACTIVE
  PAUSED
  COMPLETED
}

enum ABMEngagementType {
  EMAIL
  MEETING
  CALL
  DEMO
  PROPOSAL
  EVENT
}

/// ABM Target Accounts
model ABMAccount {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name     String
  industry String
  size     String
  revenue  Float?

  tier   ABMAccountTier   @default(STANDARD)
  status ABMAccountStatus @default(TARGET)

  assignedTo String? // User ID of account manager

  // Engagement tracking
  score              Int       @default(0)
  engagementCount    Int       @default(0)
  lastEngagementDate DateTime?

  metadata Json? // Additional account data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  engagements ABMEngagement[]

  @@index([organizationId])
  @@index([tier])
  @@index([status])
  @@index([assignedTo])
  @@map("abm_accounts")
}

/// ABM Campaigns
model ABMCampaign {
  id          String  @id @default(uuid())
  name        String
  description String?

  targetAccounts String[] // Array of account IDs
  strategy       ABMCampaignStrategy
  status         ABMCampaignStatus   @default(PLANNING)

  budget    Float?
  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([strategy])
  @@map("abm_campaigns")
}

/// ABM Account Engagements
model ABMEngagement {
  id        String     @id @default(uuid())
  accountId String
  account   ABMAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  type    ABMEngagementType
  date    DateTime
  outcome String?
  notes   String?
  score   Int? // Engagement quality score

  createdAt DateTime @default(now())

  @@index([accountId])
  @@index([type])
  @@index([date])
  @@map("abm_engagements")
}

/// Vendor-specific coupons (vendors can create for their products)
model VendorCoupon {
  id       String        @id @default(uuid())
  vendorId String // Which vendor created this
  vendor   VendorProfile @relation(fields: [vendorId], references: [id])

  code        String  @unique
  name        String
  description String?

  // Discount Configuration
  type  CouponType
  value Float

  // Usage Restrictions
  minOrderValue     Float?
  maxDiscountAmount Float?
  usageLimitPerUser Int?
  totalUsageLimit   Int?

  // Validity
  startDate DateTime
  endDate   DateTime?

  // Scope (can only apply to vendor's own products)
  applicableProductIds String[] @default([])

  // Status
  isActive  Boolean @default(true)
  timesUsed Int     @default(0)

  // Approval (if vendor coupons need admin approval)
  requiresApproval Boolean                    @default(false)
  approvalStatus   VendorCouponApprovalStatus @default(PENDING)
  approvedById     String?
  approvedAt       DateTime?
  rejectionReason  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  usages VendorCouponUsage[]

  @@index([vendorId])
  @@index([code])
  @@index([isActive])
  @@index([approvalStatus])
  @@map("vendor_coupons")
}

/// Tracks vendor coupon usage
model VendorCouponUsage {
  id             String       @id @default(uuid())
  vendorCouponId String
  vendorCoupon   VendorCoupon @relation(fields: [vendorCouponId], references: [id], onDelete: Cascade)

  userId         String
  orderId        String?
  discountAmount Float

  usedAt DateTime @default(now())

  @@index([vendorCouponId])
  @@index([userId])
  @@index([orderId])
  @@map("vendor_coupon_usages")
}

enum VendorCouponApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

/// Saved addresses for fast checkout
model SavedAddress {
  id     String @id @default(uuid())
  userId String

  // Address details
  fullName   String
  email      String?
  phone      String?
  street     String
  city       String
  state      String
  postalCode String
  country    String

  // Type/Label
  label String? // e.g., "Home", "Work", "Office"
  type  AddressType @default(SHIPPING) // SHIPPING, BILLING, BOTH

  // Status
  isDefault  Boolean @default(false)
  isVerified Boolean @default(false) // Address verification status

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isDefault])
  @@map("saved_addresses")
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

/// Shopping cart for users and guests
model Cart {
  id         String  @id @default(uuid())
  userId     String? // Null for guest carts
  sessionId  String? // For guest cart identification
  shareToken String? @unique // For cart sharing via URL

  // Totals (calculated and cached)
  subtotal Float @default(0)
  tax      Float @default(0)
  total    Float @default(0)

  // Price Lock
  priceLocked      Boolean   @default(false)
  priceLockedAt    DateTime?
  priceLockedUntil DateTime?

  // Metadata
  isAbandoned      Boolean @default(false)
  convertedToOrder Boolean @default(false)
  mergedIntoCartId String? // If this cart was merged into another

  lastActivityAt DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  expiresAt      DateTime? // For guest carts cleanup

  // Relations
  user                User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  items               CartItem[]
  abandonmentTracking CartAbandonment?

  @@index([userId])
  @@index([sessionId])
  @@index([shareToken])
  @@index([isAbandoned])
  @@index([lastActivityAt])
  @@index([expiresAt])
  @@map("carts")
}

/// Items in shopping cart
model CartItem {
  id        String  @id @default(uuid())
  cartId    String
  productId String
  variantId String? // If product has variants

  quantity    Int
  price       Float // Price at time of adding to cart
  lockedPrice Float? // Locked price if price lock is active

  // Inventory Reservation
  inventoryReserved Boolean   @default(false)
  reservedAt        DateTime?
  reservationExpiry DateTime?

  addedAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cart    Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([cartId])
  @@index([productId])
  @@index([variantId])
  @@index([inventoryReserved])
  @@map("cart_items")
}

/// Track cart abandonment for recovery
model CartAbandonment {
  id     String @id @default(uuid())
  cartId String @unique

  // Contact Info (for guest carts)
  email String?
  phone String?

  // Abandonment Tracking
  abandonedAt         DateTime  @default(now())
  recoveryEmailSent   Boolean   @default(false)
  recoveryEmailSentAt DateTime?
  remindersSent       Int       @default(0)

  // Recovery
  recovered       Boolean   @default(false)
  recoveredAt     DateTime?
  recoveryOrderId String?

  // Discount tracking
  recoveryDiscountCode    String? // Unique discount code for this abandonment
  recoveryDiscountPercent Float? // Discount percentage offered
  discountExpiresAt       DateTime? // When the recovery discount expires

  // Metadata
  cartValue     Float
  itemCount     Int
  lastEmailType AbandonmentEmailType? // Track which email was last sent

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cart   Cart                   @relation(fields: [cartId], references: [id], onDelete: Cascade)
  emails CartAbandonmentEmail[]

  @@index([email])
  @@index([abandonedAt])
  @@index([recovered])
  @@index([recoveryDiscountCode])
  @@map("cart_abandonments")
}

/// Email sequence types for abandoned cart recovery
enum AbandonmentEmailType {
  REMINDER_1HR // First reminder - 1 hour after abandonment
  REMINDER_24HR // Second reminder - 24 hours after abandonment
  REMINDER_72HR // Final reminder - 72 hours after abandonment with discount
}

/// Track individual abandonment emails for recovery campaigns
model CartAbandonmentEmail {
  id            String  @id @default(uuid())
  abandonmentId String
  emailLogId    String? @unique // Link to EmailLog for tracking

  // Email type and timing
  emailType    AbandonmentEmailType
  scheduledFor DateTime // When the email should be sent

  // Status tracking
  sent      Boolean   @default(false)
  sentAt    DateTime?
  opened    Boolean   @default(false)
  openedAt  DateTime?
  clicked   Boolean   @default(false)
  clickedAt DateTime?

  // Recovery attribution
  convertedToOrder Boolean @default(false)
  orderId          String?
  recoveryDiscount Float? // Discount offered in this email
  discountUsed     Boolean @default(false)

  // Unsubscribe tracking
  unsubscribed   Boolean   @default(false)
  unsubscribedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  abandonment CartAbandonment @relation(fields: [abandonmentId], references: [id], onDelete: Cascade)
  emailLog    EmailLog?       @relation(fields: [emailLogId], references: [id], onDelete: SetNull)

  @@unique([abandonmentId, emailType]) // Only one email per type per abandonment
  @@index([abandonmentId])
  @@index([emailType])
  @@index([scheduledFor])
  @@index([sent])
  @@index([convertedToOrder])
  @@map("cart_abandonment_emails")
}

// ============================================
// EMAIL NOTIFICATION SYSTEM
// ============================================

enum EmailType {
  TRANSACTIONAL // Order confirmations, password resets, etc.
  MARKETING // Newsletters, promotions
  NOTIFICATION // Cart abandonment, price drops, etc.
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  QUEUED
}

/// Email templates for different notification types
model EmailTemplate {
  id          String  @id @default(uuid())
  name        String  @unique // e.g., "order_confirmation", "cart_abandonment"
  subject     String // Subject line template with variables
  htmlContent String  @db.Text // HTML email content with variables
  textContent String? @db.Text // Plain text version

  // Template metadata
  type        EmailType
  description String?
  variables   Json? // List of available variables for this template

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  emails          EmailLog[]
  automationRules EmailAutomationRule[] @relation("EmailAutomationRuleTemplate")

  @@index([name])
  @@index([type])
  @@index([isActive])
  @@map("email_templates")
}

/// Log of all sent emails
model EmailLog {
  id         String  @id @default(uuid())
  templateId String?
  userId     String?

  // Email details
  to          String
  cc          String[] @default([])
  bcc         String[] @default([])
  subject     String
  htmlContent String   @db.Text
  textContent String?  @db.Text

  // Metadata
  type         EmailType
  status       EmailStatus @default(PENDING)
  errorMessage String?

  // Tracking
  sentAt    DateTime?
  openedAt  DateTime?
  clickedAt DateTime?

  // Additional data
  metadata Json? // Store order ID, product IDs, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  template         EmailTemplate?        @relation(fields: [templateId], references: [id], onDelete: SetNull)
  user             User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  abandonmentEmail CartAbandonmentEmail?

  @@index([userId])
  @@index([to])
  @@index([status])
  @@index([type])
  @@index([sentAt])
  @@index([createdAt])
  @@map("email_logs")
}

/// User notification preferences
model NotificationPreference {
  id     String @id @default(uuid())
  userId String @unique

  // Email preferences
  orderConfirmation     Boolean @default(true)
  shippingUpdates       Boolean @default(true)
  deliveryNotifications Boolean @default(true)

  // Marketing preferences
  newsletters            Boolean @default(false)
  promotionalEmails      Boolean @default(false)
  productRecommendations Boolean @default(false)

  // Activity notifications
  cartAbandonment   Boolean @default(true)
  priceDropAlerts   Boolean @default(true)
  backInStockAlerts Boolean @default(true)
  wishlistUpdates   Boolean @default(true)
  reviewReminders   Boolean @default(true)

  // Account notifications
  securityAlerts Boolean @default(true)
  accountUpdates Boolean @default(true)

  // Communication channels
  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(false)
  pushEnabled  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_preferences")
}

/// Email queue for batch processing
model EmailQueue {
  id String @id @default(uuid())

  // Email details
  to          String
  subject     String
  htmlContent String? @db.Text // Made optional for template-based emails
  textContent String? @db.Text

  // Metadata
  templateId       String?
  templateData     Json? // Template variables
  userId           String?
  type             EmailType?
  priority         Int        @default(5) // 1-10, higher = more important
  automationRuleId String? // Link to automation rule if triggered by automation

  // Processing
  status       EmailStatus @default(QUEUED)
  attempts     Int         @default(0)
  maxAttempts  Int         @default(3)
  errorMessage String?

  scheduledFor DateTime? // For delayed/scheduled emails
  processedAt  DateTime?

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([scheduledFor])
  @@index([priority])
  @@index([createdAt])
  @@map("email_queue")
}

// ============================================
// SECURITY & COMPLIANCE
// ============================================

enum ActivityType {
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  EMAIL_CHANGE
  PROFILE_UPDATE
  ORDER_PLACED
  PAYMENT_PROCESSED
  REFUND_ISSUED
  ADMIN_ACTION
  API_KEY_CREATED
  API_KEY_DELETED
  DATA_EXPORT
  DATA_DELETION
  SUSPICIOUS_ACTIVITY
}

/// Audit trail for security and compliance
model AuditLog {
  id           String       @id @default(uuid())
  userId       String?
  activityType ActivityType

  // Activity details
  action   String // Specific action taken
  resource String? // Resource affected (e.g., "order:123")
  changes  Json? // What changed (before/after)

  // Request metadata
  ipAddress  String?
  userAgent  String?
  method     String? // HTTP method
  path       String? // API path
  statusCode Int? // Response status

  // Security flags
  isSuspicious Boolean @default(false)
  riskScore    Int     @default(0) // 0-100

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([activityType])
  @@index([createdAt])
  @@index([isSuspicious])
  @@index([ipAddress])
  @@map("audit_logs")
}

/// API keys for external integrations
model ApiKey {
  id     String @id @default(uuid())
  userId String
  name   String // Descriptive name for the key

  key       String @unique // The actual API key (hashed)
  keyPrefix String // First few characters for identification

  // Permissions
  scopes   String[] // API scopes/permissions
  isActive Boolean  @default(true)

  // Usage tracking
  lastUsedAt DateTime?
  usageCount Int       @default(0)

  // Security
  expiresAt   DateTime?
  ipWhitelist String[]  @default([]) // Allowed IPs (empty = all)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([key])
  @@index([isActive])
  @@index([expiresAt])
  @@map("api_keys")
}

/// Two-Factor Authentication
model TwoFactorAuth {
  id     String @id @default(uuid())
  userId String @unique

  // TOTP settings
  secret      String // Base32 encoded secret
  isEnabled   Boolean  @default(false)
  backupCodes String[] // Encrypted backup codes

  // Recovery
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("two_factor_auth")
}

/// Login attempts tracking for brute force protection
model LoginAttempt {
  id        String  @id @default(uuid())
  email     String
  ipAddress String
  userAgent String?

  success       Boolean @default(false)
  failureReason String?

  createdAt DateTime @default(now())

  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@map("login_attempts")
}

/// User sessions for better session management
model UserSession {
  id     String @id @default(uuid())
  userId String
  token  String @unique // Hashed session token

  // Session metadata
  ipAddress    String
  userAgent    String?
  deviceInfo   Json? // Browser, OS, device type
  deviceType   DevicePlatform @default(WEB)
  deviceId     String? // Device fingerprint hash
  deviceName   String? // User-assigned friendly name
  location     Json? // Geolocation data { city, country, lat, lng }

  // Status
  isActive      Boolean   @default(true)
  isRevoked     Boolean   @default(false)
  revokedReason String?   // Why session was terminated (e.g., "session_limit", "user_logout", "admin_action")
  revokedAt     DateTime?

  expiresAt      DateTime
  lastActivityAt DateTime @default(now())
  createdAt      DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([isActive])
  @@index([expiresAt])
  @@index([userId, isActive])
  @@index([deviceId])
  @@map("user_sessions")
}

/// Session settings for concurrent session limits
model SessionSettings {
  id             String @id @default(uuid())
  organizationId String? @unique // null = global settings

  // Session limits
  maxConcurrentSessions Int    @default(5)
  maxMobileSessions     Int    @default(3)
  maxWebSessions        Int    @default(3)
  enforcementMode       String @default("evict_oldest") // "block", "evict_oldest", "evict_idle"
  idleTimeoutMinutes    Int    @default(30)

  // Notifications
  notifyOnNewSession Boolean @default(true)
  notifyOnEviction   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("session_settings")
}

/// Multi-Factor Authentication settings
model UserMfa {
  id     String @id @default(uuid())
  userId String @unique

  // MFA configuration
  secret      String? // TOTP secret (encrypted in production)
  backupCodes Json? // Array of hashed backup codes
  enabled     Boolean @default(false)

  // Timestamps
  verifiedAt DateTime? // When MFA was verified/enabled
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_mfa")
}

/// Email verification tokens for account verification
model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([email])
  @@map("email_verification_tokens")
}

/// Data export requests (GDPR compliance)
model DataExportRequest {
  id     String @id @default(uuid())
  userId String

  status String @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  format String @default("JSON") // JSON, CSV

  // Result
  fileUrl      String?
  expiresAt    DateTime? // When the download link expires
  errorMessage String?

  requestedAt DateTime  @default(now())
  processedAt DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
  @@map("data_export_requests")
}

/// IP blacklist for security
model IpBlacklist {
  id        String @id @default(uuid())
  ipAddress String @unique
  reason    String

  isActive  Boolean   @default(true)
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ipAddress])
  @@index([isActive])
  @@index([expiresAt])
  @@map("ip_blacklist")
}

/// Security events for monitoring
model SecurityEvent {
  id       String @id @default(uuid())
  type     String // BRUTE_FORCE, SUSPICIOUS_ACTIVITY, DATA_BREACH_ATTEMPT, etc.
  severity String // LOW, MEDIUM, HIGH, CRITICAL

  description String
  ipAddress   String?
  userId      String?

  metadata Json?
  resolved Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([type])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
  @@index([ipAddress])
  @@map("security_events")
}

// ==================== Customer Support System ====================

model SupportTicket {
  id              String             @id @default(uuid())
  ticketNumber    String             @unique
  userId          String?
  guestEmail      String?
  subject         String
  description     String             @db.Text
  status          TicketStatus       @default(OPEN)
  priority        TicketPriority     @default(MEDIUM)
  category        String?
  assignedToId    String?
  assignedTo      User?              @relation("AssignedTickets", fields: [assignedToId], references: [id])
  relatedOrderId  String?
  relatedOrder    Order?             @relation(fields: [relatedOrderId], references: [id])
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  closedAt        DateTime?
  slaDeadline     DateTime?
  slaBreached     Boolean            @default(false)
  tags            String[]
  metadata        Json?
  messages        TicketMessage[]
  attachments     TicketAttachment[]
  internalNotes   TicketNote[]
  user            User?              @relation("UserTickets", fields: [userId], references: [id])
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([userId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([ticketNumber])
  @@map("support_tickets")
}

model TicketMessage {
  id          String        @id @default(uuid())
  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId      String?
  user        User?         @relation(fields: [userId], references: [id])
  senderName  String
  senderEmail String?
  message     String        @db.Text
  isInternal  Boolean       @default(false)
  isFromStaff Boolean       @default(false)
  attachments String[]
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
  @@map("ticket_messages")
}

model TicketAttachment {
  id         String        @id @default(uuid())
  ticketId   String
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  fileName   String
  fileUrl    String
  fileSize   Int
  mimeType   String
  uploadedBy String?
  createdAt  DateTime      @default(now())

  @@index([ticketId])
  @@map("ticket_attachments")
}

model TicketNote {
  id        String        @id @default(uuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  authorId  String
  author    User          @relation(fields: [authorId], references: [id])
  note      String        @db.Text
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([ticketId])
  @@index([authorId])
  @@map("ticket_notes")
}

model KnowledgeBaseArticle {
  id              String                 @id @default(uuid())
  title           String
  slug            String                 @unique
  content         String                 @db.Text
  excerpt         String?
  categoryId      String?
  category        KnowledgeBaseCategory? @relation(fields: [categoryId], references: [id])
  tags            String[]
  authorId        String
  author          User                   @relation(fields: [authorId], references: [id])
  status          ArticleStatus          @default(DRAFT)
  views           Int                    @default(0)
  helpfulCount    Int                    @default(0)
  notHelpfulCount Int                    @default(0)
  isPublished     Boolean                @default(false)
  publishedAt     DateTime?
  metadata        Json?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  @@index([categoryId])
  @@index([authorId])
  @@index([slug])
  @@index([status])
  @@map("knowledge_base_articles")
}

model KnowledgeBaseCategory {
  id          String                  @id @default(uuid())
  name        String
  slug        String                  @unique
  description String?
  icon        String?
  parentId    String?
  parent      KnowledgeBaseCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    KnowledgeBaseCategory[] @relation("CategoryHierarchy")
  articles    KnowledgeBaseArticle[]
  order       Int                     @default(0)
  isActive    Boolean                 @default(true)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@index([parentId])
  @@index([slug])
  @@map("knowledge_base_categories")
}

model CannedResponse {
  id        String   @id @default(uuid())
  title     String
  shortcut  String   @unique
  content   String   @db.Text
  category  String?
  tags      String[]
  isActive  Boolean  @default(true)
  createdBy String
  creator   User     @relation(fields: [createdBy], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shortcut])
  @@index([category])
  @@map("canned_responses")
}

model LiveChatSession {
  id           String        @id @default(uuid())
  userId       String?
  user         User?         @relation(fields: [userId], references: [id])
  guestName    String?
  guestEmail   String?
  sessionToken String?       @unique // Token for anonymous session ownership verification
  assignedToId String?
  assignedTo   User?         @relation("AssignedChats", fields: [assignedToId], references: [id])
  status       ChatStatus    @default(WAITING)
  startedAt    DateTime      @default(now())
  endedAt      DateTime?
  messages     ChatMessage[]
  metadata     Json?

  @@index([userId])
  @@index([assignedToId])
  @@index([status])
  @@map("live_chat_sessions")
}

model ChatMessage {
  id          String          @id @default(uuid())
  sessionId   String
  session     LiveChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  senderId    String?
  sender      User?           @relation(fields: [senderId], references: [id])
  message     String          @db.Text
  isFromStaff Boolean         @default(false)
  isSystem    Boolean         @default(false)
  createdAt   DateTime        @default(now())

  @@index([sessionId])
  @@index([senderId])
  @@map("chat_messages")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_CUSTOMER
  WAITING_FOR_STAFF
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ChatStatus {
  WAITING
  ACTIVE
  ENDED
}

// ==================== Social Features ====================

model ProductShare {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  platform  String // facebook, twitter, whatsapp, email, etc.
  shareUrl  String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([userId])
  @@index([platform])
  @@map("product_shares")
}

model ReviewHelpful {
  id        String   @id @default(uuid())
  reviewId  String
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  isHelpful Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([userId])
  @@map("review_helpful")
}

model VendorFollow {
  id                  String   @id @default(uuid())
  userId              String
  user                User     @relation("UserFollowing", fields: [userId], references: [id])
  vendorId            String
  vendor              User     @relation("VendorFollowers", fields: [vendorId], references: [id])
  notifyOnNewProducts Boolean  @default(true)
  notifyOnDeals       Boolean  @default(true)
  createdAt           DateTime @default(now())

  @@unique([userId, vendorId])
  @@index([userId])
  @@index([vendorId])
  @@map("vendor_follows")
}

model ActivityFeed {
  id           String           @id @default(uuid())
  userId       String?
  user         User?            @relation(fields: [userId], references: [id])
  activityType ActivityFeedType
  title        String
  description  String?
  metadata     Json?
  imageUrl     String?
  linkUrl      String?
  isPublic     Boolean          @default(true)
  createdAt    DateTime         @default(now())

  @@index([userId])
  @@index([activityType])
  @@index([createdAt])
  @@map("activity_feed")
}

model UserInteraction {
  id              String          @id @default(uuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  targetType      InteractionType
  targetId        String
  interactionType String // like, comment, share, view, etc.
  metadata        Json?
  createdAt       DateTime        @default(now())

  @@index([userId])
  @@index([targetType, targetId])
  @@index([interactionType])
  @@map("user_interactions")
}

model SocialComment {
  id         String          @id @default(uuid())
  userId     String
  user       User            @relation(fields: [userId], references: [id])
  targetType String // product, review, article, etc.
  targetId   String
  comment    String          @db.Text
  parentId   String?
  parent     SocialComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies    SocialComment[] @relation("CommentReplies")
  likesCount Int             @default(0)
  isApproved Boolean         @default(true)
  isHidden   Boolean         @default(false)
  metadata   Json?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  @@index([userId])
  @@index([targetType, targetId])
  @@index([parentId])
  @@map("social_comments")
}

model UserBadge {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  badgeType   String
  title       String
  description String?
  iconUrl     String?
  earnedAt    DateTime @default(now())

  @@index([userId])
  @@index([badgeType])
  @@map("user_badges")
}

enum ActivityFeedType {
  PRODUCT_PURCHASE
  REVIEW_POSTED
  VENDOR_FOLLOWED
  WISHLIST_SHARED
  ACHIEVEMENT_EARNED
  PRODUCT_SHARED
}

enum InteractionType {
  PRODUCT
  REVIEW
  VENDOR
  ARTICLE
  USER
}

// ==================== Advanced Analytics & Reporting ====================

model SalesReport {
  id                 String     @id @default(uuid())
  reportDate         DateTime
  reportType         ReportType
  totalRevenue       Float      @default(0)
  totalOrders        Int        @default(0)
  totalItems         Int        @default(0)
  averageOrderValue  Float      @default(0)
  newCustomers       Int        @default(0)
  returningCustomers Int        @default(0)
  conversionRate     Float      @default(0)
  metadata           Json?
  createdAt          DateTime   @default(now())

  @@unique([reportDate, reportType])
  @@index([reportDate])
  @@index([reportType])
  @@map("sales_reports")
}

model RevenueMetric {
  id             String       @id @default(uuid())
  metricDate     DateTime
  period         MetricPeriod
  revenue        Float        @default(0)
  grossProfit    Float        @default(0)
  netProfit      Float        @default(0)
  refunds        Float        @default(0)
  discounts      Float        @default(0)
  taxes          Float        @default(0)
  shipping       Float        @default(0)
  productCosts   Float        @default(0)
  operatingCosts Float        @default(0)
  metadata       Json?
  createdAt      DateTime     @default(now())

  @@unique([metricDate, period])
  @@index([metricDate])
  @@index([period])
  @@map("revenue_metrics")
}

model CustomerInsight {
  id                 String    @id @default(uuid())
  userId             String    @unique
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  totalOrders        Int       @default(0)
  totalSpent         Float     @default(0)
  averageOrderValue  Float     @default(0)
  lifetimeValue      Float     @default(0)
  firstOrderDate     DateTime?
  lastOrderDate      DateTime?
  daysSinceLastOrder Int?
  orderFrequency     Float     @default(0)
  favoriteCategory   String?
  favoriteVendor     String?
  riskScore          Int       @default(0)
  customerSegment    String?
  churnProbability   Float     @default(0)
  loyaltyTier        String?
  metadata           Json?
  updatedAt          DateTime  @updatedAt

  @@index([userId])
  @@index([customerSegment])
  @@index([loyaltyTier])
  @@map("customer_insights")
}

model ProductPerformance {
  id                String   @id @default(uuid())
  productId         String   @unique
  product           Product  @relation(fields: [productId], references: [id])
  totalViews        Int      @default(0)
  totalClicks       Int      @default(0)
  totalAddToCart    Int      @default(0)
  totalPurchases    Int      @default(0)
  totalRevenue      Float    @default(0)
  conversionRate    Float    @default(0)
  averageRating     Float    @default(0)
  totalReviews      Int      @default(0)
  returnRate        Float    @default(0)
  shareCount        Int      @default(0)
  wishlistCount     Int      @default(0)
  inventoryTurnover Float    @default(0)
  profitMargin      Float    @default(0)
  trend             String? // trending_up, trending_down, stable
  metadata          Json?
  updatedAt         DateTime @updatedAt

  @@index([productId])
  @@index([trend])
  @@map("product_performance")
}

model ConversionFunnel {
  id                     String       @id @default(uuid())
  funnelDate             DateTime
  period                 MetricPeriod
  visitors               Int          @default(0)
  productViews           Int          @default(0)
  addToCart              Int          @default(0)
  checkoutStarted        Int          @default(0)
  purchaseCompleted      Int          @default(0)
  visitToViewRate        Float        @default(0)
  viewToCartRate         Float        @default(0)
  cartToCheckoutRate     Float        @default(0)
  checkoutToPurchaseRate Float        @default(0)
  overallConversionRate  Float        @default(0)
  metadata               Json?
  createdAt              DateTime     @default(now())

  @@unique([funnelDate, period])
  @@index([funnelDate])
  @@index([period])
  @@map("conversion_funnels")
}

model DashboardWidget {
  id            String   @id @default(uuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  widgetType    String
  title         String
  configuration Json
  position      Int      @default(0)
  isActive      Boolean  @default(true)
  isPublic      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([widgetType])
  @@map("dashboard_widgets")
}

model PerformanceSnapshot {
  id           String   @id @default(uuid())
  snapshotDate DateTime
  entityType   String // product, category, vendor, overall
  entityId     String?
  metrics      Json
  createdAt    DateTime @default(now())

  @@index([snapshotDate])
  @@index([entityType, entityId])
  @@map("performance_snapshots")
}

enum ReportType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

enum MetricPeriod {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

// ==================== Mobile App API Enhancements ====================

model PushNotificationToken {
  id         String         @id @default(uuid())
  userId     String
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId   String
  platform   DevicePlatform
  token      String
  endpoint   String?
  isActive   Boolean        @default(true)
  lastUsedAt DateTime       @default(now())
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@unique([userId, deviceId])
  @@index([userId])
  @@index([token])
  @@map("push_notification_tokens")
}

model MobileNotification {
  id             String               @id @default(uuid())
  userId         String?
  user           User?                @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String
  body           String
  data           Json?
  imageUrl       String?
  actionUrl      String?
  category       NotificationCategory
  priority       NotificationPriority @default(NORMAL)
  badge          Int?
  sound          String?
  isSent         Boolean              @default(false)
  sentAt         DateTime?
  isRead         Boolean              @default(false)
  readAt         DateTime?
  deliveryStatus String?
  failureReason  String?
  createdAt      DateTime             @default(now())

  @@index([userId])
  @@index([category])
  @@index([isSent])
  @@map("mobile_notifications")
}

model MobileSession {
  id             String         @id @default(uuid())
  userId         String
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId       String
  deviceName     String?
  deviceModel    String?
  platform       DevicePlatform
  appVersion     String?
  osVersion      String?
  sessionToken   String         @unique
  isActive       Boolean        @default(true)
  lastActivityAt DateTime       @default(now())
  ipAddress      String?
  location       Json?
  createdAt      DateTime       @default(now())
  expiresAt      DateTime

  @@index([userId])
  @@index([deviceId])
  @@index([sessionToken])
  @@map("mobile_sessions")
}

model OfflineSyncQueue {
  id           String     @id @default(uuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId     String
  action       String
  entityType   String
  entityId     String?
  payload      Json
  status       SyncStatus @default(PENDING)
  retryCount   Int        @default(0)
  processedAt  DateTime?
  errorMessage String?
  createdAt    DateTime   @default(now())

  @@index([userId])
  @@index([deviceId])
  @@index([status])
  @@map("offline_sync_queue")
}

model DeepLink {
  id            String    @id @default(uuid())
  linkId        String    @unique
  targetType    String
  targetId      String?
  campaign      String?
  source        String?
  medium        String?
  metadata      Json?
  clickCount    Int       @default(0)
  lastClickedAt DateTime?
  createdAt     DateTime  @default(now())
  expiresAt     DateTime?

  @@index([linkId])
  @@index([targetType, targetId])
  @@map("deep_links")
}

model AppConfig {
  id          String          @id @default(uuid())
  key         String          @unique
  value       Json
  platform    DevicePlatform?
  minVersion  String?
  maxVersion  String?
  isActive    Boolean         @default(true)
  description String?
  updatedAt   DateTime        @updatedAt
  createdAt   DateTime        @default(now())

  @@index([key])
  @@index([platform])
  @@map("app_configs")
}

enum DevicePlatform {
  IOS
  ANDROID
  WEB
  DESKTOP
}

enum NotificationCategory {
  ORDER_UPDATE
  SHIPPING
  PROMOTION
  PRICE_DROP
  BACK_IN_STOCK
  REVIEW_REQUEST
  LOYALTY_REWARD
  GENERAL
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model SeoMeta {
  id             String   @id @default(uuid())
  entityType     String
  entityId       String
  title          String?
  description    String?  @db.Text
  keywords       String[]
  ogTitle        String?
  ogDescription  String?  @db.Text
  ogImage        String?
  canonical      String?
  robots         String?
  structuredData Json?
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())

  @@unique([entityType, entityId])
  @@index([entityType, entityId])
  @@map("seo_meta")
}

model Sitemap {
  id         String   @id @default(uuid())
  url        String
  changeFreq String   @default("weekly")
  priority   Float    @default(0.5)
  lastMod    DateTime @default(now())
  entityType String?
  entityId   String?

  @@index([url])
  @@index([entityType, entityId])
  @@map("sitemaps")
}

// ==================== Marketplace, Loyalty, Infrastructure ====================

model VendorCommission {
  id        String    @id @default(uuid())
  vendorId  String
  orderId   String
  amount    Float
  rate      Float
  status    String    @default("PENDING")
  paidAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([vendorId])
  @@index([orderId])
  @@map("vendor_commissions")
}

model CacheConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  ttl       Int
  isActive  Boolean  @default(true)
  updatedAt DateTime @updatedAt

  @@map("cache_configs")
}

model RateLimit {
  id          String   @id @default(uuid())
  endpoint    String
  maxRequests Int
  windowMs    Int
  isActive    Boolean  @default(true)
  updatedAt   DateTime @updatedAt

  @@index([endpoint])
  @@map("rate_limits")
}

// ==================== Bulk Upload ====================

model BulkUploadJob {
  id                String        @id @default(uuid())
  vendorId          String
  vendor            VendorProfile @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  fileName          String
  status            String        @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  totalRows         Int           @default(0)
  processedRows     Int           @default(0)
  successCount      Int           @default(0)
  errorCount        Int           @default(0)
  errors            Json          @default("[]")
  createdProductIds Json          @default("[]")
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  completedAt       DateTime?

  @@index([vendorId])
  @@index([status])
  @@index([createdAt])
  @@map("bulk_upload_jobs")
}

// ==================== Featured Listings ====================

model FeaturedListing {
  id            String           @id @default(uuid())
  productId     String
  product       Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  vendorId      String
  vendor        VendorProfile    @relation(fields: [vendorId], references: [id])
  position      FeaturedPosition
  priority      Int              @default(0)
  startDate     DateTime
  endDate       DateTime
  cost          Float
  status        FeaturedStatus   @default(PENDING)
  impressions   Int              @default(0)
  clicks        Int              @default(0)
  paymentId     String?
  paymentStatus String? // paid, pending, refunded
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([productId])
  @@index([vendorId])
  @@index([position])
  @@index([status])
  @@index([startDate, endDate])
  @@map("featured_listings")
}

model FeaturedSlot {
  id          String           @id @default(uuid())
  position    FeaturedPosition
  categoryId  String?
  category    Category?        @relation(fields: [categoryId], references: [id])
  maxListings Int              @default(10)
  dailyRate   Float
  weeklyRate  Float
  monthlyRate Float
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([position, categoryId])
  @@index([position])
  @@index([categoryId])
  @@map("featured_slots")
}

enum FeaturedPosition {
  HOME_BANNER
  HOME_FEATURED
  CATEGORY_TOP
  SEARCH_PROMOTED
  SIDEBAR
}

enum FeaturedStatus {
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}

// ============================================
// Privacy and Consent Tracking Models
// GDPR/CCPA Compliance
// ============================================

// Consent Log - Track user consent for GDPR Article 7
model ConsentLog {
  id     String @id @default(uuid())
  userId String

  // Consent Categories
  dataProcessing    Boolean @default(true) // Required for account functionality
  marketing         Boolean @default(false) // Marketing communications
  analytics         Boolean @default(false) // Analytics and tracking
  thirdPartySharing Boolean @default(false) // Sharing data with third parties
  cookies           Boolean @default(false) // Cookie consent

  // Audit Trail
  ipAddress String?
  userAgent String?
  version   String  @default("1.0") // Privacy policy version

  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@map("consent_logs")
}

// Data Deletion Requests - Track GDPR Article 17 / CCPA Section 1798.105 requests
model DataDeletionRequest {
  id     String @id @default(uuid())
  userId String

  // Deletion Details
  strategy      DeletionStrategy // SOFT_DELETE, HARD_DELETE, ANONYMIZE
  reason        String?
  status        DeletionStatus   @default(PENDING)
  scheduledDate DateTime
  completedAt   DateTime?

  // Cancellation Grace Period
  cancellationDeadline DateTime

  // Audit Trail
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([scheduledDate])
  @@index([userId, status])
  @@map("data_deletion_requests")
}

// Agreed Terms - Track which version of terms/privacy policy user agreed to
model AgreedTerms {
  id     String @id @default(uuid())
  userId String

  // Document Versions
  termsVersion         String
  privacyPolicyVersion String
  cookiePolicyVersion  String?

  // Audit Trail
  ipAddress String?
  userAgent String?
  agreedAt  DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([agreedAt])
  @@index([userId, agreedAt])
  @@map("agreed_terms")
}

// Enums for Privacy Models
enum DeletionStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FAILED
}

enum DeletionStrategy {
  SOFT_DELETE
  HARD_DELETE
  ANONYMIZE
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

// ==================== ORGANIZATION MODULE ENUMS ====================

enum OrganizationType {
  INDIVIDUAL
  SMALL_BUSINESS
  ENTERPRISE
  MARKETPLACE
}

enum OrganizationStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum MemberStatus {
  INVITED
  ACTIVE
  SUSPENDED
  REMOVED
}

enum KycStatus {
  NOT_STARTED
  DOCUMENTS_SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

// ==================== ORGANIZATION MODULE MODELS ====================

// Core Organization Model
model Organization {
  id     String             @id @default(uuid())
  name   String
  slug   String             @unique
  type   OrganizationType   @default(SMALL_BUSINESS)
  status OrganizationStatus @default(PENDING_VERIFICATION)

  // Business Details
  legalName          String?
  registrationNumber String?
  taxId              String? // Encrypted
  industry           String?
  website            String?

  // Contact
  primaryEmail String
  primaryPhone String?
  address      Json? // {street, city, state, zip, country}

  // Branding
  logoUrl      String?
  bannerUrl    String?
  primaryColor String?
  description  String?

  // Settings
  settings Json? // Organization-wide settings
  features String[] // Enabled features

  // Billing
  billingEmail     String?
  billingAddress   Json?
  stripeCustomerId String?
  subscriptionTier String  @default("free")

  // Limits
  maxTeamMembers Int @default(5)
  maxProducts    Int @default(100)
  maxApiCalls    Int @default(10000)

  // Dates
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  // Owner relation - will be added after checking User model
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Relations
  members             OrganizationMember[]
  departments         Department[]
  teams               Team[]
  roles               OrganizationRole[]
  kycApplications     KycApplication[]
  auditLogs           OrganizationAuditLog[]
  invitations         OrganizationInvitation[]
  apiKeys             OrganizationApiKey[]
  billing             OrganizationBilling?
  marketingCampaigns  MarketingCampaign[]
  landingPages        LandingPage[]
  aBMAccounts         ABMAccount[]
  offices             Office[]                 @relation("OfficeOrganization")
  rfqs                RFQ[]                    @relation("RFQOrganization")
  enterpriseContracts EnterpriseContract[]     @relation("EnterpriseContractOrg")

  // Multi-tenant marketplace relations
  tenantDomains       TenantDomain[]
  tenantLocales       TenantLocale[]
  tenantCurrencies    TenantCurrency[]
  tenantGeoRules      TenantGeoRule[]
  tenantProducts      Product[]            @relation("TenantProducts")

  // Product integration connectors
  connectorConfigs    ConnectorConfig[]

  @@index([slug])
  @@index([status])
  @@index([ownerId])
  @@map("organizations")
}

// Organization Membership
model OrganizationMember {
  id             String       @id @default(uuid())
  organizationId String
  userId         String
  status         MemberStatus @default(ACTIVE)

  // Role Assignment
  roleId       String?
  departmentId String?
  teamId       String?

  // Metadata
  title        String? // Job title
  joinedAt     DateTime  @default(now())
  invitedBy    String?
  lastActiveAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         OrganizationRole? @relation(fields: [roleId], references: [id])
  department   Department?       @relation(fields: [departmentId], references: [id])
  team         Team?             @relation(fields: [teamId], references: [id])

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([roleId])
  @@map("organization_members")
}

// Department within Organization
model Department {
  id             String  @id @default(uuid())
  organizationId String
  name           String
  description    String?
  parentId       String?
  level          Int     @default(0)

  headId String? // Department head user ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       Department?          @relation("DeptHierarchy", fields: [parentId], references: [id])
  children     Department[]         @relation("DeptHierarchy")
  members      OrganizationMember[]
  teams        Team[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([parentId])
  @@map("departments")
}

// Team within Department/Organization
model Team {
  id             String  @id @default(uuid())
  organizationId String
  departmentId   String?
  name           String
  description    String?

  leadId String? // Team lead user ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department   Department?          @relation(fields: [departmentId], references: [id])
  members      OrganizationMember[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([departmentId])
  @@map("teams")
}

// Role Definition
model OrganizationRole {
  id             String  @id @default(uuid())
  organizationId String? // null = system role
  name           String
  description    String?
  isSystem       Boolean @default(false)
  isDefault      Boolean @default(false)

  // Permission set
  permissions String[] // Array of permission codes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization?        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      OrganizationMember[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([isSystem])
  @@map("organization_roles")
}

// Permission Registry
model Permission {
  id          String  @id @default(uuid())
  code        String  @unique // e.g., "org:read", "products:write"
  name        String
  description String?
  category    String // e.g., "organization", "products", "orders"

  createdAt DateTime @default(now())

  @@index([category])
  @@map("permissions")
}

// KYC Application
model KycApplication {
  id             String    @id @default(uuid())
  organizationId String
  status         KycStatus @default(NOT_STARTED)

  // Document Types
  idType        String? // passport, drivers_license, national_id
  idDocumentUrl String? // Encrypted URL
  idVerified    Boolean @default(false)

  addressDocumentUrl String?
  addressVerified    Boolean @default(false)

  businessDocUrl   String?
  businessVerified Boolean @default(false)

  // Verification Results
  verificationScore Float?
  verificationData  Json? // AI analysis results

  // Review
  reviewerId      String?
  reviewNotes     String?
  rejectionReason String?

  submittedAt DateTime?
  reviewedAt  DateTime?
  expiresAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@map("kyc_applications")
}

// Organization Invitation
model OrganizationInvitation {
  id             String  @id @default(uuid())
  organizationId String
  email          String
  roleId         String?
  departmentId   String?
  teamId         String?

  token  String @unique
  status String @default("pending") // pending, accepted, expired, cancelled

  invitedById String
  message     String?

  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@map("organization_invitations")
}

// Organization API Keys
model OrganizationApiKey {
  id             String @id @default(uuid())
  organizationId String
  name           String
  keyHash        String // Hashed API key
  keyPrefix      String // First 8 chars for identification

  permissions String[] // Scoped permissions
  rateLimit   Int      @default(1000)

  lastUsedAt DateTime?
  expiresAt  DateTime?
  revokedAt  DateTime?

  createdById String
  createdAt   DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([keyPrefix])
  @@map("organization_api_keys")
}

// Organization Audit Log
model OrganizationAuditLog {
  id             String  @id @default(uuid())
  organizationId String
  userId         String?

  action     String // e.g., "member.invited", "role.changed"
  resource   String // e.g., "organization", "team", "member"
  resourceId String?

  oldValue Json?
  newValue Json?
  metadata Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("organization_audit_logs")
}

// Organization Billing
model OrganizationBilling {
  id             String @id @default(uuid())
  organizationId String @unique

  // Stripe
  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Plan
  planId       String @default("free")
  planName     String @default("Free")
  billingCycle String @default("monthly") // monthly, yearly

  // Status
  status             String    @default("active") // active, past_due, cancelled
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?

  // Payment Method
  paymentMethodId    String?
  paymentMethodLast4 String?
  paymentMethodBrand String?

  // Balance
  balance       Float @default(0)
  creditBalance Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices     OrganizationInvoice[]

  @@map("organization_billing")
}

// Organization Invoice
model OrganizationInvoice {
  id        String @id @default(uuid())
  billingId String

  stripeInvoiceId String?
  number          String  @unique

  amount   Float
  currency String @default("USD")
  status   String // draft, open, paid, void, uncollectible

  description String?
  lineItems   Json?

  dueDate DateTime?
  paidAt  DateTime?

  pdfUrl String?

  createdAt DateTime @default(now())

  // Relations
  billing OrganizationBilling @relation(fields: [billingId], references: [id], onDelete: Cascade)

  @@index([billingId])
  @@index([status])
  @@map("organization_invoices")
}

// ==================== ESCROW & MILESTONE MODELS ====================

// Escrow Account for B2B Transactions
model EscrowAccount {
  id      String @id @default(uuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  buyerId String
  buyer   User   @relation("EscrowBuyer", fields: [buyerId], references: [id], onDelete: Cascade)

  sellerId String
  seller   User   @relation("EscrowSeller", fields: [sellerId], references: [id], onDelete: Cascade)

  amount   Float
  currency String @default("USD")
  status   String @default("PENDING") // PENDING, FUNDED, IN_PROGRESS, RELEASED, REFUNDED, DISPUTED

  fundedAmount   Float? @default(0)
  releasedAmount Float? @default(0)

  milestones Json? // Stored as JSON array
  fees       Float?

  fundedAt    DateTime?
  releasedAt  DateTime?
  completedAt DateTime?
  refundedAt  DateTime?

  paymentReference String?
  releasedBy       String?
  refundReason     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  disputes EscrowDispute[]

  @@index([orderId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@map("escrow_accounts")
}

// Escrow Dispute
model EscrowDispute {
  id       String        @id @default(uuid())
  escrowId String
  escrow   EscrowAccount @relation(fields: [escrowId], references: [id], onDelete: Cascade)

  initiatedBy String // 'BUYER' or 'SELLER'
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  reason   String
  details  String
  evidence Json? // Array of evidence
  status   String @default("OPEN") // OPEN, INVESTIGATING, RESOLVED, ESCALATED

  resolution      String?
  resolutionNotes String?
  resolvedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([escrowId])
  @@index([userId])
  @@index([status])
  @@map("escrow_disputes")
}

// Escrow for milestone-based payments
model Escrow {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  buyerId String
  buyer   User   @relation("MilestoneEscrowBuyer", fields: [buyerId], references: [id], onDelete: Cascade)

  sellerId String
  seller   User   @relation("MilestoneEscrowSeller", fields: [sellerId], references: [id], onDelete: Cascade)

  totalAmount    Float
  currency       String @default("USD")
  fundedAmount   Float  @default(0)
  releasedAmount Float  @default(0)

  status String @default("PENDING") // PENDING, FUNDED, MILESTONE_COMPLETED, RELEASED, DISPUTED, REFUNDED, CANCELLED

  automaticRelease   Boolean @default(false)
  releaseDelay       Int     @default(3) // Days
  termsAndConditions String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  milestones   Milestone[]
  transactions EscrowTransaction[]
  dispute      EscrowMilestoneDispute?

  @@index([orderId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@map("escrows")
}

// Milestone for Escrow
model Milestone {
  id       String @id @default(uuid())
  escrowId String
  escrow   Escrow @relation(fields: [escrowId], references: [id], onDelete: Cascade)

  name        String
  description String
  amount      Float
  status      String @default("PENDING") // PENDING, IN_PROGRESS, SUBMITTED, APPROVED, REJECTED, PAID

  sequenceNumber Int

  dueDate      DateTime?
  deliverables String[]

  submittedAt     DateTime?
  submissionNotes String?

  approvedAt    DateTime?
  approvalNotes String?

  rejectedAt      DateTime?
  rejectionReason String?

  paidAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([escrowId])
  @@index([status])
  @@index([sequenceNumber])
  @@map("milestones")
}

// Escrow Transaction
model EscrowTransaction {
  id       String @id @default(uuid())
  escrowId String
  escrow   Escrow @relation(fields: [escrowId], references: [id], onDelete: Cascade)

  type          String // FUNDING, RELEASE, REFUND
  amount        Float
  transactionId String?
  milestoneId   String?
  description   String?

  createdAt DateTime @default(now())

  @@index([escrowId])
  @@index([type])
  @@map("escrow_transactions")
}

// Escrow Milestone Dispute
model EscrowMilestoneDispute {
  id       String @id @default(uuid())
  escrowId String @unique
  escrow   Escrow @relation(fields: [escrowId], references: [id], onDelete: Cascade)

  initiatedBy String
  reason      String
  evidence    String[]
  status      String   @default("OPEN") // OPEN, RESOLVED, ESCALATED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@map("escrow_milestone_disputes")
}

// ============================================
// ANALYTICS SYSTEM
// ============================================

model AnalyticsEvent {
  id             String  @id @default(uuid())
  eventType      String
  eventCategory  String?
  userId         String?
  sessionId      String
  organizationId String?

  // Event metadata
  metadata   Json?
  properties Json?

  // Context
  ipAddress String?
  userAgent String?
  referer   String?
  page      String?

  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@index([sessionId])
  @@index([organizationId])
  @@index([timestamp])
  @@index([createdAt])
  @@map("analytics_events")
}

// ============================================
// CROSS-BORDER TRADE MODELS
// ============================================

model CategoryRestriction {
  id                 String  @id @default(uuid())
  categoryId         String
  originCountry      String
  destinationCountry String
  country            String? // Additional country field (nullable)
  restrictionType    String // PROHIBITED, RESTRICTED, REQUIRES_LICENSE
  description        String?
  requiresLicense    Boolean @default(false)
  licenseType        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([originCountry])
  @@index([destinationCountry])
  @@index([country])
  @@map("category_restrictions")
}

model ComplianceCheck {
  id                 String  @id @default(uuid())
  productId          String?
  originCountry      String
  destinationCountry String
  hsCode             String?
  result             String // APPROVED, RESTRICTED, PROHIBITED, REQUIRES_LICENSE
  restrictions       Json?
  licenses           Json?

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([result])
  @@index([createdAt])
  @@map("compliance_checks")
}

model SanctionCheck {
  id           String @id @default(uuid())
  entityName   String
  country      String
  entityType   String // INDIVIDUAL, ORGANIZATION
  result       String // CLEAR, MATCH, POTENTIAL_MATCH
  matchedLists Json?
  riskScore    Float  @default(0)

  createdAt DateTime @default(now())

  @@index([entityName])
  @@index([country])
  @@index([result])
  @@index([createdAt])
  @@map("sanction_checks")
}

model HSCode {
  id          String  @id @default(uuid())
  code        String  @unique
  description String
  chapter     String
  section     String?
  dutyRate    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([chapter])
  @@map("hs_codes")
}

model HSCodeRestriction {
  id              String  @id @default(uuid())
  hsCode          String
  country         String
  restrictionType String // PROHIBITED, RESTRICTED, REQUIRES_LICENSE
  description     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hsCode])
  @@index([country])
  @@map("hs_code_restrictions")
}

model TradeLicense {
  id               String   @id @default(uuid())
  organizationId   String
  licenseType      String
  licenseNumber    String   @unique
  issuingAuthority String
  issuedDate       DateTime
  expiryDate       DateTime
  country          String? // Primary country for this license
  countries        String[] // Countries where valid
  status           String   @default("ACTIVE") // ACTIVE, EXPIRED, REVOKED
  documentUrl      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([licenseNumber])
  @@index([status])
  @@index([expiryDate])
  @@map("trade_licenses")
}

model CustomsCalculation {
  id                 String @id @default(uuid())
  hsCode             String
  originCountry      String
  destinationCountry String
  productValue       Float
  currency           String @default("USD")

  // Calculated amounts
  duties    Float
  taxes     Float
  fees      Float
  totalCost Float

  createdAt DateTime @default(now())

  @@index([hsCode])
  @@index([destinationCountry])
  @@index([createdAt])
  @@map("customs_calculations")
}

model CustomsDeclaration {
  id                 String  @id @default(uuid())
  orderId            String?
  shipmentId         String?
  declarationType    String? // EXPORT, IMPORT
  hsCode             String?
  description        String?
  quantity           Int?
  value              Float?
  currency           String  @default("USD")
  originCountry      String?
  destinationCountry String?

  // Declaration details
  declarationNumber String?
  declarationDate   DateTime?
  status            String    @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED, GENERATED
  data              Json? // Additional declaration data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([shipmentId])
  @@index([status])
  @@index([declarationNumber])
  @@map("customs_declarations")
}

// ============================================
// CURRENCY & EXCHANGE MODELS
// ============================================

model ExchangeRate {
  id           String @id @default(uuid())
  fromCurrency String
  toCurrency   String
  rate         Float
  source       String // MARKET, MANUAL, API

  createdAt DateTime @default(now())

  @@index([fromCurrency, toCurrency])
  @@index([createdAt])
  @@map("exchange_rates")
}

model CurrencyConversion {
  id             String  @id @default(uuid())
  userId         String?
  organizationId String?

  amount          Float
  fromCurrency    String
  toCurrency      String
  exchangeRate    Float
  convertedAmount Float
  fees            Float  @default(0)

  // Transaction reference
  orderId         String?
  transactionType String? // ORDER, PAYOUT, REFUND

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([orderId])
  @@index([createdAt])
  @@map("currency_conversions")
}

model CurrencyHedge {
  id             String  @id @default(uuid())
  organizationId String?

  fromCurrency String
  toCurrency   String
  amount       Float
  lockedRate   Float?
  currentRate  Float? // Current exchange rate
  targetRate   Float? // Target exchange rate for the hedge
  expiryDate   DateTime?
  status       String    @default("ACTIVE") // ACTIVE, EXPIRED, EXERCISED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([expiryDate])
  @@map("currency_hedges")
}

// ============================================
// GROWTH & MARKETING MODELS
// ============================================

model ChurnRisk {
  id     String @id @default(uuid())
  userId String @unique

  riskScore  Float // 0-100
  riskLevel  String // LOW, MEDIUM, HIGH
  factors    Json? // Contributing factors
  assessedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation("UserChurnRisk", fields: [userId], references: [id], onDelete: Cascade)

  @@index([riskLevel])
  @@index([assessedAt])
  @@map("churn_risks")
}

model LeadScore {
  id     String @id @default(uuid())
  userId String @unique

  score   Float // 0-100
  tier    String // HOT, WARM, COLD
  factors Json? // Scoring factors

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tier])
  @@index([score])
  @@map("lead_scores")
}

model ReferralProgram {
  id             String  @id @default(uuid())
  organizationId String?

  name        String
  description String?
  active      Boolean @default(true)

  // Rewards
  referrerReward   Float
  refereeReward    Float
  rewardType       String // CREDIT, DISCOUNT, POINTS
  requirementType  String? // Type of requirement to fulfill
  requirementValue Float? // Value for the requirement

  // Conditions
  minPurchaseAmount Float?
  maxRedemptions    Int?
  validFrom         DateTime?
  validUntil        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  referralCodes ReferralCode[]
  referrals     Referral[]     @relation("ReferralProgram")

  @@index([active])
  @@map("referral_programs")
}

model ReferralCode {
  id        String @id @default(uuid())
  programId String
  userId    String

  code       String @unique
  usageCount Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  program ReferralProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([programId])
  @@map("referral_codes")
}

model LoyaltyPoints {
  id     String @id @default(uuid())
  userId String

  points Int     @default(0)
  tier   String? // BRONZE, SILVER, GOLD, PLATINUM
  source String? // Source of points (e.g., PURCHASE, REFERRAL, BONUS)

  // Transaction tracking
  totalEarned   Int @default(0)
  totalRedeemed Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([tier])
  @@map("loyalty_points")
}

model UserCredit {
  id     String @id @default(uuid())
  userId String @unique

  amount   Float   @default(0) // Current credit amount (alias for balance)
  balance  Float   @default(0)
  currency String  @default("USD")
  source   String? // Source of the credit

  // Tracking
  totalEarned Float @default(0)
  totalSpent  Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("user_credits")
}

model LandingPage {
  id             String  @id @default(uuid())
  organizationId String?
  campaignId     String?

  name        String
  slug        String  @unique
  title       String
  description String?
  template    String?

  // Content
  content      Json?
  primaryCTA   Json? // Call to action
  secondaryCTA Json?

  // SEO
  seoMetadata Json?
  tags        String[] @default([])

  // Settings
  status   String  @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  region   String?
  language String  @default("en")

  // Analytics
  analytics Json?
  metrics   Json? // Performance metrics

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  organization Organization?      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campaign     MarketingCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([campaignId])
  @@index([status])
  @@index([slug])
  @@map("landing_pages")
}

// ============================================
// EMAIL AUTOMATION MODELS
// ============================================

model EmailAutomationRule {
  id String @id @default(uuid())

  name            String
  trigger         String // SIGNUP, CART_ABANDON, PURCHASE, etc.
  conditions      Json?
  emailTemplateId String?
  delay           Int     @default(0) // Minutes to wait before sending
  enabled         Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  template EmailTemplate? @relation("EmailAutomationRuleTemplate", fields: [emailTemplateId], references: [id], onDelete: SetNull)

  @@index([trigger])
  @@index([enabled])
  @@index([emailTemplateId])
  @@map("email_automation_rules")
}

model EmailSequence {
  id String @id @default(uuid())

  name        String
  description String?
  trigger     String // What triggers the sequence
  steps       Json // Array of sequence steps
  enabled     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollments EmailSequenceEnrollment[]

  @@index([trigger])
  @@index([enabled])
  @@map("email_sequences")
}

model EmailSequenceEnrollment {
  id         String @id @default(uuid())
  sequenceId String
  userId     String

  currentStep    Int    @default(0)
  status         String @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  enrollmentData Json? // Additional enrollment data

  enrolledAt  DateTime  @default(now())
  completedAt DateTime?

  sequence EmailSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@index([sequenceId])
  @@index([userId])
  @@index([status])
  @@map("email_sequence_enrollments")
}

// ============================================
// ENTERPRISE MODELS
// ============================================

model EnterpriseContract {
  id             String  @id @default(uuid())
  organizationId String
  vendorId       String?

  title  String
  type   String // MSA, SLA, NDA, etc.
  status String @default("DRAFT") // DRAFT, ACTIVE, EXPIRED, TERMINATED
  terms  Json?

  // Dates
  startDate       DateTime
  endDate         DateTime
  autoRenew       Boolean  @default(false)
  renewalTermDays Int?

  // Financial
  value    Float?
  currency String @default("USD")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization   @relation("EnterpriseContractOrg", fields: [organizationId], references: [id], onDelete: Cascade)
  vendor       VendorProfile? @relation("EnterpriseContractVendor", fields: [vendorId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([vendorId])
  @@index([status])
  @@index([endDate])
  @@map("enterprise_contracts")
}

model Office {
  id             String @id @default(uuid())
  organizationId String

  name String
  code String // Unique office code within org
  type String // HEADQUARTERS, BRANCH, WAREHOUSE, etc.

  address        Json?
  contactInfo    Json?
  operatingHours Json?
  approvalRules  Json? // Approval rules for this office

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization  Organization     @relation("OfficeOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  transfersFrom OfficeTransfer[] @relation("TransferFrom")
  transfersTo   OfficeTransfer[] @relation("TransferTo")

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([type])
  @@index([isActive])
  @@map("offices")
}

model OfficeTransfer {
  id           String @id @default(uuid())
  fromOfficeId String
  toOfficeId   String

  items       Json // Items being transferred
  requestedBy String
  approvedBy  String?
  receivedBy  String? // Who received the transfer
  reason      String?
  status      String  @default("PENDING") // PENDING, IN_TRANSIT, COMPLETED, CANCELLED

  requestedAt DateTime  @default(now())
  approvedAt  DateTime?
  completedAt DateTime?
  deliveredAt DateTime? // When the transfer was delivered

  fromOffice Office @relation("TransferFrom", fields: [fromOfficeId], references: [id])
  toOffice   Office @relation("TransferTo", fields: [toOfficeId], references: [id])

  @@index([fromOfficeId])
  @@index([toOfficeId])
  @@index([status])
  @@map("office_transfers")
}

model Purchase {
  id             String  @id @default(uuid())
  officeId       String?
  organizationId String
  vendorId       String?

  purchaseOrderNumber String @unique
  status              String @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, RECEIVED, CANCELLED

  items    Json
  total    Float
  currency String @default("USD")

  requestedBy String
  approvedBy  String?

  date       DateTime  @default(now()) // Purchase date
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime?
  receivedAt DateTime?

  @@index([officeId])
  @@index([organizationId])
  @@index([vendorId])
  @@index([status])
  @@index([date])
  @@index([purchaseOrderNumber])
  @@map("purchases")
}

model Expense {
  id             String  @id @default(uuid())
  officeId       String?
  organizationId String

  category    String
  description String
  amount      Float
  currency    String @default("USD")

  submittedBy String
  approvedBy  String?
  status      String  @default("PENDING") // PENDING, APPROVED, REJECTED, PAID

  receiptUrl String?

  date       DateTime  @default(now()) // Expense date
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime?
  paidAt     DateTime?

  @@index([officeId])
  @@index([organizationId])
  @@index([status])
  @@index([category])
  @@index([date])
  @@map("expenses")
}

model RFQ {
  id             String @id @default(uuid())
  organizationId String

  title        String
  description  String
  requirements Json?
  items        Json

  status   String    @default("DRAFT") // DRAFT, PUBLISHED, CLOSED, AWARDED
  deadline DateTime?
  budget   Float?
  currency String    @default("USD")

  awardedResponseId  String? // ID of awarded response
  awardedAt          DateTime? // When the RFQ was awarded
  cancellationReason String? // Reason if cancelled

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  closedAt    DateTime?

  organization Organization  @relation("RFQOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  responses    RFQResponse[]

  @@index([organizationId])
  @@index([status])
  @@index([deadline])
  @@map("rfqs")
}

model RFQResponse {
  id       String @id @default(uuid())
  rfqId    String
  vendorId String

  proposal     Json
  quotedPrice  Float
  totalPrice   Float? // Total calculated price
  currency     String    @default("USD")
  deliveryTime Int? // Days
  items        Json? // Line items breakdown
  validUntil   DateTime? // Valid until date for the quote

  status String  @default("SUBMITTED") // SUBMITTED, UNDER_REVIEW, ACCEPTED, REJECTED
  notes  String?

  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rfq    RFQ           @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  vendor VendorProfile @relation("RFQResponseVendor", fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([rfqId])
  @@index([vendorId])
  @@index([status])
  @@map("rfq_responses")
}

// ============================================
// VENDOR MODEL (for category-vendor indexing)
// ============================================

model Vendor {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String?
  logoUrl     String?
  website     String?
  email       String?
  phone       String?
  address     Json?

  // Vendor Status
  status     String  @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED
  isVerified Boolean @default(false)
  isActive   Boolean @default(true)

  // Metrics
  rating        Float? @default(0)
  totalProducts Int    @default(0)
  totalSales    Float  @default(0)

  // Relations
  products Product[] @relation("VendorProducts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([isVerified])
  @@index([isActive])
  @@map("vendors")
}

// ============================================
// ENTERPRISE PAYMENT MODELS
// ============================================

model LetterOfCredit {
  id             String  @id @default(uuid())
  organizationId String?
  orderId        String?

  lcNumber       String? @unique
  issuingBank    String?
  advisingBank   String?
  confirmingBank String?
  beneficiary    String?
  applicant      String?

  amount   Float?
  currency String @default("USD")

  // LC Details
  type               String? // SIGHT, USANCE, REVOCABLE, IRREVOCABLE
  lcType             String? // SIGHT, USANCE, DEFERRED (alias for type)
  terms              Json?
  termsAndConditions String[] @default([])
  documents          String[] @default([]) // Required documents
  requiredDocuments  String[] @default([]) // Alias for documents
  presentedDocuments Json? // Documents presented for payment
  description        String?

  // Status and Dates
  status             String    @default("DRAFT") // DRAFT, ISSUED, CONFIRMED, AMENDED, EXPIRED, COMPLETED
  issueDate          DateTime?
  issuedAt           DateTime? // When LC was issued
  expiryDate         DateTime?
  shipmentDate       DateTime?
  presentationPeriod Int? // Days
  acceptedAt         DateTime? // When LC was accepted
  paidAt             DateTime? // When payment was made
  presentedAt        DateTime? // When documents were presented

  // Bank References
  issuingBankRef String?
  paymentRef     String?

  // Financial
  drawingAmount Float?
  balanceAmount Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([orderId])
  @@index([lcNumber])
  @@index([status])
  @@index([expiryDate])
  @@map("letters_of_credit")
}

model WireTransfer {
  id             String  @id @default(uuid())
  organizationId String?
  orderId        String?

  referenceNumber String? @unique
  transferNumber  String? @unique // Alternative transfer identifier

  // Sender/Recipient ID references (for service code)
  senderId    String?
  recipientId String?

  // Sender Details
  senderName      String?
  senderAccount   String?
  senderBank      String?
  senderBankSwift String?

  // Recipient Details
  recipientName      String?
  recipientAccount   String?
  recipientBank      String?
  recipientBankSwift String?

  // Transfer Details
  amount       Float
  currency     String  @default("USD")
  purpose      String?
  instructions String?
  network      String? // SWIFT, ACH, SEPA, BACS, WIRE
  reference    String? // User-provided reference

  // Fees and Charges
  fee              Float? @default(0) // Alias for transferFee
  transferFee      Float? @default(0)
  intermediaryFees Float? @default(0)

  // Status and Dates
  status           String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED, CANCELLED
  initiatedAt      DateTime  @default(now())
  completedAt      DateTime?
  estimatedArrival DateTime?

  // Tracking
  trackingNumber   String?
  confirmationCode String?

  // Relations
  statusHistory WireTransferStatusHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([orderId])
  @@index([referenceNumber])
  @@index([transferNumber])
  @@index([status])
  @@index([senderId])
  @@index([recipientId])
  @@map("wire_transfers")
}

model WireTransferStatusHistory {
  id             String       @id @default(uuid())
  wireTransferId String
  wireTransfer   WireTransfer @relation(fields: [wireTransferId], references: [id], onDelete: Cascade)

  status String
  notes  String?

  createdAt DateTime @default(now())

  @@index([wireTransferId])
  @@index([createdAt])
  @@map("wire_transfer_status_history")
}

model InvoiceFinancing {
  id             String  @id @default(uuid())
  organizationId String?
  invoiceId      String?

  // Invoice Details
  invoiceNumber String?
  invoiceAmount Float?
  currency      String    @default("USD")
  invoiceDate   DateTime?
  dueDate       DateTime?

  // Financing Details
  advanceRate     Float? // Percentage (e.g., 80 = 80%)
  advanceAmount   Float? // Amount financed
  fee             Float? // Financing fee
  feePercentage   Float? // Fee as percentage
  requestedAmount Float? // Amount requested by supplier
  approvedAmount  Float? // Amount approved for financing
  discountFee     Float? // Discount fee calculated
  netAmount       Float? // Net amount after fees
  paymentTerms    Int? // Payment terms in days
  financingType   String? // FACTORING, DISCOUNTING, SUPPLY_CHAIN
  referenceNumber String? @unique

  // Parties
  buyerId     String?
  supplierId  String?
  financierId String?

  // Status and Dates
  status          String    @default("PENDING") // PENDING, APPROVED, ADVANCED, REPAID, DEFAULTED
  applicationDate DateTime  @default(now())
  approvalDate    DateTime?
  approvedAt      DateTime? // Alias for approvalDate
  advanceDate     DateTime?
  fundedAt        DateTime? // When funds were disbursed
  repaymentDate   DateTime?
  repaidAt        DateTime? // When fully repaid

  // Transaction References
  disbursementTransactionId String?
  repaymentTransactionId    String?

  // Repayment
  repaidAmount     Float? @default(0)
  remainingBalance Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([invoiceId])
  @@index([invoiceNumber])
  @@index([referenceNumber])
  @@index([status])
  @@index([dueDate])
  @@map("invoice_financing")
}

// ============================================
// INVENTORY MODEL
// ============================================

model Inventory {
  id         String  @id @default(uuid())
  productId  String
  locationId String? // Office/warehouse ID
  officeId   String? // Office ID (alias for locationId)

  quantity          Int @default(0)
  reservedQuantity  Int @default(0)
  availableQuantity Int @default(0)

  reorderPoint    Int?
  reorderQuantity Int?

  lastRestocked DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, locationId])
  @@unique([officeId, productId])
  @@index([productId])
  @@index([locationId])
  @@index([officeId])
  @@index([availableQuantity])
  @@map("inventory")
}

// ============================================
// PHONE VERIFICATION SYSTEM
// ============================================

model PhoneVerificationCode {
  id          String   @id @default(uuid())
  userId      String
  phoneNumber String
  code        String // 6-digit verification code
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  verified    Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([phoneNumber])
  @@index([code])
  @@index([expiresAt])
  @@map("phone_verification_codes")
}

// ============================================
// BILLING AUDIT TRAIL SYSTEM
// ============================================

model BillingAuditLog {
  id                 String    @id @default(uuid())
  eventType          String    // charge.created, charge.captured, refund.initiated, etc.
  orderId            String
  chargeId           String?
  amount             Decimal   @db.Decimal(10, 2)
  currency           String    @default("USD")

  // Actor information (who triggered the event)
  actor              Json?     // { type, id, email, ipAddress, userAgent, source }

  // Fee calculation breakdown
  feeCalculation     Json?     // { baseAmount, taxAmount, shippingAmount, handlingFee, platformFee, discountAmount, totalAmount, taxBreakdown, discountsApplied }

  // Payment gateway response
  gatewayResponse    Json?     // { gateway, transactionId, chargeId, customerId, status, authorizationCode, metadata, rawResponse }

  // Currency conversion details
  currencyConversion Json?     // { fromCurrency, toCurrency, exchangeRate, originalAmount, convertedAmount, rateTimestamp, rateSource }

  // Idempotency key for duplicate prevention
  idempotencyKey     String?   @unique

  // Additional context
  reason             String?   // Reason for refunds, adjustments, etc.
  metadata           Json?     // Additional custom data

  // Timestamps
  timestamp          DateTime  @default(now())
  createdAt          DateTime  @default(now())

  // Relations
  order              Order?    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([chargeId])
  @@index([eventType])
  @@index([timestamp])
  @@index([createdAt])
  @@map("billing_audit_logs")
}

// ============================================
// CUSTOMER IMPERSONATION SYSTEM
// ============================================

model ImpersonationSession {
  id String @id @default(uuid())

  // Impersonator (admin/support user)
  impersonatorId    String
  impersonatorEmail String
  impersonatorName  String
  impersonator      User   @relation("Impersonator", fields: [impersonatorId], references: [id], onDelete: Cascade)

  // Target user being impersonated
  targetUserId    String
  targetUserEmail String
  targetUserName  String
  targetUser      User   @relation("ImpersonationTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  // Session details
  reason          String  // Required reason for audit
  ticketReference String? // Optional support ticket reference
  mode            String  @default("VIEW_ONLY") // VIEW_ONLY or FULL_ACCESS

  // Timing
  startedAt DateTime  @default(now())
  endedAt   DateTime? // Null if session is still active
  expiresAt DateTime  // Max 1 hour from start

  // End session notes
  notes      String? // Notes about what was done
  resolution String? // Resolution status (resolved, escalated, etc.)

  // Request metadata
  ipAddress String
  userAgent String?

  // Relations
  actions ImpersonationAction[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([impersonatorId])
  @@index([targetUserId])
  @@index([startedAt])
  @@index([endedAt])
  @@index([mode])
  @@map("impersonation_sessions")
}

model ImpersonationAction {
  id        String @id @default(uuid())
  sessionId String

  // HTTP request details
  method      String // GET, POST, PUT, DELETE, etc.
  path        String // Request path
  requestBody Json?  // Sanitized request body
  statusCode  Int    // HTTP response status code

  // Metadata
  timestamp DateTime @default(now())
  ipAddress String
  userAgent String?

  // Relations
  session ImpersonationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
  @@index([method])
  @@map("impersonation_actions")
}

// ==================== EXPERIMENTATION & FEATURE FLAGS ====================

enum ExperimentStatus {
  DRAFT
  RUNNING
  PAUSED
  CONCLUDED
  ARCHIVED
}

enum FeatureFlagType {
  BOOLEAN
  PERCENTAGE
  SEGMENT
  ENVIRONMENT
}

enum TargetingRuleOperator {
  EQUALS
  NOT_EQUALS
  CONTAINS
  NOT_CONTAINS
  GREATER_THAN
  LESS_THAN
  IN
  NOT_IN
  REGEX
  EXISTS
  NOT_EXISTS
}

model Experiment {
  id          String           @id @default(uuid())
  name        String
  description String?
  hypothesis  String?
  status      ExperimentStatus @default(DRAFT)

  // Experiment configuration
  trafficAllocation Float   @default(100) // Percentage of traffic to include
  isExclusive       Boolean @default(false) // Cannot be in other experiments

  // Mutual exclusion group
  mutualExclusionGroupId String?
  mutualExclusionGroup   MutualExclusionGroup? @relation(fields: [mutualExclusionGroupId], references: [id])

  // Metrics configuration
  primaryMetric   String? // Key of primary metric
  secondaryMetrics Json?   // Array of secondary metric keys

  // Lifecycle
  startedAt    DateTime?
  pausedAt     DateTime?
  concludedAt  DateTime?
  winnerVariantId String?

  // Audit
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  variants         ExperimentVariant[]
  targetingRules   ExperimentTargetingRule[]
  assignments      ExperimentAssignment[]
  events           ExperimentEvent[]
  metrics          ExperimentMetric[]
  auditLogs        ExperimentAuditLog[]

  @@index([status])
  @@index([createdAt])
  @@index([mutualExclusionGroupId])
  @@map("experiments")
}

model ExperimentVariant {
  id           String  @id @default(uuid())
  experimentId String
  name         String
  description  String?
  weight       Float   @default(50) // Percentage weight 0-100
  isControl    Boolean @default(false)

  // Variant payload (for feature variations)
  payload Json?

  // Relations
  experiment  Experiment             @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  assignments ExperimentAssignment[]
  events      ExperimentEvent[]

  @@unique([experimentId, name])
  @@index([experimentId])
  @@map("experiment_variants")
}

model ExperimentTargetingRule {
  id           String                 @id @default(uuid())
  experimentId String
  attribute    String // e.g., "country", "plan", "signup_date", "user_id"
  operator     TargetingRuleOperator
  value        Json // Can be string, number, array, etc.
  priority     Int                    @default(0) // Higher priority rules evaluated first

  // Relations
  experiment Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId])
  @@map("experiment_targeting_rules")
}

model ExperimentAssignment {
  id           String   @id @default(uuid())
  experimentId String
  variantId    String
  userId       String
  assignedAt   DateTime @default(now())

  // Assignment context
  hashKey    String // The hash key used for deterministic assignment
  context    Json?  // Additional context at assignment time

  // Relations
  experiment Experiment        @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  variant    ExperimentVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([experimentId, userId])
  @@index([experimentId])
  @@index([variantId])
  @@index([userId])
  @@index([assignedAt])
  @@map("experiment_assignments")
}

model ExperimentEvent {
  id           String   @id @default(uuid())
  experimentId String
  variantId    String
  userId       String
  eventName    String // e.g., "conversion", "click", "purchase"
  eventValue   Float?  // Optional value (e.g., revenue amount)
  metadata     Json?   // Additional event data
  timestamp    DateTime @default(now())

  // Relations
  experiment Experiment        @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  variant    ExperimentVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([experimentId])
  @@index([variantId])
  @@index([userId])
  @@index([eventName])
  @@index([timestamp])
  @@map("experiment_events")
}

model ExperimentMetric {
  id           String @id @default(uuid())
  experimentId String
  key          String // Metric identifier
  name         String
  description  String?
  eventName    String // Event to track for this metric

  // Metric configuration
  aggregationType String @default("count") // count, sum, average, min, max, conversion_rate
  minimumSampleSize Int @default(100)
  confidenceLevel Float @default(0.95) // 95% confidence

  // Results (updated periodically)
  results Json? // Stores latest computed results per variant

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  experiment Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@unique([experimentId, key])
  @@index([experimentId])
  @@map("experiment_metrics")
}

model MutualExclusionGroup {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  experiments Experiment[]

  @@map("mutual_exclusion_groups")
}

model ExperimentAuditLog {
  id           String   @id @default(uuid())
  experimentId String
  action       String // created, started, paused, concluded, variant_added, etc.
  userId       String?
  changes      Json?    // Before/after state
  timestamp    DateTime @default(now())

  // Relations
  experiment Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  @@index([experimentId])
  @@index([timestamp])
  @@map("experiment_audit_logs")
}

// Feature Flags
model FeatureFlag {
  id          String          @id @default(uuid())
  key         String          @unique
  name        String
  description String?
  type        FeatureFlagType @default(BOOLEAN)
  enabled     Boolean         @default(false)

  // Default value when no rules match
  defaultValue Json @default("false")

  // For percentage rollouts
  percentageEnabled Float? // 0-100

  // Environment-specific settings
  environments Json? // { "production": true, "staging": true, "development": true }

  // Audit
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rules     FeatureFlagRule[]
  segments  FeatureFlagSegment[]
  auditLogs FeatureFlagAuditLog[]

  @@index([key])
  @@index([enabled])
  @@index([type])
  @@map("feature_flags")
}

model FeatureFlagRule {
  id        String                @id @default(uuid())
  flagId    String
  attribute String // e.g., "country", "plan", "user_id"
  operator  TargetingRuleOperator
  value     Json
  priority  Int                   @default(0) // Higher priority = evaluated first
  enabled   Boolean               @default(true)

  // Value to return when rule matches
  returnValue Json @default("true")

  // Relations
  flag FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)

  @@index([flagId])
  @@index([priority])
  @@map("feature_flag_rules")
}

model FeatureFlagSegment {
  id          String  @id @default(uuid())
  flagId      String
  segmentId   String // References a user segment
  enabled     Boolean @default(true)
  returnValue Json    @default("true")

  // Relations
  flag FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)

  @@unique([flagId, segmentId])
  @@index([flagId])
  @@map("feature_flag_segments")
}

model FeatureFlagAuditLog {
  id        String   @id @default(uuid())
  flagId    String
  action    String // created, enabled, disabled, rule_added, rule_removed, etc.
  userId    String?
  changes   Json?    // Before/after state
  timestamp DateTime @default(now())

  // Relations
  flag FeatureFlag @relation(fields: [flagId], references: [id], onDelete: Cascade)

  @@index([flagId])
  @@index([timestamp])
  @@map("feature_flag_audit_logs")
}

// User Segments for targeting
model UserSegment {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?

  // Segment definition
  rules Json // Array of targeting rules

  // Computed membership (cached)
  memberCount  Int      @default(0)
  lastComputed DateTime?

  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@map("user_segments")
}

// ============================================
// DEVICE FINGERPRINTING & FRAUD DETECTION
// ============================================

/// Stores device fingerprints for fraud detection and trust scoring
model DeviceFingerprint {
  id                String   @id @default(uuid())

  // Fingerprint hash - unique identifier for the device
  fingerprintHash   String   @unique

  // Raw fingerprint components (encrypted/hashed for privacy)
  components        Json     // Canvas, WebGL, audio, fonts, etc.

  // Device characteristics
  platform          DevicePlatform
  browserFamily     String?  // Chrome, Firefox, Safari, etc.
  browserVersion    String?
  osFamily          String?  // Windows, macOS, iOS, Android, Linux
  osVersion         String?
  deviceType        String?  // desktop, mobile, tablet
  screenResolution  String?  // e.g., "1920x1080"
  timezone          String?
  language          String?

  // Trust and risk scoring
  trustScore        Int      @default(50) // 0-100, higher is more trusted
  riskLevel         String   @default("unknown") // low, medium, high, critical
  isTrusted         Boolean  @default(false)
  isBlocked         Boolean  @default(false)
  blockReason       String?

  // Bot/emulator detection
  isBot             Boolean  @default(false)
  isEmulator        Boolean  @default(false)
  botConfidence     Float    @default(0) // 0-1 confidence score
  detectionSignals  Json?    // Array of detected bot/emulator signals

  // Association tracking
  associatedUserIds String[] // Users who have used this device
  ipAddresses       String[] // IP addresses seen with this device

  // Activity metrics
  firstSeenAt       DateTime @default(now())
  lastSeenAt        DateTime @default(now())
  loginCount        Int      @default(0)
  transactionCount  Int      @default(0)
  failedLoginCount  Int      @default(0)
  suspiciousActivityCount Int @default(0)

  // Fraud incidents
  fraudIncidents    DeviceFraudIncident[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([fingerprintHash])
  @@index([trustScore])
  @@index([riskLevel])
  @@index([isBot])
  @@index([isBlocked])
  @@index([lastSeenAt])
  @@map("device_fingerprints")
}

/// Links users to their known devices for trust building
model UserDeviceAssociation {
  id                String   @id @default(uuid())

  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  fingerprintHash   String

  // Trust status for this user-device pair
  trustLevel        String   @default("new") // new, recognized, trusted, suspicious, blocked
  deviceNickname    String?  // User-assigned friendly name

  // Verification status
  isVerified        Boolean  @default(false)
  verifiedAt        DateTime?
  verificationMethod String? // email, sms, 2fa

  // Usage statistics
  firstUsedAt       DateTime @default(now())
  lastUsedAt        DateTime @default(now())
  useCount          Int      @default(1)
  successfulLogins  Int      @default(0)
  failedLogins      Int      @default(0)

  // Location data (last known)
  lastIpAddress     String?
  lastLocation      Json?    // { city, country, lat, lng }

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, fingerprintHash])
  @@index([userId])
  @@index([fingerprintHash])
  @@index([trustLevel])
  @@map("user_device_associations")
}

/// Tracks fraud incidents associated with devices
model DeviceFraudIncident {
  id                String   @id @default(uuid())

  fingerprintHash   String
  deviceFingerprint DeviceFingerprint @relation(fields: [fingerprintHash], references: [fingerprintHash], onDelete: Cascade)

  userId            String?  // User involved (if known)

  // Incident details
  incidentType      String   // account_takeover, payment_fraud, bot_activity, credential_stuffing, etc.
  severity          String   // low, medium, high, critical
  description       String

  // Evidence
  evidence          Json?    // Supporting data for the incident
  ipAddress         String?
  userAgent         String?

  // Resolution
  status            String   @default("open") // open, investigating, resolved, false_positive
  resolvedAt        DateTime?
  resolvedBy        String?
  resolution        String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([fingerprintHash])
  @@index([userId])
  @@index([incidentType])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@map("device_fraud_incidents")
}

// ==================== MFA Enforcement ====================

/// MFA enforcement settings - configures which roles require MFA
model MfaEnforcementSettings {
  id                    String   @id @default(uuid())
  organizationId        String?  @unique // null = global settings

  // Enforcement policies
  enforceForAllUsers    Boolean  @default(false)
  enforceForRoles       String[] @default(["ADMIN", "VENDOR"]) // UserRole values
  enforceForLogin       Boolean  @default(true)
  enforceForPayment     Boolean  @default(true)
  paymentThreshold      Float    @default(100.00) // Amount in default currency

  // Grace period for new users/role changes
  gracePeriodEnabled    Boolean  @default(true)
  gracePeriodDays       Int      @default(7)
  gracePeriodMaxLogins  Int      @default(10) // Max logins without MFA

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([organizationId])
  @@map("mfa_enforcement_settings")
}

/// Trusted devices for MFA - allows skipping MFA on recognized devices
model TrustedDevice {
  id              String   @id @default(uuid())
  userId          String

  // Device identification
  deviceId        String   // Device fingerprint hash
  deviceName      String?  // User-friendly name (e.g., "John's MacBook Pro")

  // Device metadata
  userAgent       String?
  ipAddress       String?  // IP at time of trust
  platform        String?  // web, ios, android
  browserInfo     Json?    // Browser details

  // Trust settings
  trustLevel      String   @default("trusted") // trusted, temporary
  trustDurationDays Int    @default(30) // How long to trust this device

  // Activity tracking
  lastUsedAt      DateTime @default(now())
  lastIpAddress   String?  // Last IP used with this device
  useCount        Int      @default(1)

  // Expiration
  expiresAt       DateTime
  isActive        Boolean  @default(true)
  revokedAt       DateTime?
  revokeReason    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relation
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
  @@index([userId])
  @@index([deviceId])
  @@index([expiresAt])
  @@index([isActive])
  @@map("trusted_devices")
}

// ============================================================================
// MULTI-TENANT GLOBAL MARKETPLACE MODELS
// ============================================================================

// Domain Type Enum - Types of domains a tenant can configure
enum DomainType {
  PRIMARY      // Main domain for the tenant (e.g., store.example.com)
  SUBDOMAIN    // Subdomain of the platform (e.g., tenant.broxiva.com)
  CUSTOM       // Custom domain owned by tenant
  VANITY       // Short vanity domain
}

// Domain Status Enum - Status of domain verification/configuration
enum DomainStatus {
  PENDING         // Domain added but not verified
  VERIFYING       // Verification in progress
  VERIFIED        // Domain verified and active
  FAILED          // Verification failed
  SUSPENDED       // Domain suspended (e.g., billing issue)
  EXPIRED         // Domain verification expired
}

// SSL Status Enum - SSL certificate status for domains
enum SslStatus {
  PENDING         // SSL cert being provisioned
  ACTIVE          // SSL cert active
  EXPIRED         // SSL cert expired
  FAILED          // SSL provisioning failed
  RENEWING        // SSL cert being renewed
}

// Translation Status Enum - For product/content translations
enum TranslationStatus {
  DRAFT           // Translation in progress
  AUTO_TRANSLATED // Machine translated, needs review
  VENDOR_APPROVED // Vendor has approved translation
  PUBLISHED       // Translation is live
}

/// Tenant Domain Model - Maps custom domains to tenant organizations
/// Supports multi-domain configurations for white-label storefronts
model TenantDomain {
  id                String       @id @default(cuid())
  host              String       @unique // e.g., "shop.acme.com" or "acme.broxiva.com"
  tenantId          String
  tenant            Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  domainType        DomainType   @default(SUBDOMAIN)
  status            DomainStatus @default(PENDING)
  verificationToken String?      // Token for DNS TXT record verification
  cnameTarget       String?      // Target for CNAME record (e.g., "custom.broxiva.com")
  verifiedAt        DateTime?    // When domain was verified
  sslStatus         SslStatus?   // SSL certificate status
  sslExpiresAt      DateTime?    // SSL certificate expiration
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([domainType])
  @@map("tenant_domains")
}

/// Tenant Locale Model - Supported locales/languages per tenant
/// Enables multi-language storefronts with locale-specific content
model TenantLocale {
  id        String       @id @default(cuid())
  tenantId  String
  tenant    Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  locale    String       // BCP 47 format: "en-US", "fr-CA", "zh-CN"
  isDefault Boolean      @default(false) // Default locale for tenant
  isEnabled Boolean      @default(true) // Whether locale is active
  label     String?      // Display name: "English (US)", "Francais (Canada)"
  createdAt DateTime     @default(now())

  @@unique([tenantId, locale])
  @@index([tenantId])
  @@index([isDefault])
  @@map("tenant_locales")
}

/// Tenant Currency Model - Supported currencies per tenant
/// Enables multi-currency pricing and transactions
model TenantCurrency {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  currency    String       // ISO 4217: USD, EUR, GBP, NGN, etc.
  isDefault   Boolean      @default(false) // Default currency for tenant
  isEnabled   Boolean      @default(true) // Whether currency is active
  symbol      String?      // Currency symbol: $, EUR, etc.
  displayName String?      // "US Dollar", "Euro", etc.
  createdAt   DateTime     @default(now())

  @@unique([tenantId, currency])
  @@index([tenantId])
  @@index([isDefault])
  @@map("tenant_currencies")
}

/// Tenant Geo Rule Model - Geographic rules and restrictions per tenant
/// Controls market access, default settings, and regional compliance
model TenantGeoRule {
  id              String       @id @default(cuid())
  tenantId        String
  tenant          Organization @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  countryCode     String       // ISO 3166-1 alpha-2: US, GB, NG, CA, etc.
  countryName     String?      // Human readable: "United States", "Nigeria"
  isAllowed       Boolean      @default(true) // Is this country allowed for this tenant
  defaultCurrency String?      // Default currency for this country (ISO 4217)
  defaultLocale   String?      // Default locale for this country (BCP 47)
  shippingZone    String?      // Shipping zone identifier
  taxRate         Decimal?     @db.Decimal(5, 4) // Tax rate: 0.0750 = 7.5%
  vatNumber       String?      // VAT/GST number if applicable
  notes           String?      // Admin notes
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([tenantId, countryCode])
  @@index([tenantId])
  @@index([countryCode])
  @@index([isAllowed])
  @@map("tenant_geo_rules")
}

/// FX Rate Model - Foreign exchange rates for currency conversion
/// Cached rates from external sources with expiration
model FxRate {
  id            String   @id @default(cuid())
  baseCurrency  String   // Source currency (ISO 4217)
  quoteCurrency String   // Target currency (ISO 4217)
  rate          Decimal  @db.Decimal(18, 8) // High precision: 1.00000000 to 999999999999999999.99999999
  inverseRate   Decimal? @db.Decimal(18, 8) // Precomputed inverse for performance
  source        String   // Rate source: "openexchangerates", "ecb", "xe", "manual"
  fetchedAt     DateTime @default(now()) // When rate was fetched
  expiresAt     DateTime // When rate should be refreshed
  metadata      Json?    // Additional data from source

  @@unique([baseCurrency, quoteCurrency])
  @@index([baseCurrency, quoteCurrency, fetchedAt])
  @@index([expiresAt])
  @@map("fx_rates")
}

/// Order FX Snapshot Model - Captures FX rate at time of order
/// Ensures financial accuracy and audit trail for currency conversions
model OrderFxSnapshot {
  id              String   @id @default(cuid())
  orderId         String   @unique
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  baseCurrency    String   // Original transaction currency
  quoteCurrency   String   // Settlement/display currency
  rate            Decimal  @db.Decimal(18, 8) // Rate at time of order
  originalAmount  Decimal  @db.Decimal(19, 4) // Amount in base currency (minor units)
  convertedAmount Decimal  @db.Decimal(19, 4) // Amount in quote currency (minor units)
  source          String?  // Rate source at time of snapshot
  snapshotAt      DateTime @default(now()) // Timestamp of snapshot

  @@index([orderId])
  @@index([snapshotAt])
  @@map("order_fx_snapshots")
}

/// User Preference Model - User-specific locale/currency preferences
/// Persists user choices for personalized experience
model UserPreference {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  country   String?  // Preferred country (ISO 3166-1 alpha-2)
  language  String?  // Preferred language/locale (BCP 47)
  currency  String?  // Preferred currency (ISO 4217)
  timezone  String?  // Preferred timezone (IANA: "America/New_York")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country])
  @@index([currency])
  @@map("user_preferences")
}

// ==================== CONNECTOR & PRODUCT INTEGRATION MODELS ====================

/// Connector Type Enum - Supported product source integrations
enum ConnectorType {
  SHOPIFY
  WOOCOMMERCE
  REST_API
  CSV
}

/// Sync Status Enum - Product sync state tracking
enum SyncStatus {
  SYNCED
  PENDING
  FAILED
  CONFLICT
  DELETED
}

/// Connector Configuration Model - Stores integration settings
/// Manages connections to external product sources (Shopify, WooCommerce, REST, CSV)
model ConnectorConfig {
  id       String        @id @default(cuid())
  tenantId String
  tenant   Organization  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  type     ConnectorType
  name     String

  /// Encrypted JSON containing credentials and integration settings
  /// Structure varies by connector type (Shopify OAuth tokens, WooCommerce keys, etc.)
  config Json

  isActive       Boolean   @default(true)
  lastSyncAt     DateTime?
  lastSyncStatus String?   // SYNCED, PARTIAL, FAILED, IN_PROGRESS

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productSources ProductSource[]
  syncLogs       ConnectorSyncLog[]

  @@unique([tenantId, type, name])
  @@index([tenantId])
  @@index([type])
  @@index([isActive])
  @@map("connector_configs")
}

/// Product Source Model - Maps external products to internal products
/// Tracks synchronization state for each imported product
model ProductSource {
  id          String          @id @default(cuid())
  productId   String
  product     Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  connectorId String
  connector   ConnectorConfig @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  /// External product identifier in the source system
  externalId String

  /// Last successful sync timestamp
  lastSyncAt DateTime

  /// Current sync status
  syncStatus SyncStatus @default(PENDING)

  /// Hash of last synced data for change detection
  dataHash String?

  /// Stores conflict details if syncStatus is CONFLICT
  conflictData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectorId, externalId])
  @@index([productId])
  @@index([connectorId])
  @@index([syncStatus])
  @@index([lastSyncAt])
  @@map("product_sources")
}

/// Connector Sync Log Model - Audit trail for sync operations
/// Records sync history, statistics, and errors for debugging
model ConnectorSyncLog {
  id          String          @id @default(cuid())
  connectorId String
  connector   ConnectorConfig @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  /// Type of sync operation
  syncType String // FULL, DELTA, MANUAL, WEBHOOK, SCHEDULED

  /// Sync status
  status String // PENDING, IN_PROGRESS, COMPLETED, PARTIAL, FAILED, CANCELLED

  /// Sync timing
  startedAt   DateTime
  completedAt DateTime?

  /// Statistics
  totalProcessed Int @default(0)
  created        Int @default(0)
  updated        Int @default(0)
  deleted        Int @default(0)
  skipped        Int @default(0)
  failed         Int @default(0)

  /// Error details (JSON array of error objects)
  errors Json?

  /// Warning details (JSON array of warning objects)
  warnings Json?

  /// Triggering context (userId, scheduled, webhook, etc.)
  triggeredBy String?
  metadata    Json?

  createdAt DateTime @default(now())

  @@index([connectorId])
  @@index([status])
  @@index([syncType])
  @@index([startedAt])
  @@map("connector_sync_logs")
}

