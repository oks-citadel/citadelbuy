# ==========================================
# CitadelBuy Next.js Web - Production Dockerfile
# Multi-stage build with standalone output
# Node.js 20 Alpine with optimizations
# ==========================================

# ==========================================
# Stage 1: Dependencies
# Install all dependencies including dev dependencies
# ==========================================
FROM node:20-alpine AS deps

# Install libc6-compat for compatibility
RUN apk add --no-cache libc6-compat && rm -rf /var/cache/apk/*

WORKDIR /app

# Copy package manager files
COPY package.json pnpm-lock.yaml* package-lock.json* ./

# Install pnpm globally
RUN npm install -g pnpm@10.23.0

# Install dependencies
RUN pnpm install || npm install

# ==========================================
# Stage 2: Builder
# Build Next.js application with standalone output
# ==========================================
FROM node:20-alpine AS builder

WORKDIR /app

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Copy application source
COPY . .

# Set build environment variables
# DOCKER_BUILD=true enables standalone output mode
ENV DOCKER_BUILD=true
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Build arguments for client-side environment variables
# These are embedded in the JavaScript bundle at build time
ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_WS_URL
ARG NEXT_PUBLIC_AI_SERVICE_URL
ARG NEXT_PUBLIC_APP_NAME
ARG NEXT_PUBLIC_APP_URL
ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ARG NEXT_PUBLIC_GOOGLE_CLIENT_ID
ARG NEXT_PUBLIC_GITHUB_CLIENT_ID
ARG NEXT_PUBLIC_FACEBOOK_APP_ID
ARG NEXT_PUBLIC_APPLE_CLIENT_ID
ARG NEXT_PUBLIC_GA_TRACKING_ID
ARG NEXT_PUBLIC_FB_PIXEL_ID
ARG NEXT_PUBLIC_TIKTOK_PIXEL_ID
ARG NEXT_PUBLIC_ENABLE_AI_FEATURES
ARG NEXT_PUBLIC_ENABLE_AR_TRYON
ARG NEXT_PUBLIC_ENABLE_VOICE_SEARCH
ARG NEXT_PUBLIC_ENABLE_CHATBOT
ARG NEXT_PUBLIC_CDN_URL
ARG NEXT_PUBLIC_IMAGE_OPTIMIZATION
ARG NEXT_PUBLIC_VAPID_PUBLIC_KEY
ARG NEXT_PUBLIC_SENTRY_DSN

# Build Next.js application
# Standalone output includes only necessary files
RUN npm run build

# ==========================================
# Stage 3: Production Runner
# Minimal image with Next.js standalone output
# ==========================================
FROM node:20-alpine AS runner

# Install dumb-init for signal handling and curl for health checks
RUN apk add --no-cache \
    dumb-init \
    curl \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# Create non-root user for security
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001 -G nodejs

# Set to production environment
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Copy Next.js standalone output
# Standalone mode includes minimal Node.js server and dependencies
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# Runtime environment variables
# These are server-side only and not embedded in bundles
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Expose Next.js port
EXPOSE 3000

# Switch to non-root user
USER nextjs

# Health check endpoint
# Next.js doesn't have a built-in health endpoint by default
# You may need to create /api/health route in your app
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:3000/api/health || curl -f http://localhost:3000/ || exit 1

# Use dumb-init for proper signal handling
ENTRYPOINT ["dumb-init", "--"]

# Start Next.js server
# Standalone output includes server.js
CMD ["node", "server.js"]

# ==========================================
# Build Instructions:
# ==========================================
# Build with environment variables:
# docker build -f Dockerfile.production \
#   --build-arg NEXT_PUBLIC_API_URL=https://api.citadelbuy.com \
#   --build-arg NEXT_PUBLIC_WS_URL=wss://api.citadelbuy.com \
#   -t citadelbuy-web:prod .
#
# Run:
# docker run -p 3000:3000 citadelbuy-web:prod
# ==========================================

# ==========================================
# Security Features:
# ==========================================
# ✓ Non-root user (nextjs:1001)
# ✓ Multi-stage build (minimal attack surface)
# ✓ Alpine base (small, security-focused)
# ✓ Standalone output (no source code)
# ✓ Health check for monitoring
# ✓ Proper signal handling with dumb-init
# ✓ No development dependencies
# ✓ Telemetry disabled for privacy
# ==========================================

# ==========================================
# Size Optimizations:
# ==========================================
# ✓ Alpine Linux base (~5MB)
# ✓ Next.js standalone output (~50-100MB)
# ✓ No node_modules in final image
# ✓ Static files optimized
# ✓ Expected final image size: ~150-250MB
# ==========================================

# ==========================================
# Performance Features:
# ==========================================
# ✓ Standalone output (faster cold starts)
# ✓ Static file optimization
# ✓ Image optimization ready
# ✓ Compressed output
# ✓ Production-ready server
# ==========================================
