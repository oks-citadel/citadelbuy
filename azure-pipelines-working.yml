# CitadelBuy - Simplified Working Azure Pipeline
# This is a minimal, functional pipeline for Azure DevOps
# Organization: citadelcloudmanagement
# Project: CitadelBuy
# ACR: broxivaprodacr.azurecr.io

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '**/*.md'
      - 'docs/**'

pr:
  branches:
    include:
      - main
      - develop

# Pipeline parameters
parameters:
  - name: buildImages
    displayName: 'Build Docker Images'
    type: boolean
    default: true

  - name: pushToACR
    displayName: 'Push to Azure Container Registry'
    type: boolean
    default: true

# Variables
variables:
  - name: DOCKER_BUILDKIT
    value: '1'
  - name: ACR_NAME
    value: 'broxivaprodacr'
  - name: ACR_LOGIN_SERVER
    value: 'broxivaprodacr.azurecr.io'
  - name: IMAGE_TAG
    value: '$(Build.BuildId)'
  - name: SHORT_SHA
    value: $[substring(variables['Build.SourceVersion'], 0, 7)]

pool:
  vmImage: 'ubuntu-latest'

stages:
  # ============================================
  # STAGE 1: Validation
  # ============================================
  - stage: Validate
    displayName: 'Code Validation'
    jobs:
      - job: BasicValidation
        displayName: 'Basic Checks'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - script: |
              echo "Repository: $(Build.Repository.Name)"
              echo "Branch: $(Build.SourceBranch)"
              echo "Commit: $(Build.SourceVersion)"
              echo "Build ID: $(Build.BuildId)"
              echo "Short SHA: $(SHORT_SHA)"
            displayName: 'Display build info'

          - script: |
              echo "Checking for required files..."
              ls -la organization/apps/api/ || echo "API directory not found"
              ls -la organization/apps/web/ || echo "Web directory not found"

              if [ -f "organization/apps/api/Dockerfile.production" ]; then
                echo "✓ API Dockerfile.production found"
              else
                echo "✗ API Dockerfile.production not found"
              fi

              if [ -f "organization/apps/web/Dockerfile.production" ]; then
                echo "✓ Web Dockerfile.production found"
              else
                echo "✗ Web Dockerfile.production not found"
              fi
            displayName: 'Verify project structure'

  # ============================================
  # STAGE 2: Build Docker Images
  # ============================================
  - stage: BuildImages
    displayName: 'Build Docker Images'
    dependsOn: Validate
    condition: and(succeeded(), eq('${{ parameters.buildImages }}', true))
    jobs:
      - job: BuildAPI
        displayName: 'Build API Image'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: Docker@2
            displayName: 'Build API Docker Image'
            inputs:
              command: 'build'
              dockerfile: 'organization/apps/api/Dockerfile.production'
              buildContext: 'organization/apps/api'
              tags: |
                $(ACR_LOGIN_SERVER)/broxiva-api:$(IMAGE_TAG)
                $(ACR_LOGIN_SERVER)/broxiva-api:$(SHORT_SHA)
                $(ACR_LOGIN_SERVER)/broxiva-api:$(Build.SourceBranchName)
                $(ACR_LOGIN_SERVER)/broxiva-api:latest
              arguments: '--build-arg BUILDKIT_INLINE_CACHE=1'
            continueOnError: false

          - script: |
              echo "API image built successfully:"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-api:$(IMAGE_TAG)"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-api:$(SHORT_SHA)"
            displayName: 'Display API build result'

      - job: BuildWeb
        displayName: 'Build Web Image'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: Docker@2
            displayName: 'Build Web Docker Image'
            inputs:
              command: 'build'
              dockerfile: 'organization/apps/web/Dockerfile.production'
              buildContext: 'organization/apps/web'
              tags: |
                $(ACR_LOGIN_SERVER)/broxiva-web:$(IMAGE_TAG)
                $(ACR_LOGIN_SERVER)/broxiva-web:$(SHORT_SHA)
                $(ACR_LOGIN_SERVER)/broxiva-web:$(Build.SourceBranchName)
                $(ACR_LOGIN_SERVER)/broxiva-web:latest
              arguments: '--build-arg BUILDKIT_INLINE_CACHE=1'
            continueOnError: false

          - script: |
              echo "Web image built successfully:"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-web:$(IMAGE_TAG)"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-web:$(SHORT_SHA)"
            displayName: 'Display Web build result'

  # ============================================
  # STAGE 3: Push to ACR
  # ============================================
  - stage: PushToACR
    displayName: 'Push Images to ACR'
    dependsOn: BuildImages
    condition: and(succeeded(), eq('${{ parameters.pushToACR }}', true), ne(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - job: PushImages
        displayName: 'Push to Azure Container Registry'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          # Login to ACR - This will require a service connection named 'BroxivaACR' or 'AzureServiceConnection'
          - task: AzureCLI@2
            displayName: 'Login to ACR via Azure CLI'
            inputs:
              azureSubscription: 'AzureServiceConnection'  # Update this to match your service connection name
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az acr login --name $(ACR_NAME)
                echo "Logged in to $(ACR_LOGIN_SERVER)"
            continueOnError: false

          # Rebuild and push API
          - task: Docker@2
            displayName: 'Build and Push API Image'
            inputs:
              command: 'buildAndPush'
              dockerfile: 'organization/apps/api/Dockerfile.production'
              buildContext: 'organization/apps/api'
              repository: 'broxiva-api'
              containerRegistry: 'BroxivaACR'  # Update this to match your ACR service connection
              tags: |
                $(IMAGE_TAG)
                $(SHORT_SHA)
                $(Build.SourceBranchName)
                latest
              arguments: '--build-arg BUILDKIT_INLINE_CACHE=1'
            continueOnError: false

          # Rebuild and push Web
          - task: Docker@2
            displayName: 'Build and Push Web Image'
            inputs:
              command: 'buildAndPush'
              dockerfile: 'organization/apps/web/Dockerfile.production'
              buildContext: 'organization/apps/web'
              repository: 'broxiva-web'
              containerRegistry: 'BroxivaACR'  # Update this to match your ACR service connection
              tags: |
                $(IMAGE_TAG)
                $(SHORT_SHA)
                $(Build.SourceBranchName)
                latest
              arguments: '--build-arg BUILDKIT_INLINE_CACHE=1'
            continueOnError: false

          - script: |
              echo "================================================"
              echo "Images pushed to ACR successfully!"
              echo "================================================"
              echo ""
              echo "API Images:"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-api:$(IMAGE_TAG)"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-api:$(SHORT_SHA)"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-api:$(Build.SourceBranchName)"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-api:latest"
              echo ""
              echo "Web Images:"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-web:$(IMAGE_TAG)"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-web:$(SHORT_SHA)"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-web:$(Build.SourceBranchName)"
              echo "  - $(ACR_LOGIN_SERVER)/broxiva-web:latest"
              echo "================================================"
            displayName: 'Display push summary'

  # ============================================
  # STAGE 4: Verify ACR Images
  # ============================================
  - stage: VerifyACR
    displayName: 'Verify ACR Push'
    dependsOn: PushToACR
    condition: succeeded()
    jobs:
      - job: VerifyImages
        displayName: 'Verify Images in ACR'
        steps:
          - task: AzureCLI@2
            displayName: 'List ACR Repositories and Tags'
            inputs:
              azureSubscription: 'AzureServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Listing repositories in $(ACR_NAME)..."
                az acr repository list --name $(ACR_NAME) -o table

                echo ""
                echo "Checking broxiva-api tags..."
                az acr repository show-tags --name $(ACR_NAME) --repository broxiva-api --orderby time_desc --top 5 -o table || echo "No broxiva-api repository found"

                echo ""
                echo "Checking broxiva-web tags..."
                az acr repository show-tags --name $(ACR_NAME) --repository broxiva-web --orderby time_desc --top 5 -o table || echo "No broxiva-web repository found"
            continueOnError: true
