# CitadelBuy E-commerce Platform - Root Azure Pipeline
# This pipeline references the main pipeline in the organization folder
# Documentation: https://dev.azure.com/citadelcloudmanagement/CitadelBuy

trigger:
  branches:
    include:
      - main
      - develop
      - master
      - feature/*
      - release/*
  paths:
    exclude:
      - '*.md'
      - 'docs/**'
      - '.vscode/**'
      - '.idea/**'

pr:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '*.md'
      - 'docs/**'

# Pipeline parameters
parameters:
  - name: skipTests
    displayName: 'Skip Tests'
    type: boolean
    default: false

  - name: buildMicroservices
    displayName: 'Build Python Microservices'
    type: boolean
    default: true

  - name: deployEnvironment
    displayName: 'Deploy to Environment'
    type: string
    default: 'none'
    values:
      - none
      - staging
      - production

# Global variables
variables:
  - name: NODE_VERSION
    value: '20'
  - name: PNPM_VERSION
    value: '9'
  - name: PYTHON_VERSION
    value: '3.11'
  - name: AZURE_CONTAINER_REGISTRY
    value: 'citadelbuyacr.azurecr.io'
  - name: ORGANIZATION_PATH
    value: 'organization'
  - name: isMain
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  - name: isDevelop
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/develop')]
  - name: isMaster
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/master')]

# Build agent pool
pool:
  vmImage: 'ubuntu-latest'

stages:
  # ============================================
  # STAGE 1: Code Quality & Validation
  # ============================================
  - stage: Validate
    displayName: '1. Validate Code Quality'
    jobs:
      - job: LintAndFormat
        displayName: 'Lint & Format Check'
        steps:
          - checkout: self
            fetchDepth: 0
            displayName: 'Checkout code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - task: Cache@2
            displayName: 'Cache pnpm store'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | $(ORGANIZATION_PATH)/pnpm-lock.yaml'
              path: '$(Pipeline.Workspace)/.pnpm-store'
              restoreKeys: |
                pnpm | "$(Agent.OS)"

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
              pnpm --version
            displayName: 'Setup pnpm'

          - script: |
              cd $(ORGANIZATION_PATH)
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: |
              cd $(ORGANIZATION_PATH)
              pnpm lint || true
            displayName: 'Run ESLint'
            continueOnError: true

          - script: |
              cd $(ORGANIZATION_PATH)
              pnpm format:check || true
            displayName: 'Check code formatting'
            continueOnError: true

      - job: TypeCheck
        displayName: 'TypeScript Type Check'
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            displayName: 'Setup Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - task: Cache@2
            displayName: 'Cache pnpm store'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | $(ORGANIZATION_PATH)/pnpm-lock.yaml'
              path: '$(Pipeline.Workspace)/.pnpm-store'

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
            displayName: 'Setup pnpm'

          - script: |
              cd $(ORGANIZATION_PATH)
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: |
              cd $(ORGANIZATION_PATH)/apps/api
              npx prisma generate
            displayName: 'Generate Prisma Client'

          - script: |
              cd $(ORGANIZATION_PATH)
              pnpm type-check || true
            displayName: 'Run TypeScript type check'
            continueOnError: true

  # ============================================
  # STAGE 2: Unit Tests
  # ============================================
  - stage: Test
    displayName: '2. Run Tests'
    dependsOn: Validate
    condition: and(succeeded(), eq('${{ parameters.skipTests }}', false))
    jobs:
      - job: APITests
        displayName: 'API Unit Tests'
        services:
          postgres:
            image: postgres:16-alpine
            ports:
              - 5432:5432
            env:
              POSTGRES_USER: test
              POSTGRES_PASSWORD: test
              POSTGRES_DB: citadelbuy_test
          redis:
            image: redis:7-alpine
            ports:
              - 6379:6379
        steps:
          - checkout: self
            displayName: 'Checkout code'

          - task: NodeTool@0
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | $(ORGANIZATION_PATH)/pnpm-lock.yaml'
              path: '$(Pipeline.Workspace)/.pnpm-store'

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
            displayName: 'Setup pnpm'

          - script: |
              cd $(ORGANIZATION_PATH)
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: |
              cd $(ORGANIZATION_PATH)/apps/api
              npx prisma generate
            displayName: 'Generate Prisma Client'

          - script: |
              cd $(ORGANIZATION_PATH)/apps/api
              npx prisma migrate deploy
            displayName: 'Run migrations'
            env:
              DATABASE_URL: postgresql://test:test@localhost:5432/citadelbuy_test

          - script: |
              cd $(ORGANIZATION_PATH)/apps/api
              pnpm test --passWithNoTests || true
            displayName: 'Run API tests'
            env:
              DATABASE_URL: postgresql://test:test@localhost:5432/citadelbuy_test
              REDIS_URL: redis://localhost:6379
              JWT_SECRET: test-jwt-secret-for-ci
              NODE_ENV: test
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit.xml'
              mergeTestResults: true
              testRunTitle: 'API Tests'
            continueOnError: true

      - job: WebTests
        displayName: 'Web Unit Tests'
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | $(ORGANIZATION_PATH)/pnpm-lock.yaml'
              path: '$(Pipeline.Workspace)/.pnpm-store'

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
            displayName: 'Setup pnpm'

          - script: |
              cd $(ORGANIZATION_PATH)
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: |
              cd $(ORGANIZATION_PATH)/apps/web
              pnpm test --passWithNoTests || true
            displayName: 'Run Web tests'
            continueOnError: true

  # ============================================
  # STAGE 3: Build Applications
  # ============================================
  - stage: Build
    displayName: '3. Build Applications'
    dependsOn: Test
    condition: or(succeeded(), eq('${{ parameters.skipTests }}', true))
    jobs:
      - job: BuildNodeApps
        displayName: 'Build Node.js Applications'
        steps:
          - checkout: self

          - task: NodeTool@0
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | $(ORGANIZATION_PATH)/pnpm-lock.yaml'
              path: '$(Pipeline.Workspace)/.pnpm-store'

          - script: |
              npm install -g pnpm@$(PNPM_VERSION)
              pnpm config set store-dir $(Pipeline.Workspace)/.pnpm-store
            displayName: 'Setup pnpm'

          - script: |
              cd $(ORGANIZATION_PATH)
              pnpm install --frozen-lockfile
            displayName: 'Install dependencies'

          - script: |
              cd $(ORGANIZATION_PATH)/apps/api
              npx prisma generate
            displayName: 'Generate Prisma Client'

          - script: |
              cd $(ORGANIZATION_PATH)
              pnpm build
            displayName: 'Build all packages'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish API build'
            inputs:
              targetPath: '$(ORGANIZATION_PATH)/apps/api/dist'
              artifact: 'api-build'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Web build'
            inputs:
              targetPath: '$(ORGANIZATION_PATH)/apps/web/.next'
              artifact: 'web-build'

  # ============================================
  # STAGE 4: Build Docker Images
  # ============================================
  - stage: DockerBuild
    displayName: '4. Build Docker Images'
    dependsOn: Build
    condition: and(succeeded(), or(eq(variables.isMain, true), eq(variables.isDevelop, true), eq(variables.isMaster, true)))
    jobs:
      - job: BuildMainImages
        displayName: 'Build API & Web Images'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: 'login'
              containerRegistry: 'AzureContainerRegistry'

          - bash: |
              SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
              BRANCH=$(echo $(Build.SourceBranchName) | tr '/' '-' | tr '[:upper:]' '[:lower:]')
              echo "##vso[task.setvariable variable=IMAGE_TAG]$SHA"
              echo "##vso[task.setvariable variable=BRANCH_TAG]$BRANCH"
              echo "Building with tags: $SHA, $BRANCH"
            displayName: 'Generate image tags'

          - task: Docker@2
            displayName: 'Build API image'
            inputs:
              command: 'buildAndPush'
              containerRegistry: 'AzureContainerRegistry'
              repository: 'citadelbuy-api'
              dockerfile: '$(ORGANIZATION_PATH)/apps/api/Dockerfile.production'
              buildContext: '$(ORGANIZATION_PATH)/apps/api'
              tags: |
                $(IMAGE_TAG)
                $(BRANCH_TAG)

          - task: Docker@2
            displayName: 'Build Web image'
            inputs:
              command: 'buildAndPush'
              containerRegistry: 'AzureContainerRegistry'
              repository: 'citadelbuy-web'
              dockerfile: '$(ORGANIZATION_PATH)/apps/web/Dockerfile.production'
              buildContext: '$(ORGANIZATION_PATH)/apps/web'
              tags: |
                $(IMAGE_TAG)
                $(BRANCH_TAG)

      - job: BuildMicroservices
        displayName: 'Build Python Microservices'
        condition: eq('${{ parameters.buildMicroservices }}', true)
        strategy:
          matrix:
            inventory:
              SERVICE_NAME: 'inventory'
              SERVICE_PATH: '$(ORGANIZATION_PATH)/apps/services/inventory'
            media:
              SERVICE_NAME: 'media'
              SERVICE_PATH: '$(ORGANIZATION_PATH)/apps/services/media'
            notification:
              SERVICE_NAME: 'notification'
              SERVICE_PATH: '$(ORGANIZATION_PATH)/apps/services/notification'
            personalization:
              SERVICE_NAME: 'personalization'
              SERVICE_PATH: '$(ORGANIZATION_PATH)/apps/services/personalization'
        steps:
          - checkout: self

          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: 'login'
              containerRegistry: 'AzureContainerRegistry'

          - bash: |
              SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
              echo "##vso[task.setvariable variable=IMAGE_TAG]$SHA"
            displayName: 'Generate image tag'

          - task: Docker@2
            displayName: 'Build $(SERVICE_NAME) service'
            inputs:
              command: 'buildAndPush'
              containerRegistry: 'AzureContainerRegistry'
              repository: 'citadelbuy-$(SERVICE_NAME)'
              dockerfile: '$(SERVICE_PATH)/Dockerfile'
              buildContext: '$(SERVICE_PATH)'
              tags: |
                $(IMAGE_TAG)

  # ============================================
  # STAGE 5: Deploy to Staging
  # ============================================
  - stage: DeployStaging
    displayName: '5. Deploy to Staging'
    dependsOn: DockerBuild
    condition: and(succeeded(), or(eq(variables.isDevelop, true), eq('${{ parameters.deployEnvironment }}', 'staging')))
    jobs:
      - deployment: DeployToStaging
        displayName: 'Deploy to Staging Environment'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Get AKS Credentials'
                  inputs:
                    azureSubscription: 'Azure-ServiceConnection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az aks get-credentials \
                        --resource-group citadelbuy-staging-rg \
                        --name citadelbuy-staging-aks \
                        --overwrite-existing

                - bash: |
                    SHA=$(echo $(Build.SourceVersion) | cut -c1-7)

                    # Apply Kubernetes manifests
                    kubectl apply -f $(ORGANIZATION_PATH)/infrastructure/kubernetes/staging/

                    # Update deployments with new images
                    kubectl set image deployment/api \
                      api=$(AZURE_CONTAINER_REGISTRY)/citadelbuy-api:$SHA \
                      -n citadelbuy-staging

                    kubectl set image deployment/web \
                      web=$(AZURE_CONTAINER_REGISTRY)/citadelbuy-web:$SHA \
                      -n citadelbuy-staging

                    # Wait for rollout
                    kubectl rollout status deployment/api -n citadelbuy-staging --timeout=300s
                    kubectl rollout status deployment/web -n citadelbuy-staging --timeout=300s
                  displayName: 'Deploy to Kubernetes'

                - bash: |
                    echo "Verifying staging deployment..."
                    curl -sf https://staging.citadelbuy.com/api/health
                  displayName: 'Verify Deployment'

  # ============================================
  # STAGE 6: Deploy to Production
  # ============================================
  - stage: DeployProduction
    displayName: '6. Deploy to Production'
    dependsOn: DockerBuild
    condition: and(succeeded(), or(eq(variables.isMain, true), eq('${{ parameters.deployEnvironment }}', 'production')))
    jobs:
      - deployment: DeployToProduction
        displayName: 'Deploy to Production Environment'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Get AKS Credentials'
                  inputs:
                    azureSubscription: 'Azure-ServiceConnection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az aks get-credentials \
                        --resource-group citadelbuy-prod-rg \
                        --name citadelbuy-prod-aks \
                        --overwrite-existing

                - bash: |
                    SHA=$(echo $(Build.SourceVersion) | cut -c1-7)

                    # Apply Kubernetes manifests
                    kubectl apply -f $(ORGANIZATION_PATH)/infrastructure/kubernetes/production/

                    # Blue-Green deployment
                    kubectl set image deployment/api-green \
                      api=$(AZURE_CONTAINER_REGISTRY)/citadelbuy-api:$SHA \
                      -n citadelbuy-prod

                    kubectl set image deployment/web-green \
                      web=$(AZURE_CONTAINER_REGISTRY)/citadelbuy-web:$SHA \
                      -n citadelbuy-prod

                    # Wait for green deployment
                    kubectl rollout status deployment/api-green -n citadelbuy-prod --timeout=300s
                    kubectl rollout status deployment/web-green -n citadelbuy-prod --timeout=300s

                    # Switch traffic to green
                    kubectl patch service api-service -n citadelbuy-prod \
                      -p '{"spec":{"selector":{"app":"api-green"}}}'
                    kubectl patch service web-service -n citadelbuy-prod \
                      -p '{"spec":{"selector":{"app":"web-green"}}}'
                  displayName: 'Blue-Green Deployment'

                - bash: |
                    echo "Verifying production deployment..."
                    sleep 30
                    curl -sf https://citadelbuy.com/api/health
                  displayName: 'Verify Production'
