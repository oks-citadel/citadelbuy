name: 'Bootstrap Environment'
description: 'Standard bootstrap for all CI/CD workflows - checkout, Node.js, pnpm, cache, and diagnostics'

inputs:
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '20'
  pnpm-version:
    description: 'pnpm version to use'
    required: false
    default: '10'
  fetch-depth:
    description: 'Git fetch depth (0 for full history)'
    required: false
    default: '1'
  working-directory:
    description: 'Working directory for commands'
    required: false
    default: '.'
  install-dependencies:
    description: 'Whether to run pnpm install'
    required: false
    default: 'true'
  turbo-cache:
    description: 'Enable Turborepo remote caching'
    required: false
    default: 'false'
  turbo-token:
    description: 'Turborepo remote cache token'
    required: false
    default: ''
  turbo-team:
    description: 'Turborepo team for remote cache'
    required: false
    default: ''
  debug:
    description: 'Enable debug output'
    required: false
    default: 'false'

outputs:
  node-version:
    description: 'Installed Node.js version'
    value: ${{ steps.node-info.outputs.version }}
  pnpm-version:
    description: 'Installed pnpm version'
    value: ${{ steps.pnpm-info.outputs.version }}
  cache-hit:
    description: 'Whether pnpm cache was restored'
    value: ${{ steps.pnpm-cache.outputs.cache-hit }}
  git-sha:
    description: 'Current git SHA'
    value: ${{ steps.git-info.outputs.sha }}
  git-sha-short:
    description: 'Short git SHA (7 chars)'
    value: ${{ steps.git-info.outputs.sha-short }}
  git-branch:
    description: 'Current git branch'
    value: ${{ steps.git-info.outputs.branch }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: ${{ inputs.fetch-depth }}

    - name: Get git info
      id: git-info
      shell: bash
      run: |
        echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "sha-short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: ${{ inputs.pnpm-version }}

    - name: Get pnpm info
      id: pnpm-info
      shell: bash
      run: |
        echo "version=$(pnpm --version)" >> $GITHUB_OUTPUT
        echo "store-path=$(pnpm store path)" >> $GITHUB_OUTPUT

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'pnpm'
        cache-dependency-path: '${{ inputs.working-directory }}/pnpm-lock.yaml'

    - name: Get Node.js info
      id: node-info
      shell: bash
      run: |
        echo "version=$(node --version)" >> $GITHUB_OUTPUT

    - name: Restore pnpm store cache
      id: pnpm-cache
      uses: actions/cache@v4
      with:
        path: ${{ steps.pnpm-info.outputs.store-path }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      if: inputs.install-dependencies == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        pnpm install --frozen-lockfile

    - name: Setup Turborepo cache
      if: inputs.turbo-cache == 'true' && inputs.turbo-token != ''
      shell: bash
      run: |
        echo "TURBO_TOKEN=${{ inputs.turbo-token }}" >> $GITHUB_ENV
        echo "TURBO_TEAM=${{ inputs.turbo-team }}" >> $GITHUB_ENV
        echo "TURBO_REMOTE_ONLY=true" >> $GITHUB_ENV

    - name: Debug - Environment diagnostics
      if: inputs.debug == 'true'
      shell: bash
      run: |
        echo "=== Environment Diagnostics ==="
        echo ""
        echo "--- Node.js ---"
        node --version
        echo ""
        echo "--- pnpm ---"
        pnpm --version
        echo "Store path: $(pnpm store path)"
        echo ""
        echo "--- Git ---"
        echo "SHA: ${{ steps.git-info.outputs.sha }}"
        echo "Short SHA: ${{ steps.git-info.outputs.sha-short }}"
        echo "Branch: ${{ steps.git-info.outputs.branch }}"
        echo ""
        echo "--- Working Directory ---"
        pwd
        ls -la
        echo ""
        echo "--- Environment Variables ---"
        echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
        echo "RUNNER_OS: $RUNNER_OS"
        echo "RUNNER_ARCH: $RUNNER_ARCH"
        echo ""
        echo "--- Cache Status ---"
        echo "Cache hit: ${{ steps.pnpm-cache.outputs.cache-hit }}"
        echo ""
        echo "=== End Diagnostics ==="
