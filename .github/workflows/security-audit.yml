name: Security Audit

on:
  # Run weekly on Monday at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Run on every push to main
  push:
    branches: [main, master]

  # Run on every pull request
  pull_request:
    branches: [main, master]

  # Allow manual trigger
  workflow_dispatch:

jobs:
  backend-audit:
    name: Backend Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: broxiva/backend/package-lock.json

      - name: Install dependencies
        working-directory: broxiva/backend
        run: npm ci

      - name: Run npm audit (production only)
        working-directory: broxiva/backend
        run: |
          echo "## Backend Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --production --audit-level=moderate || echo "âš ï¸ Vulnerabilities found" >> $GITHUB_STEP_SUMMARY

      - name: Run npm audit (all dependencies)
        working-directory: broxiva/backend
        run: |
          echo "### Full Dependency Audit" >> $GITHUB_STEP_SUMMARY
          npm audit || echo "Completed with warnings"
        continue-on-error: true

      - name: Check for high severity vulnerabilities
        working-directory: broxiva/backend
        run: |
          # This will fail the build if there are critical vulnerabilities
          npm audit --audit-level=high --production
        continue-on-error: false

  frontend-audit:
    name: Frontend Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: broxiva/frontend/package-lock.json

      - name: Install dependencies
        working-directory: broxiva/frontend
        run: npm ci

      - name: Run npm audit (production only)
        working-directory: broxiva/frontend
        run: |
          echo "## Frontend Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --production --audit-level=moderate || echo "âš ï¸ Vulnerabilities found" >> $GITHUB_STEP_SUMMARY

      - name: Run npm audit (all dependencies)
        working-directory: broxiva/frontend
        run: |
          echo "### Full Dependency Audit" >> $GITHUB_STEP_SUMMARY
          npm audit || echo "Completed with warnings"
        continue-on-error: true

      - name: Check for high severity vulnerabilities
        working-directory: broxiva/frontend
        run: |
          # This will fail the build if there are critical vulnerabilities
          npm audit --audit-level=high --production
        continue-on-error: false

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [backend-audit, frontend-audit]
    if: always()

    steps:
      - name: Create security summary
        run: |
          echo "# ðŸ”’ Security Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Backend audit: ${{ needs.backend-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Frontend audit: ${{ needs.frontend-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed results in job logs above" >> $GITHUB_STEP_SUMMARY
