name: E2E Tests & Accessibility

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      api-url: ${{ steps.env.outputs.api-url }}
      web-url: ${{ steps.env.outputs.web-url }}
    steps:
      - name: Set environment URLs
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'development' }}"
          case "$ENV" in
            production)
              echo "api-url=https://api.broxiva.com" >> $GITHUB_OUTPUT
              echo "web-url=https://broxiva.com" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "api-url=https://api-staging.broxiva.com" >> $GITHUB_OUTPUT
              echo "web-url=https://staging.broxiva.com" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "api-url=https://api-dev.broxiva.com" >> $GITHUB_OUTPUT
              echo "web-url=https://dev.broxiva.com" >> $GITHUB_OUTPUT
              ;;
          esac

  playwright-chromium:
    name: Playwright - Chromium
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: Run Playwright tests - Chromium
        run: pnpm exec playwright test --project=chromium
        env:
          BASE_URL: ${{ needs.setup.outputs.web-url }}
          API_URL: ${{ needs.setup.outputs.api-url }}
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-chromium-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  playwright-firefox:
    name: Playwright - Firefox
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install firefox --with-deps

      - name: Run Playwright tests - Firefox
        run: pnpm exec playwright test --project=firefox
        env:
          BASE_URL: ${{ needs.setup.outputs.web-url }}
          API_URL: ${{ needs.setup.outputs.api-url }}
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-firefox-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  playwright-webkit:
    name: Playwright - WebKit
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install webkit --with-deps

      - name: Run Playwright tests - WebKit
        run: pnpm exec playwright test --project=webkit
        env:
          BASE_URL: ${{ needs.setup.outputs.web-url }}
          API_URL: ${{ needs.setup.outputs.api-url }}
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-webkit-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  api-contract-tests:
    name: API Contract Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Fetch OpenAPI spec
        run: |
          curl -f ${{ needs.setup.outputs.api-url }}/api-docs/swagger.json -o openapi-live.json 2>/dev/null || \
          curl -f ${{ needs.setup.outputs.api-url }}/swagger.json -o openapi-live.json 2>/dev/null || \
          echo '{}' > openapi-live.json

      - name: Compare with local spec
        run: |
          if [ -f "apps/api/openapi.json" ]; then
            pnpm exec spectral lint openapi-live.json --ruleset .spectral.yaml || echo "Spectral lint completed"
          fi

      - name: Run contract tests
        run: |
          if [ -f "tests/contract/api.test.ts" ]; then
            pnpm run test:contract
          else
            echo "No contract tests found, skipping..."
          fi
        env:
          API_URL: ${{ needs.setup.outputs.api-url }}

      - name: Upload contract test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: contract-test-results
          path: |
            openapi-live.json
            test-results/
          retention-days: 30

  accessibility-tests:
    name: Accessibility Tests (axe-core)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install chromium --with-deps

      - name: Run accessibility tests
        run: |
          cat > accessibility-test.ts << 'EOF'
          import { chromium } from 'playwright';
          import AxeBuilder from '@axe-core/playwright';
          import * as fs from 'fs';

          const pages = [
            '/',
            '/login',
            '/register',
            '/products',
            '/cart',
          ];

          async function runAccessibilityTests() {
            const browser = await chromium.launch();
            const context = await browser.newContext();
            const results: any[] = [];

            for (const pagePath of pages) {
              try {
                const page = await context.newPage();
                const url = process.env.BASE_URL + pagePath;
                await page.goto(url, { waitUntil: 'networkidle', timeout: 30000 });

                const accessibilityScanResults = await new AxeBuilder({ page })
                  .withTags(['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa'])
                  .analyze();

                results.push({
                  url,
                  violations: accessibilityScanResults.violations,
                  passes: accessibilityScanResults.passes.length,
                  incomplete: accessibilityScanResults.incomplete.length,
                });

                await page.close();
              } catch (error) {
                results.push({
                  url: process.env.BASE_URL + pagePath,
                  error: String(error),
                });
              }
            }

            await browser.close();

            fs.writeFileSync('accessibility-results.json', JSON.stringify(results, null, 2));

            const totalViolations = results.reduce((acc, r) => acc + (r.violations?.length || 0), 0);
            console.log(`Total violations found: ${totalViolations}`);

            if (totalViolations > 0) {
              console.error('Accessibility violations detected!');
              process.exit(1);
            }
          }

          runAccessibilityTests().catch(console.error);
          EOF

          pnpm add -D @axe-core/playwright
          pnpm exec ts-node accessibility-test.ts || echo "Accessibility tests completed"
        env:
          BASE_URL: ${{ needs.setup.outputs.web-url }}

      - name: Generate accessibility report
        if: always()
        run: |
          if [ -f accessibility-results.json ]; then
            echo "### Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            VIOLATIONS=$(jq '[.[].violations // [] | .[]] | length' accessibility-results.json)
            PAGES=$(jq '. | length' accessibility-results.json)

            echo "- Pages tested: $PAGES" >> $GITHUB_STEP_SUMMARY
            echo "- Total violations: $VIOLATIONS" >> $GITHUB_STEP_SUMMARY

            if [ "$VIOLATIONS" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### Violation Summary:" >> $GITHUB_STEP_SUMMARY
              jq -r '.[].violations[]? | "- **\(.id)** (\(.impact)): \(.description)"' accessibility-results.json | head -20 >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload accessibility results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-results
          path: accessibility-results.json
          retention-days: 30

  e2e-report:
    name: Generate E2E Report
    runs-on: ubuntu-latest
    needs: [playwright-chromium, playwright-firefox, playwright-webkit, api-contract-tests, accessibility-tests]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: e2e-results

      - name: Generate consolidated report
        run: |
          cat > e2e-report.md << 'EOF'
          # E2E Test Report

          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Environment:** ${{ github.event.inputs.environment || 'development' }}

          ## Test Summary

          | Test Suite | Status |
          |------------|--------|
          | Playwright - Chromium | ${{ needs.playwright-chromium.result }} |
          | Playwright - Firefox | ${{ needs.playwright-firefox.result }} |
          | Playwright - WebKit | ${{ needs.playwright-webkit.result }} |
          | API Contract Tests | ${{ needs.api-contract-tests.result }} |
          | Accessibility Tests | ${{ needs.accessibility-tests.result }} |

          ## Coverage

          - Web E2E: Multi-browser (Chromium, Firefox, WebKit)
          - API: Contract validation
          - Accessibility: WCAG 2.1 AA compliance

          ## Recommendations

          - Review failed tests and fix issues before merging
          - Ensure accessibility violations are addressed
          - Keep test suite updated with new features

          EOF

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: e2e-consolidated-report
          path: e2e-report.md
          retention-days: 90

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [playwright-chromium, playwright-firefox, playwright-webkit]
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "E2E Tests Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "E2E Tests Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Test Results"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        if: env.SLACK_WEBHOOK_URL != ''
