name: Dependency Vulnerability Scanning

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'
  schedule:
    # Run every Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '20'

jobs:
  npm-audit:
    name: NPM Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run npm audit
        run: |
          npm audit --json > npm-audit.json || true
          npm audit --audit-level=moderate > npm-audit.txt || true

      - name: Analyze npm audit results
        id: audit-analysis
        run: |
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' npm-audit.json)
          TOTAL=$(jq '.metadata.vulnerabilities.total // 0' npm-audit.json)

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          echo "### NPM Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY

          if [ $CRITICAL -gt 0 ] || [ $HIGH -gt 0 ]; then
            echo "::error::Found $CRITICAL critical and $HIGH high severity vulnerabilities"
            echo "has_critical=true" >> $GITHUB_OUTPUT
          else
            echo "has_critical=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate fix suggestions
        run: |
          echo "## NPM Audit Fix Suggestions" > npm-audit-fixes.md
          echo "" >> npm-audit-fixes.md
          echo "Run the following command to attempt automatic fixes:" >> npm-audit-fixes.md
          echo '```bash' >> npm-audit-fixes.md
          echo "npm audit fix" >> npm-audit-fixes.md
          echo '```' >> npm-audit-fixes.md
          echo "" >> npm-audit-fixes.md
          echo "For breaking changes, use:" >> npm-audit-fixes.md
          echo '```bash' >> npm-audit-fixes.md
          echo "npm audit fix --force" >> npm-audit-fixes.md
          echo '```' >> npm-audit-fixes.md

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: |
            npm-audit.json
            npm-audit.txt
            npm-audit-fixes.md
          retention-days: 30
        if: always()

      - name: Fail on critical vulnerabilities
        if: steps.audit-analysis.outputs.has_critical == 'true'
        run: |
          echo "::error::Critical or high severity vulnerabilities detected"
          exit 1

  snyk-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-results.json
        if: env.SNYK_TOKEN != ''

      - name: Run Snyk with SARIF output
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk-results.sarif
        if: env.SNYK_TOKEN != ''

      - name: Upload Snyk SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-results.sarif
          category: snyk
        if: env.SNYK_TOKEN != ''

      - name: Parse Snyk results
        id: snyk-analysis
        run: |
          if [ -f snyk-results.json ]; then
            CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "critical")] | length' snyk-results.json || echo 0)
            HIGH=$(jq '[.vulnerabilities[] | select(.severity == "high")] | length' snyk-results.json || echo 0)

            echo "### Snyk Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY

            if [ $CRITICAL -gt 0 ] || [ $HIGH -gt 0 ]; then
              echo "::warning::Found $CRITICAL critical and $HIGH high severity issues in Snyk scan"
            fi
          else
            echo "Snyk scan results not available. Set SNYK_TOKEN secret to enable Snyk scanning."
          fi
        if: always()
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload Snyk results
        uses: actions/upload-artifact@v4
        with:
          name: snyk-results
          path: |
            snyk-results.json
            snyk-results.sarif
          retention-days: 30
        if: always() && env.SNYK_TOKEN != ''
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  osv-scanner:
    name: OSV Scanner (Google)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run OSV Scanner
        uses: google/osv-scanner-action@v1
        continue-on-error: true
        with:
          scan-args: |-
            --format=json
            --output=osv-results.json
            ./

      - name: Run OSV Scanner for SARIF
        uses: google/osv-scanner-action@v1
        continue-on-error: true
        with:
          scan-args: |-
            --format=sarif
            --output=osv-results.sarif
            ./

      - name: Upload OSV SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: osv-results.sarif
          category: osv-scanner
        if: always()

      - name: Parse OSV results
        run: |
          if [ -f osv-results.json ]; then
            TOTAL=$(jq '.results[].packages[].vulnerabilities | length' osv-results.json | awk '{s+=$1} END {print s}' || echo 0)

            echo "### OSV Scanner Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Total vulnerabilities found: $TOTAL" >> $GITHUB_STEP_SUMMARY
          fi
        if: always()

      - name: Upload OSV results
        uses: actions/upload-artifact@v4
        with:
          name: osv-scanner-results
          path: |
            osv-results.json
            osv-results.sarif
          retention-days: 30
        if: always()

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          license-checker --json --out licenses.json
          license-checker --summary > licenses-summary.txt

          # Check for restricted licenses
          RESTRICTED=$(license-checker --json | jq -r '.[] | select(.licenses | test("GPL|AGPL|LGPL")) | .name' || echo "")

          if [ ! -z "$RESTRICTED" ]; then
            echo "::warning::Found potentially restricted licenses:"
            echo "$RESTRICTED"
            echo "$RESTRICTED" > restricted-licenses.txt
          fi

      - name: Generate license report
        run: |
          cat > license-report.md << 'EOF'
          # License Compliance Report

          ## Summary

          This report shows all third-party dependencies and their licenses.

          ## Approved Licenses
          - MIT
          - Apache-2.0
          - BSD-2-Clause
          - BSD-3-Clause
          - ISC

          ## Licenses Requiring Review
          - GPL (GNU General Public License)
          - AGPL (Affero GPL)
          - LGPL (Lesser GPL)

          ## Details

          See attached `licenses.json` for complete license information.

          EOF

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            licenses.json
            licenses-summary.txt
            license-report.md
            restricted-licenses.txt
          retention-days: 90
        if: always()

  dependency-graph:
    name: Generate Dependency Graph
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Generate dependency tree
        run: |
          npm list --all --json > dependency-tree.json || true
          npm list --all > dependency-tree.txt || true

      - name: Analyze dependency depth and size
        run: |
          TOTAL_DEPS=$(npm list --all --json | jq '[.. | .dependencies? // {} | keys[]] | unique | length' || echo 0)
          DIRECT_DEPS=$(jq '.dependencies | length' package.json || echo 0)

          echo "### Dependency Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Direct dependencies: $DIRECT_DEPS" >> $GITHUB_STEP_SUMMARY
          echo "- Total dependencies (including transitive): $TOTAL_DEPS" >> $GITHUB_STEP_SUMMARY

      - name: Check for outdated packages
        run: |
          npm outdated --json > outdated-packages.json || true
          npm outdated > outdated-packages.txt || true

      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            dependency-tree.json
            dependency-tree.txt
            outdated-packages.json
            outdated-packages.txt
          retention-days: 30
        if: always()

  vulnerability-report:
    name: Consolidated Vulnerability Report
    runs-on: ubuntu-latest
    needs: [npm-audit, snyk-scan, osv-scanner, license-compliance]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: scan-results

      - name: Generate consolidated report
        run: |
          cat > vulnerability-report.md << 'EOF'
          # Dependency Vulnerability Report

          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}

          ## Executive Summary

          This report consolidates findings from multiple dependency scanning tools.

          ### Scan Results

          | Tool | Status |
          |------|--------|
          | NPM Audit | ${{ needs.npm-audit.result }} |
          | Snyk | ${{ needs.snyk-scan.result }} |
          | OSV Scanner | ${{ needs.osv-scanner.result }} |
          | License Check | ${{ needs.license-compliance.result }} |

          ## Remediation Steps

          1. **Immediate Actions** (Critical/High vulnerabilities)
             - Review all critical and high severity findings
             - Update affected dependencies to patched versions
             - If no patch available, consider alternatives or implement workarounds

          2. **Short-term Actions** (Moderate vulnerabilities)
             - Schedule updates for moderate severity issues
             - Test thoroughly in development environment

          3. **Long-term Actions**
             - Implement automated dependency updates (Dependabot/Renovate)
             - Establish regular dependency review cadence
             - Monitor security advisories for used packages

          ## Resources

          - [npm audit documentation](https://docs.npmjs.com/cli/v8/commands/npm-audit)
          - [Snyk Vulnerability Database](https://snyk.io/vuln)
          - [GitHub Advisory Database](https://github.com/advisories)
          - [OSV Database](https://osv.dev/)

          EOF

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-consolidated-report
          path: vulnerability-report.md
          retention-days: 90

  notify-on-vulnerabilities:
    name: Notify on Critical Vulnerabilities
    runs-on: ubuntu-latest
    needs: [npm-audit, snyk-scan, osv-scanner]
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Dependency Vulnerability Alert",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":package: Dependency Vulnerabilities Detected"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Critical or high severity vulnerabilities found in dependencies. Update packages immediately."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Results"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        if: env.SLACK_WEBHOOK_URL != ''

  block-pr-on-vulnerabilities:
    name: Block PR on Critical Vulnerabilities
    runs-on: ubuntu-latest
    needs: [npm-audit]
    if: github.event_name == 'pull_request'

    steps:
      - name: Check for critical vulnerabilities
        run: |
          if [ "${{ needs.npm-audit.result }}" == "failure" ]; then
            echo "::error::Critical dependency vulnerabilities detected"
            exit 1
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## :x: Dependency Vulnerability Check Failed\n\nCritical or high severity vulnerabilities detected in dependencies.\n\n**Required Actions:**\n1. Run `npm audit` locally to see details\n2. Update vulnerable packages: `npm audit fix`\n3. For breaking changes: `npm audit fix --force` (test thoroughly)\n4. Re-run checks after updates\n\n**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            })
