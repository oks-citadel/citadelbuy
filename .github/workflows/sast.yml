name: SAST - Static Application Security Testing

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write
  actions: read

env:
  SEVERITY_THRESHOLD: 'high,critical'

jobs:
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'typescript']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality,security-extended
          config: |
            paths-ignore:
              - node_modules
              - dist
              - build
              - coverage
              - '**/*.test.ts'
              - '**/*.test.js'
              - '**/*.spec.ts'
              - '**/*.spec.js'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          upload: true
          output: sarif-results

      - name: Filter SARIF by severity
        uses: advanced-security/filter-sarif@v1
        with:
          patterns: |
            -**/*.test.ts
            -**/*.spec.ts
            -**/test/**
            -**/tests/**
          input: sarif-results/${{ matrix.language }}.sarif
          output: sarif-results/${{ matrix.language }}-filtered.sarif

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sarif-results/${{ matrix.language }}-filtered.sarif

      - name: Upload CodeQL results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: codeql-results-${{ matrix.language }}
          path: sarif-results/
          retention-days: 30

  semgrep-analysis:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config=auto \
            --config=p/ci \
            --config=p/owasp-top-ten \
            --config=p/security-audit \
            --sarif \
            --output=semgrep-results.sarif \
            --severity=ERROR \
            --severity=WARNING \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='build' \
            --exclude='*.test.*' \
            --exclude='*.spec.*' \
            --metrics=off \
            --verbose

      - name: Upload Semgrep SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep
        if: always()

      - name: Generate detailed report
        run: |
          semgrep scan \
            --config=auto \
            --json \
            --output=semgrep-report.json \
            --exclude='node_modules' \
            --exclude='dist' \
            --metrics=off
        if: always()

      - name: Parse results and check thresholds
        run: |
          if [ -f semgrep-report.json ]; then
            CRITICAL=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-report.json)
            HIGH=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-report.json)

            echo "CRITICAL_ISSUES=$CRITICAL" >> $GITHUB_ENV
            echo "HIGH_ISSUES=$HIGH" >> $GITHUB_ENV

            echo "### Semgrep Security Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Critical Issues: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High Issues: $HIGH" >> $GITHUB_STEP_SUMMARY

            if [ $CRITICAL -gt 0 ]; then
              echo "::error::Found $CRITICAL critical security issues"
              exit 1
            fi
          fi
        if: always()

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: |
            semgrep-results.sarif
            semgrep-report.json
          retention-days: 30
        if: always()

  eslint-security:
    name: ESLint Security Rules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          pnpm add -D eslint-plugin-security eslint-plugin-no-secrets

      - name: Run ESLint security scan
        run: |
          npx eslint . \
            --ext .js,.jsx,.ts,.tsx \
            --plugin security \
            --plugin no-secrets \
            --format json \
            --output-file eslint-security.json \
            --ignore-pattern 'node_modules' \
            --ignore-pattern 'dist' \
            --ignore-pattern 'build' \
            || true

      - name: Convert to SARIF
        run: |
          pnpm add -g @microsoft/eslint-formatter-sarif
          pnpm exec eslint . \
            --ext .js,.jsx,.ts,.tsx \
            --plugin security \
            --format @microsoft/eslint-formatter-sarif \
            --output-file eslint-security.sarif \
            || true

      - name: Upload ESLint SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: eslint-security.sarif
          category: eslint-security
        if: always()

      - name: Upload ESLint results
        uses: actions/upload-artifact@v4
        with:
          name: eslint-security-results
          path: eslint-security.json
          retention-days: 30
        if: always()

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [codeql-analysis, semgrep-analysis, eslint-security]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts

      - name: Generate consolidated report
        run: |
          cat > security-report.md << 'EOF'
          # Security Scan Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Summary

          | Tool | Status | Critical | High | Medium | Low |
          |------|--------|----------|------|--------|-----|
          | CodeQL | ${{ needs.codeql-analysis.result }} | - | - | - | - |
          | Semgrep | ${{ needs.semgrep-analysis.result }} | - | - | - | - |
          | ESLint Security | ${{ needs.eslint-security.result }} | - | - | - | - |

          ## Recommendations

          1. Review all critical and high severity findings immediately
          2. Update dependencies with known vulnerabilities
          3. Follow secure coding guidelines
          4. Implement suggested remediations from scan results

          ## Resources

          - [OWASP Top 10](https://owasp.org/www-project-top-ten/)
          - [CWE Top 25](https://cwe.mitre.org/top25/)
          - [NIST Secure Software Development Framework](https://csrc.nist.gov/projects/ssdf)

          EOF

          cat security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 90

  notify-security-team:
    name: Notify Security Team
    runs-on: ubuntu-latest
    needs: [codeql-analysis, semgrep-analysis, eslint-security]
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Security Scan Alert",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":warning: Security Vulnerabilities Detected"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\nSAST Analysis"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Critical or high severity vulnerabilities were found. Please review immediately."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Security Alerts"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/security"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        if: env.SLACK_WEBHOOK_URL != ''

      - name: Send Teams notification
        uses: jdcargile/ms-teams-notification@v1.4
        with:
          github-token: ${{ github.token }}
          ms-teams-webhook-uri: ${{ secrets.TEAMS_SECURITY_WEBHOOK }}
          notification-summary: "Security vulnerabilities detected in ${{ github.repository }}"
          notification-color: dc3545
          timezone: UTC
        if: env.TEAMS_WEBHOOK_URL != ''
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_SECURITY_WEBHOOK }}

  block-pr-on-critical:
    name: Block PR on Critical Issues
    runs-on: ubuntu-latest
    needs: [codeql-analysis, semgrep-analysis]
    if: github.event_name == 'pull_request'

    steps:
      - name: Check scan results
        run: |
          if [ "${{ needs.semgrep-analysis.result }}" == "failure" ]; then
            echo "::error::Critical security issues found. PR cannot be merged."
            exit 1
          fi
          echo "No critical security issues found."

      - name: Comment on PR
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## :no_entry: Security Scan Failed\n\nCritical or high severity security vulnerabilities were detected in this PR.\n\n**Action Required:**\n1. Review the security scan results in the workflow run\n2. Address all critical and high severity findings\n3. Re-run the security scan after fixes\n\n**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n:lock: This PR is blocked until security issues are resolved.'
            })
