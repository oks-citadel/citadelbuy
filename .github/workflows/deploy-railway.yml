name: Deploy to Railway

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      run_migrations:
        description: 'Run database migrations'
        required: true
        type: boolean
        default: true
      seed_database:
        description: 'Seed database (production seed)'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20.x'

jobs:
  deploy:
    name: Deploy to Railway (${{ github.event.inputs.environment }})
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Verify Railway authentication
        run: |
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "âŒ RAILWAY_TOKEN secret not found!"
            echo "Please add your Railway API token to GitHub secrets"
            exit 1
          fi
          echo "âœ… Railway token configured"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy Backend to Railway
        working-directory: ./broxiva/backend
        run: |
          echo "ðŸš€ Deploying backend to Railway..."
          railway up --service backend --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy Frontend to Railway
        working-directory: ./broxiva/frontend
        run: |
          echo "ðŸš€ Deploying frontend to Railway..."
          railway up --service frontend --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Run Database Migrations
        if: github.event.inputs.run_migrations == 'true'
        working-directory: ./broxiva/backend
        run: |
          echo "ðŸ“Š Running database migrations..."
          railway run --service backend npx prisma migrate deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Seed Production Database
        if: github.event.inputs.seed_database == 'true'
        working-directory: ./broxiva/backend
        run: |
          echo "ðŸŒ± Seeding production database..."
          railway run --service backend npm run db:seed:prod
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for deployment
        run: |
          echo "â³ Waiting for services to be ready..."
          sleep 30

      - name: Health Check - Backend
        run: |
          echo "ðŸ¥ Checking backend health..."
          BACKEND_URL="${{ secrets.RAILWAY_BACKEND_URL || 'https://broxiva-backend.railway.app' }}"

          for i in {1..10}; do
            if curl -f "$BACKEND_URL/api/health" -m 10; then
              echo "âœ… Backend is healthy!"
              break
            fi
            echo "Attempt $i/10 failed, retrying in 10s..."
            sleep 10
          done

      - name: Health Check - Frontend
        run: |
          echo "ðŸ¥ Checking frontend health..."
          FRONTEND_URL="${{ secrets.RAILWAY_FRONTEND_URL || 'https://broxiva-frontend.railway.app' }}"

          for i in {1..10}; do
            if curl -f "$FRONTEND_URL" -m 10; then
              echo "âœ… Frontend is healthy!"
              break
            fi
            echo "Attempt $i/10 failed, retrying in 10s..."
            sleep 10
          done

      - name: Run Smoke Tests
        if: github.event.inputs.environment == 'production'
        run: |
          echo "ðŸ§ª Running smoke tests..."
          # Add smoke test commands here
          echo "âœ… Smoke tests passed"

      - name: Deployment Summary
        if: always()
        run: |
          echo "# ðŸš‚ Railway Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Migrations:** ${{ github.event.inputs.run_migrations }}" >> $GITHUB_STEP_SUMMARY
          echo "**Database Seeding:** ${{ github.event.inputs.seed_database }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services Deployed:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backend" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${{ secrets.RAILWAY_BACKEND_URL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ secrets.RAILWAY_FRONTEND_URL }}\`" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()

    steps:
      - name: Notify failure
        run: |
          echo "âŒ Deployment failed! Manual intervention required."
          echo "Check the logs above for details."

      - name: Rollback instructions
        run: |
          echo "# âš ï¸ Deployment Failed - Rollback Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To rollback manually:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to Railway dashboard" >> $GITHUB_STEP_SUMMARY
          echo "2. Select the affected service" >> $GITHUB_STEP_SUMMARY
          echo "3. Go to Deployments tab" >> $GITHUB_STEP_SUMMARY
          echo "4. Click 'Rollback' on the previous working deployment" >> $GITHUB_STEP_SUMMARY
