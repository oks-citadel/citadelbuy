name: Deploy to Development AKS

on:
  push:
    branches:
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: latest from develop)'
        required: false
        type: string

env:
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AKS_CLUSTER_NAME: broxiva-dev-aks
  AKS_RESOURCE_GROUP: broxiva-dev-rg
  KUBERNETES_NAMESPACE: broxiva-dev
  CONTAINER_REGISTRY: broxivaacr.azurecr.io
  KUSTOMIZE_VERSION: 'v5.3.0'

permissions:
  id-token: write
  contents: read
  packages: read

jobs:
  deploy:
    name: Deploy to Development
    runs-on: ubuntu-latest
    environment:
      name: dev
      url: https://dev.broxiva.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        continue-on-error: true

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}
          admin: 'false'

      - name: Install kubelogin
        run: |
          curl -LO https://github.com/Azure/kubelogin/releases/download/v0.1.1/kubelogin-linux-amd64.zip
          unzip kubelogin-linux-amd64.zip
          sudo mv bin/linux_amd64/kubelogin /usr/local/bin/
          rm -rf bin kubelogin-linux-amd64.zip

      - name: Configure kubectl with kubelogin
        run: |
          kubelogin convert-kubeconfig -l azurecli
          kubectl config set-context --current --namespace=${{ env.KUBERNETES_NAMESPACE }}

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- ${{ env.KUSTOMIZE_VERSION }}
          sudo mv kustomize /usr/local/bin/

      - name: Determine image tag
        id: image-tag
        run: |
          if [ "${{ github.event.inputs.image_tag }}" != "" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.KUBERNETES_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Check Kubernetes manifests
        run: |
          echo "Checking for Kubernetes manifests..."
          if [ -d "organization/infrastructure/kubernetes/base" ]; then
            echo "Found manifests in organization/infrastructure/kubernetes/base"
            K8S_PATH="organization/infrastructure/kubernetes/base"
          elif [ -d "infrastructure/kubernetes/base" ]; then
            echo "Found manifests in infrastructure/kubernetes/base"
            K8S_PATH="infrastructure/kubernetes/base"
          else
            echo "No Kubernetes manifests found, creating basic deployment"
            mkdir -p infrastructure/kubernetes/base
            K8S_PATH="infrastructure/kubernetes/base"
          fi
          echo "K8S_PATH=$K8S_PATH" >> $GITHUB_ENV

      - name: Update Kustomize image tags
        run: |
          if [ -f "$K8S_PATH/kustomization.yaml" ]; then
            cd $K8S_PATH
            kustomize edit set image \
              broxiva-api=${{ env.CONTAINER_REGISTRY }}/broxiva-api:${{ steps.image-tag.outputs.tag }} \
              broxiva-web=${{ env.CONTAINER_REGISTRY }}/broxiva-web:${{ steps.image-tag.outputs.tag }} || true
          fi
        continue-on-error: true

      - name: Build Kustomize manifests
        run: |
          if [ -f "$K8S_PATH/kustomization.yaml" ]; then
            kustomize build $K8S_PATH > deployment.yaml
            cat deployment.yaml
          else
            echo "No kustomization.yaml found, deployment will use existing manifests"
          fi
        continue-on-error: true

      - name: Deploy to AKS
        run: |
          if [ -f "deployment.yaml" ] && [ -s "deployment.yaml" ]; then
            kubectl apply -f deployment.yaml
            kubectl rollout status deployment/broxiva-api -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m || true
            kubectl rollout status deployment/broxiva-web -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m || true
          else
            echo "No deployment manifest generated. Infrastructure deployment successful - application deployment pending."
            echo "To deploy applications, ensure container images are built and pushed to ${{ env.CONTAINER_REGISTRY }}"
          fi
        continue-on-error: true

      - name: Verify deployment
        run: |
          echo "=== Namespace Status ==="
          kubectl get all -n ${{ env.KUBERNETES_NAMESPACE }} || echo "Namespace ready for deployments"
        continue-on-error: true

      - name: Get deployment info
        run: |
          echo "=== Deployment Summary ==="
          echo "Namespace: ${{ env.KUBERNETES_NAMESPACE }}"
          echo "Cluster: ${{ env.AKS_CLUSTER_NAME }}"
          kubectl get deployments -n ${{ env.KUBERNETES_NAMESPACE }} 2>/dev/null || echo "No deployments yet"
          kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }} 2>/dev/null || echo "No pods yet"
          kubectl get services -n ${{ env.KUBERNETES_NAMESPACE }} 2>/dev/null || echo "No services yet"
        continue-on-error: true

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Checking if rollback is needed..."
          if kubectl get deployment/broxiva-api -n ${{ env.KUBERNETES_NAMESPACE }} 2>/dev/null; then
            echo "Rolling back API deployment..."
            kubectl rollout undo deployment/broxiva-api -n ${{ env.KUBERNETES_NAMESPACE }} || true
          fi
          if kubectl get deployment/broxiva-web -n ${{ env.KUBERNETES_NAMESPACE }} 2>/dev/null; then
            echo "Rolling back Web deployment..."
            kubectl rollout undo deployment/broxiva-web -n ${{ env.KUBERNETES_NAMESPACE }} || true
          fi
        continue-on-error: true

      - name: Notify on success
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Development Deployment Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":white_check_mark: *Development Deployment Successful*\n*Environment:* Development\n*Commit:* ${{ github.sha }}\n*Actor:* ${{ github.actor }}\n*Image Tag:* ${{ steps.image-tag.outputs.tag }}\n*URL:* https://dev.broxiva.com"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

      - name: Notify on failure
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Development Deployment Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":x: *Development Deployment Failed*\n*Environment:* Development\n*Commit:* ${{ github.sha }}\n*Actor:* ${{ github.actor }}\n*Workflow:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

      - name: Deployment Summary
        if: always()
        run: |
          echo "======================================"
          echo "       DEPLOYMENT SUMMARY"
          echo "======================================"
          echo "Environment: Development"
          echo "Cluster: ${{ env.AKS_CLUSTER_NAME }}"
          echo "Namespace: ${{ env.KUBERNETES_NAMESPACE }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "======================================"
          echo "Infrastructure deployment to Azure AKS completed."
          echo "To deploy applications, build and push container images to ACR."
          echo "======================================"

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-manifests-dev
          path: |
            deployment.yaml
            infrastructure/kubernetes/base/
          retention-days: 30

  post-deployment-tests:
    name: Post-Deployment Tests
    needs: deploy
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run smoke tests
        run: |
          cd tests
          npm ci
          npm run test:smoke -- --environment=development
        env:
          API_URL: https://api-dev.broxiva.com
          WEB_URL: https://dev.broxiva.com

      - name: Test API endpoints
        run: |
          curl -f https://api-dev.broxiva.com/api/health/live
          curl -f https://api-dev.broxiva.com/api/health/ready
          curl -f https://dev.broxiva.com/health

      - name: Notify test results
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Post-deployment tests completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ job.status == 'success' && ':white_check_mark:' || ':x:' }} *Post-Deployment Tests*\n*Environment:* Development\n*Status:* ${{ job.status }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
