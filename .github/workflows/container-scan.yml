name: Container Security Scanning

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - '.dockerignore'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'Dockerfile*'
      - 'docker-compose*.yml'
  schedule:
    # Run every Monday at 4 AM UTC
    - cron: '0 4 * * 1'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Specific image tag to scan'
        required: false
        default: 'latest'

permissions:
  contents: read
  security-events: write
  pull-requests: write
  packages: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-scan:
    name: Build & Scan Container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Export image as tarball
        run: |
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan -o image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar
          retention-days: 1

  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    needs: build-and-scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i image.tar

      - name: Run Trivy vulnerability scanner (Table output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Run Trivy vulnerability scanner (JSON)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-container'
        if: always()

      - name: Analyze Trivy results
        id: trivy-analysis
        run: |
          if [ -f trivy-results.json ]; then
            CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-results.json)
            HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-results.json)
            MEDIUM=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' trivy-results.json)
            LOW=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity == "LOW")] | length' trivy-results.json)

            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT

            echo "### Trivy Container Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY

            if [ $CRITICAL -gt 0 ]; then
              echo "::error::Found $CRITICAL critical vulnerabilities in container image"
              echo "has_critical=true" >> $GITHUB_OUTPUT
              exit 1
            elif [ $HIGH -gt 5 ]; then
              echo "::warning::Found $HIGH high severity vulnerabilities in container image"
              echo "has_critical=false" >> $GITHUB_OUTPUT
            else
              echo "has_critical=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Upload Trivy results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-container-results
          path: |
            trivy-results.json
            trivy-results.sarif
          retention-days: 30
        if: always()

  trivy-config-scan:
    name: Trivy IaC Configuration Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy config scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          hide-progress: false
          format: 'sarif'
          output: 'trivy-config-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Run Trivy config scanner (JSON)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          format: 'json'
          output: 'trivy-config-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy config SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-config-results.sarif'
          category: 'trivy-config'
        if: always()

      - name: Analyze Trivy config results
        run: |
          if [ -f trivy-config-results.json ]; then
            CRITICAL=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "CRITICAL")] | length' trivy-config-results.json)
            HIGH=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "HIGH")] | length' trivy-config-results.json)

            echo "### Trivy Config Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Critical misconfigurations: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High misconfigurations: $HIGH" >> $GITHUB_STEP_SUMMARY

            if [ $CRITICAL -gt 0 ]; then
              echo "::error::Found $CRITICAL critical configuration issues"
            fi
          fi
        if: always()

      - name: Upload Trivy config results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-config-results
          path: |
            trivy-config-results.json
            trivy-config-results.sarif
          retention-days: 30
        if: always()

  grype-scan:
    name: Grype Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build-and-scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i image.tar

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Run Grype scan
        run: |
          grype ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan -o json > grype-results.json
          grype ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan -o table > grype-results.txt

      - name: Run Grype scan (SARIF)
        run: |
          grype ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan -o sarif > grype-results.sarif

      - name: Upload Grype SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: grype-results.sarif
          category: grype
        if: always()

      - name: Analyze Grype results
        run: |
          if [ -f grype-results.json ]; then
            CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' grype-results.json)
            HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' grype-results.json)

            echo "### Grype Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY
          fi
        if: always()

      - name: Upload Grype results
        uses: actions/upload-artifact@v4
        with:
          name: grype-results
          path: |
            grype-results.json
            grype-results.txt
            grype-results.sarif
          retention-days: 30
        if: always()

  docker-bench-security:
    name: Docker Bench Security
    runs-on: ubuntu-latest
    needs: build-and-scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i image.tar

      - name: Run Docker Bench for Security
        run: |
          docker run --rm --net host --pid host --userns host --cap-add audit_control \
            -e DOCKER_CONTENT_TRUST=$DOCKER_CONTENT_TRUST \
            -v /var/lib:/var/lib \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v /usr/lib/systemd:/usr/lib/systemd \
            -v /etc:/etc --label docker_bench_security \
            docker/docker-bench-security > docker-bench-results.txt || true

      - name: Parse Docker Bench results
        run: |
          cat docker-bench-results.txt

          echo "### Docker Bench Security Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 docker-bench-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        if: always()

      - name: Upload Docker Bench results
        uses: actions/upload-artifact@v4
        with:
          name: docker-bench-results
          path: docker-bench-results.txt
          retention-days: 30
        if: always()

  hadolint:
    name: Hadolint Dockerfile Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: sarif
          output-file: hadolint-results.sarif
          no-fail: true

      - name: Run Hadolint (JSON)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: json
          output-file: hadolint-results.json
          no-fail: true

      - name: Upload Hadolint SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: hadolint-results.sarif
          category: hadolint
        if: always()

      - name: Analyze Hadolint results
        run: |
          if [ -f hadolint-results.json ]; then
            ERROR_COUNT=$(jq '[.[] | select(.level == "error")] | length' hadolint-results.json)
            WARNING_COUNT=$(jq '[.[] | select(.level == "warning")] | length' hadolint-results.json)

            echo "### Hadolint Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Errors: $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $WARNING_COUNT" >> $GITHUB_STEP_SUMMARY

            if [ $ERROR_COUNT -gt 0 ]; then
              echo "::error::Found $ERROR_COUNT Dockerfile errors"
            fi
          fi
        if: always()

      - name: Upload Hadolint results
        uses: actions/upload-artifact@v4
        with:
          name: hadolint-results
          path: |
            hadolint-results.sarif
            hadolint-results.json
          retention-days: 30
        if: always()

  dockle:
    name: Dockle Image Linting
    runs-on: ubuntu-latest
    needs: build-and-scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i image.tar

      - name: Install Dockle
        run: |
          VERSION=$(curl --silent "https://api.github.com/repos/goodwithtech/dockle/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -L -o dockle.tar.gz https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit.tar.gz
          tar zxvf dockle.tar.gz
          sudo mv dockle /usr/local/bin

      - name: Run Dockle
        run: |
          dockle --format json --output dockle-results.json ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan || true
          dockle --exit-code 1 --exit-level fatal ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:scan > dockle-results.txt || true

      - name: Analyze Dockle results
        run: |
          if [ -f dockle-results.json ]; then
            FATAL=$(jq '[.details[] | select(.level == "FATAL")] | length' dockle-results.json)
            WARN=$(jq '[.details[] | select(.level == "WARN")] | length' dockle-results.json)

            echo "### Dockle Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Fatal: $FATAL" >> $GITHUB_STEP_SUMMARY
            echo "- Warnings: $WARN" >> $GITHUB_STEP_SUMMARY

            if [ $FATAL -gt 0 ]; then
              echo "::error::Found $FATAL fatal issues in container image"
            fi
          fi
        if: always()

      - name: Upload Dockle results
        uses: actions/upload-artifact@v4
        with:
          name: dockle-results
          path: |
            dockle-results.json
            dockle-results.txt
          retention-days: 30
        if: always()

  container-report:
    name: Generate Container Security Report
    runs-on: ubuntu-latest
    needs: [trivy-scan, trivy-config-scan, grype-scan, hadolint, dockle]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: container-scan-results

      - name: Generate consolidated report
        run: |
          cat > container-security-report.md << 'EOF'
          # Container Security Report

          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository:** ${{ github.repository }}
          **Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          **Branch:** ${{ github.ref_name }}

          ## Scan Summary

          | Tool | Purpose | Status |
          |------|---------|--------|
          | Trivy | Vulnerability Scanning | ${{ needs.trivy-scan.result }} |
          | Trivy Config | IaC Configuration | ${{ needs.trivy-config-scan.result }} |
          | Grype | Vulnerability Scanning | ${{ needs.grype-scan.result }} |
          | Hadolint | Dockerfile Linting | ${{ needs.hadolint.result }} |
          | Dockle | Image Best Practices | ${{ needs.dockle.result }} |

          ## Key Findings

          Review individual scan results for detailed findings and remediation steps.

          ## Remediation Guidelines

          ### Critical Vulnerabilities
          1. Update base image to latest patched version
          2. Update vulnerable packages in Dockerfile
          3. Consider alternative packages if no fix available

          ### Dockerfile Best Practices
          1. Use specific version tags, not `latest`
          2. Run as non-root user
          3. Minimize layers and image size
          4. Use multi-stage builds
          5. Don't include secrets in image

          ### Configuration Issues
          1. Follow CIS Docker Benchmark
          2. Enable Docker Content Trust
          3. Use read-only root filesystem where possible
          4. Set appropriate resource limits

          ## Resources

          - [CIS Docker Benchmark](https://www.cisecurity.org/benchmark/docker)
          - [Docker Security Best Practices](https://docs.docker.com/develop/security-best-practices/)
          - [NIST Container Security Guide](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-190.pdf)

          EOF

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: container-security-report
          path: container-security-report.md
          retention-days: 90

  notify-on-critical:
    name: Notify on Critical Issues
    runs-on: ubuntu-latest
    needs: [trivy-scan, grype-scan]
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Container Security Alert",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":whale: Critical Container Vulnerabilities"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Image:*\n${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Critical vulnerabilities detected in container image. Update base image and packages immediately."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Scan Results"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_SECURITY_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        if: env.SLACK_WEBHOOK_URL != ''

  block-pr-on-critical:
    name: Block PR on Critical Vulnerabilities
    runs-on: ubuntu-latest
    needs: [trivy-scan]
    if: github.event_name == 'pull_request'

    steps:
      - name: Check scan results
        run: |
          if [ "${{ needs.trivy-scan.result }}" == "failure" ]; then
            echo "::error::Critical container vulnerabilities detected"
            exit 1
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## :x: Container Security Scan Failed\n\nCritical vulnerabilities detected in container image.\n\n**Required Actions:**\n1. Review scan results in workflow run\n2. Update base image to latest patched version\n3. Update vulnerable packages in Dockerfile\n4. Rebuild and re-scan\n\n**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            })
